<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã±ã±ã‚“è¨¼åˆ¸</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #e3f2fd;
            /* ãƒ“ã‚¸ãƒã‚¹ã£ã½ã„è–„ã„é’ */
            text-align: center;
            padding: 20px;
            margin: 0;
            color: #0d47a1;
            touch-action: manipulation;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0 0 10px 0;
            color: #1565c0;
            font-size: 24px;
        }

        /* è³‡ç”£è¡¨ç¤º */
        .assets-area {
            display: flex;
            justify-content: space-around;
            background: #fff3e0;
            border: 2px solid #ffe0b2;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .asset-val {
            font-weight: bold;
            font-size: 18px;
            color: #e65100;
        }

        /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚«ãƒ¼ */
        .news-box {
            background: #333;
            color: #00e5ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            border-left: 5px solid #ff1744;
        }

        .news-text {
            display: inline-block;
            animation: marquee 10s linear infinite;
        }

        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* éŠ˜æŸ„ãƒªã‚¹ãƒˆ */
        .stock-list {
            display: grid;
            gap: 15px;
        }

        .stock-card {
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 15px;
            text-align: left;
            transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .stock-card.up {
            border-color: #ff5252;
            background: #ffebee;
        }

        .stock-card.down {
            border-color: #448aff;
            background: #e3f2fd;
        }

        .st-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .st-name {
            font-size: 18px;
            font-weight: bold;
        }

        .st-price {
            font-size: 22px;
            font-weight: bold;
        }

        .st-change {
            font-size: 14px;
            margin-left: 10px;
        }

        .st-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .st-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .st-holdings {
            font-size: 14px;
            flex: 1;
            text-align: right;
            color: #555;
        }

        button.btn-trade {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }

        .btn-buy {
            background: #ff5252;
        }

        .btn-sell {
            background: #4caf50;
        }

        .btn-trade:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ãƒ‡ãƒãƒƒã‚°ç”¨ */
        .debug-area {
            margin-top: 50px;
            text-align: right;
            opacity: 0.3;
        }

        .debug-area:hover {
            opacity: 1;
        }

        /* â–¼â–¼â–¼ è¿½åŠ ï¼šãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
        .link-area {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
        }

        .btn-link {
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 14px;
            transition: 0.2s;
            display: inline-block;
        }

        .to-bank {
            background: #fff;
            color: #2e7d32;
            border: 2px solid #2e7d32;
            box-shadow: 0 2px 5px rgba(46, 125, 50, 0.2);
        }

        .to-home {
            color: #1565c0;
            text-decoration: underline;
        }

        /* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */
    </style>
</head>

<body>

    <div class="container">
        <h1>ğŸ“ˆ ã±ã±ã‚“è¨¼åˆ¸</h1>

        <select id="user-select" onchange="updateUI()" style="padding: 5px; font-size: 16px; margin-bottom: 15px;">
            <option value="">(ãªã¾ãˆã‚’ãˆã‚‰ã‚“ã§ã­)</option>
        </select>

        <div class="assets-area">
            <div>ğŸ’° <span id="my-pts" class="asset-val">0</span> pt</div>
            <div>ğŸŒ° <span id="my-don" class="asset-val">0</span></div>
        </div>

        <div class="news-box">
            <div id="news-text" class="news-text">ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div id="stock-list" class="stock-list">
        </div>

        <div style="margin-top: 20px; font-size: 12px; color: #aaa;">
            â€»æ ªä¾¡ã¯ 1æ—¥ã« 1å› ã‹ã‚ã‚Šã¾ã™ã€‚æ¯æ—¥ãƒã‚§ãƒƒã‚¯ã—ã¦ã­ã€‚
        </div>

        <div class="link-area">
            <a href="index.html" class="btn-link to-home">ğŸ  ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>
            <a href="bank.html" class="btn-link to-bank">ğŸ¦ ã±ã±ã‚“éŠ€è¡Œã¸ã„ã</a>
        </div>
        <div class="debug-area">
            <button onclick="debugResetDate()" style="font-size:10px;">[DEBUG] æ—¥ä»˜ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
        </div>
    </div>

    <script>
        const STOCK_KEYS = ['motor', 'food', 'tech', 'nikkei', 'sp500'];

        window.onload = function () {
            const users = getUserNames();
            const select = document.getElementById('user-select');
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.innerText = u;
                select.appendChild(opt);
            });

            // 1. ã¾ãšç”»é¢ã‚’ä»Šã®çŠ¶æ…‹ã§ã™ãã«è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ãŸã›ãªã„ï¼‰
            updateUI();

            // 2. è£ã§ã€Œæ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‹ï¼Ÿã€ã‚’ãƒã‚§ãƒƒã‚¯
            // â€»ãƒªã‚¢ãƒ«é€£å‹•ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã§æ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€ç”»é¢è¡¨ç¤ºå¾Œã«å®Ÿè¡Œ
            checkAndAdvanceDate().then(report => {
                // ã‚‚ã—æ›´æ–°ãŒã‚ã£ãŸã‚‰ã€ã‚‚ã†ä¸€åº¦ç”»é¢ã‚’æç”»ã—ãªãŠã™
                if (report) {
                    updateUI();

                    if (report.length >= 0) {
                        let msg = "ğŸ“… æ–°ã—ã„æ—¥ã«ãªã‚Šã¾ã—ãŸï¼\næ ªä¾¡ãŒå¤‰å‹•ã—ã¾ã—ãŸã€‚";
                        if (report.length > 0) {
                            msg += "\n\nã€é…å½“é‡‘ã®ãŠçŸ¥ã‚‰ã›ã€‘\n" + report.join("\n");
                        }
                        setTimeout(() => alert(msg), 100);
                    }
                }
            });
        };

        function updateUI() {
            const userName = document.getElementById('user-select').value;
            const market = getMarketData();

            document.getElementById('news-text').innerText = market.news;

            if (userName) {
                document.getElementById('my-pts').innerText = getUserPoints(userName);
                document.getElementById('my-don').innerText = getUserDonguri(userName);
            } else {
                document.getElementById('my-pts').innerText = 0;
                document.getElementById('my-don').innerText = 0;
            }

            const container = document.getElementById('stock-list');
            container.innerHTML = '';

            STOCK_KEYS.forEach(key => {
                const info = STOCK_MASTER[key];
                const price = market.prices[key];
                const lastPrice = market.lastPrices[key];
                const diff = price - lastPrice;

                let holdings = 0;
                if (userName) {
                    const stocks = getUserStocks(userName) || {};
                    holdings = stocks[key] || 0;
                }

                let colorClass = '';
                let sign = 'Â±';
                if (diff > 0) { colorClass = 'up'; sign = '+'; }
                else if (diff < 0) { colorClass = 'down'; sign = ''; }

                const unit = info.currency === 'point' ? 'pt' : 'ğŸŒ°';

                const html = `
                <div class="stock-card ${colorClass}">
                    <div class="st-header">
                        <span class="st-name">${info.name}</span>
                        <div>
                            <span class="st-price">${price} <span style="font-size:14px">${unit}</span></span>
                            <span class="st-change" style="color:${diff > 0 ? 'red' : (diff < 0 ? 'blue' : 'gray')}">${sign}${diff}</span>
                        </div>
                    </div>
                    <div class="st-desc">${info.desc} (é…å½“: ${Math.floor(info.dividendRate * 100)}%)</div>
                    
                    <div class="st-actions">
                        <button class="btn-trade btn-buy" onclick="trade('${key}', 'buy')" ${!userName ? 'disabled' : ''}>è²·ã†</button>
                        <button class="btn-trade btn-sell" onclick="trade('${key}', 'sell')" ${!userName || holdings <= 0 ? 'disabled' : ''}>å£²ã‚‹</button>
                        <div class="st-holdings">æŒã¡æ ª: <b>${holdings}</b> æ ª</div>
                    </div>
                </div>
            `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function trade(stockId, type) {
            const userName = document.getElementById('user-select').value;
            if (!userName) return;

            const amount = 1;

            if (type === 'buy') {
                const market = getMarketData();
                const price = market.prices[stockId];
                const info = STOCK_MASTER[stockId];
                const unit = info.currency === 'point' ? 'pt' : 'ğŸŒ°';

                if (confirm(`${info.name} ã‚’ ${price}${unit} ã§ 1æ ª è²·ã„ã¾ã™ã‹ï¼Ÿ`)) {
                    const success = buyStock(userName, stockId, amount);
                    if (success) {
                        alert("ã‹ã„ã¾ã—ãŸï¼");
                        updateUI();
                    } else {
                        alert(`${unit}ãŒ è¶³ã‚Šãªã„ã‚ˆï¼`);
                    }
                }
            } else {
                const success = sellStock(userName, stockId, amount);
                if (success) {
                    alert("ã†ã‚Šã¾ã—ãŸï¼");
                    updateUI();
                } else {
                    alert("å£²ã‚Œã‚‹æ ªã‚’ã‚‚ã£ã¦ã„ãªã„ã‚ˆ");
                }
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨: ä¿å­˜ã•ã‚ŒãŸæ—¥ä»˜ã‚’æ¶ˆã™ï¼ˆï¼æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å¿…ãšæ›´æ–°ãŒèµ°ã‚‹ï¼‰
        /*
                function debugResetDate() {
                    const market = getMarketData();
                    market.lastUpdate = "";
                    localStorage.setItem('papan_market_v1', JSON.stringify(market));
                    alert("æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€Œæ¬¡ã®æ—¥ã€ã«ãªã‚Šã¾ã™ã€‚");
                    location.reload();
                }
        */

    </script>

</body>

</html>