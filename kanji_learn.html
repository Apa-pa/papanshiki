<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êº¢Â≠ó„Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ | „Å±„Å±„ÇìÂºè</title>
    <script src="ranking.js"></script>
    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "UD Digital Kyokasho-tai-R", "UD Digital Kyokasho-tai", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background: linear-gradient(135deg, #fef9e7 0%, #fdebd0 50%, #fef9e7 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .container {
            width: 95%;
            max-width: 500px;
            margin: 0 auto;
            padding: 15px 10px 30px;
            position: relative;
        }

        /* „ÇÇ„Å©„Çã„Éú„Çø„É≥ */
        .home-btn {
            display: inline-block;
            text-decoration: none;
            color: #888;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 5px 12px;
            border-radius: 15px;
            transition: 0.3s;
            margin-bottom: 10px;
        }

        .home-btn:hover {
            background-color: #eee;
        }

        /* „Çø„Ç§„Éà„É´ */
        .title {
            text-align: center;
            font-size: 24px;
            color: #e67e22;
            margin: 10px 0 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        .subtitle {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin-bottom: 20px;
        }

        /* === „Çπ„Çø„Éº„ÉàÁîªÈù¢ === */
        .start-screen {
            text-align: center;
        }

        .grade-select-label {
            font-size: 16px;
            color: #6b4e3d;
            font-weight: bold;
            margin: 20px 0 15px;
        }

        .grade-btns {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .grade-btn {
            background: white;
            border: 3px solid #f0c27f;
            font-size: 18px;
            font-weight: bold;
            padding: 14px 24px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            color: #6b4e3d;
            box-shadow: 0 4px 0 #e6b06e;
            width: 80%;
            max-width: 250px;
        }

        .grade-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #e6b06e;
        }

        .grade-btn.selected {
            background: #f0c27f;
            color: white;
            border-color: #e6a855;
        }

        /* ÈÄ≤ÊçóË°®Á§∫ */
        .progress-info {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .progress-bar-bg {
            background: #eee;
            border-radius: 10px;
            height: 16px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #f7dc6f, #f0c27f, #e67e22);
            border-radius: 10px;
            transition: width 0.5s ease;
            min-width: 0;
        }

        .progress-text {
            font-size: 14px;
            color: #888;
        }

        .progress-count {
            font-size: 22px;
            font-weight: bold;
            color: #e67e22;
        }

        /* „É¢„Éº„ÉâÈÅ∏Êäû„Éú„Çø„É≥ */
        .mode-btns {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .mode-btn {
            background: white;
            border: 3px solid #4CAF50;
            font-size: 20px;
            font-weight: bold;
            padding: 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            color: #333;
            box-shadow: 0 4px 0 #388E3C;
        }

        .mode-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #388E3C;
        }

        .mode-btn.zukan-btn {
            border-color: #9C27B0;
            box-shadow: 0 4px 0 #7B1FA2;
        }

        .mode-btn-desc {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
            font-weight: normal;
        }

        /* === Â≠¶ÁøíÁîªÈù¢ === */
        .learn-screen {
            display: none;
            text-align: center;
        }

        .learn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .learn-progress {
            font-size: 14px;
            color: #888;
        }

        .learn-back-btn {
            background: none;
            border: 1px solid #ccc;
            color: #888;
            font-size: 13px;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
        }

        /* „Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ */
        .card-container {
            perspective: 800px;
            margin: 10px auto;
            width: 100%;
            max-width: 360px;
            height: 320px;
        }

        .flash-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .flash-card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .card-front {
            background: linear-gradient(145deg, #fff, #fef9e7);
            border: 4px solid #f0c27f;
        }

        .card-front .kanji-display {
            font-size: 120px;
            font-weight: bold;
            color: #333;
            line-height: 1.1;
        }

        .card-front .tap-hint {
            font-size: 13px;
            color: #bbb;
            margin-top: 15px;
        }

        .card-front .strokes-info {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }

        .card-back {
            background: linear-gradient(145deg, #fef9e7, #fdebd0);
            border: 4px solid #e67e22;
            transform: rotateY(180deg);
        }

        .card-back .kanji-small {
            font-size: 50px;
            font-weight: bold;
            color: #e67e22;
            margin-bottom: 8px;
        }

        .card-back .reading {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .card-back .meaning {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .card-back .example-sentence {
            font-size: 16px;
            color: #555;
            background: rgba(255, 255, 255, 0.6);
            padding: 8px 16px;
            border-radius: 12px;
            margin-bottom: 6px;
        }

        .card-back .hint-text {
            font-size: 13px;
            color: #999;
        }

        /* Â≠¶Áøí„Éú„Çø„É≥ */
        .learn-btns {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 15px;
        }

        .learn-action-btn {
            font-size: 18px;
            font-weight: bold;
            padding: 14px 28px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-memorized {
            background: #4CAF50;
            color: white;
            box-shadow: 0 4px 0 #388E3C;
        }

        .btn-memorized:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #388E3C;
        }

        .btn-again {
            background: #ff9800;
            color: white;
            box-shadow: 0 4px 0 #e68900;
        }

        .btn-again:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #e68900;
        }

        /* === „ÇØ„Ç§„Ç∫ÁîªÈù¢ === */
        .quiz-screen {
            display: none;
            text-align: center;
        }

        .quiz-question {
            font-size: 18px;
            color: #555;
            margin: 10px 0;
        }

        .quiz-kanji {
            font-size: 100px;
            font-weight: bold;
            color: #333;
            margin: 15px 0;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        .quiz-option-btn {
            background: white;
            border: 3px solid #4dd0e1;
            font-size: 20px;
            font-weight: bold;
            padding: 16px;
            border-radius: 18px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            color: #333;
            box-shadow: 0 3px 0 #26c6da;
        }

        .quiz-option-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #26c6da;
        }

        .quiz-option-btn.correct {
            background: #4CAF50;
            color: white;
            border-color: #388E3C;
        }

        .quiz-option-btn.wrong {
            background: #ef5350;
            color: white;
            border-color: #c62828;
        }

        .quiz-option-btn:disabled {
            cursor: default;
        }

        /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .quiz-feedback {
            font-size: 60px;
            margin: 10px 0;
            display: none;
        }

        /* === ÁµêÊûúÁîªÈù¢ === */
        .result-screen {
            display: none;
            text-align: center;
        }

        .result-title {
            font-size: 26px;
            color: #e67e22;
            margin: 20px 0 10px;
        }

        .result-count {
            font-size: 40px;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }

        .result-msg {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .result-btn {
            font-size: 18px;
            font-weight: bold;
            padding: 14px 32px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            margin: 8px;
            transition: all 0.2s;
        }

        .result-point-btn {
            background: #ff9800;
            color: white;
            box-shadow: 0 4px 0 #e68900;
        }

        .result-point-btn:disabled {
            background: #ccc;
            box-shadow: 0 4px 0 #999;
        }

        .result-point-btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #e68900;
        }

        .result-restart-btn {
            background: #2196F3;
            color: white;
            box-shadow: 0 4px 0 #1565C0;
        }

        .result-restart-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1565C0;
        }

        /* === Âõ≥ÈëëÁîªÈù¢ === */
        .zukan-screen {
            display: none;
        }

        .zukan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .zukan-title {
            font-size: 20px;
            color: #9C27B0;
            font-weight: bold;
        }

        .zukan-back-btn {
            background: none;
            border: 1px solid #ccc;
            color: #888;
            font-size: 13px;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
        }

        .zukan-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .zukan-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .zukan-cell.mastered {
            background: linear-gradient(145deg, #fff8e1, #ffecb3);
            border: 2px solid #f0c27f;
            color: #333;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .zukan-cell.mastered:hover {
            transform: scale(1.08);
        }

        .zukan-cell.locked {
            background: #eee;
            border: 2px solid #ddd;
            color: #ccc;
        }

        /* Âõ≥ÈëëË©≥Á¥∞„É¢„Éº„ÉÄ„É´ */
        .zukan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .zukan-modal.show {
            display: flex;
        }

        .zukan-modal-content {
            background: white;
            border-radius: 25px;
            padding: 25px;
            width: 85%;
            max-width: 350px;
            text-align: center;
            animation: popIn 0.3s ease;
        }

        .zukan-modal-kanji {
            font-size: 80px;
            font-weight: bold;
            color: #e67e22;
        }

        .zukan-modal-reading {
            font-size: 22px;
            font-weight: bold;
            margin: 8px 0 4px;
        }

        .zukan-modal-meaning {
            font-size: 16px;
            color: #666;
            margin-bottom: 6px;
        }

        .zukan-modal-example {
            font-size: 16px;
            color: #555;
            background: #fef9e7;
            padding: 8px 16px;
            border-radius: 12px;
            margin: 8px 0;
        }

        .zukan-modal-close {
            background: #eee;
            border: none;
            font-size: 16px;
            padding: 10px 30px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            font-family: inherit;
        }

        /* „Ç≠„É©„Ç≠„É©„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes sparkle {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }

            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }

            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }

        .sparkle {
            position: fixed;
            font-size: 30px;
            pointer-events: none;
            z-index: 200;
            animation: sparkle 0.8s ease forwards;
        }

        /* === „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Ç™„Éº„Éê„Éº„É¨„Ç§ === */
        #user-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e67e22, #f39c12, #f1c40f);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .user-select-box {
            background: white;
            padding: 30px 25px;
            border-radius: 25px;
            max-width: 90%;
            width: 360px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: popIn 0.3s ease;
        }

        .user-select-box h2 {
            color: #e67e22;
            font-size: 24px;
            margin: 0 0 5px;
        }

        .user-select-box p {
            color: #888;
            font-size: 14px;
            margin: 0 0 20px;
        }

        .user-btn {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #f39c12, #f1c40f);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 0 #e67e22;
            transition: all 0.2s;
        }

        .user-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #e67e22;
        }

        /* ÂÖ®ÁîªÈù¢ÈùûË°®Á§∫„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ */
        .hidden {
            display: none !important;
        }

        /* „Çπ„Éû„ÉõÂØæÂøú */
        @media (max-width: 400px) {
            .card-container {
                height: 280px;
            }

            .card-front .kanji-display {
                font-size: 90px;
            }

            .card-back .kanji-small {
                font-size: 40px;
            }

            .card-back .reading {
                font-size: 18px;
            }

            .zukan-cell {
                font-size: 24px;
            }

            .quiz-kanji {
                font-size: 80px;
            }
        }
    </style>
</head>

<body>

    <!-- „É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûÁîªÈù¢ -->
    <div id="user-overlay">
        <div class="user-select-box">
            <h2>üìö Êº¢Â≠ó„Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ</h2>
            <p>„Å†„Çå„Åå „Åæ„Å™„Å∂Ôºü</p>
            <div id="user-list"></div>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="home-btn">‚Üê „ÇÇ„Å©„Çã</a>
        <h1 class="title">üìö Êº¢Â≠ó„Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ</h1>
        <p class="subtitle">„Ç´„Éº„Éâ„Çí„ÇÅ„Åè„Å£„Å¶Êº¢Â≠ó„Çí„Åä„Åº„Åà„Çà„ÅÜÔºÅ</p>

        <!-- === „Çπ„Çø„Éº„ÉàÁîªÈù¢ === -->
        <div id="start-screen" class="start-screen">
            <p class="grade-select-label">„Åå„Åè„Å≠„Çì „Çí „Åà„Çâ„Çì„Åß„Å≠</p>
            <div class="grade-btns" id="grade-btns">
                <!-- JS„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>

            <div class="progress-info" id="progress-info" style="display:none;">
                <div class="progress-text">„Åä„Åº„Åà„Åü „Åã„Çì„Åò</div>
                <div>
                    <span class="progress-count" id="progress-count">0</span>
                    <span class="progress-text"> / <span id="progress-total">80</span> „Åò</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            <div class="mode-btns" id="mode-btns" style="display:none;">
                <button class="mode-btn" onclick="startLearning()">
                    üìñ „Åå„Åè„Åó„ÇÖ„ÅÜ „Åô„Çã
                    <div class="mode-btn-desc">„ÅÇ„Åü„Çâ„Åó„ÅÑ „Åã„Çì„Åò „Çí „Åä„Åº„Åà„Çà„ÅÜ</div>
                </button>
                <button class="mode-btn zukan-btn" onclick="showZukan()">
                    üìï „Åã„Çì„Åò „Åö„Åã„Çì
                    <div class="mode-btn-desc">„Åä„Åº„Åà„Åü „Åã„Çì„Åò „Çí „Åø„Å¶„Åø„Çà„ÅÜ</div>
                </button>
            </div>
        </div>

        <!-- === Â≠¶ÁøíÁîªÈù¢ === -->
        <div id="learn-screen" class="learn-screen">
            <div class="learn-header">
                <button class="learn-back-btn" onclick="backToStart()">‚Üê „ÇÇ„Å©„Çã</button>
                <span class="learn-progress"><span id="learn-current">1</span> / <span id="learn-total">10</span></span>
            </div>

            <div class="card-container" onclick="flipCard()">
                <div class="flash-card" id="flash-card">
                    <div class="card-face card-front">
                        <div class="kanji-display" id="card-kanji">‰∏Ä</div>
                        <div class="strokes-info" id="card-strokes">„Åã„Åè„Åô„ÅÜ: 1</div>
                        <div class="tap-hint">üëÜ „Çø„ÉÉ„Éó„Åó„Å¶ „ÅÜ„Çâ„Åå„Åà„Åô</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="kanji-small" id="card-kanji-back">‰∏Ä</div>
                        <div class="reading" id="card-reading">„ÅÑ„Å° / „Å≤„Å®(„Å§)</div>
                        <div class="meaning" id="card-meaning">„Åã„Åö „ÅÆ 1</div>
                        <div class="example-sentence" id="card-example">üìù ‰∏Ä„Å§ „Åè„Å†„Åï„ÅÑ</div>
                        <div class="hint-text" id="card-hint">üí° „Çà„Åì „ÅÆ „Åº„ÅÜ 1„ÅΩ„Çì</div>
                    </div>
                </div>
            </div>

            <div class="learn-btns" id="learn-btns" style="display:none;">
                <button class="learn-action-btn btn-again" onclick="nextCard(false)">üîÑ „ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
                <button class="learn-action-btn btn-memorized" onclick="nextCard(true)">‚úÖ „Åä„Åº„Åà„ÅüÔºÅ</button>
            </div>
        </div>

        <!-- === „ÇØ„Ç§„Ç∫ÁîªÈù¢ === -->
        <div id="quiz-screen" class="quiz-screen">
            <div class="learn-header">
                <span></span>
                <span class="learn-progress">„Éü„Éã„ÇØ„Ç§„Ç∫</span>
            </div>
            <p class="quiz-question">„Åì„ÅÆ „Åã„Çì„Åò „ÅÆ „Çà„Åø„Åã„Åü „ÅØÔºü</p>
            <div class="quiz-kanji" id="quiz-kanji">‰∏Ä</div>
            <div class="quiz-options" id="quiz-options">
                <!-- JS„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>
            <div class="quiz-feedback" id="quiz-feedback"></div>
        </div>

        <!-- === ÁµêÊûúÁîªÈù¢ === -->
        <div id="result-screen" class="result-screen">
            <h2 class="result-title">üéâ „Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ</h2>
            <p class="result-msg">„Åç„Çá„ÅÜ „Åä„Åº„Åà„Åü „Åã„Çì„Åò</p>
            <div class="result-count" id="result-new-count">0 „Åò</div>
            <div id="result-review-msg" style="font-size:14px; color:#888; margin-bottom:15px;"></div>

            <button class="result-btn result-point-btn" id="result-point-btn" onclick="getPoints()">
                üéÅ „Éù„Ç§„É≥„Éà„Çí„ÇÇ„Çâ„ÅÜ
            </button>
            <br>
            <button class="result-btn result-restart-btn" onclick="backToStart()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „ÇÑ„Çã</button>
            <br><br>
            <a href="index.html" class="home-btn" style="position:static;">„Éà„ÉÉ„Éó„Å∏„ÇÇ„Å©„Çã</a>
        </div>

        <!-- === Âõ≥ÈëëÁîªÈù¢ === -->
        <div id="zukan-screen" class="zukan-screen">
            <div class="zukan-header">
                <span class="zukan-title">üìï „Åã„Çì„Åò „Åö„Åã„Çì</span>
                <button class="zukan-back-btn" onclick="backToStart()">‚Üê „ÇÇ„Å©„Çã</button>
            </div>
            <div class="progress-info">
                <div class="progress-text">
                    <span class="progress-count" id="zukan-count">0</span>
                    <span> / <span id="zukan-total">80</span> „Åò „Åä„Åº„Åà„Åü„ÇàÔºÅ</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="zukan-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="zukan-grid" id="zukan-grid">
                <!-- JS„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>
        </div>

        <!-- Âõ≥Èëë„É¢„Éº„ÉÄ„É´ -->
        <div class="zukan-modal" id="zukan-modal" onclick="closeZukanModal(event)">
            <div class="zukan-modal-content" onclick="event.stopPropagation()">
                <div class="zukan-modal-kanji" id="modal-kanji">‰∏Ä</div>
                <div class="zukan-modal-reading" id="modal-reading">„ÅÑ„Å° / „Å≤„Å®(„Å§)</div>
                <div class="zukan-modal-meaning" id="modal-meaning">„Åã„Åö „ÅÆ 1</div>
                <div class="zukan-modal-example" id="modal-example">üìù ‰∏Ä„Å§ „Åè„Å†„Åï„ÅÑ</div>
                <button class="zukan-modal-close" onclick="closeZukanModal()">„Å®„Åò„Çã</button>
            </div>
        </div>
    </div>

    <!-- Êº¢Â≠ó„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø -->
    <script src="kanji/grade1.js"></script>
    <script src="kanji/grade2.js"></script>

    <script>
        (function () {
            // === Â≠¶Âπ¥„Éá„Éº„Çø„ÅÆÁôªÈå≤ ===
            // Êñ∞„Åó„ÅÑÂ≠¶Âπ¥„ÇíËøΩÂä†„Åô„Çã„Å´„ÅØ„ÄÅ„Åì„Åì„Å´ { id, label, data } „ÇíËøΩÂä†„Åó„ÄÅÂØæÂøú„Åô„ÇãJS„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ
            var GRADE_LIST = [
                { id: "grade1", label: "1<ruby>Âπ¥<rt>„Å≠„Çì</rt>Áîü<rt>„Åõ„ÅÑ</rt></ruby>", data: GRADE1_KANJI },
                { id: "grade2", label: "2<ruby>Âπ¥<rt>„Å≠„Çì</rt>Áîü<rt>„Åõ„ÅÑ</rt></ruby>", data: GRADE2_KANJI },
                // { id: "grade3", label: "3<ruby>Âπ¥<rt>„Å≠„Çì</rt>Áîü<rt>„Åõ„ÅÑ</rt></ruby>", data: GRADE3_KANJI },
            ];

            // === „Éá„Éº„ÇøÁÆ°ÁêÜ ===
            var KANJI_KEY_PREFIX = "papan_kanji_mastered_v1_";
            var currentUserName = null;

            function getKey() { return KANJI_KEY_PREFIX + currentUserName; }

            // ÁøíÂæóÊ∏à„ÅøÊº¢Â≠ó„ÇíË™≠„ÅøËæº„ÇÄ
            function loadMastered() {
                if (!currentUserName) return {};
                try {
                    return JSON.parse(localStorage.getItem(getKey())) || {};
                } catch (e) { return {}; }
            }

            // ÁøíÂæóÊ∏à„ÅøÊº¢Â≠ó„Çí‰øùÂ≠ò„Åô„Çã
            function saveMastered(data) {
                if (!currentUserName) return;
                localStorage.setItem(getKey(), JSON.stringify(data));
            }

            // ÊåáÂÆöÂ≠¶Âπ¥„ÅÆÁøíÂæóÊ∏à„Åø„É™„Çπ„Éà„ÇíÂèñÂæó
            function getMasteredList(gradeId) {
                const data = loadMastered();
                return data[gradeId] || [];
            }

            // Êº¢Â≠ó„ÇíÁøíÂæóÊ∏à„Åø„Å´ËøΩÂä†
            function addMastered(gradeId, kanji) {
                const data = loadMastered();
                if (!data[gradeId]) data[gradeId] = [];
                if (!data[gradeId].includes(kanji)) {
                    data[gradeId].push(kanji);
                }
                saveMastered(data);
            }

            // === Áä∂ÊÖãÂ§âÊï∞ ===
            let selectedGrade = null;   // ÈÅ∏Êäû‰∏≠„ÅÆÂ≠¶Âπ¥
            let currentKanjiData = [];  // ÁèæÂú®„ÅÆÂ≠¶Âπ¥„ÅÆÂÖ®Êº¢Â≠ó„Éá„Éº„Çø
            let studySet = [];          // ‰ªäÂõû„ÅÆÂ≠¶Áøí„Çª„ÉÉ„ÉàÔºà10Â≠óÔºâ
            let studyIndex = 0;         // ÁèæÂú®„ÅÆÂ≠¶Áøí‰ΩçÁΩÆ
            let newlyMastered = [];     // ‰ªäÂõûÊñ∞„Åó„ÅèË¶ö„Åà„ÅüÊº¢Â≠ó
            let reviewedAgain = [];     // „ÇÇ„ÅÜ„ÅÑ„Å°„Å© „Å´„Åó„ÅüÊº¢Â≠ó
            let isFlipped = false;      // „Ç´„Éº„Éâ„Åå„ÇÅ„Åè„Çå„Å¶„ÅÑ„Çã„Åã

            // HTML„ÅÆonclick„Åã„ÇâÂëº„Åπ„Çã„Çà„ÅÜ„Å´window„Å´ÂÖ¨Èñã
            window.startLearning = startLearning;
            window.showZukan = showZukan;
            window.backToStart = backToStart;
            window.flipCard = flipCard;
            window.nextCard = nextCard;
            window.getPoints = getPoints;
            window.closeZukanModal = closeZukanModal;
            window.selectUser = selectUser;

            // === „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû ===
            function initUserSelection() {
                var users = (typeof getUserNames === 'function') ? getUserNames() : [];
                var listEl = document.getElementById('user-list');
                listEl.innerHTML = '';

                users.forEach(function (name) {
                    var btn = document.createElement('button');
                    btn.className = 'user-btn';
                    btn.textContent = name;
                    btn.onclick = function () { selectUser(name); };
                    listEl.appendChild(btn);
                });
            }

            function selectUser(name) {
                currentUserName = name;
                document.getElementById('user-overlay').style.display = 'none';
                renderGradeButtons();
            }

            // === ÂàùÊúüÂåñ ===
            initUserSelection();

            // Â≠¶Âπ¥„Éú„Çø„É≥„ÇíÊèèÁîª
            function renderGradeButtons() {
                const container = document.getElementById('grade-btns');
                container.innerHTML = '';
                GRADE_LIST.forEach(g => {
                    const btn = document.createElement('button');
                    btn.className = 'grade-btn';
                    btn.innerHTML = g.label;
                    btn.onclick = () => selectGrade(g.id, btn);
                    container.appendChild(btn);
                });
            }

            // Â≠¶Âπ¥„ÇíÈÅ∏Êäû
            function selectGrade(gradeId, btn) {
                selectedGrade = gradeId;
                const gradeInfo = GRADE_LIST.find(g => g.id === gradeId);
                currentKanjiData = gradeInfo.data;

                // „Éú„Çø„É≥„ÅÆË¶ã„ÅüÁõÆ„ÇíÊõ¥Êñ∞
                document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');

                // ÈÄ≤Êçó„ÇíË°®Á§∫
                updateProgressDisplay();
                document.getElementById('progress-info').style.display = 'block';
                document.getElementById('mode-btns').style.display = 'flex';
            }

            // ÈÄ≤ÊçóË°®Á§∫„ÇíÊõ¥Êñ∞
            function updateProgressDisplay() {
                const mastered = getMasteredList(selectedGrade);
                const total = currentKanjiData.length;
                const count = mastered.length;
                const pct = total > 0 ? Math.round((count / total) * 100) : 0;

                document.getElementById('progress-count').textContent = count;
                document.getElementById('progress-total').textContent = total;
                document.getElementById('progress-fill').style.width = pct + '%';
            }

            // === Â≠¶Áøí„É¢„Éº„Éâ ===
            function startLearning() {
                const mastered = getMasteredList(selectedGrade);
                // Êú™ÁøíÂæó„ÅÆÊº¢Â≠ó„ÇíÂèñÂæó
                let unmastered = currentKanjiData.filter(k => !mastered.includes(k.kanji));

                if (unmastered.length === 0) {
                    // ÂÖ®„Å¶ÁøíÂæóÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„É©„É≥„ÉÄ„É†„Å´Âæ©Áøí
                    unmastered = shuffleArray([...currentKanjiData]);
                }

                // ÊúÄÂ§ß10Â≠ó„ÇíÂ≠¶Áøí„Çª„ÉÉ„Éà„Å´
                studySet = shuffleArray(unmastered).slice(0, 10);
                studyIndex = 0;
                newlyMastered = [];
                reviewedAgain = [];

                showScreen('learn-screen');
                document.getElementById('learn-total').textContent = studySet.length;
                showCard();
            }

            // „Ç´„Éº„Éâ„ÇíË°®Á§∫
            function showCard() {
                const k = studySet[studyIndex];
                isFlipped = false;

                // „Ç´„Éº„Éâ„ÇíË°®„Å´Êàª„Åô
                document.getElementById('flash-card').classList.remove('flipped');
                document.getElementById('learn-btns').style.display = 'none';

                // Ë°®Èù¢
                document.getElementById('card-kanji').textContent = k.kanji;
                document.getElementById('card-strokes').textContent = '„Åã„Åè„Åô„ÅÜ: ' + k.strokes;

                // Ë£èÈù¢
                document.getElementById('card-kanji-back').textContent = k.kanji;
                document.getElementById('card-reading').textContent = k.readings.join(' / ');
                document.getElementById('card-meaning').textContent = k.meaning;
                document.getElementById('card-example').textContent = 'üìù ' + k.example;
                document.getElementById('card-hint').textContent = 'üí° ' + k.hint;

                // ÈÄ≤ÊçóÊõ¥Êñ∞
                document.getElementById('learn-current').textContent = studyIndex + 1;
            }

            // „Ç´„Éº„Éâ„Çí„ÇÅ„Åè„Çã
            function flipCard() {
                if (isFlipped) return;
                isFlipped = true;
                document.getElementById('flash-card').classList.add('flipped');
                // „Éú„Çø„É≥„ÇíË°®Á§∫
                setTimeout(() => {
                    document.getElementById('learn-btns').style.display = 'flex';
                }, 400);
            }

            // Ê¨°„ÅÆ„Ç´„Éº„Éâ„Å∏
            function nextCard(memorized) {
                const k = studySet[studyIndex];

                if (memorized) {
                    // „Åä„Åº„Åà„Åü ‚Üí „ÇØ„Ç§„Ç∫„Å∏
                    showQuiz(k);
                } else {
                    // „ÇÇ„ÅÜ„ÅÑ„Å°„Å© ‚Üí „É™„Çπ„Éà„ÅÆÊúÄÂæå„Å´ËøΩÂä†„Åó„Å¶Ê¨°„Å∏
                    if (!reviewedAgain.includes(k.kanji)) reviewedAgain.push(k.kanji);
                    advanceStudy();
                }
            }

            // Â≠¶Áøí„ÇíÈÄ≤„ÇÅ„Çã
            function advanceStudy() {
                studyIndex++;
                if (studyIndex < studySet.length) {
                    showCard();
                } else {
                    // Â≠¶ÁøíÂÆå‰∫Ü ‚Üí ÁµêÊûúÁîªÈù¢
                    showResult();
                }
            }

            // === „Éü„Éã„ÇØ„Ç§„Ç∫ ===
            function showQuiz(kanjiObj) {
                showScreen('quiz-screen');
                document.getElementById('quiz-kanji').textContent = kanjiObj.kanji;
                document.getElementById('quiz-feedback').style.display = 'none';

                // Ê≠£Ëß£„ÅÆË™≠„ÅøÊñπÔºàÊúÄÂàù„ÅÆË™≠„ÅøÔºâ
                const correctReading = kanjiObj.readings[0];

                // „ÉÄ„Éü„Éº„Çí‰ΩúÊàêÔºà‰ªñ„ÅÆÊº¢Â≠ó„ÅÆË™≠„Åø„Åã„Çâ3„Å§Ôºâ
                let dummies = [];
                const otherKanji = currentKanjiData.filter(k => k.kanji !== kanjiObj.kanji);
                const shuffled = shuffleArray([...otherKanji]);
                for (let i = 0; i < shuffled.length && dummies.length < 3; i++) {
                    const r = shuffled[i].readings[0];
                    if (r !== correctReading && !dummies.includes(r)) {
                        dummies.push(r);
                    }
                }

                // ÈÅ∏ÊäûËÇ¢„Çí„Ç∑„É£„ÉÉ„Éï„É´
                const options = shuffleArray([correctReading, ...dummies]);

                const container = document.getElementById('quiz-options');
                container.innerHTML = '';
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'quiz-option-btn';
                    btn.textContent = opt;
                    btn.onclick = () => checkQuizAnswer(btn, opt, correctReading, kanjiObj);
                    container.appendChild(btn);
                });
            }

            // „ÇØ„Ç§„Ç∫„ÅÆÊ≠£Ë™§Âà§ÂÆö
            function checkQuizAnswer(btn, selected, correct, kanjiObj) {
                const allBtns = document.querySelectorAll('.quiz-option-btn');
                allBtns.forEach(b => b.disabled = true);

                const feedback = document.getElementById('quiz-feedback');

                if (selected === correct) {
                    // Ê≠£Ëß£ÔºÅ
                    btn.classList.add('correct');
                    feedback.textContent = 'üéâ „Åõ„ÅÑ„Åã„ÅÑÔºÅ';
                    feedback.style.display = 'block';
                    feedback.style.color = '#4CAF50';

                    // ÁøíÂæóÊ∏à„Åø„Å´ËøΩÂä†
                    addMastered(selectedGrade, kanjiObj.kanji);
                    if (!newlyMastered.includes(kanjiObj.kanji)) {
                        newlyMastered.push(kanjiObj.kanji);
                    }

                    // „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
                    createSparkles();

                    setTimeout(() => {
                        showScreen('learn-screen');
                        advanceStudy();
                    }, 1200);
                } else {
                    // ‰∏çÊ≠£Ëß£
                    btn.classList.add('wrong');
                    // Ê≠£Ëß£„ÇíË°®Á§∫
                    allBtns.forEach(b => {
                        if (b.textContent === correct) b.classList.add('correct');
                    });
                    feedback.textContent = 'üò¢ „Åñ„Çì„Å≠„Çì‚Ä¶ „Åü„Å†„Åó„Åè„ÅØ„Äå' + correct + '„Äç';
                    feedback.style.display = 'block';
                    feedback.style.color = '#ef5350';

                    setTimeout(() => {
                        showScreen('learn-screen');
                        advanceStudy();
                    }, 2000);
                }
            }

            // „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
            function createSparkles() {
                const emojis = ['‚ú®', '‚≠ê', 'üåü', 'üí´', 'üéâ'];
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        const spark = document.createElement('div');
                        spark.className = 'sparkle';
                        spark.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                        spark.style.left = (20 + Math.random() * 60) + 'vw';
                        spark.style.top = (20 + Math.random() * 40) + 'vh';
                        document.body.appendChild(spark);
                        setTimeout(() => spark.remove(), 800);
                    }, i * 100);
                }
            }

            // === ÁµêÊûúÁîªÈù¢ ===
            function showResult() {
                showScreen('result-screen');
                const newCount = newlyMastered.length;
                document.getElementById('result-new-count').textContent = newCount + ' „Åò';

                // „Éù„Ç§„É≥„Éà„Éú„Çø„É≥„ÅÆ„É™„Çª„ÉÉ„Éà
                const pointBtn = document.getElementById('result-point-btn');
                pointBtn.disabled = false;
                pointBtn.textContent = 'üéÅ „Éù„Ç§„É≥„Éà„Çí„ÇÇ„Çâ„ÅÜÔºà' + (newCount * 5) + 'ptÔºâ';
                if (newCount === 0) {
                    pointBtn.textContent = 'üéÅ „Éù„Ç§„É≥„Éà„Çí„ÇÇ„Çâ„ÅÜÔºàÂèÇÂä†Ë≥û 10ptÔºâ';
                }

                // Âæ©Áøí„É°„ÉÉ„Çª„Éº„Ç∏
                const reviewMsg = document.getElementById('result-review-msg');
                if (reviewedAgain.length > 0) {
                    reviewMsg.textContent = '„Äå„ÇÇ„ÅÜ„ÅÑ„Å°„Å©„Äç„Å´„Åó„Åü „Åã„Çì„Åò: ' + reviewedAgain.join('„ÄÅ');
                } else {
                    reviewMsg.textContent = '';
                }

                // ÈÄ≤ÊçóÊõ¥Êñ∞
                updateProgressDisplay();
            }

            // „Éù„Ç§„É≥„ÉàÁç≤Âæó
            function getPoints() {
                const btn = document.getElementById('result-point-btn');
                btn.disabled = true;
                btn.textContent = '„ÇÇ„Çâ„ÅÑ„Åæ„Åó„ÅüÔºÅ';
                btn.style.background = '#ccc';

                const newCount = newlyMastered.length;
                const points = newCount > 0 ? newCount * 5 : 10; // ÊúÄ‰Ωé10ptÔºàÂèÇÂä†Ë≥ûÔºâ
                if (typeof showPointGetDialog === 'function') {
                    showPointGetDialog(points, 'kanji_learn');
                } else {
                    alert(points + '„Éù„Ç§„É≥„Éà „Ç≤„ÉÉ„ÉàÔºÅ');
                }
            }

            // === Âõ≥ÈëëÁîªÈù¢ ===
            function showZukan() {
                showScreen('zukan-screen');
                const mastered = getMasteredList(selectedGrade);
                const total = currentKanjiData.length;
                const count = mastered.length;
                const pct = total > 0 ? Math.round((count / total) * 100) : 0;

                document.getElementById('zukan-count').textContent = count;
                document.getElementById('zukan-total').textContent = total;
                document.getElementById('zukan-fill').style.width = pct + '%';

                // „Ç∞„É™„ÉÉ„Éâ„ÇíÊèèÁîª
                const grid = document.getElementById('zukan-grid');
                grid.innerHTML = '';
                currentKanjiData.forEach(k => {
                    const cell = document.createElement('div');
                    const isMastered = mastered.includes(k.kanji);
                    cell.className = 'zukan-cell ' + (isMastered ? 'mastered' : 'locked');
                    cell.textContent = isMastered ? k.kanji : 'Ôºü';

                    if (isMastered) {
                        cell.onclick = () => showZukanDetail(k);
                    }
                    grid.appendChild(cell);
                });
            }

            // Âõ≥Èëë„ÅÆË©≥Á¥∞Ë°®Á§∫
            function showZukanDetail(k) {
                document.getElementById('modal-kanji').textContent = k.kanji;
                document.getElementById('modal-reading').textContent = k.readings.join(' / ');
                document.getElementById('modal-meaning').textContent = k.meaning;
                document.getElementById('modal-example').textContent = 'üìù ' + k.example;
                document.getElementById('zukan-modal').classList.add('show');
            }

            function closeZukanModal(event) {
                document.getElementById('zukan-modal').classList.remove('show');
            }

            // === ÁîªÈù¢Âàá„ÇäÊõø„Åà ===
            function showScreen(screenId) {
                const screens = ['start-screen', 'learn-screen', 'quiz-screen', 'result-screen', 'zukan-screen'];
                screens.forEach(id => {
                    document.getElementById(id).style.display = (id === screenId) ? (id === 'zukan-screen' ? 'block' : (id === 'start-screen' ? 'block' : '')) : 'none';
                    if (id === screenId && id !== 'zukan-screen' && id !== 'start-screen') {
                        document.getElementById(id).style.display = 'block';
                    }
                });
            }

            // „Çπ„Çø„Éº„ÉàÁîªÈù¢„Å´Êàª„Çã
            function backToStart() {
                showScreen('start-screen');
                if (selectedGrade) {
                    updateProgressDisplay();
                }
            }

            // === „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ===
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

        })(); // IIFEÁµÇ‰∫Ü
    </script>
</body>

</html>