<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ââ≤Âêà„Å®ÔºÖ„Éû„Çπ„Çø„Éº | „Å±„Å±„ÇìÂºè</title>
    <script src="ranking.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "UD Digital Kyokasho-tai-R", "UD Digital Kyokasho-tai", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #e8f5e9 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .container {
            width: 95%;
            max-width: 500px;
            margin: 0 auto;
            padding: 15px 10px 30px;
        }

        .home-btn {
            display: inline-block;
            text-decoration: none;
            color: #888;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 5px 12px;
            border-radius: 15px;
            transition: 0.3s;
            margin-bottom: 10px;
        }

        .home-btn:hover {
            background-color: #eee;
        }

        .title {
            text-align: center;
            font-size: 24px;
            color: #2e7d32;
            margin: 10px 0 5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        .subtitle {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin-bottom: 20px;
        }

        /* === „Éû„ÉÉ„Éó === */
        .map-screen {
            text-align: center;
        }

        .stage-path {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin: 20px 0;
        }

        .stage-node {
            width: 90%;
            max-width: 360px;
            background: white;
            border-radius: 20px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 3px solid #e0e0e0;
        }

        .stage-node.cleared {
            border-color: #66bb6a;
            background: linear-gradient(135deg, #f1f8e9, #e8f5e9);
        }

        .stage-node.current {
            border-color: #388e3c;
            box-shadow: 0 4px 16px rgba(56, 142, 60, 0.3);
            animation: pulse 2s infinite;
        }

        .stage-node.locked {
            opacity: 0.5;
            cursor: default;
        }

        .stage-node:active:not(.locked) {
            transform: scale(0.97);
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 4px 16px rgba(56, 142, 60, 0.3);
            }

            50% {
                box-shadow: 0 4px 24px rgba(56, 142, 60, 0.55);
            }
        }

        .stage-icon {
            font-size: 40px;
            min-width: 50px;
            text-align: center;
        }

        .stage-info {
            text-align: left;
            flex: 1;
        }

        .stage-num {
            font-size: 12px;
            color: #aaa;
            font-weight: bold;
        }

        .stage-name {
            font-size: 17px;
            font-weight: bold;
            color: #333;
            margin: 2px 0;
        }

        .stage-desc {
            font-size: 12px;
            color: #888;
        }

        .stage-stars {
            font-size: 18px;
            min-width: 60px;
            text-align: right;
        }

        .stage-lock {
            font-size: 24px;
            min-width: 60px;
            text-align: right;
            color: #ccc;
        }

        .path-connector {
            width: 4px;
            height: 20px;
            background: #e0e0e0;
            border-radius: 2px;
        }

        .path-connector.active {
            background: #66bb6a;
        }

        /* === „É¨„ÉÉ„Çπ„É≥ === */
        .lesson-screen {
            display: none;
            text-align: center;
        }

        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lesson-back-btn {
            background: none;
            border: 1px solid #ccc;
            color: #888;
            font-size: 13px;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
        }

        .lesson-stage-name {
            font-size: 16px;
            font-weight: bold;
            color: #2e7d32;
        }

        .lesson-slide {
            background: white;
            border-radius: 25px;
            padding: 25px 20px;
            margin: 10px auto;
            max-width: 400px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            min-height: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .lesson-visual {
            margin: 10px 0;
        }

        .lesson-visual svg {
            max-width: 340px;
            width: 100%;
            height: auto;
        }

        .lesson-text {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            margin: 15px 0;
        }

        .lesson-text .highlight {
            color: #2e7d32;
            font-weight: bold;
            font-size: 22px;
        }

        .lesson-text .big-formula {
            font-size: 24px;
            font-weight: bold;
            color: #2e7d32;
        }

        .lesson-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 15px 0 10px;
        }

        .lesson-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
        }

        .lesson-dot.active {
            background: #66bb6a;
        }

        .lesson-next-btn {
            background: #4CAF50;
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            padding: 14px 40px;
            border-radius: 30px;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 0 #388E3C;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .lesson-next-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #388E3C;
        }

        /* === Á∑¥ÁøíÂïèÈ°å === */
        .quiz-screen {
            display: none;
            text-align: center;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .quiz-progress-text {
            font-size: 14px;
            color: #888;
        }

        .quiz-card {
            background: white;
            border-radius: 25px;
            padding: 25px 20px;
            margin: 10px auto;
            max-width: 400px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .quiz-question-text {
            font-size: 18px;
            color: #555;
            margin-bottom: 15px;
        }

        .quiz-visual {
            margin: 10px 0 20px;
        }

        .quiz-visual svg {
            max-width: 320px;
            width: 100%;
            height: auto;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        .quiz-option {
            background: white;
            border: 3px solid #81c784;
            font-size: 19px;
            font-weight: bold;
            padding: 14px;
            border-radius: 18px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            color: #333;
            box-shadow: 0 3px 0 #66bb6a;
        }

        .quiz-option:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 #66bb6a;
        }

        .quiz-option.correct {
            background: #4CAF50;
            color: white;
            border-color: #388E3C;
        }

        .quiz-option.wrong {
            background: #ef5350;
            color: white;
            border-color: #c62828;
        }

        .quiz-option:disabled {
            cursor: default;
        }

        .quiz-feedback {
            font-size: 50px;
            margin: 10px 0;
            display: none;
        }

        /* === „ÇØ„É™„Ç¢ === */
        .clear-screen {
            display: none;
            text-align: center;
        }

        .clear-title {
            font-size: 28px;
            color: #388e3c;
            margin: 20px 0 10px;
        }

        .clear-stars {
            font-size: 50px;
            margin: 15px 0;
        }

        .clear-msg {
            font-size: 16px;
            color: #666;
            margin-bottom: 15px;
        }

        .clear-score {
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
        }

        .clear-btn {
            font-size: 18px;
            font-weight: bold;
            padding: 14px 32px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            margin: 8px;
            transition: all 0.2s;
        }

        .clear-point-btn {
            background: #ff9800;
            color: white;
            box-shadow: 0 4px 0 #e65100;
        }

        .clear-point-btn:disabled {
            background: #ccc;
            box-shadow: 0 4px 0 #999;
        }

        .clear-point-btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #e65100;
        }

        .clear-next-btn {
            background: #4CAF50;
            color: white;
            box-shadow: 0 4px 0 #388E3C;
        }

        .clear-next-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #388E3C;
        }

        .clear-map-btn {
            background: #2196F3;
            color: white;
            box-shadow: 0 4px 0 #1565C0;
        }

        .clear-map-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1565C0;
        }

        @keyframes starBounce {
            0% {
                transform: scale(0);
            }

            60% {
                transform: scale(1.3);
            }

            100% {
                transform: scale(1);
            }
        }

        .star-anim {
            display: inline-block;
            animation: starBounce 0.5s ease forwards;
        }

        .sparkle {
            position: fixed;
            font-size: 30px;
            pointer-events: none;
            z-index: 200;
            animation: sparkleAnim 0.8s ease forwards;
        }

        @keyframes sparkleAnim {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }

            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }

            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }

        /* === „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Ç™„Éº„Éê„Éº„É¨„Ç§ === */
        #user-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1b5e20, #2e7d32, #66bb6a);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .user-select-box {
            background: white;
            padding: 30px 25px;
            border-radius: 25px;
            max-width: 90%;
            width: 360px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .user-select-box h2 {
            color: #2e7d32;
            font-size: 24px;
            margin: 0 0 5px;
        }

        .user-select-box p {
            color: #888;
            font-size: 14px;
            margin: 0 0 20px;
        }

        .user-btn {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #2e7d32, #66bb6a);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 0 #1b5e20;
            transition: all 0.2s;
        }

        .user-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1b5e20;
        }

        .no-user-msg {
            color: #aaa;
            font-size: 14px;
            padding: 10px;
            line-height: 1.7;
        }

        @media (max-width: 400px) {
            .lesson-slide {
                padding: 20px 15px;
                min-height: 280px;
            }

            .lesson-text {
                font-size: 16px;
            }

            .stage-name {
                font-size: 15px;
            }

            .quiz-option {
                font-size: 16px;
                padding: 12px;
            }
        }
    </style>
</head>

<body>

    <div id="user-overlay">
        <div class="user-select-box">
            <h2>üìä Ââ≤Âêà„Å®ÔºÖ„Éû„Çπ„Çø„Éº</h2>
            <p>„Å†„Çå„Åå „Åæ„Å™„Å∂Ôºü</p>
            <div id="user-list"></div>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="home-btn">‚Üê „ÇÇ„Å©„Çã</a>
        <h1 class="title">üìä Ââ≤Âêà„Å®ÔºÖ„Éû„Çπ„Çø„Éº</h1>
        <p class="subtitle">„Çπ„ÉÜ„Éº„Ç∏„Çí„ÇØ„É™„Ç¢„Åó„Å¶Ââ≤Âêà„Çí„Éû„Çπ„Çø„Éº„Åó„Çà„ÅÜÔºÅ</p>

        <div id="map-screen" class="map-screen">
            <div class="stage-path" id="stage-path"></div>
        </div>

        <div id="lesson-screen" class="lesson-screen">
            <div class="lesson-header">
                <button class="lesson-back-btn" onclick="backToMap()">‚Üê „ÇÇ„Å©„Çã</button>
                <span class="lesson-stage-name" id="lesson-stage-name"></span>
                <span></span>
            </div>
            <div class="lesson-slide" id="lesson-slide"></div>
            <div class="lesson-dots" id="lesson-dots"></div>
            <button class="lesson-next-btn" id="lesson-next-btn" onclick="nextSlide()">„Å§„Åé„Å∏ ‚Üí</button>
        </div>

        <div id="quiz-screen" class="quiz-screen">
            <div class="quiz-header">
                <button class="lesson-back-btn" onclick="backToMap()">‚Üê „ÇÇ„Å©„Çã</button>
                <span class="quiz-progress-text" id="quiz-progress-text">„ÇÇ„Çì„Å†„ÅÑ 1/3</span>
            </div>
            <div class="quiz-card">
                <p class="quiz-question-text" id="quiz-question-text"></p>
                <div class="quiz-visual" id="quiz-visual"></div>
                <div class="quiz-options" id="quiz-options"></div>
            </div>
            <div class="quiz-feedback" id="quiz-feedback"></div>
        </div>

        <div id="clear-screen" class="clear-screen">
            <h2 class="clear-title">üéâ „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ</h2>
            <div class="clear-stars" id="clear-stars"></div>
            <p class="clear-msg" id="clear-msg"></p>
            <p class="clear-score" id="clear-score"></p>
            <button class="clear-btn clear-point-btn" id="clear-point-btn" onclick="getPoints()">
                üéÅ „Éù„Ç§„É≥„Éà„Çí„ÇÇ„Çâ„ÅÜ
            </button>
            <br>
            <button class="clear-btn clear-next-btn" id="clear-next-btn" onclick="goNextStage()" style="display:none;">
                „Å§„Åé„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏ ‚Üí
            </button>
            <button class="clear-btn clear-map-btn" onclick="backToMap()">„Éû„ÉÉ„Éó„Å´„ÇÇ„Å©„Çã</button>
        </div>
    </div>

    <script>
        (function () {

            // ===================================================
            //  SVG„Éò„É´„Éë„Éº
            // ===================================================

            /** Â∏Ø„Ç∞„É©„ÉïSVGÔºöÂÖ®‰Ωì„Çín„ÅßÂàÜÂâ≤„Åó„ÄÅm„Éû„ÇπÂàÜ„ÇíËâ≤Â°ó„Çä */
            function barSVG(total, filled, color) {
                color = color || '#66bb6a';
                var W = 240, H = 40;
                var cellW = W / total;
                var s = '<svg viewBox="0 0 ' + W + ' ' + H + '" xmlns="http://www.w3.org/2000/svg">';
                for (var i = 0; i < total; i++) {
                    var x = i * cellW;
                    s += '<rect x="' + x + '" y="0" width="' + (cellW - 2) + '" height="' + H + '" rx="3" fill="' + (i < filled ? color : '#e0e0e0') + '"/>';
                }
                s += '</svg>';
                return s;
            }

            /** 100„Éû„Çπ„Ç∞„É™„ÉÉ„ÉâSVGÔºöfilled„Éû„ÇπÂàÜ„ÇíËâ≤Â°ó„Çä */
            function gridSVG(filled, color) {
                color = color || '#66bb6a';
                var cols = 10, rows = 10, cell = 22, gap = 2;
                var W = cols * (cell + gap), H = rows * (cell + gap);
                var s = '<svg viewBox="0 0 ' + W + ' ' + H + '" xmlns="http://www.w3.org/2000/svg">';
                for (var i = 0; i < 100; i++) {
                    var col = i % cols, row = Math.floor(i / cols);
                    var x = col * (cell + gap), y = row * (cell + gap);
                    s += '<rect x="' + x + '" y="' + y + '" width="' + cell + '" height="' + cell + '" rx="2" fill="' + (i < filled ? color : '#e8f5e9') + '"/>';
                }
                s += '</svg>';
                return s;
            }

            /** Ââ≤Âêà„ÅÆÈñ¢‰øÇÂºèSVG */
            function formulaSVG(text, color) {
                color = color || '#2e7d32';
                var s = '<svg viewBox="0 0 340 56" xmlns="http://www.w3.org/2000/svg">';
                s += '<rect x="0" y="0" width="340" height="56" rx="12" fill="#f1f8e9"/>';
                s += '<text x="170" y="36" text-anchor="middle" font-size="19" font-weight="bold" fill="' + color + '">' + text + '</text>';
                s += '</svg>';
                return s;
            }

            /** ÊØîËºÉ„Éê„ÉºSVGÔºà2ÊÆµÔºâ */
            function compareSVG(label1, fill1, label2, fill2, total) {
                var W = 240, cellW = (W - 60) / total;
                var s = '<svg viewBox="0 0 ' + W + ' 80" xmlns="http://www.w3.org/2000/svg">';
                // ‰∏äÊÆµ
                s += '<text x="0" y="18" font-size="13" fill="#555">' + label1 + '</text>';
                for (var i = 0; i < total; i++) {
                    var x = 60 + i * cellW;
                    s += '<rect x="' + x + '" y="4" width="' + (cellW - 2) + '" height="20" rx="2" fill="' + (i < fill1 ? '#66bb6a' : '#e0e0e0') + '"/>';
                }
                // ‰∏ãÊÆµ
                s += '<text x="0" y="58" font-size="13" fill="#555">' + label2 + '</text>';
                for (var j = 0; j < total; j++) {
                    var x2 = 60 + j * cellW;
                    s += '<rect x="' + x2 + '" y="44" width="' + (cellW - 2) + '" height="20" rx="2" fill="' + (j < fill2 ? '#1976d2' : '#e0e0e0') + '"/>';
                }
                s += '</svg>';
                return s;
            }

            // ===================================================
            //  „Çπ„ÉÜ„Éº„Ç∏„Éá„Éº„Çø
            // ===================================================
            var STAGES = [
                {
                    id: 1,
                    name: '„Çè„Çä„ÅÇ„ÅÑ„Å£„Å¶„Å™„Å´Ôºü',
                    desc: '„Åú„Çì„Åü„ÅÑ„ÅÆ„ÅÜ„Å°„ÅÆ„Å©„ÅÆ„Åè„Çâ„ÅÑÔºü',
                    icon: 'üç∞',
                    lessons: [
                        {
                            text: '<span class="highlight">Ââ≤ÂêàÔºà„Çè„Çä„ÅÇ„ÅÑÔºâ</span> „ÅØ<br>„Äå„Åú„Çì„Åü„ÅÑ„ÅÆ„ÅÜ„Å°„ÄÅ„Å©„ÅÆ„Åè„Çâ„ÅÑ„Åã„Äç<br>„Çí„ÅÇ„Çâ„Çè„ÅôÊï∞„Å†„ÇàÔºÅ',
                            svg: null
                        },
                        {
                            text: '10„Åì„ÅÆ„ÅÜ„Å° 3„Åì„Åå „É™„É≥„Ç¥„Å†„Çà„ÄÇ\n„É™„É≥„Ç¥„ÅÆÂâ≤Âêà„ÅØÔºü',
                            svg: function () { return barSVG(10, 3, '#ef5350'); }
                        },
                        {
                            text: '<span class="big-formula">3 √∑ 10 = 0.3</span><br>„É™„É≥„Ç¥„ÅØ „Åú„Çì„Åü„ÅÑ„ÅÆ <span class="highlight">0.3</span> „Å†„Å≠ÔºÅ',
                            svg: function () { return formulaSVG('Ââ≤Âêà Ôºù ÊØî„Åπ„ÇãÈáè √∑ „ÇÇ„Å®„Å´„Åô„ÇãÈáè'); }
                        },
                        {
                            text: '0.3„ÅØ„Äå1„Çí„ÇÇ„Å®„Å´„Åó„Åü„Å®„Åç 0.3„Å∂„Çì„Äç<br>„Å®„ÅÑ„ÅÜÊÑèÂë≥„Å†„ÇàÔºÅ<br>1„Çà„ÇäÂ∞è„Åï„ÅÑ„ÅÆ„Åå ÊôÆÈÄö„Å†„Çà„ÄÇ',
                            svg: function () { return barSVG(10, 3, '#ef5350'); }
                        }
                    ],
                    quizzes: [
                        {
                            q: '5„Åì„ÅÆ„ÅÜ„Å° 1„Åì„ÅåÂΩì„Åü„Çä„ÄÇÂâ≤Âêà„ÅØÔºü',
                            svg: function () { return barSVG(5, 1, '#ff9800'); },
                            options: ['0.1', '0.2', '0.5', '1'],
                            answer: 1
                        },
                        {
                            q: '4„Åì„ÅÆ„ÅÜ„Å° 2„ÅìÈ£ü„Åπ„Åü„ÄÇÂâ≤Âêà„ÅØÔºü',
                            svg: function () { return barSVG(4, 2, '#66bb6a'); },
                            options: ['0.2', '0.4', '0.5', '2'],
                            answer: 2
                        },
                        {
                            q: '10‰∫∫„ÅÆ„ÅÜ„Å° 7‰∫∫„ÅåÂêàÊ†º„ÄÇÂâ≤Âêà„ÅØÔºü',
                            svg: function () { return barSVG(10, 7, '#1976d2'); },
                            options: ['0.3', '0.5', '0.7', '7'],
                            answer: 2
                        }
                    ]
                },
                {
                    id: 2,
                    name: 'ÔºÖ„Å£„Å¶„Å™„Å´Ôºü',
                    desc: 'Ââ≤Âêà„ÇíÔºÖ„Åß„ÅÇ„Çâ„Çè„Åù„ÅÜÔºÅ',
                    icon: 'üíØ',
                    lessons: [
                        {
                            text: 'Ââ≤Âêà„ÅØ <span class="highlight">ÔºÖÔºà„Éë„Éº„Çª„É≥„ÉàÔºâ</span><br>„Åß„ÇÇ„ÅÇ„Çâ„Çè„Åõ„Çã„ÇàÔºÅ',
                            svg: null
                        },
                        {
                            text: '<span class="highlight">1ÔºÖ</span> „ÅØ „Åú„Çì„Åü„ÅÑ„Çí 100„Å´ „Çè„Åë„Åü „ÅÜ„Å°„ÅÆ 1„Å§<br>„Å§„Åæ„Çä <span class="big-formula">1ÔºÖ Ôºù 0.01</span>',
                            svg: function () { return gridSVG(1); }
                        },
                        {
                            text: '<span class="big-formula">30ÔºÖ Ôºù 0.3</span><br>100„Éû„Çπ„ÅÆ„ÅÜ„Å° 30„Éû„ÇπÂàÜ„Å†„Å≠ÔºÅ',
                            svg: function () { return gridSVG(30); }
                        },
                        {
                            text: 'Â§âÊèõ„ÅÆ„Åç„Åª„ÇìÔºö<br><span class="big-formula">Ââ≤Âêà √ó 100 Ôºù ÔºÖ</span><br>‰æãÔºâ0.3 √ó 100 Ôºù <span class="highlight">30ÔºÖ</span>',
                            svg: function () { return formulaSVG('Ââ≤Âêà √ó 100 Ôºù ÔºÖ'); }
                        },
                        {
                            text: '„Åé„ÇÉ„Åè„ÇÇÂ§ß‰∫ãÔºÅ<br><span class="big-formula">ÔºÖ √∑ 100 Ôºù Ââ≤Âêà</span><br>‰æãÔºâ50ÔºÖ √∑ 100 Ôºù <span class="highlight">0.5</span>',
                            svg: function () { return formulaSVG('ÔºÖ √∑ 100 Ôºù Ââ≤Âêà'); }
                        }
                    ],
                    quizzes: [
                        {
                            q: '0.25„ÇíÔºÖ„Åß„ÅÇ„Çâ„Çè„Åô„Å®Ôºü',
                            svg: function () { return gridSVG(25); },
                            options: ['2.5ÔºÖ', '25ÔºÖ', '0.25ÔºÖ', '250ÔºÖ'],
                            answer: 1
                        },
                        {
                            q: '75ÔºÖ„ÇíÂâ≤ÂêàÔºàÂ∞èÊï∞Ôºâ„ÅßÔºü',
                            svg: function () { return gridSVG(75); },
                            options: ['7.5', '750', '0.75', '0.075'],
                            answer: 2
                        },
                        {
                            q: '100„Éû„Çπ„ÅÆ„ÅÜ„Å° 40„Éû„Çπ„ÅØ ‰ΩïÔºÖÔºü',
                            svg: function () { return gridSVG(40); },
                            options: ['4ÔºÖ', '14ÔºÖ', '40ÔºÖ', '400ÔºÖ'],
                            answer: 2
                        }
                    ]
                },
                {
                    id: 3,
                    name: 'Ââ≤Âêà„ÅÆË®àÁÆó',
                    desc: '3„Å§„ÅÆÈñ¢‰øÇ„Çí„Éû„Çπ„Çø„Éº„Åó„Çà„ÅÜÔºÅ',
                    icon: 'üßÆ',
                    lessons: [
                        {
                            text: 'Ââ≤Âêà„Å´„ÅØ 3„Å§„ÅÆÂ§ß‰∫ã„Å™ Èñ¢‰øÇ„Åå„ÅÇ„Çã„ÇàÔºÅ',
                            svg: function () { return formulaSVG('„ÇÇ„Å®„Å´„Åô„ÇãÈáè √ó Ââ≤Âêà Ôºù ÊØî„Åπ„ÇãÈáè'); }
                        },
                        {
                            text: '‰æãÔºâ 200ÂÜÜ„ÅÆ <span class="highlight">30ÔºÖ</span> „ÅØ „ÅÑ„Åè„ÇâÔºü<br><span class="big-formula">200 √ó 0.3 Ôºù 60ÂÜÜ</span>',
                            svg: function () { return barSVG(10, 3, '#ff9800'); }
                        },
                        {
                            text: '„Äå„ÇÇ„Å®„Å´„Åô„ÇãÈáè„Äç„Åå „Çè„Åã„Çâ„Å™„ÅÑ„Å®„ÅçÔºö<br><span class="big-formula">ÊØî„Åπ„ÇãÈáè √∑ Ââ≤Âêà Ôºù „ÇÇ„Å®„Å´„Åô„ÇãÈáè</span>',
                            svg: function () { return formulaSVG('ÊØî„Åπ„ÇãÈáè √∑ Ââ≤Âêà Ôºù „ÇÇ„Å®„Å´„Åô„ÇãÈáè'); }
                        },
                        {
                            text: '‰æãÔºâ 60ÂÜÜ„Åå ÂÖ®‰Ωì„ÅÆ 30ÔºÖ „Å™„Çâ ÂÖ®‰Ωì„ÅØÔºü<br><span class="big-formula">60 √∑ 0.3 Ôºù 200ÂÜÜ</span>',
                            svg: function () { return barSVG(10, 3, '#ff9800'); }
                        }
                    ],
                    quizzes: [
                        {
                            q: '500ÂÜÜ„ÅÆ 20ÔºÖ „ÅØ„ÅÑ„Åè„ÇâÔºü',
                            svg: function () { return barSVG(10, 2, '#1976d2'); },
                            options: ['10ÂÜÜ', '50ÂÜÜ', '100ÂÜÜ', '200ÂÜÜ'],
                            answer: 2
                        },
                        {
                            q: '80‰∫∫„ÅÆ 25ÔºÖ „ÅØ‰Ωï‰∫∫Ôºü',
                            svg: function () { return barSVG(4, 1, '#66bb6a'); },
                            options: ['10‰∫∫', '20‰∫∫', '25‰∫∫', '40‰∫∫'],
                            answer: 1
                        },
                        {
                            q: '30ÂÜÜ„Åå ÂÖ®‰Ωì„ÅÆ 10ÔºÖ„ÄÇÂÖ®‰Ωì„ÅØ„ÅÑ„Åè„ÇâÔºü',
                            svg: function () { return barSVG(10, 1, '#ef5350'); },
                            options: ['3ÂÜÜ', '30ÂÜÜ', '100ÂÜÜ', '300ÂÜÜ'],
                            answer: 3
                        }
                    ]
                },
                {
                    id: 4,
                    name: 'Ââ≤Âºï„Å®Ââ≤Â¢ó',
                    desc: 'Ë≤∑„ÅÑÁâ©„Åß„Çà„Åè‰Ωø„ÅÜÔºÖ„ÇíÂ≠¶„Åº„ÅÜÔºÅ',
                    icon: 'üõí',
                    lessons: [
                        {
                            text: '„ÅäÂ∫ó„ÅÆ <span class="highlight">20ÔºÖ„Ç™„Éï</span> „Å£„Å¶ „Å©„ÅÜ„ÅÑ„ÅÜÊÑèÂë≥Ôºü',
                            svg: null
                        },
                        {
                            text: '20ÔºÖ„Ç™„Éï Ôºù ÂÖÉ„ÅÆÂÄ§ÊÆµ„ÅÆ <span class="highlight">80ÔºÖ</span> „Å†„ÇàÔºÅ<br>Ôºà100ÔºÖ ‚àí 20ÔºÖ Ôºù 80ÔºÖÔºâ',
                            svg: function () { return compareSVG('ÂÖÉ„ÅÆÂÄ§ÊÆµ', 10, '20%„Ç™„Éï', 8, 10); }
                        },
                        {
                            text: '‰æãÔºâ 1000ÂÜÜ„ÅÆ 20ÔºÖ„Ç™„Éï„ÅØÔºü<br><span class="big-formula">1000 √ó 0.8 Ôºù 800ÂÜÜ</span>',
                            svg: function () { return formulaSVG('1000 √ó 0.8 Ôºù 800ÂÜÜ', '#1976d2'); }
                        },
                        {
                            text: 'Ê∂àË≤ªÁ®é 10ÔºÖ „ÅØ <span class="highlight">1.1„Çí„Åã„Åë„Çã</span>ÔºÅ<br>‰æãÔºâ 500ÂÜÜ √ó 1.1 Ôºù <span class="big-formula">550ÂÜÜ</span>',
                            svg: function () { return formulaSVG('ÂÄ§ÊÆµ √ó 1.1 Ôºù Á®éËæº„Åø‰æ°Ê†º', '#e65100'); }
                        },
                        {
                            text: '„Åæ„Å®„ÇÅ üìù<br>‚ë† Ââ≤Âêà Ôºù ÊØî„Åπ„ÇãÈáè √∑ „ÇÇ„Å®„Å´„Åô„ÇãÈáè<br>‚ë° 1ÔºÖ Ôºù 0.01<br>‚ë¢ ‚óãÔºÖ„Ç™„Éï ‚Üí (100‚àí‚óã)ÔºÖ„Çí„Åã„Åë„Çã<br>‚ë£ ‚óãÔºÖÂ¢ó„Åó ‚Üí (100Ôºã‚óã)ÔºÖ„Çí„Åã„Åë„Çã',
                            svg: null
                        }
                    ],
                    quizzes: [
                        {
                            q: '800ÂÜÜ„ÅÆ 25ÔºÖ„Ç™„Éï„ÅÆ ÂÄ§ÊÆµ„ÅØÔºü',
                            svg: function () { return compareSVG('800ÂÜÜ', 4, '25%„Ç™„Éï', 3, 4); },
                            options: ['200ÂÜÜ', '400ÂÜÜ', '600ÂÜÜ', '700ÂÜÜ'],
                            answer: 2
                        },
                        {
                            q: '400ÂÜÜ„ÅÆ Ê∂àË≤ªÁ®é10ÔºÖ Ëæº„Åø„ÅÆ ÂÄ§ÊÆµ„ÅØÔºü',
                            svg: function () { return formulaSVG('400 √ó 1.1 Ôºù Ôºü', '#e65100'); },
                            options: ['410ÂÜÜ', '440ÂÜÜ', '450ÂÜÜ', '480ÂÜÜ'],
                            answer: 1
                        },
                        {
                            q: 'ÂÆö‰æ°600ÂÜÜ„ÅÆ30ÔºÖ„Ç™„Éï„ÄÇ„ÅÑ„Åè„Çâ„ÅßË≤∑„Åà„ÇãÔºü',
                            svg: function () { return compareSVG('600ÂÜÜ', 10, '30%„Ç™„Éï', 7, 10); },
                            options: ['180ÂÜÜ', '300ÂÜÜ', '420ÂÜÜ', '570ÂÜÜ'],
                            answer: 2
                        }
                    ]
                }
            ];

            // ===================================================
            //  „Éá„Éº„ÇøÁÆ°ÁêÜÔºàranking.js / bunsu_learn „Å®Âêå„Éë„Çø„Éº„É≥Ôºâ
            // ===================================================
            var WARIAI_KEY_PREFIX = 'papan_wariai_progress_v1_';
            var currentUserName = null;

            function getKey() { return WARIAI_KEY_PREFIX + currentUserName; }

            function loadProgress() {
                if (!currentUserName) return { clearedStages: [], stars: {} };
                try { return JSON.parse(localStorage.getItem(getKey())) || { clearedStages: [], stars: {} }; }
                catch (e) { return { clearedStages: [], stars: {} }; }
            }

            function saveProgress(data) {
                if (!currentUserName) return;
                localStorage.setItem(getKey(), JSON.stringify(data));
            }

            function isCleared(stageId) { return loadProgress().clearedStages.indexOf(stageId) !== -1; }
            function isUnlocked(stageId) { return stageId === 1 || isCleared(stageId - 1); }
            function getStars(stageId) { return loadProgress().stars[stageId] || 0; }

            // ===================================================
            //  Áä∂ÊÖãÂ§âÊï∞
            // ===================================================
            var currentStage = null;
            var slideIndex = 0;
            var quizIndex = 0;
            var correctCount = 0;
            var totalQuizzes = 3;
            var pointsGiven = false;

            // ===================================================
            //  ÁîªÈù¢Âà∂Âæ°
            // ===================================================
            function showScreen(screenId) {
                ['map-screen', 'lesson-screen', 'quiz-screen', 'clear-screen'].forEach(function (id) {
                    document.getElementById(id).style.display = (id === screenId) ? 'block' : 'none';
                });
            }

            // ===================================================
            //  „Éû„ÉÉ„Éó
            // ===================================================
            function renderMap() {
                showScreen('map-screen');
                var container = document.getElementById('stage-path');
                container.innerHTML = '';

                STAGES.forEach(function (stage, idx) {
                    if (idx > 0) {
                        var conn = document.createElement('div');
                        conn.className = 'path-connector' + (isCleared(stage.id - 1) ? ' active' : '');
                        container.appendChild(conn);
                    }

                    var node = document.createElement('div');
                    node.className = 'stage-node';
                    var cleared = isCleared(stage.id);
                    var unlocked = isUnlocked(stage.id);

                    if (cleared) node.classList.add('cleared');
                    else if (unlocked) node.classList.add('current');
                    else node.classList.add('locked');

                    var starsHtml = '';
                    if (cleared) {
                        var s = getStars(stage.id);
                        starsHtml = '<div class="stage-stars">';
                        for (var i = 0; i < 3; i++) starsHtml += (i < s ? '‚≠ê' : '‚òÜ');
                        starsHtml += '</div>';
                    } else if (!unlocked) {
                        starsHtml = '<div class="stage-lock">üîí</div>';
                    }

                    node.innerHTML =
                        '<div class="stage-icon">' + stage.icon + '</div>' +
                        '<div class="stage-info">' +
                        '<div class="stage-num">„Çπ„ÉÜ„Éº„Ç∏ ' + stage.id + '</div>' +
                        '<div class="stage-name">' + stage.name + '</div>' +
                        '<div class="stage-desc">' + stage.desc + '</div>' +
                        '</div>' + starsHtml;

                    if (unlocked) {
                        (function (s) { node.onclick = function () { startStage(s); }; })(stage);
                    }
                    container.appendChild(node);
                });
            }

            // ===================================================
            //  „Çπ„ÉÜ„Éº„Ç∏ÈñãÂßã
            // ===================================================
            function startStage(stage) {
                currentStage = stage;
                slideIndex = 0;
                quizIndex = 0;
                correctCount = 0;
                pointsGiven = false;
                showLesson();
            }

            // ===================================================
            //  „É¨„ÉÉ„Çπ„É≥
            // ===================================================
            function showLesson() {
                showScreen('lesson-screen');
                document.getElementById('lesson-stage-name').textContent = currentStage.name;
                renderSlide();
                renderDots();
            }

            function renderSlide() {
                var slide = currentStage.lessons[slideIndex];
                var html = '';
                if (slide.svg) html += '<div class="lesson-visual">' + slide.svg() + '</div>';
                html += '<div class="lesson-text">' + slide.text + '</div>';
                document.getElementById('lesson-slide').innerHTML = html;

                document.getElementById('lesson-next-btn').textContent =
                    (slideIndex === currentStage.lessons.length - 1) ? '„Çå„Çì„Åó„ÇÖ„ÅÜ„ÇÇ„Çì„Å†„ÅÑ„Å∏ ‚Üí' : '„Å§„Åé„Å∏ ‚Üí';
            }

            function renderDots() {
                var dotsEl = document.getElementById('lesson-dots');
                dotsEl.innerHTML = '';
                for (var i = 0; i < currentStage.lessons.length; i++) {
                    var dot = document.createElement('div');
                    dot.className = 'lesson-dot' + (i <= slideIndex ? ' active' : '');
                    dotsEl.appendChild(dot);
                }
            }

            function nextSlide() {
                if (slideIndex < currentStage.lessons.length - 1) {
                    slideIndex++;
                    renderSlide();
                    renderDots();
                } else {
                    startQuiz();
                }
            }

            // ===================================================
            //  Á∑¥ÁøíÂïèÈ°å
            // ===================================================
            function startQuiz() {
                quizIndex = 0;
                correctCount = 0;
                showScreen('quiz-screen');
                renderQuiz();
            }

            function renderQuiz() {
                var quiz = currentStage.quizzes[quizIndex];
                document.getElementById('quiz-progress-text').textContent = '„ÇÇ„Çì„Å†„ÅÑ ' + (quizIndex + 1) + '/' + totalQuizzes;
                document.getElementById('quiz-question-text').textContent = quiz.q;
                document.getElementById('quiz-visual').innerHTML = quiz.svg ? quiz.svg() : '';

                var optionsEl = document.getElementById('quiz-options');
                optionsEl.innerHTML = '';
                quiz.options.forEach(function (opt, idx) {
                    var btn = document.createElement('button');
                    btn.className = 'quiz-option';
                    btn.textContent = opt;
                    btn.onclick = function () { answerQuiz(idx); };
                    optionsEl.appendChild(btn);
                });

                document.getElementById('quiz-feedback').style.display = 'none';
            }

            function answerQuiz(selected) {
                var quiz = currentStage.quizzes[quizIndex];
                var buttons = document.querySelectorAll('.quiz-option');
                var feedback = document.getElementById('quiz-feedback');

                buttons.forEach(function (btn) { btn.disabled = true; });

                if (selected === quiz.answer) {
                    correctCount++;
                    buttons[selected].classList.add('correct');
                    feedback.textContent = '‚≠ï „Åõ„ÅÑ„Åã„ÅÑÔºÅ';
                    feedback.style.display = 'block';
                    createSparkles();
                } else {
                    buttons[selected].classList.add('wrong');
                    buttons[quiz.answer].classList.add('correct');
                    feedback.textContent = '‚ùå „Åñ„Çì„Å≠„Çì‚Ä¶';
                    feedback.style.display = 'block';
                }

                setTimeout(function () {
                    quizIndex++;
                    if (quizIndex < totalQuizzes) renderQuiz();
                    else showClearScreen();
                }, 1200);
            }

            // ===================================================
            //  „ÇØ„É™„Ç¢ÁîªÈù¢
            // ===================================================
            function showClearScreen() {
                showScreen('clear-screen');

                var stars = correctCount >= 3 ? 3 : correctCount >= 2 ? 2 : 1;

                var progress = loadProgress();
                if (progress.clearedStages.indexOf(currentStage.id) === -1) progress.clearedStages.push(currentStage.id);
                var prevStars = progress.stars[currentStage.id] || 0;
                if (stars > prevStars) progress.stars[currentStage.id] = stars;
                saveProgress(progress);

                var starsEl = document.getElementById('clear-stars');
                starsEl.innerHTML = '';
                for (var i = 0; i < 3; i++) {
                    var span = document.createElement('span');
                    span.className = 'star-anim';
                    span.textContent = i < stars ? '‚≠ê' : '‚òÜ';
                    span.style.animationDelay = (i * 0.2) + 's';
                    starsEl.appendChild(span);
                }

                document.getElementById('clear-msg').textContent = ['„Åå„Çì„Å∞„Å£„Åü„Å≠ÔºÅ', '„Åô„Åî„ÅÑÔºÅ', '„Åã„Çì„Å∫„ÅçÔºÅÔºÅ'][stars - 1];
                document.getElementById('clear-score').textContent = correctCount + '/' + totalQuizzes + ' „ÇÇ„Çì „Åõ„ÅÑ„Åã„ÅÑ';

                pointsGiven = false;
                var pointBtn = document.getElementById('clear-point-btn');
                pointBtn.disabled = false;
                pointBtn.textContent = 'üéÅ „Éù„Ç§„É≥„Éà„Çí„ÇÇ„Çâ„ÅÜ';

                var nextStage = STAGES.find(function (s) { return s.id === currentStage.id + 1; });
                document.getElementById('clear-next-btn').style.display = nextStage ? 'inline-block' : 'none';

                createSparkles();
            }

            // ===================================================
            //  „Éù„Ç§„É≥„ÉàÁç≤ÂæóÔºàranking.js „ÅÆ showPointGetDialog „Çí‰ΩøÁî®Ôºâ
            // ===================================================
            function getPoints() {
                if (pointsGiven) return;
                pointsGiven = true;

                var points = Math.max(correctCount * 10, 10);

                var btn = document.getElementById('clear-point-btn');
                btn.disabled = true;
                btn.textContent = '‚úÖ „ÇÇ„Çâ„Å£„ÅüÔºÅ';

                if (typeof showPointGetDialog === 'function') {
                    showPointGetDialog(points, 'wariai_learn');
                } else {
                    alert(points + '„Éù„Ç§„É≥„Éà „ÇÇ„Çâ„Å£„Åü„ÇàÔºÅ');
                }
            }

            // ===================================================
            //  „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
            // ===================================================
            function goNextStage() {
                var nextStage = STAGES.find(function (s) { return s.id === currentStage.id + 1; });
                if (nextStage) startStage(nextStage);
                else backToMap();
            }

            function backToMap() { renderMap(); }

            // ===================================================
            //  „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
            // ===================================================
            function createSparkles() {
                var emojis = ['‚ú®', '‚≠ê', 'üåü', 'üí´', 'üéâ'];
                for (var i = 0; i < 8; i++) {
                    (function (delay) {
                        setTimeout(function () {
                            var el = document.createElement('div');
                            el.className = 'sparkle';
                            el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                            el.style.left = (20 + Math.random() * 60) + 'vw';
                            el.style.top = (20 + Math.random() * 50) + 'vh';
                            document.body.appendChild(el);
                            setTimeout(function () { el.remove(); }, 900);
                        }, delay * 100);
                    })(i);
                }
            }

            // ===================================================
            //  „É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûÔºàranking.js „ÅÆ getUserNames „Çí‰ΩøÁî®Ôºâ
            // ===================================================
            function initUserSelection() {
                var users = (typeof getUserNames === 'function') ? getUserNames() : [];
                var listEl = document.getElementById('user-list');
                listEl.innerHTML = '';

                if (users.length === 0) {
                    listEl.innerHTML = '<p class="no-user-msg">„É¶„Éº„Ç∂„Éº„Åå „Åø„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ<br>„Åª„Åã„ÅÆ„Éö„Éº„Ç∏„Åß „Å™„Åæ„Åà„Çí ÁôªÈå≤„Åó„Å¶„Å≠ÔºÅ</p>';
                    return;
                }

                users.forEach(function (name) {
                    var btn = document.createElement('button');
                    btn.className = 'user-btn';
                    btn.textContent = name;
                    btn.onclick = function () { selectUser(name); };
                    listEl.appendChild(btn);
                });
            }

            function selectUser(name) {
                currentUserName = name;
                document.getElementById('user-overlay').style.display = 'none';
                renderMap();
            }

            // ===================================================
            //  window ÂÖ¨Èñã
            // ===================================================
            window.backToMap = backToMap;
            window.nextSlide = nextSlide;
            window.getPoints = getPoints;
            window.goNextStage = goNextStage;
            window.selectUser = selectUser;

            // ===================================================
            //  ÂàùÊúüÂåñ
            // ===================================================
            initUserSelection();

        })();
    </script>
</body>

</html>