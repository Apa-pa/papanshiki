<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼¢å­—ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ï¼ˆ2å¹´ç”Ÿï¼‰ | ã±ã±ã‚“å¼</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #263238;
            color: white;
            text-align: center;
            margin: 0;
            padding: 10px;
            touch-action: manipulation;
            user-select: none;
            overflow: hidden;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: #37474f;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± */
        .header-ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #455a64;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .floor-badge {
            background: #ffc107;
            color: #333;
            padding: 3px 10px;
            border-radius: 5px;
        }

        .hp-bar-container {
            flex-grow: 1;
            margin: 0 15px;
            background: #263238;
            height: 15px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: #4caf50;
            width: 100%;
            transition: width 0.3s;
        }

        .hp-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 10px;
            line-height: 15px;
            top: 0;
        }

        /* ãƒãƒˆãƒ«ç”»é¢ */
        .battle-screen {
            flex-grow: 1;
            position: relative;
            background: #263238;
            border: 2px solid #546e7a;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            padding-bottom: 10px;
        }

        /* ãƒœã‚¹éšã®èƒŒæ™¯æ¼”å‡º */
        .boss-floor {
            background: radial-gradient(circle, #5d4037 0%, #263238 80%);
            border-color: #ff5722;
        }

        /* æ•µã‚­ãƒ£ãƒ©ã‚¨ãƒªã‚¢ */
        .enemy-area {
            width: 100%;
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .enemy-emoji {
            font-size: 80px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
            transition: transform 0.1s;
            line-height: 1;
        }

        .enemy-img-file {
            width: 120px;
            height: 120px;
            object-fit: contain;
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.3));
            transition: transform 0.1s;
        }

        .boss-img-file {
            width: 160px;
            height: 160px;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.5));
            transition: transform 0.1s;
        }

        /* HPãƒãƒ¼ */
        .enemy-hp-bar {
            width: 140px;
            height: 12px;
            background: #000;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
        }

        .enemy-hp-fill {
            height: 100%;
            background: #e91e63;
            width: 100%;
            transition: width 0.2s;
        }

        /* ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¤ºä½ç½® */
        .damage-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            font-weight: bold;
            color: #ff5252;
            text-shadow: 3px 3px 0 #fff;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }

        /* å•é¡Œè¡¨ç¤º */
        .question-box {
            font-size: 28px;
            font-weight: bold;
            color: #80deea;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
            width: 90%;
            box-sizing: border-box;
            line-height: 1.4;
        }

        .question-sub {
            font-size: 16px;
            color: #b0bec5;
            margin-top: 5px;
        }

        /* é¸æŠè‚¢ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ */
        .numpad {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding-top: 5px;
            flex-shrink: 0;
            height: 180px;
            /* å›ºå®šé«˜ã• */
        }

        .key {
            background: #546e7a;
            color: white;
            font-size: 24px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px #37474f;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.1s;
        }

        .key:active {
            transform: translateY(2px);
            box-shadow: 0 0 #37474f;
        }

        .key-correct {
            background: #00bcd4 !important;
            box-shadow: 0 4px #0097a7 !important;
        }

        .key-wrong {
            background: #ef5350 !important;
            box-shadow: 0 4px #c62828 !important;
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .menu-box {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            text-align: center;
        }

        .btn {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-sizing: border-box;
            text-decoration: none;
            line-height: normal;
        }

        .btn-start {
            background: #ff9800;
            color: white;
        }

        .btn-home {
            background: #90a4ae;
            color: white;
        }

        .btn-reset {
            background: #ef9a9a;
            color: #b71c1c;
            font-size: 14px;
            padding: 10px;
            margin-top: 5px;
        }

        .btn-reward {
            padding: 10px 20px;
            font-size: 16px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-reward:disabled {
            background: #ccc;
            cursor: default;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-5px, 0);
            }

            75% {
                transform: translate(5px, 0);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .shaking {
            animation: shake 0.2s;
        }

        @keyframes popUp {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.5);
            }

            50% {
                transform: translate(-50%, -100%) scale(1.2);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -120%) scale(1);
            }
        }

        .pop-anim {
            animation: popUp 0.8s ease-out forwards;
        }

        /* ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”¨ */
        #ending-screen {
            background: linear-gradient(135deg, #1a237e, #4a148c);
            color: white;
        }

        .ending-title {
            font-size: 32px;
            color: #ffd700;
            text-shadow: 0 0 10px #e65100;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header-ui">
            <div class="floor-badge"><span id="floor-disp">1</span>F</div>
            <div class="hp-bar-container">
                <div id="hero-hp-bar" class="hp-bar"></div>
                <div id="hero-hp-text" class="hp-text">50/50</div>
            </div>
            <button onclick="saveAndQuit()"
                style="background:none; border:1px solid #aaa; color:#fff; border-radius:5px; font-size:12px; cursor:pointer;">ä¸­æ–­</button>
        </div>

        <div class="battle-screen" id="battle-field">
            <div class="enemy-area">
                <div id="damage-disp" class="damage-popup">10</div>
                <div id="enemy-display">ğŸ‘¾</div>
                <div class="enemy-hp-bar">
                    <div id="enemy-hp-fill" class="enemy-hp-fill"></div>
                </div>
            </div>

            <div class="question-box" id="question-text">
                ã‚‚ã‚“ã ã„
                <div class="question-sub" id="question-sub"></div>
            </div>
        </div>

        <div class="numpad" id="choices-area">
            <!-- é¸æŠè‚¢ãƒœã‚¿ãƒ³ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>

        <div id="start-screen" class="overlay" style="display:flex;">
            <div class="menu-box">
                <h1 style="color:#e65100; margin-top:0;">ğŸ“š æ¼¢å­—ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h1>
                <p>2å¹´ç”Ÿã®æ¼¢å­—ã ã‚ˆï¼<br>ã ã‚ŒãŒãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                <select id="user-select" style="font-size:18px; padding:10px; width:100%; margin-bottom:20px;">
                    <option value="">(ãˆã‚‰ã‚“ã§ã­)</option>
                </select>

                <div id="resume-info" style="display:none; color:#555; margin-bottom:10px;">
                    <span id="save-floor">1</span>éšã‹ã‚‰ å†é–‹ï¼
                </div>

                <button id="start-btn-text" class="btn btn-start" onclick="gameStart()">å†’é™ºã¸ã„ãï¼</button>

                <div id="reset-area"
                    style="display:none; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                    <button class="btn btn-reset" onclick="resetGameStart()">ã¯ã˜ã‚ã‹ã‚‰ (ãƒ‡ãƒ¼ã‚¿ã‚’ã‘ã™)</button>
                </div>

                <a href="index.html" class="btn btn-home">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
            </div>
        </div>

        <div id="clear-screen" class="overlay">
            <div class="menu-box">
                <div style="font-size:60px;">ğŸ—ï¸</div>
                <h2 id="clear-msg" style="color:#00bcd4;">ã‚¯ãƒªã‚¢ï¼</h2>
                <p>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å€’ã—ãŸï¼</p>

                <button id="reward-btn" class="btn-reward" style="display:none;">
                    ğŸ 30ãƒã‚¤ãƒ³ãƒˆ
                </button>

                <p style="font-size:14px; color:#888;">HPãŒå°‘ã—å›å¾©ã—ãŸã‚ˆ</p>
                <button class="btn btn-start" onclick="nextFloor()">æ¬¡ã®éšã¸é€²ã‚€</button>

                <button class="btn btn-home" onclick="saveAndQuitNext()">ã‚»ãƒ¼ãƒ–ã—ã¦ã‚„ã‚ã‚‹</button>
            </div>
        </div>

        <div id="ending-screen" class="overlay">
            <div class="menu-box" style="background:rgba(255,255,255,0.9);">
                <div style="font-size:80px;">ğŸ‘‘</div>
                <h1 class="ending-title">å®Œå…¨åˆ¶è¦‡ï¼</h1>
                <p style="font-size:18px; color:#333;">ãŠã‚ã§ã¨ã†ï¼<br>åœ°ä¸‹100éšã®ãƒœã‚¹ã‚’å€’ã—ã€<br>æ¼¢å­—ãƒã‚¹ã‚¿ãƒ¼ã«ãªã£ãŸï¼</p>
                <p style="color:#e91e63; font-weight:bold;">ã‚­ãƒŸã®çŸ¥è­˜ã¯æœ€å¼·ã ï¼</p>
                <a href="index.html" class="btn btn-start">ğŸ  å‡±æ—‹ï¼ˆãƒ›ãƒ¼ãƒ ã¸ï¼‰</a>
            </div>
        </div>

        <div id="gameover-screen" class="overlay">
            <div class="menu-box">
                <div style="font-size:60px;">âš°ï¸</div>
                <h2 style="color:#ff5252;">ã‚„ã‚‰ã‚ŒãŸ...</h2>
                <p>HPãŒãªããªã£ã¦ã—ã¾ã£ãŸã€‚</p>
                <button class="btn btn-start" onclick="retryFloor()">ã“ã®éšã‹ã‚‰ã‚„ã‚ŠãªãŠã™</button>
                <a href="index.html" class="btn btn-home" style="text-decoration:none;">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
            </div>
        </div>
    </div>

    <script>
        // --- æ¼¢å­—ãƒ‡ãƒ¼ã‚¿ï¼ˆ2å¹´ç”Ÿï¼‰ ---
        // æ–‡ç« ã®ä¸­ã§èª­ã¿ã‚’ç­”ãˆã‚‹å½¢å¼ï¼ˆæœªç¿’æ¼¢å­—ã¯ã²ã‚‰ãŒãªç­‰ã§å¯¾å¿œï¼‰
        const KANJI_DATA = [
            { q: "ã¤ãªã‚’ ã€å¼•ã€ã", a: "ã²", type: "read", dummy: ["ã¬", "ãŠ", "ã", "ãŸ"] },
            { q: "ã¨ã‚Š ã® ã€ç¾½ã€", a: "ã¯ã­", type: "read", dummy: ["ã†", "ã¬ã®", "ãˆ", "ã‹ã‚"] },
            { q: "ç™½ã„ ã€é›²ã€", a: "ãã‚‚", type: "read", dummy: ["ã‚†ã", "ã‚ã‚", "ã‹ã¿", "ãã‚‰"] },
            { q: "ã©ã†ã¶ã¤ã€åœ’ã€", a: "ãˆã‚“", type: "read", dummy: ["ã—ã‚‡", "ã“", "ã¯ã‚“", "ãŠã‚“"] },
            { q: "ã„ãˆã‹ã‚‰ ã€é ã€ã„", a: "ã¨ãŠ", type: "read", dummy: ["ã¡ã‹", "ãŠã", "ã¯ã‚„", "ãŸã‹"] },
            { q: "ã“ã‚Œã¯ ã€ä½•ã€ ã§ã™ã‹", a: "ãªã«", type: "read", dummy: ["ã ã‚Œ", "ã©ã“", "ã„ã¤", "ãªãœ"] },
            { q: "ç†ï¼ˆã‚Šï¼‰ã€ç§‘ã€ ã® ã˜ã‚…ãã‚‡ã†", a: "ã‹", type: "read", dummy: ["ã‚Š", "ãŒ", "ã•", "ãŸ"] },
            { q: "ã€å¤ã€ä¼‘ã¿", a: "ãªã¤", type: "read", dummy: ["ãµã‚†", "ã‚ã", "ã¯ã‚‹", "ã‚ˆã‚‹"] },
            { q: "ã€å®¶ã€ ã« ã‹ãˆã‚‹", a: "ã„ãˆ", type: "read", dummy: ["ã¸ã‚„", "ã‚€ã‚‰", "ã¾ã¡", "ã‚„ã¾"] },
            { q: "ã†ãŸ ã‚’ ã€æ­Œã€ã†", a: "ã†ãŸ", type: "read", dummy: ["ã‚ã‚‰", "ãªã", "ã•ã‘", "ã‚ˆã‚€"] },
            { q: "ãƒ†ãƒ¬ãƒ“ã® ã€ç”»ã€ã‚ã‚“", a: "ãŒ", type: "read", dummy: ["ã‹", "ãˆ", "ãš", "ã‚"] },
            { q: "ã“ã¾ ãŒ ã€å›ã€ã‚‹", a: "ã¾ã‚", type: "read", dummy: ["ã‚ã", "ã¯ã—", "ã‚ã‚†", "ã¨ã¾"] },
            { q: "ã¨ã‚‚ã ã¡ ã« ã€ä¼šã€ã†", a: "ã‚", type: "read", dummy: ["ã‚„", "ã„", "ã", "ã™"] },
            { q: "ã€æµ·ã€ ã§ ãŠã‚ˆã", a: "ã†ã¿", type: "read", dummy: ["ã‹ã‚", "ã¿ãš", "ã„ã‘", "ã¬ã¾"] },
            { q: "ã€çµµã€ ã‚’ ã‹ã", a: "ãˆ", type: "read", dummy: ["ã‹ã„", "ãš", "ãŒ", "ã—"] },
            { q: "ã€å¤–ã€ ã§ ã‚ãã¶", a: "ãã¨", type: "read", dummy: ["ãªã‹", "ã†ã¡", "ã¾ãˆ", "ã†ã‚‰"] },
            { q: "ã€è§’ã€ãŒ ã‚ã‚‹ ã©ã†ã¶ã¤", a: "ã¤ã®", type: "read", dummy: ["ã‹ã©", "ã™ã¿", "ã¾ã‚‹", "ãŠã«"] },
            { q: "ã€æ¥½ã€ã—ã„ ã˜ã‹ã‚“", a: "ãŸã®", type: "read", dummy: ["ã‹ãª", "ãã‚‹", "ã†ã‚Œ", "ãŠã‚‚"] },
            { q: "ã›ã„ã€æ´»ã€", a: "ã‹ã¤", type: "read", dummy: ["ã¯ã¤", "ã‘ã¤", "ãŒã¤", "ã†"] },
            { q: "æœ¨ ã¨ æœ¨ ã® ã€é–“ã€", a: "ã‚ã„ã ", type: "read", dummy: ["ã¾", "ãªã‹", "ã†ã¡", "ãã°"] },
            { q: "ã€ä¸¸ã€ã„ å½¢ï¼ˆã‹ãŸã¡ï¼‰", a: "ã¾ã‚‹", type: "read", dummy: ["ã—ã‹ã", "ãªãŒ", "ã»ã", "ãµã¨"] },
            { q: "ã€å²©ã€ ã® ä¸Šï¼ˆã†ãˆï¼‰", a: "ã„ã‚", type: "read", dummy: ["ã„ã—", "ã‚„ã¾", "ã™ãª", "ã¤ã¡"] },
            { q: "ã€é¡”ã€ ã‚’ ã‚ã‚‰ã†", a: "ã‹ãŠ", type: "read", dummy: ["ã‚ãŸã¾", "ãã³", "ã¯ãª", "ã‚"] },
            { q: "ã€æ±½ã€ã—ã‚ƒ ã« ã®ã‚‹", a: "ã", type: "read", dummy: ["ã‘", "ã—", "ã˜", "ã¡"] },
            { q: "æ—¥ã€è¨˜ã€ ã‚’ ã‹ã", a: "ã", type: "read", dummy: ["ã—", "ã¡", "ã˜", "ã²"] },
            { q: "ãŠã†ã¡ ã¸ ã€å¸°ã€ã‚‹", a: "ã‹ãˆ", type: "read", dummy: ["ã„", "ã", "ã‚‚ã©", "ãŠ"] },
            { q: "ã€å¼“ã€ã¨ çŸ¢ï¼ˆã‚„ï¼‰", a: "ã‚†ã¿", type: "read", dummy: ["ã„ã¨", "ãˆã ", "ã²ã‚‚", "ãŸã‘"] },
            { q: "ã€ç‰›ã€ ã® ãƒŸãƒ«ã‚¯", a: "ã†ã—", type: "read", dummy: ["ã†ã¾", "ã²ã¤ã˜", "ã¶ãŸ", "ã„ã¬"] },
            { q: "å·ï¼ˆã‹ã‚ï¼‰ ã® ã€é­šã€", a: "ã•ã‹ãª", type: "read", dummy: ["ã¨ã‚Š", "ã‚€ã—", "ã‹ã„", "ã«ã"] },
            { q: "æ±ï¼ˆã¨ã†ï¼‰ã€äº¬ã€", a: "ãã‚‡ã†", type: "read", dummy: ["ã¨", "ã‘ã„", "ã“ã†", "ã‹ã‚“"] },
            { q: "åŠ›ï¼ˆã¡ã‹ã‚‰ï¼‰ ãŒ ã€å¼·ã€ã„", a: "ã¤ã‚ˆ", type: "read", dummy: ["ã‚ˆã‚", "ã“ã‚", "ã‹ãŸ", "ã‚ã¤"] },
            { q: "ã¹ã‚“ãã‚‡ã† ã‚’ ã€æ•™ã€ãˆã‚‹", a: "ãŠã—", type: "read", dummy: ["ã‹ã‚“ãŒ", "ã¤ãŸ", "ãªã‚‰", "ã‚ˆ"] },
            { q: "å­¦æ ¡ï¼ˆãŒã£ã“ã†ï¼‰ ã« ã€è¿‘ã€ã„", a: "ã¡ã‹", type: "read", dummy: ["ã¨ãŠ", "ã²ã‚", "ã›ã¾", "ãªãŒ"] },
            { q: "ã€å…„ã€ ã¨ ãŠã¨ã†ã¨", a: "ã‚ã«", type: "read", dummy: ["ã‚ã­", "ã¡ã¡", "ã¯ã¯", "ããµ"] },
            { q: "ã•ã‚“ã‹ã ã® ã€å½¢ã€", a: "ã‹ãŸã¡", type: "read", dummy: ["ã„ã‚", "ãŠã¨", "ã‚ã˜", "ã‚ˆã†ã™"] },
            { q: "ã¨ã€è¨ˆã€", a: "ã‘ã„", type: "read", dummy: ["ã•ã‚“", "ã‹", "ãŒ", "ã‘ã‚“"] },
            { q: "ã€å…ƒã€æ°— ãª ã“ãˆ", a: "ã’ã‚“", type: "read", dummy: ["ãŒã‚“", "ã¦ã‚“", "ã‹ã‚“", "ã›ã‚“"] },
            { q: "ãŠç¤¼ï¼ˆã‚Œã„ï¼‰ ã‚’ ã€è¨€ã€ã†", a: "ã„", type: "read", dummy: ["ã¯ãª", "ã‹ãŸ", "ã¤ãŸ", "ã•ã‘"] },
            { q: "ã€åŸã€ã£ã± ã§ ã‚ãã¶", a: "ã¯ã‚‰", type: "read", dummy: ["ã®", "ã«ã‚", "ã‚„ã¾", "ãŠã‹"] },
            { q: "ã€æˆ¸ã€ ã‚’ ã‚ã‘ã‚‹", a: "ã¨", type: "read", dummy: ["ã¾ã©", "ã‹ã¹", "ã‚„ã­", "ã‚†ã‹"] },
            { q: "ã€å¤ã€ã„ æœ¬ï¼ˆã»ã‚“ï¼‰", a: "ãµã‚‹", type: "read", dummy: ["ã‚ãŸã‚‰", "ãªãŒ", "ã¿ã˜ã‹", "ãŠã"] },
            { q: "ã€åˆã€ã” ï¼“ã˜", a: "ã”", type: "read", dummy: ["ã†", "ã•", "ã‹", "ãŒ"] },
            { q: "ã€å¾Œã€ã‚ ã‚’ ã¿ã‚‹", a: "ã†ã—", type: "read", dummy: ["ã¾ãˆ", "ã‚ˆã“", "ãªã‹", "ãã¨"] },
            { q: "ã‚†ã‚ ã‚’ ã€èªã€ã‚‹", a: "ã‹ãŸ", type: "read", dummy: ["ã¯ãª", "ã„", "ã¤ãŸ", "ã‚ˆ"] },
            { q: "ã€å·¥ã€ã˜ä¸­ï¼ˆã¡ã‚…ã†ï¼‰", a: "ã“ã†", type: "read", dummy: ["ã", "ã”", "ã¨", "ã‹"] },
            { q: "ã€åºƒã€ã„ ã†ã¿", a: "ã²ã‚", type: "read", dummy: ["ã›ã¾", "ã¨ãŠ", "ãŸã‹", "ãµã‹"] },
            { q: "ã€äº¤ã€ã°ã‚“", a: "ã“ã†", type: "read", dummy: ["ã°ã‚“", "ã—ã‚‡", "ã‹ã‚“", "ãã‚‡ã†"] },
            { q: "ãŠæ—¥ï¼ˆã²ï¼‰ã•ã¾ ã® ã€å…‰ã€", a: "ã²ã‹ã‚Š", type: "read", dummy: ["ã‹ãŒã‚„", "ã‚ã‹", "ã‚ã•", "ã²"] },
            { q: "ã‚ˆã ã€è€ƒã€ãˆã‚‹", a: "ã‹ã‚“ãŒ", type: "read", dummy: ["ãŠã‚‚", "ã†ãŸãŒ", "ã—ã‚‰", "ã"] },
            { q: "å­¦æ ¡ï¼ˆãŒã£ã“ã†ï¼‰ ã¸ ã€è¡Œã€ã", a: "ã„", type: "read", dummy: ["ã", "ãŠã“ãª", "ã", "ã‚ã‚‹"] },
            { q: "èƒŒï¼ˆã›ï¼‰ ãŒ ã€é«˜ã€ã„", a: "ãŸã‹", type: "read", dummy: ["ã²ã", "ãªãŒ", "ãŠã‚‚", "ã²ã‚"] },
            { q: "ã€é»„ã€ã„ã‚", a: "ã", type: "read", dummy: ["ã‚ã‹", "ã‚ãŠ", "ã—ã‚", "ãã‚"] },
            { q: "ç›®ï¼ˆã‚ï¼‰ ãŒ ã€åˆã€ã†", a: "ã‚", type: "read", dummy: ["ã‚„", "ã„", "ã", "ã¾"] },
            { q: "ã€è°·ã€ãŒã‚", a: "ãŸã«", type: "read", dummy: ["ã‚„ã¾", "ã‹ã‚", "ãŠã‹", "ã†ã¿"] },
            { q: "æ—¥æœ¬ï¼ˆã«ã»ã‚“ï¼‰ ã¨ ã„ã† ã€å›½ã€", a: "ãã«", type: "read", dummy: ["ã¾ã¡", "ã‚€ã‚‰", "ã—ã¾", "ã„ãˆ"] },
            { q: "ã€é»’ã€ã„ ã‹ã¿", a: "ãã‚", type: "read", dummy: ["ã—ã‚", "ã‚ã‹", "ã‚ãŠ", "ã"] },
            { q: "ã€ä»Šã€ ã™ã ã‚„ã‚‹", a: "ã„ã¾", type: "read", dummy: ["ãã®ã†", "ã‚ã—ãŸ", "ã•ã", "ã‚ã¨"] },
            { q: "å¤©ï¼ˆã¦ã‚“ï¼‰ã€æ‰ã€", a: "ã•ã„", type: "read", dummy: ["ã–ã„", "ã›ã„", "ãŸã„", "ã‹ã„"] },
            { q: "ã€ç´°ã€ã„ ã„ã¨", a: "ã»ã", type: "read", dummy: ["ãµã¨", "ã†ã™", "ãªãŒ", "ã¡ã„"] },
            { q: "ã”ã¯ã‚“ ã‚’ ã€ä½œã€ã‚‹", a: "ã¤ã", type: "read", dummy: ["ã‚„", "ãª", "ã‹", "ã†"] },
            { q: "ã€ç®—ã€ã™ã†", a: "ã•ã‚“", type: "read", dummy: ["ã–ã‚“", "ã›ã‚“", "ã‹ã‚“", "ãŸã‚“"] }
        ];

        let currentUser = "";
        let gameState = {
            floor: 1,
            maxHp: 50,
            currentHp: 50
        };

        // æˆ¦é—˜ä¸­ãƒ‡ãƒ¼ã‚¿
        let enemy = { hp: 10, maxHp: 10, isBoss: false };
        let currentQ = null;
        let currentReward = 30;

        const ENEMIES = ['ğŸ‘¾', 'ğŸ¦‡', 'ğŸ', 'ğŸº', 'ğŸ’€', 'ğŸ‘»', 'ğŸ‘º', 'ğŸ‘¹', 'ğŸ‰', 'ğŸ‘¿'];

        // åŠ¹æœéŸ³ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯å†ç”Ÿã•ã‚Œãªã„ï¼‰
        const SE = {
            attack: new Audio('se/attack.mp3'),
            damage: new Audio('se/damage.mp3'),
            clear: new Audio('se/clear.mp3')
        };

        function playSe(type) {
            try {
                const audio = SE[type];
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => { /* ç„¡è¦– */ });
                }
            } catch (e) { }
        }

        window.onload = function () {
            const users = getUserNames(); // ranking.js ã«ä¾å­˜
            const select = document.getElementById('user-select');
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.innerText = u;
                select.appendChild(opt);
            });

            select.addEventListener('change', function () {
                const user = this.value;
                if (!user) return;

                const saved = loadGameData(user);
                const resumeInfo = document.getElementById('resume-info');
                const startBtn = document.getElementById('start-btn-text');
                const resetArea = document.getElementById('reset-area');

                if (saved) {
                    document.getElementById('save-floor').innerText = saved.floor;
                    resumeInfo.style.display = 'block';
                    startBtn.innerText = "ã¤ã¥ãã‹ã‚‰ å†’é™ºï¼";
                    resetArea.style.display = 'block';
                } else {
                    resumeInfo.style.display = 'none';
                    startBtn.innerText = "å†’é™ºã¸ã„ãï¼";
                    resetArea.style.display = 'none';
                }
            });
        };

        function getKey(user) { return `papan_kanji_dungeon_v2_${user}`; }

        function saveGameData(user, data) {
            localStorage.setItem(getKey(user), JSON.stringify(data));
        }

        function loadGameData(user) {
            const json = localStorage.getItem(getKey(user));
            return json ? JSON.parse(json) : null;
        }

        function gameStart() {
            const user = document.getElementById('user-select').value;
            if (!user) { alert("ãªã¾ãˆã‚’ãˆã‚‰ã‚“ã§ã­"); return; }

            currentUser = user;
            const saved = loadGameData(user);

            if (saved) {
                gameState = saved;
            } else {
                gameState = { floor: 1, maxHp: 50, currentHp: 50 };
            }

            document.getElementById('start-screen').style.display = 'none';
            initFloor();
        }

        function resetGameStart() {
            const user = document.getElementById('user-select').value;
            if (!user) return;

            if (confirm(user + "ã•ã‚“ã® ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦\n1éšã‹ã‚‰ ã¯ã˜ã‚ã¾ã™ã‹ï¼Ÿ")) {
                currentUser = user;
                gameState = { floor: 1, maxHp: 50, currentHp: 50 };
                saveGameData(currentUser, gameState);

                document.getElementById('start-screen').style.display = 'none';
                initFloor();
            }
        }

        function saveAndQuit() {
            if (!currentUser) return;
            saveGameData(currentUser, gameState);
            alert("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚ã¾ãŸã‚ãã‚“ã§ã­ï¼");
            location.href = "index.html";
        }

        function saveAndQuitNext() {
            if (!currentUser) return;

            gameState.floor++;
            gameState.maxHp += 5;
            gameState.currentHp = gameState.maxHp; // æ¬¡ã®éšã¸è¡Œãã¨ãã¯å…¨å›å¾©ãƒœãƒ¼ãƒŠã‚¹

            if (gameState.floor > 100) gameState.floor = 101;

            saveGameData(currentUser, gameState);
            alert("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚ã¤ãã¯ " + gameState.floor + "éš ã‹ã‚‰å†’é™ºå†é–‹ã§ã™ï¼");
            location.href = "index.html";
        }

        // --- ãƒ•ãƒ­ã‚¢åˆæœŸåŒ– ---
        function initFloor() {
            if (gameState.floor > 100) {
                document.getElementById('ending-screen').style.display = 'flex';
                return;
            }

            document.getElementById('floor-disp').innerText = gameState.floor;
            updateHeroHpUI();

            const field = document.getElementById('battle-field');
            const enemyDisplay = document.getElementById('enemy-display');
            enemy.isBoss = false;

            let hpVal = 0;

            if (gameState.floor % 10 === 0) {
                // ãƒœã‚¹éš
                enemy.isBoss = true;
                const avgDmg = 12 + Math.floor(gameState.floor / 2);
                hpVal = avgDmg * 5; // ãƒœã‚¹ã®HPã¯å°‘ã—é«˜ã‚(æ¼¢å­—ãªã®ã§è©¦è¡Œå›æ•°è€ƒæ…®)

                const bossNum = gameState.floor / 10;
                const bossNumStr = bossNum < 10 ? '0' + bossNum : bossNum;
                const imgPath = `image/monster${bossNumStr}.png`;
                enemyDisplay.innerHTML = `<img src="${imgPath}" class="boss-img-file" alt="ãƒœã‚¹">`;
                field.classList.add('boss-floor');

            } else if (gameState.floor === 1) {
                // 1éšã‚¹ãƒ©ã‚¤ãƒ 
                hpVal = 50;
                enemyDisplay.innerHTML = '<img src="slime.png" class="enemy-img-file" alt="ã‚¹ãƒ©ã‚¤ãƒ ">';
                field.classList.remove('boss-floor');

            } else {
                // é€šå¸¸éš
                const avgDmg = 12 + Math.floor(gameState.floor / 2);
                hpVal = avgDmg * 4;

                const idx = (gameState.floor) % ENEMIES.length;
                enemyDisplay.innerHTML = ENEMIES[idx];
                enemyDisplay.className = "enemy-emoji";
                field.classList.remove('boss-floor');
            }

            enemy.maxHp = hpVal;
            enemy.hp = hpVal;

            updateEnemyHpUI();
            nextQuestion();
        }

        // --- å•é¡Œä½œæˆãƒ­ã‚¸ãƒƒã‚¯ ---
        function nextQuestion() {
            // ãƒ©ãƒ³ãƒ€ãƒ ã«1å•é¸æŠ
            const idx = Math.floor(Math.random() * KANJI_DATA.length);
            const qData = KANJI_DATA[idx];
            currentQ = qData;

            // å•é¡Œæ–‡è¡¨ç¤º
            document.getElementById('question-text').innerHTML = qData.q + '<div class="question-sub">ã® èª­ã¿ã‹ãŸã¯ï¼Ÿ</div>';

            // é¸æŠè‚¢ç”Ÿæˆï¼ˆæ­£è§£ + ãƒ€ãƒŸãƒ¼3ã¤ï¼‰
            let choices = [...qData.dummy];
            // ãƒ€ãƒŸãƒ¼ãŒå¤šã™ãã‚‹å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã«3ã¤é¸ã¶å‡¦ç†ã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„ãŒã€ä»Šã¯ãƒ‡ãƒ¼ã‚¿å´ã§èª¿æ•´
            // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ã‹ã‚‰å…ˆé ­3ã¤ã‚’å–ã‚‹
            choices = choices.sort(() => Math.random() - 0.5).slice(0, 3);
            choices.push(qData.a);

            // å…¨ä½“ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            choices.sort(() => Math.random() - 0.5);

            // ãƒœã‚¿ãƒ³æç”»
            const area = document.getElementById('choices-area');
            area.innerHTML = "";

            choices.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'key';
                btn.innerText = c;
                btn.onclick = () => checkAnswer(btn, c);
                area.appendChild(btn);
            });
        }

        // --- åˆ¤å®š ---
        function checkAnswer(btnElement, answer) {
            // é€£æ‰“é˜²æ­¢ã®ãŸã‚ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const btns = document.querySelectorAll('.key');
            btns.forEach(b => b.disabled = true);

            if (answer === currentQ.a) {
                // æ­£è§£
                btnElement.classList.add('key-correct');

                const baseDmg = Math.floor(Math.random() * 5) + 15; // ãƒ€ãƒ¡ãƒ¼ã‚¸èª¿æ•´
                const levelBonus = Math.floor(gameState.floor / 2);
                const damage = baseDmg + levelBonus;

                playSe('attack');
                playEffect('attack');
                enemy.hp -= damage;
                showDamage(damage);

                setTimeout(() => {
                    if (enemy.hp <= 0) {
                        enemy.hp = 0;
                        updateEnemyHpUI();
                        setTimeout(floorClear, 500);
                    } else {
                        updateEnemyHpUI();
                        nextQuestion();
                    }
                }, 500); // æ¼”å‡ºå¾…ã¡

            } else {
                // ä¸æ­£è§£
                btnElement.classList.add('key-wrong');

                const dmg = Math.floor(Math.random() * 5) + 5;
                playSe('damage');
                playEffect('damage');
                gameState.currentHp -= dmg;
                if (gameState.currentHp < 0) gameState.currentHp = 0;

                updateHeroHpUI();
                const field = document.getElementById('battle-field');
                field.style.borderColor = '#ff5252';
                setTimeout(() => field.style.borderColor = '#546e7a', 200);

                if (gameState.currentHp <= 0) {
                    setTimeout(gameOver, 500);
                } else {
                    // ä¸æ­£è§£ã®å ´åˆã¯å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®å•é¡Œï¼ˆã¾ãŸã¯åŒã˜å•é¡Œï¼‰
                    // ã“ã“ã§ã¯æ¬¡ã®å•é¡Œã¸è¡Œã
                    setTimeout(() => {
                        nextQuestion();
                    }, 800);
                }
            }
        }

        // --- UIæ›´æ–° ---
        function updateHeroHpUI() {
            const bar = document.getElementById('hero-hp-bar');
            const txt = document.getElementById('hero-hp-text');
            const pct = (gameState.currentHp / gameState.maxHp) * 100;
            bar.style.width = pct + "%";
            if (pct < 30) bar.style.background = "#ff5252";
            else bar.style.background = "#4caf50";
            txt.innerText = `${gameState.currentHp} / ${gameState.maxHp}`;
        }

        function updateEnemyHpUI() {
            const bar = document.getElementById('enemy-hp-fill');
            const pct = (enemy.hp / enemy.maxHp) * 100;
            bar.style.width = pct + "%";
        }

        function showDamage(val) {
            const el = document.getElementById('damage-disp');
            el.innerText = val;
            el.classList.remove('pop-anim');
            void el.offsetWidth;
            el.classList.add('pop-anim');
        }

        function playEffect(type) {
            const target = type === 'attack' ? document.getElementById('enemy-display') : document.getElementById('battle-field');
            target.classList.add('shaking');
            setTimeout(() => target.classList.remove('shaking'), 200);
        }

        // --- çµæœç”»é¢ ---
        // --- çµæœç”»é¢ ---
        function floorClear() {
            playSe('clear');
            saveGameData(currentUser, gameState);

            // å ±é…¬è¨ˆç®—
            if (gameState.floor === 100) {
                currentReward = 1000;
                document.getElementById('clear-msg').innerText = "åœ°ä¸‹100éš åˆ¶è¦‡ï¼";
            } else if (enemy.isBoss) {
                currentReward = 100;
                document.getElementById('clear-msg').innerText = "ãƒœã‚¹æ’ƒç ´ï¼";
            } else {
                currentReward = 30;
                document.getElementById('clear-msg').innerText = "ã‚¯ãƒªã‚¢ï¼";
            }

            // è‡ªå‹•ã§ãƒã‚¤ãƒ³ãƒˆå–å¾—
            if (typeof showPointGetDialog === 'function') {
                showPointGetDialog(currentReward);
            }

            // UIæ›´æ–°: ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã€ç²å¾—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const btn = document.getElementById('reward-btn');
            btn.style.display = 'none';

            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
            const existingMsg = document.getElementById('auto-reward-msg');
            if (existingMsg) existingMsg.remove();

            const msg = document.createElement('div');
            msg.id = 'auto-reward-msg';
            msg.innerText = `ğŸ ${currentReward} ãƒã‚¤ãƒ³ãƒˆ ã‚²ãƒƒãƒˆï¼`;
            msg.style.cssText = "font-size: 20px; color: #ff9800; font-weight: bold; margin-bottom: 20px;";

            // ãƒœã‚¿ãƒ³ã®ç›´å¾Œã«æŒ¿å…¥
            btn.insertAdjacentElement('afterend', msg);

            document.getElementById('clear-screen').style.display = 'flex';
        }

        function receiveReward() {
            const btn = document.getElementById('reward-btn');
            btn.disabled = true;
            btn.innerText = 'ã‚²ãƒƒãƒˆï¼';
            btn.style.background = '#ccc';

            if (typeof showPointGetDialog === 'function') {
                showPointGetDialog(currentReward);
            } else {
                alert(`${currentReward}ãƒã‚¤ãƒ³ãƒˆã‚²ãƒƒãƒˆï¼`);
            }
        }

        function nextFloor() {
            document.getElementById('clear-screen').style.display = 'none';

            // è¿½åŠ ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ¬¡å›è¡¨ç¤ºæ™‚ã«å†ç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯ç‰¹ã«ä½•ã‚‚ã—ãªãã¦ã‚‚è‰¯ã„
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆã‚‚ä¸è¦ï¼ˆå¸¸ã«éè¡¨ç¤ºã§çµ±ä¸€ã™ã‚‹ãŸã‚ï¼‰

            if (gameState.floor >= 100) {
                document.getElementById('ending-screen').style.display = 'flex';
                gameState.floor = 101;
                saveGameData(currentUser, gameState);
                return;
            }

            gameState.floor++;
            gameState.maxHp += 5;
            gameState.currentHp = gameState.maxHp; // æ¬¡ã®éšã¸è¡Œãã¨ãã¯å…¨å›å¾©

            saveGameData(currentUser, gameState);
            initFloor();
        }

        function gameOver() {
            document.getElementById('gameover-screen').style.display = 'flex';
        }

        function retryFloor() {
            document.getElementById('gameover-screen').style.display = 'none';
            gameState.currentHp = Math.floor(gameState.maxHp / 2); // åŠåˆ†ã§å¾©æ´»
            updateHeroHpUI();
            saveGameData(currentUser, gameState);
            initFloor();
        }

    </script>
</body>

</html>