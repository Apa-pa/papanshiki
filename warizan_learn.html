<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ââ≤„ÇäÁÆó„Éû„Çπ„Çø„Éº | „Å±„Å±„ÇìÂºè</title>
    <script src="ranking.js"></script>
    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "UD Digital Kyokasho-tai-R", "UD Digital Kyokasho-tai", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 50%, #fff3e0 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .container {
            width: 95%;
            max-width: 500px;
            margin: 0 auto;
            padding: 15px 10px 30px;
            position: relative;
        }

        /* „ÇÇ„Å©„Çã„Éú„Çø„É≥ */
        .home-btn {
            display: inline-block;
            text-decoration: none;
            color: #888;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 5px 12px;
            border-radius: 15px;
            transition: 0.3s;
            margin-bottom: 10px;
        }

        .home-btn:hover { background-color: #eee; }

        /* „Çø„Ç§„Éà„É´ */
        .title {
            text-align: center;
            font-size: 24px;
            color: #e65100;
            margin: 10px 0 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }

        .subtitle {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin-bottom: 20px;
        }

        /* === „Çπ„ÉÜ„Éº„Ç∏„Éû„ÉÉ„Éó === */
        .map-screen { text-align: center; }

        .stage-path {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin: 20px 0;
        }

        .stage-node {
            width: 90%;
            max-width: 360px;
            background: white;
            border-radius: 20px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 3px solid #e0e0e0;
        }

        .stage-node.cleared {
            border-color: #ff9800;
            background: linear-gradient(135deg, #fff8e1, #fff3e0);
        }

        .stage-node.current {
            border-color: #ff5722;
            box-shadow: 0 4px 16px rgba(255,87,34,0.3);
            animation: pulse 2s infinite;
        }

        .stage-node.locked {
            opacity: 0.5;
            cursor: default;
        }

        .stage-node:active:not(.locked) { transform: scale(0.97); }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 16px rgba(255,87,34,0.3); }
            50%       { box-shadow: 0 4px 24px rgba(255,87,34,0.55); }
        }

        .stage-icon   { font-size: 40px; min-width: 50px; text-align: center; }
        .stage-info   { text-align: left; flex: 1; }
        .stage-num    { font-size: 12px; color: #aaa; font-weight: bold; }
        .stage-name   { font-size: 17px; font-weight: bold; color: #333; margin: 2px 0; }
        .stage-desc   { font-size: 12px; color: #888; }
        .stage-stars  { font-size: 18px; min-width: 60px; text-align: right; }
        .stage-lock   { font-size: 24px; min-width: 60px; text-align: right; color: #ccc; }

        .path-connector { width: 4px; height: 20px; background: #e0e0e0; border-radius: 2px; }
        .path-connector.active { background: #ff9800; }

        /* === „É¨„ÉÉ„Çπ„É≥ÁîªÈù¢ === */
        .lesson-screen { display: none; text-align: center; }

        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lesson-back-btn {
            background: none;
            border: 1px solid #ccc;
            color: #888;
            font-size: 13px;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
        }

        .lesson-stage-name { font-size: 16px; font-weight: bold; color: #e65100; }

        .lesson-slide {
            background: white;
            border-radius: 25px;
            padding: 25px 20px;
            margin: 10px auto;
            max-width: 400px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            min-height: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .lesson-visual { margin: 10px 0; }
        .lesson-visual svg { max-width: 280px; width: 100%; height: auto; }

        .lesson-text {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            margin: 15px 0;
        }

        .lesson-text .highlight  { color: #e65100; font-weight: bold; font-size: 22px; }
        .lesson-text .big-formula { font-size: 26px; font-weight: bold; color: #e65100; }

        .lesson-dots { display: flex; gap: 8px; justify-content: center; margin: 15px 0 10px; }
        .lesson-dot  { width: 10px; height: 10px; border-radius: 50%; background: #ddd; }
        .lesson-dot.active { background: #ff9800; }

        .lesson-next-btn {
            background: #ff9800;
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            padding: 14px 40px;
            border-radius: 30px;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 0 #e65100;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .lesson-next-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #e65100; }

        /* === Á∑¥ÁøíÂïèÈ°åÁîªÈù¢ === */
        .quiz-screen { display: none; text-align: center; }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .quiz-progress-text { font-size: 14px; color: #888; }

        .quiz-card {
            background: white;
            border-radius: 25px;
            padding: 25px 20px;
            margin: 10px auto;
            max-width: 400px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .quiz-question-text { font-size: 18px; color: #555; margin-bottom: 15px; }
        .quiz-visual        { margin: 10px 0 20px; }
        .quiz-visual svg    { max-width: 250px; width: 100%; height: auto; }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 15px 0;
        }

        .quiz-option {
            background: white;
            border: 3px solid #ffb74d;
            font-size: 20px;
            font-weight: bold;
            padding: 16px;
            border-radius: 18px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            color: #333;
            box-shadow: 0 3px 0 #ff9800;
        }

        .quiz-option:active  { transform: translateY(2px); box-shadow: 0 1px 0 #ff9800; }
        .quiz-option.correct { background: #4CAF50; color: white; border-color: #388E3C; }
        .quiz-option.wrong   { background: #ef5350; color: white; border-color: #c62828; }
        .quiz-option:disabled { cursor: default; }

        .quiz-feedback { font-size: 50px; margin: 10px 0; display: none; }

        /* === „ÇØ„É™„Ç¢ÁîªÈù¢ === */
        .clear-screen { display: none; text-align: center; }
        .clear-title  { font-size: 28px; color: #ff9800; margin: 20px 0 10px; }
        .clear-stars  { font-size: 50px; margin: 15px 0; }
        .clear-msg    { font-size: 16px; color: #666; margin-bottom: 15px; }
        .clear-score  { font-size: 14px; color: #888; margin-bottom: 20px; }

        .clear-btn {
            font-size: 18px;
            font-weight: bold;
            padding: 14px 32px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            margin: 8px;
            transition: all 0.2s;
        }

        .clear-point-btn { background: #ff9800; color: white; box-shadow: 0 4px 0 #e65100; }
        .clear-point-btn:disabled { background: #ccc; box-shadow: 0 4px 0 #999; }
        .clear-point-btn:active:not(:disabled) { transform: translateY(2px); box-shadow: 0 2px 0 #e65100; }

        .clear-next-btn { background: #4CAF50; color: white; box-shadow: 0 4px 0 #388E3C; }
        .clear-next-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #388E3C; }

        .clear-map-btn { background: #2196F3; color: white; box-shadow: 0 4px 0 #1565C0; }
        .clear-map-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #1565C0; }

        /* „Ç≠„É©„Ç≠„É© */
        @keyframes starBounce {
            0%   { transform: scale(0); }
            60%  { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .star-anim { display: inline-block; animation: starBounce 0.5s ease forwards; }

        .sparkle {
            position: fixed;
            font-size: 30px;
            pointer-events: none;
            z-index: 200;
            animation: sparkleAnim 0.8s ease forwards;
        }

        @keyframes sparkleAnim {
            0%   { transform: scale(0) rotate(0deg);   opacity: 1; }
            50%  { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        /* === „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Ç™„Éº„Éê„Éº„É¨„Ç§ === */
        #user-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #e65100, #ff9800, #ffb74d);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .user-select-box {
            background: white;
            padding: 30px 25px;
            border-radius: 25px;
            max-width: 90%;
            width: 360px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .user-select-box h2 { color: #e65100; font-size: 24px; margin: 0 0 5px; }
        .user-select-box p  { color: #888; font-size: 14px; margin: 0 0 20px; }

        .user-btn {
            display: block;
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 0 #e65100;
            transition: all 0.2s;
        }

        .user-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #e65100; }

        .no-user-msg { color: #aaa; font-size: 14px; padding: 10px; line-height: 1.7; }

        /* „Çπ„Éû„ÉõÂØæÂøú */
        @media (max-width: 400px) {
            .lesson-slide { padding: 20px 15px; min-height: 280px; }
            .lesson-text  { font-size: 16px; }
            .stage-name   { font-size: 15px; }
            .quiz-option  { font-size: 17px; padding: 12px; }
        }
    </style>
</head>

<body>

    <!-- „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="user-overlay">
        <div class="user-select-box">
            <h2>‚ûó Ââ≤„ÇäÁÆó„Éû„Çπ„Çø„Éº</h2>
            <p>„Å†„Çå„Åå „Åæ„Å™„Å∂Ôºü</p>
            <div id="user-list"></div>
        </div>
    </div>

    <div class="container">
        <a href="index.html" class="home-btn">‚Üê „ÇÇ„Å©„Çã</a>
        <h1 class="title">‚ûó Ââ≤„ÇäÁÆó„Éû„Çπ„Çø„Éº</h1>
        <p class="subtitle">„Çπ„ÉÜ„Éº„Ç∏„Çí„ÇØ„É™„Ç¢„Åó„Å¶Ââ≤„ÇäÁÆó„Çí„Éû„Çπ„Çø„Éº„Åó„Çà„ÅÜÔºÅ</p>

        <!-- „Éû„ÉÉ„Éó -->
        <div id="map-screen" class="map-screen">
            <div class="stage-path" id="stage-path"></div>
        </div>

        <!-- „É¨„ÉÉ„Çπ„É≥ -->
        <div id="lesson-screen" class="lesson-screen">
            <div class="lesson-header">
                <button class="lesson-back-btn" onclick="backToMap()">‚Üê „ÇÇ„Å©„Çã</button>
                <span class="lesson-stage-name" id="lesson-stage-name"></span>
                <span></span>
            </div>
            <div class="lesson-slide" id="lesson-slide"></div>
            <div class="lesson-dots" id="lesson-dots"></div>
            <button class="lesson-next-btn" id="lesson-next-btn" onclick="nextSlide()">„Å§„Åé„Å∏ ‚Üí</button>
        </div>

        <!-- Á∑¥ÁøíÂïèÈ°å -->
        <div id="quiz-screen" class="quiz-screen">
            <div class="quiz-header">
                <button class="lesson-back-btn" onclick="backToMap()">‚Üê „ÇÇ„Å©„Çã</button>
                <span class="quiz-progress-text" id="quiz-progress-text">„ÇÇ„Çì„Å†„ÅÑ 1/3</span>
            </div>
            <div class="quiz-card">
                <p class="quiz-question-text" id="quiz-question-text"></p>
                <div class="quiz-visual" id="quiz-visual"></div>
                <div class="quiz-options" id="quiz-options"></div>
            </div>
            <div class="quiz-feedback" id="quiz-feedback"></div>
        </div>

        <!-- „ÇØ„É™„Ç¢ -->
        <div id="clear-screen" class="clear-screen">
            <h2 class="clear-title">üéâ „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ</h2>
            <div class="clear-stars" id="clear-stars"></div>
            <p class="clear-msg" id="clear-msg"></p>
            <p class="clear-score" id="clear-score"></p>
            <button class="clear-btn clear-point-btn" id="clear-point-btn" onclick="getPoints()">
                üéÅ „Éù„Ç§„É≥„Éà„Çí„ÇÇ„Çâ„ÅÜ
            </button>
            <br>
            <button class="clear-btn clear-next-btn" id="clear-next-btn" onclick="goNextStage()" style="display:none;">
                „Å§„Åé„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏ ‚Üí
            </button>
            <button class="clear-btn clear-map-btn" onclick="backToMap()">„Éû„ÉÉ„Éó„Å´„ÇÇ„Å©„Çã</button>
        </div>
    </div>

    <script>
    (function () {

        // ===================================================
        //  SVG„Éò„É´„Éë„Éº
        // ===================================================

        /** „Ç¢„Ç§„ÉÜ„É†„Çí„Ç∞„É´„Éº„Éó„Å´ÂàÜ„Åë„ÇãSVG */
        function groupSVG(total, groups, emoji) {
            var perGroup = Math.floor(total / groups);
            var rem = total % groups;
            var svgH = groups * 52 + (rem > 0 ? 46 : 8);
            var s = '<svg viewBox="0 0 240 ' + svgH + '" xmlns="http://www.w3.org/2000/svg">';

            for (var g = 0; g < groups; g++) {
                var y = g * 52 + 4;
                s += '<rect x="4" y="' + y + '" width="232" height="40" rx="10" fill="#fff8e1" stroke="#ffb74d" stroke-width="2" stroke-dasharray="5,3"/>';
                for (var i = 0; i < perGroup; i++) {
                    s += '<text x="' + (22 + i * 30) + '" y="' + (y + 28) + '" font-size="20" text-anchor="middle">' + emoji + '</text>';
                }
            }

            if (rem > 0) {
                var ry = groups * 52 + 8;
                s += '<text x="4" y="' + (ry + 14) + '" font-size="11" fill="#aaa">„ÅÇ„Åæ„ÇäÔºö</text>';
                for (var r = 0; r < rem; r++) {
                    s += '<text x="' + (58 + r * 28) + '" y="' + (ry + 16) + '" font-size="18" opacity="0.45">' + emoji + '</text>';
                }
            }
            s += '</svg>';
            return s;
        }

        /** Âºè„ÇíÂ§ß„Åç„ÅèË°®Á§∫„Åô„ÇãSVG */
        function formulaSVG(a, b, c, rem) {
            var expr = a + ' √∑ ' + b + ' = ' + c;
            if (rem !== undefined) expr += ' „ÅÇ„Åæ„Çä ' + rem;
            var s = '<svg viewBox="0 0 240 60" xmlns="http://www.w3.org/2000/svg">';
            s += '<text x="120" y="42" text-anchor="middle" font-size="26" font-weight="bold" fill="#e65100">' + expr + '</text>';
            s += '</svg>';
            return s;
        }

        /** „Åã„ÅëÁÆó‚Üî„Çè„ÇäÁÆó„ÅÆÈÄÜÈñ¢‰øÇSVG */
        function reverseSVG(a, b, c) {
            var s = '<svg viewBox="0 0 240 110" xmlns="http://www.w3.org/2000/svg">';
            s += '<text x="120" y="26" text-anchor="middle" font-size="20" font-weight="bold" fill="#ff9800">' + a + ' √ó ' + b + ' = ' + c + '</text>';
            s += '<text x="120" y="52" text-anchor="middle" font-size="22" fill="#bbb">‚Üï</text>';
            s += '<text x="120" y="80" text-anchor="middle" font-size="20" font-weight="bold" fill="#e65100">' + c + ' √∑ ' + b + ' = ' + a + '</text>';
            s += '<text x="120" y="105" text-anchor="middle" font-size="20" font-weight="bold" fill="#e65100">' + c + ' √∑ ' + a + ' = ' + b + '</text>';
            s += '</svg>';
            return s;
        }

        /** „ÅÇ„Åæ„Çä„ÅÆÁ¢∫„Åã„ÇÅSVG */
        function checkSVG(div, sor, result, rem) {
            var s = '<svg viewBox="0 0 240 80" xmlns="http://www.w3.org/2000/svg">';
            s += '<text x="8" y="24" font-size="14" fill="#555">Á¢∫„Åã„ÇÅÔºö' + sor + ' √ó ' + result + ' + ' + rem + '</text>';
            s += '<text x="8" y="50" font-size="14" fill="#555">„ÄÄ= ' + (sor * result + rem) + '  ‚Üê ÂÖÉ„ÅÆÊï∞ ' + div + ' „Å´‰∏ÄËá¥ÔºÅ</text>';
            s += '<text x="120" y="74" text-anchor="middle" font-size="22">‚úÖ</text>';
            s += '</svg>';
            return s;
        }

        // ===================================================
        //  „Çπ„ÉÜ„Éº„Ç∏„Éá„Éº„Çø
        // ===================================================
        var STAGES = [
            {
                id: 1,
                name: '„Çè„Åë„Å¶„Åø„Çà„ÅÜ',
                desc: '„Çè„ÇäÁÆó„ÅÆ„Åç„Åª„Çì„ÇíÁü•„Çç„ÅÜÔºÅ',
                icon: 'üç¨',
                lessons: [
                    {
                        text: '<span class="highlight">„Çè„ÇäÁÆó</span> „ÅØ„ÄÅ„ÇÇ„ÅÆ„Çí<br><span class="highlight">„Åä„Å™„ÅòÊï∞„Åö„Å§ „Çè„Åë„Çã</span><br>„Å®„Åç„Å´‰Ωø„ÅÜ„ÇàÔºÅ',
                        svg: null
                    },
                    {
                        text: 'üç¨ 6„Åì„Çí 3‰∫∫„Å´ „Çè„Åë„Çã„Å®‚Ä¶',
                        svg: function () { return groupSVG(6, 3, 'üç¨'); }
                    },
                    {
                        text: '„Å≤„Å®„Çä <span class="highlight">2„Åì</span> „Åö„Å§„Å†„Å≠ÔºÅ<br><span class="big-formula">6 √∑ 3 = 2</span>',
                        svg: function () { return formulaSVG(6, 3, 2); }
                    },
                    {
                        text: '„Äå<span class="highlight">√∑Ôºà„Çè„ÇãÔºâ</span>„Äç„ÅØ<br>„Åä„Å™„ÅòÊï∞„Åö„Å§„Çè„Åë„Çã „Åç„Åî„ÅÜ„Å†„ÇàÔºÅ',
                        svg: null
                    }
                ],
                quizzes: [
                    {
                        q: 'üçé 8„Åì„Çí 4‰∫∫„Åß„Çè„Åë„Çã„Å®„ÄÅ„Å≤„Å®„Çä „Å™„Çì„ÅìÔºü',
                        svg: function () { return groupSVG(8, 4, 'üçé'); },
                        options: ['1„Åì', '2„Åì', '3„Åì', '4„Åì'],
                        answer: 1
                    },
                    {
                        q: '10„Åì„Çí 2‰∫∫„Åß„Çè„Åë„Çã„Å®Ôºü',
                        svg: function () { return formulaSVG(10, 2, '?'); },
                        options: ['3', '4', '5', '6'],
                        answer: 2
                    },
                    {
                        q: '9„Åì„Çí 3‰∫∫„Åß„Çè„Åë„Çã„Å®Ôºü',
                        svg: function () { return groupSVG(9, 3, '‚≠ê'); },
                        options: ['2', '3', '4', '5'],
                        answer: 1
                    }
                ]
            },
            {
                id: 2,
                name: '„Åã„ÅëÁÆó„Åß„Åã„Åè„Å´„Çì',
                desc: '„Åã„ÅëÁÆó„Å®„Çè„ÇäÁÆó„ÅØ„Åé„ÇÉ„Åè„ÅÆ„Åã„Çì„Åë„ÅÑÔºÅ',
                icon: 'üåü',
                lessons: [
                    {
                        text: '„Åã„ÅëÁÆó„Å®„Çè„ÇäÁÆó„ÅØ<br><span class="highlight">„Åé„ÇÉ„Åè„ÅÆ„Åã„Çì„Åë„ÅÑ</span> „Å†„ÇàÔºÅ',
                        svg: null
                    },
                    {
                        text: '3 √ó 4 = 12 „ÅÆ „Åé„ÇÉ„Åè„ÅØ‚Ä¶',
                        svg: function () { return reverseSVG(3, 4, 12); }
                    },
                    {
                        text: '‰πù‰πù„Çí„Åä„Åº„Åà„Å¶„ÅÑ„Çã„Å®<br>„Çè„ÇäÁÆó„ÇÇ„Åô„Åê„Çè„Åã„Çã„ÇàÔºÅ<br><span class="big-formula">56 √∑ 7 = Ôºü</span><br>‚Üí 7„ÅÆ„Å†„Çì„Åß56„ÅØ‚Ä¶ <span class="highlight">7√ó8=56</span>',
                        svg: null
                    }
                ],
                quizzes: [
                    {
                        q: '21 √∑ 7 = Ôºü„ÄÄÔºà7√ó‚ñ°=21Ôºâ',
                        svg: function () { return reverseSVG(3, 7, 21); },
                        options: ['2', '3', '4', '5'],
                        answer: 1
                    },
                    {
                        q: '48 √∑ 6 = Ôºü',
                        svg: function () { return formulaSVG(48, 6, '?'); },
                        options: ['6', '7', '8', '9'],
                        answer: 2
                    },
                    {
                        q: '72 √∑ 9 = Ôºü',
                        svg: function () { return formulaSVG(72, 9, '?'); },
                        options: ['6', '7', '8', '9'],
                        answer: 2
                    }
                ]
            },
            {
                id: 3,
                name: '„ÅÇ„Åæ„Çä„ÅÆ„ÅÇ„Çã„Çè„ÇäÁÆó',
                desc: '„Å¥„Å£„Åü„Çä„Çè„Çä„Åç„Çå„Å™„ÅÑ„Å®„Åç„ÅØÔºü',
                icon: 'üöÇ',
                lessons: [
                    {
                        text: '„Å¥„Å£„Åü„Çä„Çè„Çä„Åç„Çå„Å™„ÅÑ„Å®„Åç<br><span class="highlight">„ÅÇ„Åæ„Çä</span> „Åå„Åß„Çã„ÇàÔºÅ',
                        svg: null
                    },
                    {
                        text: 'üç¨ 7„Åì„Çí 3‰∫∫„Åß„Çè„Åë„Çã„Å®‚Ä¶',
                        svg: function () { return groupSVG(7, 3, 'üç¨'); }
                    },
                    {
                        text: '„Å≤„Å®„Çä2„Åì„Åß 1„Åì„ÅÇ„Åæ„ÇãÔºÅ<br><span class="big-formula">7 √∑ 3 = 2 „ÅÇ„Åæ„Çä 1</span>',
                        svg: function () { return formulaSVG(7, 3, 2, 1); }
                    },
                    {
                        text: '„Åã„Åè„Å´„Çì„ÅÆ„Åó„Åã„ÅüÔºö<br>„Çè„ÇãÊï∞ √ó „Åì„Åü„Åà Ôºã „ÅÇ„Åæ„Çä<br>= „ÇÇ„Å®„ÅÆÊï∞',
                        svg: function () { return checkSVG(7, 3, 2, 1); }
                    },
                    {
                        text: '„Éù„Ç§„É≥„ÉàÔºÅ<br><span class="highlight">„ÅÇ„Åæ„Çä Ôºú „Çè„ÇãÊï∞</span><br>Ôºà„ÅÇ„Åæ„Çä„ÅØ„Çè„ÇãÊï∞„Çà„ÇäÂ∞è„Åï„ÅÑÔºâ',
                        svg: null
                    }
                ],
                quizzes: [
                    {
                        q: '11 √∑ 3 „ÅÆ„Åì„Åü„Åà„Å®„ÅÇ„Åæ„Çä„ÅØÔºü',
                        svg: function () { return groupSVG(11, 3, 'üç¨'); },
                        options: ['3 „ÅÇ„Åæ„Çä 2', '4 „ÅÇ„Åæ„Çä 1', '3 „ÅÇ„Åæ„Çä 3', '2 „ÅÇ„Åæ„Çä 5'],
                        answer: 0
                    },
                    {
                        q: '17 √∑ 5 „ÅÆ„Åì„Åü„Åà„Å®„ÅÇ„Åæ„Çä„ÅØÔºü',
                        svg: function () { return formulaSVG(17, 5, '?', '?'); },
                        options: ['3 „ÅÇ„Åæ„Çä 2', '4 „ÅÇ„Åæ„Çä 3', '2 „ÅÇ„Åæ„Çä 7', '3 „ÅÇ„Åæ„Çä 4'],
                        answer: 0
                    },
                    {
                        q: '23 √∑ 4 „ÅÆ„Åì„Åü„Åà„Å®„ÅÇ„Åæ„Çä„ÅØÔºü',
                        svg: function () { return formulaSVG(23, 4, '?', '?'); },
                        options: ['6 „ÅÇ„Åæ„Çä 1', '5 „ÅÇ„Åæ„Çä 3', '5 „ÅÇ„Åæ„Çä 4', '6 „ÅÇ„Åæ„Çä 2'],
                        answer: 1
                    }
                ]
            },
            {
                id: 4,
                name: 'Â§ß„Åç„ÅÑ„Åã„Åö„ÅÆ„Çè„ÇäÁÆó',
                desc: '2„Åë„Åü„ÅÆÂâ≤„ÇäÁÆó„ÇÇ„Éû„Çπ„Çø„Éº„Åó„Çà„ÅÜÔºÅ',
                icon: 'üî¢',
                lessons: [
                    {
                        text: '2„Åë„Åü„ÅÆ„Çè„ÇäÁÆó„ÇÇ<br>‰πù‰πù„Å®Âêå„Åò„Çà„ÅÜ„Å´ËÄÉ„Åà„Çã„ÇàÔºÅ',
                        svg: null
                    },
                    {
                        text: '<span class="big-formula">36 √∑ 4 = Ôºü</span><br>4„ÅÆ„Å†„Çì„Åß36„ÅØ‚Ä¶<br><span class="highlight">4 √ó 9 = 36</span><br>„Åì„Åü„Åà„ÅØ 9ÔºÅ',
                        svg: function () { return formulaSVG(36, 4, 9); }
                    },
                    {
                        text: '„Åæ„Å®„ÇÅ üìù<br>‚ë† „Åä„Å™„ÅòÊï∞„Åö„Å§„Çè„Åë„Çã<br>‚ë° „Åã„ÅëÁÆó„ÅÆ„Åé„ÇÉ„Åè„ÅßËÄÉ„Åà„Çã<br>‚ë¢ „ÅÇ„Åæ„Çä Ôºú „Çè„ÇãÊï∞<br>‚ë£ „Åã„Åè„Å´„Çì„Åó„Çà„ÅÜÔºÅ',
                        svg: null
                    }
                ],
                quizzes: [
                    {
                        q: '56 √∑ 8 = Ôºü',
                        svg: function () { return formulaSVG(56, 8, '?'); },
                        options: ['6', '7', '8', '9'],
                        answer: 1
                    },
                    {
                        q: '63 √∑ 7 = Ôºü',
                        svg: function () { return formulaSVG(63, 7, '?'); },
                        options: ['7', '8', '9', '6'],
                        answer: 2
                    },
                    {
                        q: '48 √∑ 6 = Ôºü',
                        svg: function () { return formulaSVG(48, 6, '?'); },
                        options: ['6', '7', '8', '9'],
                        answer: 2
                    }
                ]
            }
        ];

        // ===================================================
        //  „Éá„Éº„ÇøÁÆ°ÁêÜÔºàbunsu_learn „Å®Âêå„Åò„Éë„Çø„Éº„É≥Ôºâ
        // ===================================================
        var WARISAN_KEY_PREFIX = 'papan_warisan_progress_v1_';
        var currentUserName   = null;

        function getKey()     { return WARISAN_KEY_PREFIX + currentUserName; }

        function loadProgress() {
            if (!currentUserName) return { clearedStages: [], stars: {} };
            try {
                return JSON.parse(localStorage.getItem(getKey())) || { clearedStages: [], stars: {} };
            } catch (e) { return { clearedStages: [], stars: {} }; }
        }

        function saveProgress(data) {
            if (!currentUserName) return;
            localStorage.setItem(getKey(), JSON.stringify(data));
        }

        function isCleared(stageId)  { return loadProgress().clearedStages.indexOf(stageId) !== -1; }
        function isUnlocked(stageId) { return stageId === 1 || isCleared(stageId - 1); }
        function getStars(stageId)   { return (loadProgress().stars[stageId] || 0); }

        // ===================================================
        //  Áä∂ÊÖãÂ§âÊï∞
        // ===================================================
        var currentStage = null;
        var slideIndex   = 0;
        var quizIndex    = 0;
        var correctCount = 0;
        var totalQuizzes = 3;
        var pointsGiven  = false;

        // ===================================================
        //  ÁîªÈù¢Âà∂Âæ°
        // ===================================================
        function showScreen(screenId) {
            ['map-screen', 'lesson-screen', 'quiz-screen', 'clear-screen'].forEach(function (id) {
                document.getElementById(id).style.display = (id === screenId) ? 'block' : 'none';
            });
        }

        // ===================================================
        //  „Éû„ÉÉ„Éó
        // ===================================================
        function renderMap() {
            showScreen('map-screen');
            var container = document.getElementById('stage-path');
            container.innerHTML = '';

            STAGES.forEach(function (stage, idx) {
                if (idx > 0) {
                    var conn = document.createElement('div');
                    conn.className = 'path-connector' + (isCleared(stage.id - 1) ? ' active' : '');
                    container.appendChild(conn);
                }

                var node     = document.createElement('div');
                node.className = 'stage-node';
                var cleared  = isCleared(stage.id);
                var unlocked = isUnlocked(stage.id);

                if (cleared)       node.classList.add('cleared');
                else if (unlocked) node.classList.add('current');
                else               node.classList.add('locked');

                var starsHtml = '';
                if (cleared) {
                    var s = getStars(stage.id);
                    starsHtml = '<div class="stage-stars">';
                    for (var i = 0; i < 3; i++) starsHtml += (i < s ? '‚≠ê' : '‚òÜ');
                    starsHtml += '</div>';
                } else if (!unlocked) {
                    starsHtml = '<div class="stage-lock">üîí</div>';
                }

                node.innerHTML =
                    '<div class="stage-icon">' + stage.icon + '</div>' +
                    '<div class="stage-info">' +
                      '<div class="stage-num">„Çπ„ÉÜ„Éº„Ç∏ ' + stage.id + '</div>' +
                      '<div class="stage-name">' + stage.name + '</div>' +
                      '<div class="stage-desc">' + stage.desc + '</div>' +
                    '</div>' + starsHtml;

                if (unlocked) {
                    (function (s) { node.onclick = function () { startStage(s); }; })(stage);
                }

                container.appendChild(node);
            });
        }

        // ===================================================
        //  „Çπ„ÉÜ„Éº„Ç∏ÈñãÂßã
        // ===================================================
        function startStage(stage) {
            currentStage = stage;
            slideIndex   = 0;
            quizIndex    = 0;
            correctCount = 0;
            pointsGiven  = false;
            showLesson();
        }

        // ===================================================
        //  „É¨„ÉÉ„Çπ„É≥
        // ===================================================
        function showLesson() {
            showScreen('lesson-screen');
            document.getElementById('lesson-stage-name').textContent = currentStage.name;
            renderSlide();
            renderDots();
        }

        function renderSlide() {
            var slide = currentStage.lessons[slideIndex];
            var html  = '';
            if (slide.svg) html += '<div class="lesson-visual">' + slide.svg() + '</div>';
            html += '<div class="lesson-text">' + slide.text + '</div>';
            document.getElementById('lesson-slide').innerHTML = html;

            document.getElementById('lesson-next-btn').textContent =
                (slideIndex === currentStage.lessons.length - 1) ? '„Çå„Çì„Åó„ÇÖ„ÅÜ„ÇÇ„Çì„Å†„ÅÑ„Å∏ ‚Üí' : '„Å§„Åé„Å∏ ‚Üí';
        }

        function renderDots() {
            var dotsEl = document.getElementById('lesson-dots');
            dotsEl.innerHTML = '';
            for (var i = 0; i < currentStage.lessons.length; i++) {
                var dot = document.createElement('div');
                dot.className = 'lesson-dot' + (i <= slideIndex ? ' active' : '');
                dotsEl.appendChild(dot);
            }
        }

        function nextSlide() {
            if (slideIndex < currentStage.lessons.length - 1) {
                slideIndex++;
                renderSlide();
                renderDots();
            } else {
                startQuiz();
            }
        }

        // ===================================================
        //  Á∑¥ÁøíÂïèÈ°å
        // ===================================================
        function startQuiz() {
            quizIndex    = 0;
            correctCount = 0;
            showScreen('quiz-screen');
            renderQuiz();
        }

        function renderQuiz() {
            var quiz = currentStage.quizzes[quizIndex];
            document.getElementById('quiz-progress-text').textContent =
                '„ÇÇ„Çì„Å†„ÅÑ ' + (quizIndex + 1) + '/' + totalQuizzes;
            document.getElementById('quiz-question-text').textContent = quiz.q;
            document.getElementById('quiz-visual').innerHTML = quiz.svg ? quiz.svg() : '';

            var optionsEl = document.getElementById('quiz-options');
            optionsEl.innerHTML = '';
            quiz.options.forEach(function (opt, idx) {
                var btn = document.createElement('button');
                btn.className  = 'quiz-option';
                btn.textContent = opt;
                btn.onclick = function () { answerQuiz(idx); };
                optionsEl.appendChild(btn);
            });

            document.getElementById('quiz-feedback').style.display = 'none';
        }

        function answerQuiz(selected) {
            var quiz     = currentStage.quizzes[quizIndex];
            var buttons  = document.querySelectorAll('.quiz-option');
            var feedback = document.getElementById('quiz-feedback');

            buttons.forEach(function (btn) { btn.disabled = true; });

            if (selected === quiz.answer) {
                correctCount++;
                buttons[selected].classList.add('correct');
                feedback.textContent = '‚≠ï „Åõ„ÅÑ„Åã„ÅÑÔºÅ';
                feedback.style.display = 'block';
                createSparkles();
            } else {
                buttons[selected].classList.add('wrong');
                buttons[quiz.answer].classList.add('correct');
                feedback.textContent = '‚ùå „Åñ„Çì„Å≠„Çì‚Ä¶';
                feedback.style.display = 'block';
            }

            setTimeout(function () {
                quizIndex++;
                if (quizIndex < totalQuizzes) renderQuiz();
                else showClearScreen();
            }, 1200);
        }

        // ===================================================
        //  „ÇØ„É™„Ç¢ÁîªÈù¢
        // ===================================================
        function showClearScreen() {
            showScreen('clear-screen');

            var stars = correctCount >= 3 ? 3 : correctCount >= 2 ? 2 : 1;

            // ÈÄ≤Êçó„Çí‰øùÂ≠ò
            var progress = loadProgress();
            if (progress.clearedStages.indexOf(currentStage.id) === -1) {
                progress.clearedStages.push(currentStage.id);
            }
            var prevStars = progress.stars[currentStage.id] || 0;
            if (stars > prevStars) progress.stars[currentStage.id] = stars;
            saveProgress(progress);

            // Êòü„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            var starsEl = document.getElementById('clear-stars');
            starsEl.innerHTML = '';
            for (var i = 0; i < 3; i++) {
                var span = document.createElement('span');
                span.className = 'star-anim';
                span.textContent = i < stars ? '‚≠ê' : '‚òÜ';
                span.style.animationDelay = (i * 0.2) + 's';
                starsEl.appendChild(span);
            }

            document.getElementById('clear-msg').textContent   = ['„Åå„Çì„Å∞„Å£„Åü„Å≠ÔºÅ', '„Åô„Åî„ÅÑÔºÅ', '„Åã„Çì„Å∫„ÅçÔºÅÔºÅ'][stars - 1];
            document.getElementById('clear-score').textContent = correctCount + '/' + totalQuizzes + ' „ÇÇ„Çì „Åõ„ÅÑ„Åã„ÅÑ';

            pointsGiven = false;
            var pointBtn = document.getElementById('clear-point-btn');
            pointBtn.disabled    = false;
            pointBtn.textContent = 'üéÅ „Éù„Ç§„É≥„Éà„Çí„ÇÇ„Çâ„ÅÜ';

            var nextStage = STAGES.find(function (s) { return s.id === currentStage.id + 1; });
            document.getElementById('clear-next-btn').style.display = nextStage ? 'inline-block' : 'none';

            createSparkles();
        }

        // ===================================================
        //  „Éù„Ç§„É≥„ÉàÁç≤ÂæóÔºàranking.js „ÅÆ showPointGetDialog „Çí‰ΩøÁî®Ôºâ
        // ===================================================
        function getPoints() {
            if (pointsGiven) return;
            pointsGiven = true;

            var points = Math.max(correctCount * 10, 10); // ÊúÄ‰Ωé10ptÂèÇÂä†Ë≥û

            var btn = document.getElementById('clear-point-btn');
            btn.disabled    = true;
            btn.textContent = '‚úÖ „ÇÇ„Çâ„Å£„ÅüÔºÅ';

            if (typeof showPointGetDialog === 'function') {
                showPointGetDialog(points, 'warisan_learn');
            } else {
                alert(points + '„Éù„Ç§„É≥„Éà „ÇÇ„Çâ„Å£„Åü„ÇàÔºÅ');
            }
        }

        // ===================================================
        //  „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
        // ===================================================
        function goNextStage() {
            var nextStage = STAGES.find(function (s) { return s.id === currentStage.id + 1; });
            if (nextStage) startStage(nextStage);
            else backToMap();
        }

        function backToMap() { renderMap(); }

        // ===================================================
        //  „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
        // ===================================================
        function createSparkles() {
            var emojis = ['‚ú®', '‚≠ê', 'üåü', 'üí´', 'üéâ'];
            for (var i = 0; i < 8; i++) {
                (function (delay) {
                    setTimeout(function () {
                        var el = document.createElement('div');
                        el.className = 'sparkle';
                        el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                        el.style.left = (20 + Math.random() * 60) + 'vw';
                        el.style.top  = (20 + Math.random() * 50) + 'vh';
                        document.body.appendChild(el);
                        setTimeout(function () { el.remove(); }, 900);
                    }, delay * 100);
                })(i);
            }
        }

        // ===================================================
        //  „É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûÔºàranking.js „ÅÆ getUserNames „Çí‰ΩøÁî®Ôºâ
        // ===================================================
        function initUserSelection() {
            var users  = (typeof getUserNames === 'function') ? getUserNames() : [];
            var listEl = document.getElementById('user-list');
            listEl.innerHTML = '';

            if (users.length === 0) {
                listEl.innerHTML = '<p class="no-user-msg">„É¶„Éº„Ç∂„Éº„Åå „Åø„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ<br>„Åª„Åã„ÅÆ„Éö„Éº„Ç∏„Åß „Å™„Åæ„Åà„Çí ÁôªÈå≤„Åó„Å¶„Å≠ÔºÅ</p>';
                return;
            }

            users.forEach(function (name) {
                var btn = document.createElement('button');
                btn.className   = 'user-btn';
                btn.textContent = name;
                btn.onclick = function () { selectUser(name); };
                listEl.appendChild(btn);
            });
        }

        function selectUser(name) {
            currentUserName = name;
            document.getElementById('user-overlay').style.display = 'none';
            renderMap();
        }

        // ===================================================
        //  window ÂÖ¨ÈñãÔºàonclick Â±ûÊÄß„Åã„ÇâÂëº„Å∂„Åü„ÇÅÔºâ
        // ===================================================
        window.backToMap   = backToMap;
        window.nextSlide   = nextSlide;
        window.getPoints   = getPoints;
        window.goNextStage = goNextStage;
        window.selectUser  = selectUser;

        // ===================================================
        //  ÂàùÊúüÂåñ
        // ===================================================
        initUserSelection();

    })();
    </script>
</body>
</html>
