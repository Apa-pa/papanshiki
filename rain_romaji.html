<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ã‚ãµã‚Šãƒ­ãƒ¼ãƒå­—</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #263238;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            height: 100vh;
            height: 100dvh;
            color: white;
            touch-action: manipulation;
        }

        #app-container {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #37474f;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-area {
            flex: 1;
            position: relative;
            background: linear-gradient(to bottom, #1a237e, #3949ab); /* ãƒ­ãƒ¼ãƒå­—ç‰ˆã¯é’ç´«ç³»ã®ç©º */
            overflow: hidden;
            border-bottom: 2px solid #5c6bc0;
        }

        /* ã‚¹ã‚³ã‚¢ãƒ»ãƒ©ã‚¤ãƒ•è¡¨ç¤º */
        .hud {
            position: absolute;
            top: 10px; left: 15px;
            font-size: 20px; font-weight: bold;
            text-shadow: 2px 2px 0 #000; z-index: 10;
        }
        .life-area {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 24px; z-index: 10;
        }

        /* è½ã¡ã¦ãã‚‹é›« */
        .drop {
            position: absolute;
            width: 60px; height: 70px;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 24px; /* æ–‡å­—å°‘ã—å¤§ãã */
            color: #1a237e;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 120'%3E%3Cpath d='M50 0 C50 0 5 40 5 75 C5 100 25 120 50 120 C75 120 95 100 95 75 C95 40 50 0 50 0 Z' fill='%23e8eaf6' stroke='%239fa8da' stroke-width='2'/%3E%3C/svg%3E");
            background-size: contain; background-repeat: no-repeat;
            text-shadow: 0 0 2px white;
            padding-top: 15px; box-sizing: border-box;
            will-change: top;
        }
        .drop.hit {
            transform: scale(1.5); opacity: 0; transition: all 0.2s;
        }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        #controls {
            flex-shrink: 0;
            background: #fff;
            padding: 15px 10px 30px 10px;
            box-sizing: border-box;
            display: flex; justify-content: center;
            z-index: 20;
        }

        /* ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ï¼ˆ3x3ã‚°ãƒªãƒƒãƒ‰ï¼‰ */
        #keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3åˆ— */
            gap: 12px;
            width: 100%;
            max-width: 400px; /* æ¨ªã«åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã« */
            height: auto;
        }

        .key-btn {
            background: white;
            border: 2px solid #b0bec5;
            border-radius: 12px;
            font-size: 32px;
            font-family: 'Courier New', monospace; /* ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚‰ã—ã */
            font-weight: bold;
            color: #455a64;
            cursor: pointer;
            box-shadow: 0 4px #90a4ae;
            padding: 15px 0;
            touch-action: manipulation;
            transition: 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .key-btn:active {
            background: #e8eaf6;
            transform: translateY(3px);
            box-shadow: 0 1px #90a4ae;
            border-color: #3f51b5;
            color: #3f51b5;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»çµæœç”»é¢ */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 35, 126, 0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100; text-align: center;
        }
        .title-logo { font-size: 40px; margin-bottom: 20px; text-shadow: 0 4px 10px rgba(0,0,0,0.5); color: white; }
        .start-btn {
            font-size: 24px; padding: 15px 50px;
            background: #ffca28; color: #3e2723;
            border: none; border-radius: 50px;
            font-weight: bold; cursor: pointer;
            box-shadow: 0 5px #ff6f00; margin-top: 20px;
        }
        .start-btn:active { transform: scale(0.95); box-shadow: none; }

        .damage-effect {
            animation: shake 0.3s;
            box-shadow: inset 0 0 50px rgba(255, 82, 82, 0.8) !important;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="game-area">
        <div class="hud">ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
        <div class="life-area" id="life-icons">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
        <div id="drops-container"></div>
    </div>

    <div id="controls">
        <div id="keypad">
            <button class="key-btn" onclick="checkInput('k')">k</button>
            <button class="key-btn" onclick="checkInput('s')">s</button>
            <button class="key-btn" onclick="checkInput('t')">t</button>
            
            <button class="key-btn" onclick="checkInput('n')">n</button>
            <button class="key-btn" onclick="checkInput('h')">h</button>
            <button class="key-btn" onclick="checkInput('m')">m</button>
            
            <button class="key-btn" onclick="checkInput('y')">y</button>
            <button class="key-btn" onclick="checkInput('r')">r</button>
            <button class="key-btn" onclick="checkInput('w')">w</button>
        </div>
    </div>

    <div id="start-screen" class="overlay">
        <div style="font-size:60px;">ğŸ”¤</div>
        <div class="title-logo">ã‚ã‚ãµã‚Š<br>ãƒ­ãƒ¼ãƒå­—</div>
        <p style="color:#c5cae9;">ã²ã‚‰ãŒãªãŒ ãŠã¡ã¦ãã‚‹ã‚ˆã€‚<br>ã•ã„ã—ã‚‡ã® ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚’ãŠã—ã¦ã­ï¼</p>
        <p style="color:#9fa8da; font-size: 14px;">ï¼ˆã‚Œã„ï¼š ã‹ â†’ k ï¼‰</p>
        <button class="start-btn" onclick="gameStart()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <br>
        <a href="index.html" style="color:#9fa8da; margin-top:20px; text-decoration: underline;">ğŸ  ã‚‚ã©ã‚‹</a>
    </div>

    <div id="gameover-screen" class="overlay" style="display:none;">
        <h1 style="color:#ff5252;">ãŠã—ã¾ã„ï¼</h1>
        <div style="font-size: 80px; margin: 10px;">ğŸ˜­</div>
        <p style="font-size:24px; color: white;">ã‚¹ã‚³ã‚¢: <span id="final-score">0</span></p>
        <button class="start-btn" onclick="location.reload()">ã‚‚ã†ã„ã£ã‹ã„</button>
        <br>
        <a href="index.html" style="color:#9fa8da; margin-top:20px; text-decoration: underline;">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
    </div>
</div>

<script>
    const gameArea = document.getElementById('game-area');
    const dropsContainer = document.getElementById('drops-container');
    
    // ãƒ‡ãƒ¼ã‚¿: è¡Œã”ã¨ã®ã²ã‚‰ãŒãªãƒªã‚¹ãƒˆ
    const hiraganaMap = {
        'k': ['ã‹','ã','ã','ã‘','ã“'],
        's': ['ã•','ã—','ã™','ã›','ã'],
        't': ['ãŸ','ã¡','ã¤','ã¦','ã¨'],
        'n': ['ãª','ã«','ã¬','ã­','ã®'],
        'h': ['ã¯','ã²','ãµ','ã¸','ã»'],
        'm': ['ã¾','ã¿','ã‚€','ã‚','ã‚‚'],
        'y': ['ã‚„','ã‚†','ã‚ˆ'],
        'r': ['ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚'],
        'w': ['ã‚','ã‚’']
    };
    const keys = Object.keys(hiraganaMap);

    let score = 0;
    let life = 5;
    let isPlaying = false;
    let drops = []; 
    let frameCount = 0;
    let spawnRate = 120;
    let baseFallSpeed = 0.003; 
    let currentFallSpeedPx = 0;
    let gameHeight = 0;
    let animationId;

    function resizeGame() {
        gameHeight = gameArea.clientHeight;
        currentFallSpeedPx = gameHeight * baseFallSpeed;
    }
    
    window.addEventListener('resize', resizeGame);
    resizeGame();

    function gameStart() {
        resizeGame();
        document.getElementById('start-screen').style.display = 'none';
        score = 0;
        life = 5;
        updateUI();
        isPlaying = true;
        gameLoop();
    }

    function gameLoop() {
        if (!isPlaying) return;
        frameCount++;

        if (frameCount % 600 === 0) { 
            spawnRate = Math.max(30, spawnRate - 5);
            baseFallSpeed += 0.0002;
            currentFallSpeedPx = gameHeight * baseFallSpeed;
        }

        if (frameCount % spawnRate === 0) {
            spawnDrop();
        }

        moveDrops();
        animationId = requestAnimationFrame(gameLoop);
    }

    function spawnDrop() {
        const dropEl = document.createElement('div');
        dropEl.className = 'drop';
        
        // ãƒ©ãƒ³ãƒ€ãƒ ãªå­éŸ³ã‚­ãƒ¼ã‚’é¸ã¶
        const targetKey = keys[Math.floor(Math.random() * keys.length)];
        // ãã®è¡Œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªã²ã‚‰ãŒãªã‚’é¸ã¶
        const chars = hiraganaMap[targetKey];
        const targetChar = chars[Math.floor(Math.random() * chars.length)];

        dropEl.textContent = targetChar;
        
        const maxLeft = gameArea.clientWidth - 70;
        const x = Math.random() * maxLeft;
        
        dropEl.style.left = x + 'px';
        dropEl.style.top = '-80px'; 

        dropsContainer.appendChild(dropEl);

        drops.push({
            el: dropEl,
            y: -80,
            key: targetKey // æ­£è§£ã‚­ãƒ¼ã‚’ä¿å­˜
        });
    }

    function moveDrops() {
        for (let i = drops.length - 1; i >= 0; i--) {
            const drop = drops[i];
            drop.y += currentFallSpeedPx;
            drop.el.style.top = drop.y + 'px';

            if (drop.y > gameHeight - 60) {
                takeDamage();
                drop.el.remove();
                drops.splice(i, 1);
            }
        }
    }

    function checkInput(inputKey) {
        if (!isPlaying) return;
        
        // ç”»é¢ã«ã‚ã‚‹é›«ã®ä¸­ã‹ã‚‰ã€ã‚­ãƒ¼ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™ï¼ˆä¸€ç•ªä¸‹ã®ã‚‚ã®å„ªå…ˆï¼‰
        let targetIndex = -1;
        let maxY = -9999;

        for (let i = 0; i < drops.length; i++) {
            if (drops[i].key === inputKey) {
                if (drops[i].y > maxY) {
                    maxY = drops[i].y;
                    targetIndex = i;
                }
            }
        }

        if (targetIndex !== -1) {
            // æ­£è§£
            const target = drops[targetIndex];
            target.el.classList.add('hit');
            target.el.textContent = "âœ¨"; // æ¶ˆãˆã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            
            setTimeout(() => {
                if(target.el.parentNode) target.el.remove();
            }, 200);
            
            drops.splice(targetIndex, 1);
            score += 10;
        } else {
            // ä¸æ­£è§£
            const bg = document.getElementById('app-container');
            bg.style.boxShadow = "inset 0 0 50px rgba(255, 255, 0, 0.3)";
            setTimeout(() => bg.style.boxShadow = "none", 100);
        }

        updateUI();
    }

    function takeDamage() {
        life--;
        updateUI();
        const app = document.getElementById('app-container');
        app.classList.add('damage-effect');
        setTimeout(() => app.classList.remove('damage-effect'), 300);

        if (life <= 0) {
            gameOver();
        }
    }

    function updateUI() {
        document.getElementById('score').textContent = score;
        let hearts = "";
        for(let i=0; i<life; i++) hearts += "â¤ï¸";
        document.getElementById('life-icons').textContent = hearts;
    }

    function gameOver() {
        isPlaying = false;
        cancelAnimationFrame(animationId);
        document.getElementById('final-score').textContent = score;
        document.getElementById('gameover-screen').style.display = 'flex';
        if(typeof showSaveDialog === 'function') {
            showSaveDialog('rain_consonant', score); 
        }

    }

</script>
</body>
</html>