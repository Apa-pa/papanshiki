<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éê„Éº„Ç¨„Éº„Éª„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');

        body {
            font-family: "M PLUS Rounded 1c", "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #fff3e0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            touch-action: none;
            user-select: none;
            overflow: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header {
            background: #ff9800;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .quit-btn {
            background: #fff;
            color: #ff9800;
            padding: 5px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px #e65100;
        }

        /* „É°„Ç§„É≥„Ç®„É™„Ç¢Ôºö„Ç≥„É≥„Éô„Ç¢„Å®„É≠„Éú„ÉÉ„Éà */
        .stage-area {
            flex: 2;
            background: #eefebe;
            position: relative;
            overflow: hidden;
            border-bottom: 5px solid #8bc34a;
        }

        .conveyor-belt {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            height: 20px;
            background: repeating-linear-gradient(90deg, #555 0px, #555 20px, #333 20px, #333 40px);
            animation: belt-move 2s linear infinite;
        }

        @keyframes belt-move {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 40px 0;
            }
        }

        .robot-arm {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 180px;
            background: url('image/robot_arm.svg') no-repeat center bottom;
            background-size: contain;
            transition: transform 0.2s;
            z-index: 10;
        }

        .ingredient {
            position: absolute;
            bottom: 65px;
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: left 0.1s linear, top 0.5s ease-in;
        }

        .ingredient img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.2));
        }

        /* „Éà„Éû„Éà„Å†„ÅëÂ∞ë„ÅóÂ∞è„Åï„Åè„Åô„Çã */
        .ingredient img[src*="burger_tomato.svg"] {
            transform: scale(0.85);
        }

        /* „Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞„Ç®„É™„Ç¢ */
        .coding-area {
            flex: 3;
            background: #fafafa;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        .block-palette {
            display: flex;
            gap: 10px;
            padding: 5px;
            background: #eee;
            border-radius: 10px;
            overflow-x: auto;
            min-height: 50px;
            align-items: center;
        }

        .block {
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 3px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .block img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .block:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .block-if {
            background: #2196f3;
        }

        .block-action {
            background: #e91e63;
        }

        .block-cond {
            background: #4caf50;
        }

        .program-slot {
            background: #fff;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
            position: relative;
        }

        .slot-delete-btn {
            margin-left: auto;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 24px;
            text-align: center;
        }

        .run-btn {
            background: #4caf50;
            color: white;
            font-size: 20px;
            font-weight: bold;
            border: none;
            padding: 15px;
            border-radius: 50px;
            box-shadow: 0 5px #2e7d32;
            cursor: pointer;
            margin-top: auto;
        }

        .run-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            display: none;
            text-align: center;
        }

        .hint-box {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 15px;
            max-width: 80%;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .next-btn {
            margin-top: 20px;
            padding: 10px 30px;
            font-size: 20px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px #e65100;
        }

        /* „Ç¥„ÉüÁÆ±„Å®„Éà„É¨„Ç§ */
        #trash-bin {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
        }

        #trash-bin img {
            width: 100%;
            height: 100%;
        }

        #plate {
            position: absolute;
            bottom: 25px;
            left: 20px;
            width: 100px;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            border: 2px solid #bbb;
        }

        .burger-stack {
            position: absolute;
            bottom: 35px;
            /* Áöø„ÅÆ‰∏ä */
            left: 30px;
            display: flex;
            flex-direction: column-reverse;
            /* ‰∏ã„Åã„ÇâÁ©ç„Åø‰∏ä„Åí */
            align-items: center;
            width: 80px;
        }

        .stack-item {
            width: 80px;
            height: 25px;
            /* Èáç„Å™„ÇäÂÖ∑Âêà„ÇíË™øÊï¥ */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: -10px;
            /* Â∞ë„ÅóÈáç„Å≠„Çã */
            z-index: 1;
        }

        .stack-item img {
            width: 80px;
            height: auto;
            max-height: 60px;
            object-fit: contain;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <header>
            <div style="font-weight:bold; font-size:18px;">üçî „Éê„Éº„Ç¨„Éº„Éª„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞</div>
            <a href="index.html" class="quit-btn">üè† „ÇÇ„Å©„Çã</a>
        </header>

        <div class="stage-area">
            <div class="conveyor-belt" id="belt"></div>
            <div class="robot-arm" id="robot"></div>
            <div id="plate"></div>
            <div class="burger-stack" id="stack"></div>
            <div id="trash-bin"><img src="image/burger_trash.svg" alt="trash"></div>
        </div>

        <!-- „Çπ„ÉÜ„Éº„Ç∏Ë™¨Êòé -->
        <div style="padding: 10px; background: #fff3e0; color: #e65100; font-weight: bold; text-align: center;"
            id="mission-text">
            „Éü„ÉÉ„Ç∑„Éß„É≥Ôºö„ÅäËÇâ„Å†„ÅëÁÑºÔºà„ÇÑÔºâ„ÅÑ„Å¶„ÄÅ„Éë„É≥„ÅØ„Åù„ÅÆ„Åæ„Åæ„ÅØ„Åï„ÇÇ„ÅÜÔºÅ
        </div>

        <div class="coding-area">
            <div class="block-palette" id="palette">
                <!-- „Éñ„É≠„ÉÉ„ÇØ„ÅØJS„ÅßÁîüÊàê -->
            </div>

            <div id="program-container">
                <!-- „Éó„É≠„Ç∞„É©„É†„Çπ„É≠„ÉÉ„Éà -->
            </div>

            <button class="run-btn" onclick="runProgram()">‚ñ∂ „Çπ„Çø„Éº„ÉàÔºÅ</button>
        </div>
    </div>

    <!-- „ÇØ„É™„Ç¢ÁîªÈù¢ -->
    <div id="result-screen" class="overlay">
        <div class="hint-box">
            <div style="font-size: 60px;">üéâ</div>
            <h2 style="color:#e91e63">„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ</h2>
            <p>„Åã„Çì„Å∫„Åç„Å™„Éè„É≥„Éê„Éº„Ç¨„Éº„Åå„Åß„Åç„Åü„Å≠ÔºÅ</p>
            <button class="next-btn" onclick="nextStage()">„Å§„Åé„Å∏</button>
        </div>
    </div>

    <!-- Â§±ÊïóÁîªÈù¢ -->
    <div id="fail-screen" class="overlay">
        <div class="hint-box">
            <div style="font-size: 60px;">üò±</div>
            <h2 style="color:#333">„Åó„Å£„Å±„ÅÑ...</h2>
            <p id="fail-reason">„Å∏„Çì„Å™„Éè„É≥„Éê„Éº„Ç¨„Éº„Å´„Å™„Å£„Å°„ÇÉ„Å£„Åü</p>
            <button class="next-btn" style="background:#607d8b;" onclick="resetLevel()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
        </div>
    </div>

    <script>
        // „Ç≤„Éº„É†„Éá„Éº„Çø
        const INGREDIENTS = {
            'meat': { img: 'image/burger_meat_raw.svg', name: '„ÅäËÇâ', type: 'meat' },
            'bun': { img: 'image/burger_bun_bottom.svg', name: '„Éë„É≥', type: 'bun' }, // ‰æøÂÆú‰∏äbottom
            'bun_top': { img: 'image/burger_bun_top.svg', name: '„Éë„É≥', type: 'bun' },
            'cheese': { img: 'image/burger_cheese.svg', name: '„ÉÅ„Éº„Ç∫', type: 'cheese' },
            'lettuce': { img: 'image/burger_lettuce.svg', name: '„ÇÑ„Åï„ÅÑ', type: 'vege' },
            'tomato': { img: 'image/burger_tomato.svg', name: '„Éà„Éû„Éà', type: 'vege' },
            'trash': { img: 'image/burger_trash.svg', name: '„Ç¥„Éü', type: 'trash' },
            'bug_lettuce': { img: 'image/bug_lettuce.svg', name: '„ÇÄ„Åó„Åè„ÅÑÈáéËèú', type: 'trash' },

            // Ë™øÁêÜÂæå
            'cooked_meat': { img: 'image/burger_meat_cooked.svg', name: '„ÇÑ„ÅÑ„Åü„ÅäËÇâ', type: 'meat' },
            'burnt_bun': { img: 'image/burnt_bun.svg', name: '„Åì„Åí„Åü„Éë„É≥', type: 'bun' },
        };

        const ACTIONS = {
            'grill': { name: '„ÇÑ„Åè', icon: 'üî•' },
            'stack': { name: '„ÅÆ„Åõ„Çã', icon: 'ü§≤' },
            'discard': { name: '„Åô„Å¶„Çã', icon: 'üóëÔ∏è' }
        };

        const STAGE_POOLS = {
            1: [
                {
                    text: "„ÅäËÇâ„Å†„ÅëÁÑº„ÅÑ„Å¶„ÄÅ„Éë„É≥„ÅØ„Åù„ÅÆ„Åæ„Åæ „ÅØ„Åï„ÇÇ„ÅÜÔºÅ",
                    queue: ['bun', 'meat', 'meat', 'bun_top'],
                    available_conds: ['meat', 'bun', 'bun_top'],
                    available_actions: ['grill', 'stack'],
                    correct_logic: (ing, action) => {
                        if (ing === 'meat') return action === 'grill';
                        return action === 'stack';
                    }
                },
                {
                    text: "„ÅäËÇâ„Åü„Å£„Å∑„ÇäÔºÅ„ÅäËÇâ„Å†„ÅëÁÑº„ÅÑ„Å¶„Å≠„ÄÇ",
                    queue: ['bun', 'meat', 'meat', 'meat', 'bun_top'],
                    available_conds: ['meat', 'bun', 'bun_top'],
                    available_actions: ['grill', 'stack'],
                    correct_logic: (ing, action) => {
                        if (ing === 'meat') return action === 'grill';
                        return action === 'stack';
                    }
                }
            ],
            2: [
                {
                    text: "„ÉÅ„Éº„Ç∫„Éê„Éº„Ç¨„Éº„Çí‰Ωú„Çç„ÅÜÔºÅ„ÉÅ„Éº„Ç∫„ÅØ „Åù„ÅÆ„Åæ„Åæ „ÅÆ„Åõ„Å¶„Å≠„ÄÇ",
                    queue: ['bun', 'meat', 'cheese', 'meat', 'bun_top'],
                    available_conds: ['meat', 'cheese'],
                    available_actions: ['grill', 'stack'],
                    correct_logic: (ing, action) => {
                        if (ing === 'meat') return action === 'grill';
                        return action === 'stack';
                    }
                },
                {
                    text: "ÈáéËèú„Éê„Éº„Ç¨„Éº„Çí‰Ωú„Çç„ÅÜÔºÅÈáéËèúÔºà„É¨„Çø„ÇπÔºâ„ÅØ „Åù„ÅÆ„Åæ„Åæ „ÅÆ„Åõ„Å¶„Å≠„ÄÇ",
                    queue: ['bun', 'meat', 'lettuce', 'meat', 'bun_top'],
                    available_conds: ['meat', 'lettuce'],
                    available_actions: ['grill', 'stack'],
                    correct_logic: (ing, action) => {
                        if (ing === 'meat') return action === 'grill';
                        return action === 'stack';
                    }
                },
                {
                    text: "„Éà„Éû„Éà„Éê„Éº„Ç¨„ÉºÔºÅ„Éà„Éû„Éà„ÅØ „Åù„ÅÆ„Åæ„Åæ „ÅÆ„Åõ„Å¶„Å≠„ÄÇ",
                    queue: ['bun', 'meat', 'tomato', 'meat', 'bun_top'],
                    available_conds: ['meat', 'tomato'],
                    available_actions: ['grill', 'stack'],
                    correct_logic: (ing, action) => {
                        if (ing === 'meat') return action === 'grill';
                        return action === 'stack';
                    }
                },
                {
                    text: "ÂÖ®ÈÉ®„ÅÆ„Åõ„Éê„Éº„Ç¨„ÉºÔºÅ„ÉÅ„Éº„Ç∫„Å®ÈáéËèú„ÅØ „Åù„ÅÆ„Åæ„Åæ „ÅÆ„Åõ„Å¶„Å≠„ÄÇ",
                    queue: ['bun', 'lettuce', 'meat', 'cheese', 'tomato', 'meat', 'bun_top'],
                    available_conds: ['meat', 'cheese', 'lettuce', 'tomato'],
                    available_actions: ['grill', 'stack'],
                    correct_logic: (ing, action) => {
                        if (ing === 'meat') return action === 'grill';
                        return action === 'stack';
                    }
                }
            ],
            3: [
                {
                    text: "„ÇÄ„Åó„Åè„ÅÑÈáéËèú„Åå„Åæ„Åñ„Å£„Å¶„ÇãÔºÅ „ÇÄ„Åó„Åè„ÅÑÈáéËèú„ÅØ „Åô„Å¶„Å¶ÔºÅ",
                    queue: ['bun', 'meat', 'lettuce', 'bug_lettuce', 'tomato', 'bun_top'],
                    available_conds: ['meat', 'bug_lettuce'],
                    available_actions: ['grill', 'stack', 'discard'],
                    correct_logic: (ing, action) => {
                        if (ing === 'bug_lettuce') return action === 'discard';
                        if (ing === 'meat') return action === 'grill';
                        return action === 'stack';
                    }
                },
                {
                    text: "„Ç¥„Éü„Åå„Åæ„Åñ„Å£„Å¶„ÇãÔºÅ „Ç¥„Éü„ÅØ „Åô„Å¶„Å¶ÔºÅ",
                    queue: ['bun', 'meat', 'trash', 'cheese', 'tomato', 'bun_top'],
                    available_conds: ['meat', 'trash'],
                    available_actions: ['grill', 'stack', 'discard'],
                    correct_logic: (ing, action) => {
                        if (ing === 'trash') return action === 'discard';
                        if (ing === 'meat') return action === 'grill';
                        return action === 'stack';
                    }
                }
            ]
        };

        let STAGES = [];
        let currentStageIndex = 0;
        let userProgram = [];
        let isRunning = false;

        window.onload = initGame;

        function initGame() {
            try {
                // ÂêÑ„É¨„Éô„É´„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´1„Å§„Åö„Å§ÈÅ∏Âá∫„Åó„Å¶„Ç≤„Éº„É†„ÇíÊßãÊàê
                STAGES = [
                    STAGE_POOLS[1][Math.floor(Math.random() * STAGE_POOLS[1].length)],
                    STAGE_POOLS[2][Math.floor(Math.random() * STAGE_POOLS[2].length)],
                    STAGE_POOLS[3][Math.floor(Math.random() * STAGE_POOLS[3].length)]
                ];
                loadStage(0);
            } catch (e) {
                alert("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: " + e.message);
                console.error(e);
            }
        }

        function loadStage(idx) {
            currentStageIndex = idx;
            const stage = STAGES[idx];

            document.getElementById('mission-text').innerText = `„Çπ„ÉÜ„Éº„Ç∏${idx + 1}: ${stage.text}`;
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('fail-screen').style.display = 'none';

            userProgram = [];
            renderProgramSlots();
            renderPalette();
            resetField();
        }

        function resetField() {
            document.getElementById('stack').innerHTML = '';
            document.querySelectorAll('.ingredient').forEach(e => e.remove());
        }

        function renderPalette() {
            const p = document.getElementById('palette');
            p.innerHTML = '';
            const stage = STAGES[currentStageIndex];

            // „Äå„ÇÇ„Åó„Äú„Äç„Éñ„É≠„ÉÉ„ÇØ
            stage.available_conds.forEach(c => {
                const btn = document.createElement('div');
                btn.className = 'block block-cond';
                // „Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè„ÇíÂê´„ÇÅ„Çã
                const imgTag = `<img src="${INGREDIENTS[c].img}">`;
                btn.innerHTML = `„ÇÇ„Åó ${imgTag}${INGREDIENTS[c].name} „Å™„Çâ`;
                btn.onclick = () => addBlock('if', c);
                p.appendChild(btn);
            });

            // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éñ„É≠„ÉÉ„ÇØ
            stage.available_actions.forEach(a => {
                const btn = document.createElement('div');
                btn.className = 'block block-action';
                btn.innerHTML = `${ACTIONS[a].icon} ${ACTIONS[a].name}`;
                btn.onclick = () => addBlock('action', a);
                p.appendChild(btn);
            });
        }

        function renderProgramSlots() {
            const container = document.getElementById('program-container');
            container.innerHTML = '';

            userProgram.forEach((rule, index) => {
                const slot = document.createElement('div');
                slot.className = 'program-slot';

                const ifPart = document.createElement('div');
                ifPart.className = 'block block-if';
                ifPart.innerHTML = `„ÇÇ„Åó <img src="${INGREDIENTS[rule.cond].img}">Ôºà${INGREDIENTS[rule.cond].name}Ôºâ „Å™„Çâ`;
                slot.appendChild(ifPart);

                const arrow = document.createElement('span');
                arrow.innerText = '‚û°';
                slot.appendChild(arrow);

                const actionPart = document.createElement('div');
                actionPart.className = 'block block-action';
                actionPart.innerHTML = `${ACTIONS[rule.action].icon} ${ACTIONS[rule.action].name}`;
                slot.appendChild(actionPart);

                const delBtn = document.createElement('button');
                delBtn.className = 'slot-delete-btn';
                delBtn.innerText = '√ó';
                delBtn.onclick = () => removeRule(index);
                slot.appendChild(delBtn);

                container.appendChild(slot);
            });

            const defaultSlot = document.createElement('div');
            defaultSlot.className = 'program-slot';
            defaultSlot.style.opacity = "0.7";
            defaultSlot.style.borderStyle = "solid";
            defaultSlot.innerHTML = `<span style="font-weight:bold; color:#555;">„Åù„Çå„ÅÑ„Åå„ÅÑ„ÅÆ „Å®„Åç„ÅØ ‚û° ü§≤ „Åù„ÅÆ„Åæ„Åæ„ÅÆ„Åõ„Çã</span>`;
            container.appendChild(defaultSlot);
        }

        let pendingCond = null;

        function addBlock(type, val) {
            if (isRunning) return;

            if (type === 'if') {
                if (pendingCond) {
                    alert("„Åï„Å£„ÅçÈÅ∏„Çì„Å†Êù°‰ª∂„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÊ±∫„ÇÅ„Å¶„Å≠ÔºÅ");
                    return;
                }
                pendingCond = val;

                const container = document.getElementById('program-container');
                const tempSlot = document.createElement('div');
                tempSlot.id = 'temp-slot';
                tempSlot.className = 'program-slot';
                tempSlot.style.background = '#e3f2fd';
                tempSlot.innerHTML = `<div class="block block-if">„ÇÇ„Åó <img src="${INGREDIENTS[val].img}">Ôºà${INGREDIENTS[val].name}Ôºâ „Å™„Çâ</div> <span>‚û°</span> <span style="color:#aaa;">„Å©„ÅÜ„Åô„ÇãÔºü</span>`;
                container.insertBefore(tempSlot, container.lastChild);

            } else if (type === 'action') {
                if (!pendingCond) {
                    alert("ÂÖà„Å´„Äå„ÇÇ„Åó„Äú„Äç„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ");
                    return;
                }
                userProgram.push({ cond: pendingCond, action: val });
                pendingCond = null;
                renderProgramSlots();
            }
        }

        function removeRule(index) {
            if (isRunning) return;
            userProgram.splice(index, 1);
            renderProgramSlots();
            pendingCond = null;
        }

        function resetLevel() {
            document.getElementById('fail-screen').style.display = 'none';
            resetField();
        }

        async function runProgram() {
            if (isRunning) return;
            if (pendingCond) {
                alert("‰Ωú„Çä„Åã„Åë„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„ÇàÔºÅ");
                return;
            }

            isRunning = true;
            resetField();

            const stage = STAGES[currentStageIndex];

            for (const ingKey of stage.queue) {
                const ingElem = document.createElement('div');
                ingElem.className = 'ingredient';
                // img„Çø„Ç∞„ÅßË°®Á§∫
                ingElem.innerHTML = `<img src="${INGREDIENTS[ingKey].img}">`;
                ingElem.style.left = '-60px';
                document.querySelector('.stage-area').appendChild(ingElem);

                await moveElement(ingElem, '50%', 2000);

                let chosenAction = 'stack';
                for (const rule of userProgram) {
                    if (rule.cond === ingKey) {
                        chosenAction = rule.action;
                        break;
                    }
                }

                await robotAction(chosenAction);

                let resultKey = ingKey;

                if (chosenAction === 'grill') {
                    if (ingKey === 'meat') resultKey = 'cooked_meat';
                    else if (ingKey === 'bun' || ingKey === 'bun_top') resultKey = 'burnt_bun';
                    else if (ingKey === 'cheese') resultKey = null;
                } else if (chosenAction === 'discard') {
                    resultKey = null;
                }

                const isCorrect = stage.correct_logic(ingKey, chosenAction);

                if (!isCorrect) {
                    if (chosenAction === 'discard') {
                        throwItemToTrash(ingElem);
                        await fail("„ÅÇÔºÅ„Å≤„Å§„Çà„ÅÜ„Å™„ÇÇ„ÅÆ„Çí„Åô„Å¶„Å°„ÇÉ„Å£„ÅüÔºÅ");
                        return;
                    } else if (chosenAction === 'grill' && resultKey === 'burnt_bun') {
                        ingElem.innerHTML = `<img src="${INGREDIENTS['burnt_bun'].img}">`;
                        await fail("„Éë„É≥„ÇíÁÑº„ÅÑ„Åü„Çâ „Åæ„Å£„Åè„Çç„Ç≥„Ç≤„Å´„Å™„Å£„Å°„ÇÉ„Å£„ÅüÔºÅ");
                        return;
                    } else if (chosenAction === 'stack' && (ingKey === 'trash' || ingKey === 'bug_lettuce')) {
                        await moveElement(ingElem, '80%', 1000);
                        addToStack(ingKey);
                        await fail("„ÅÇÔºÅ„Ç¥„Éü„ÅåÂÖ•„Å£„Å°„ÇÉ„Å£„ÅüÔºÅ");
                        return;
                    } else if (chosenAction === 'stack' && ingKey === 'meat') {
                        await moveElement(ingElem, '80%', 1000);
                        addToStack(ingKey);
                        await fail("„ÅäËÇâ„ÅåÁîü„Å†„ÇàÔºÅ„ÇÑ„Åã„Å™„ÅÑ„Å®ÔºÅ");
                        return;
                    } else {
                        await fail("Ë™øÁêÜ„ÅÆ„Åó„Åã„Åü„Åå „Å°„Åå„ÅÜ„Åø„Åü„ÅÑ...");
                        return;
                    }
                }

                if (chosenAction === 'discard') {
                    throwItemToTrash(ingElem);
                } else {
                    if (resultKey && INGREDIENTS[resultKey]) {
                        ingElem.innerHTML = `<img src="${INGREDIENTS[resultKey].img}">`;
                    }

                    ingElem.style.opacity = 0;
                    addToStack(resultKey);

                    await new Promise(r => setTimeout(r, 500));
                    ingElem.remove();
                }
            }

            await new Promise(r => setTimeout(r, 500));
            await clearStage();
            isRunning = false;
        }

        function moveElement(el, targetLeft, duration) {
            return new Promise(resolve => {
                el.animate([
                    { left: el.style.left },
                    { left: targetLeft }
                ], {
                    duration: duration,
                    fill: 'forwards',
                    easing: 'linear'
                }).onfinish = () => {
                    el.style.left = targetLeft;
                    resolve();
                };
            });
        }

        async function robotAction(action) {
            const robot = document.getElementById('robot');
            robot.style.transform = "translateX(-50%) scaleY(0.8)";
            await new Promise(r => setTimeout(r, 200));

            if (action === 'grill') {
                const fire = document.createElement('div');
                fire.innerText = 'üî•';
                fire.style.position = 'absolute';
                fire.style.left = '50%';
                fire.style.bottom = '80px';
                fire.style.fontSize = '40px';
                fire.style.transform = 'translateX(-50%)';
                document.querySelector('.stage-area').appendChild(fire);
                await new Promise(r => setTimeout(r, 500));
                fire.remove();
            } else {
                await new Promise(r => setTimeout(r, 300));
            }

            robot.style.transform = "translateX(-50%) scaleY(1)";
            await new Promise(r => setTimeout(r, 200));
        }

        function throwItemToTrash(el) {
            el.animate([
                { top: el.style.top, left: el.style.left, opacity: 1 },
                { top: '80%', left: '90%', opacity: 0 }
            ], {
                duration: 500,
                fill: 'forwards'
            }).onfinish = () => el.remove();
        }

        function addToStack(key) {
            if (!key) return;
            const stack = document.getElementById('stack');
            const item = document.createElement('div');
            item.className = 'stack-item';
            item.innerHTML = `<img src="${INGREDIENTS[key].img}">`;
            stack.appendChild(item);
        }

        async function fail(msg) {
            document.getElementById('fail-reason').innerText = msg;
            document.getElementById('fail-screen').style.display = 'flex';
            isRunning = false;
        }

        async function clearStage() {
            document.getElementById('result-screen').style.display = 'flex';
        }

        function nextStage() {
            if (currentStageIndex < STAGES.length - 1) {
                loadStage(currentStageIndex + 1);
            } else {
                alert("„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ„Åú„Çì„Å∂„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Çí„ÇØ„É™„Ç¢„Åó„Åü„ÇàÔºÅ");

                if (typeof showPointGetDialog === 'function') {
                    showPointGetDialog(50);
                }
                loadStage(0);
            }
        }
    </script>
    <script src="ranking.js"></script>
</body>

</html>