<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã˜ã¾ã‚“ã¯ ã»ã©ã»ã©ã«ï¼Ÿ | ã‚³ã‚³ãƒ­ã®ã‚¯ã‚¨ã‚¹ãƒˆ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #e8f5e9 100%);
            /* ã‚„ã•ã—ã„ã‚°ãƒªãƒ¼ãƒ³ç³» */
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼†ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
        .header {
            flex-shrink: 0;
            margin-bottom: 10px;
        }

        .back-btn {
            display: inline-block;
            text-decoration: none;
            color: #888;
            font-size: 14px;
            background: white;
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }

        .meter-box {
            background: white;
            padding: 12px 15px;
            border-radius: 20px;
            border: 4px solid #81c784;
            box-shadow: 0 4px 0 #66bb6a;
            text-align: center;
        }

        .meter-title {
            font-size: 15px;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .meter-bg {
            background: #eee;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            border: inset 2px rgba(0, 0, 0, 0.1);
        }

        .meter-bar {
            height: 100%;
            width: 0%;
            background: #4caf50;
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color 0.4s;
        }

        .meter-text {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
            font-weight: bold;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ã‚¨ãƒªã‚¢ */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º */
        .char-display {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 10px;
            min-height: 160px;
        }

        .char-img {
            max-height: 180px;
            object-fit: contain;
            animation: float 2.5s infinite ease-in-out;
            display: none;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.15));
        }

        .emoji-avatar {
            font-size: 55px;
            width: 130px;
            height: 130px;
            background: #fff;
            border: 6px solid #81c784;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            line-height: 1;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: popIn 0.3s ease-out;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
        .msg-box {
            background: white;
            border: 5px solid #81c784;
            border-radius: 20px;
            padding: 25px 20px 20px;
            position: relative;
            min-height: 130px;
            margin-bottom: 10px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.05);
        }

        .msg-name {
            position: absolute;
            top: -16px;
            left: 20px;
            background: #66bb6a;
            color: white;
            padding: 4px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 15px;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .msg-text {
            font-size: 19px;
            line-height: 1.6;
            color: #333;
            font-weight: bold;
        }

        ruby rt {
            font-size: 10px;
            color: #777;
            font-weight: normal;
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        .options-box {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
            display: none;
        }

        .option-btn {
            background: white;
            border: 4px solid #aed581;
            padding: 16px;
            border-radius: 18px;
            font-size: 17px;
            font-weight: bold;
            color: #333;
            text-align: left;
            box-shadow: 0 5px 0 #8bc34a;
            cursor: pointer;
            line-height: 1.5;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .option-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        /* æ¬¡ã¸ãƒœã‚¿ãƒ³ */
        .next-btn {
            background: #66bb6a;
            color: white;
            border: none;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 6px 0 #4caf50;
            transition: 0.1s;
            display: none;
            margin-bottom: 20px;
        }

        .next-btn:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        /* ãƒã‚¤ãƒ³ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .point-popup {
            position: absolute;
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
            text-shadow: 2px 2px 0 white, -2px -2px 0 white, 2px -2px 0 white, -2px 2px 0 white;
            pointer-events: none;
            animation: floatUp 1s forwards ease-out;
            z-index: 100;
            left: 50%;
            top: 30%;
            transform: translateX(-50%);
        }

        .point-popup.negative {
            color: #f44336;
        }

        @keyframes floatUp {
            0% {
                transform: translate(-50%, 0) scale(0.5);
                opacity: 1;
            }

            50% {
                transform: translate(-50%, -30px) scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -60px) scale(1);
                opacity: 0;
            }
        }

        /* ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”¨ */
        .ending-box {
            text-align: center;
            padding: 20px 10px;
            background: white;
            border-radius: 20px;
            border: 4px solid #81c784;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.05);
            display: none;
            margin-top: 20px;
        }

        .ending-icon {
            font-size: 70px;
            margin-bottom: 15px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .ending-title {
            font-size: 26px;
            color: #388e3c;
            margin-bottom: 15px;
        }

        .ending-text {
            font-size: 18px;
            line-height: 1.6;
            font-weight: bold;
            margin-bottom: 25px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <a href="hub.html" class="back-btn">â† ã‚‚ã©ã‚‹</a>
            <div class="meter-box">
                <div class="meter-title">ã¿ã‚“ãªã® ãƒ‹ã‚³ãƒ‹ã‚³ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
                <div class="meter-bg">
                    <div class="meter-bar" id="meter-bar"></div>
                </div>
                <div class="meter-text" id="meter-text">0 / 100</div>
            </div>
        </div>

        <div class="game-area" id="game-area">
            <div class="char-display" id="char-display">
                <img src="../hi-192.webp" id="char-img" class="char-img" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">
                <div id="char-icon" class="emoji-avatar">ğŸ¶ğŸ¹</div>
            </div>

            <div class="msg-box" id="msg-box">
                <div class="msg-name" id="msg-name">ãƒ’ãƒ¼ã¡ã‚ƒã‚“</div>
                <div class="msg-text" id="msg-text">ãƒ†ã‚­ã‚¹ãƒˆ</div>
            </div>

            <div class="options-box" id="options-box"></div>

            <button class="next-btn" id="next-btn" onclick="nextStep()">æ¬¡ï¼ˆã¤ãï¼‰ã¸ â–¶</button>

            <div class="ending-box" id="ending-box">
                <div class="ending-icon" id="ending-icon">ğŸ¶ğŸ¹âœ¨</div>
                <h2 class="ending-title" id="ending-title">ã‚¿ã‚¤ãƒˆãƒ«</h2>
                <div class="ending-text" id="ending-text">ãƒ†ã‚­ã‚¹ãƒˆ</div>

                <button class="next-btn" id="point-btn"
                    style="display:none; margin-top:10px; background:#4CAF50; box-shadow: 0 6px 0 #388E3C;"
                    onclick="getPoints()">ğŸ ãƒã‚¤ãƒ³ãƒˆã‚’ã‚‚ã‚‰ã†</button>

                <button class="next-btn" style="display:block; margin-top:15px;" onclick="location.reload()">ã‚‚ã†<ruby>ä¸€åº¦
                        <rt>ã„ã¡ã©</rt>
                    </ruby>ã‚ãã¶ â†»</button>
                <a href="hub.html" style="display:block; margin-top:20px; color:#888; text-decoration:none;">â†
                    ãƒãƒ–ã«<ruby>æˆ»<rt>ã‚‚ã©</rt></ruby>ã‚‹</a>
            </div>
        </div>
    </div>

    <script src="../ranking.js"></script>
    <script>
        const chars = {
            hi: { name: "ãƒ’ãƒ¼ã¡ã‚ƒã‚“", type: "img", src: "../hi-192.webp", color: "#ff9800", border: "#ffb74d" },
            an: { name: "ã‚¢ãƒ³ã¡ã‚ƒã‚“", type: "img", src: "../an192.webp", color: "#e91e63", border: "#f48fb1" },
            friends: { name: "ãŠã¨ã‚‚ã ã¡", type: "emoji", src: "ğŸ¶ğŸ¹", color: "#4caf50", border: "#81c784" }
        };

        // ã‚¹ã‚³ã‚¢ãŒ20+20+20+40 = 100ç‚¹ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´
        const scenario = [
            // --- 1. ãã£ã‹ã‘ ---
            {
                type: "msg", speaker: "hi",
                text: "ã‚„ã£ãŸãƒ¼ï¼ãƒ†ã‚¹ãƒˆã§ï¼‘ï¼ï¼<ruby>ç‚¹<rt>ã¦ã‚“</rt></ruby>ã¨ã£ãŸããƒ¼ï¼"
            },
            {
                type: "msg", speaker: "friends",
                text: "ã‚ãã€ãƒ’ãƒ¼ã¡ã‚ƒã‚“ã†ã‚Œã—ãã†ã ã­ï¼ã©ã†ã—ãŸã®ï¼Ÿ"
            },
            // --- 2. ã‚¹ãƒ†ãƒƒãƒ—1ï¼šå–œã³ã®ä¼ãˆæ–¹ ---
            {
                type: "question", speaker: "hi",
                text: "ï¼ˆã©ã†ã‚„ã£ã¦<ruby>å ±å‘Š<rt>ã»ã†ã“ã</rt></ruby>ã—ã‚ˆã†ã‹ãªï¼Ÿï¼‰",
                options: [
                    { text: "ã€Œãˆã£ã¸ã‚“ï¼<ruby>åƒ•<rt>ã¼ã</rt></ruby>ãŒ<ruby>ä¸€ç•ª<rt>ã„ã¡ã°ã‚“</rt></ruby>ã‹ã—ã“ã„ã‹ã‚‰ã­ï¼ã¿ã‚“ãªã¯ã¾ã ã¾ã ã ã­ï¼ã€", score: -10, response_speaker: "friends", response_text: "ã†ãƒ¼ã‚“â€¦ãã‚“ãª<ruby>è¨€<rt>ã„</rt></ruby>ã„<ruby>æ–¹<rt>ã‹ãŸ</rt></ruby>ã—ãªãã¦ã‚‚ã„ã„ã®ã«ã€‚" },
                    { text: "ï¼ˆãƒ†ã‚¹ãƒˆã‚’<ruby>éš <rt>ã‹ã</rt></ruby>ã—ã¦ï¼‰ã€Œã¹ã¤ã«ã€ãªã‚“ã§ã‚‚ãªã„ã‚ˆâ€¦ã€", score: 0, response_speaker: "friends", response_text: "ãˆã£ã€ãã†ãªã®ï¼Ÿã†ã‚Œã—ãã†ã«è¦‹ãˆãŸã‚“ã ã‘ã©ãªã€‚" },
                    { text: "ã€ŒãŒã‚“ã°ã£ã¦<ruby>å‹‰å¼·<rt>ã¹ã‚“ãã‚‡ã†</rt></ruby>ã—ãŸã‹ã‚‰ã€ï¼‘ï¼ï¼<ruby>ç‚¹<rt>ã¦ã‚“</rt></ruby>ã¨ã‚Œã¦ã™ã”ãã†ã‚Œã—ã„ã‚“ã ï¼ã€", score: 20, response_speaker: "friends", response_text: "ã™ã”ãƒ¼ã„ï¼ãƒ’ãƒ¼ã¡ã‚ƒã‚“ãŒã‚“ã°ã£ã¦ãŸã‚‚ã‚“ã­ï¼" }
                ]
            },
            // --- 3. ã‚¹ãƒ†ãƒƒãƒ—2ï¼šè‡ªåˆ†ä¸­å¿ƒã«ãªã£ã¦ãªã„ï¼Ÿ ---
            {
                type: "msg", speaker: "friends",
                text: "ã†ã†ã£â€¦ã‚ãŸã—ã¯ï¼”ï¼<ruby>ç‚¹<rt>ã¦ã‚“</rt></ruby>ã ã£ãŸã‚ˆã€‚ãŸãã•ã‚“<ruby>é–“é•<rt>ã¾ã¡ãŒ</rt></ruby>ãˆã¡ã‚ƒã£ãŸâ€¦ã€‚"
            },
            {
                type: "msg", speaker: "an",
                text: "ã¡ã‚‡ã£ã¨<ruby>å¾…<rt>ã¾</rt></ruby>ã£ã¦ãƒ’ãƒ¼ã¡ã‚ƒã‚“ï¼ãŠã¨ã‚‚ã ã¡ãŒ<ruby>è½<rt>ãŠ</rt></ruby>ã¡è¾¼ï¼ˆã“ï¼‰ã‚“ã§ã„ã‚‹ã¨ãã¯ã€ã€<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ãŒ<ruby>åŒ<rt>ãŠãª</rt></ruby>ã˜ã“ã¨ã‚’<ruby>è¨€<rt>ã„</rt></ruby>ã‚ã‚ŒãŸã‚‰ã©ã†<ruby>æ€<rt>ãŠã‚‚</rt></ruby>ã†ã‹ãªï¼Ÿã€ã£ã¦<ruby>è€ƒ<rt>ã‹ã‚“ãŒ</rt></ruby>ãˆã¦ã¿ã¦ã€‚"
            },
            {
                type: "question", speaker: "hi",
                text: "ï¼ˆ<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ãŒï¼”ï¼<ruby>ç‚¹<rt>ã¦ã‚“</rt></ruby>ã§<ruby>æ‚²<rt>ã‹ãª</rt></ruby>ã—ã„ã¨ãã€ï¼‘ï¼0<ruby>ç‚¹<rt>ã¦ã‚“</rt></ruby>ã®<ruby>å­<rt>ã“</rt></ruby>ã«<ruby>è‡ªæ…¢<rt>ã˜ã¾ã‚“</rt></ruby>ã•ã‚ŒãŸã‚‰ã©ã†<ruby>æ€<rt>ãŠã‚‚</rt></ruby>ã†ã‹ãªâ€¦ï¼Ÿï¼‰",
                options: [
                    { text: "ã€Œãœã‚“ãœã‚“<ruby>æ°—<rt>ã</rt></ruby>ã«ã—ãªã„ã‚ˆï¼ã€", score: -10, response_speaker: "an", response_text: "ã»ã‚“ã¨ã†ã«ï¼Ÿ<ruby>æ‚²<rt>ã‹ãª</rt></ruby>ã—ã„<ruby>æ°—æŒ<rt>ãã‚‚</rt></ruby>ã¡ã«ãªã‚‹<ruby>å­<rt>ã“</rt></ruby>ã®ã»ã†ãŒãŠãŠã„ã‚ã€‚" },
                    { text: "ã€Œ<ruby>å°‘<rt>ã™ã“</rt></ruby>ã—ã ã‘<ruby>æ‚²<rt>ã‹ãª</rt></ruby>ã—ã„ã‹ã‚‚â€¦ã€", score: 10, response_speaker: "an", response_text: "ãã†ã­ã€‚ã ã‹ã‚‰ã€<ruby>ç›¸æ‰‹<rt>ã‚ã„ã¦</rt></ruby>ã‚’<ruby>æ€<rt>ãŠã‚‚</rt></ruby>ã„ã‚„ã‚‹ã“ã¨ãŒ<ruby>å¿…è¦<rt>ã²ã¤ã‚ˆã†</rt></ruby>ã‚ˆã­ã€‚" },
                    { text: "ã€Œãªã‚“ã ã‹<ruby>å«Œ<rt>ã„ã‚„</rt></ruby>ãª<ruby>æ°—åˆ†<rt>ãã¶ã‚“</rt></ruby>ã«ãªã‚‹ã—ã€<ruby>è<rt>ã</rt></ruby>ããŸããªã„ãªâ€¦ã€", score: 20, response_speaker: "an", response_text: "ãã®<ruby>é€š<rt>ã¨ãŠ</rt></ruby>ã‚Šï¼<ruby>å„ª<rt>ã‚„ã•</rt></ruby>ã—ã„<ruby>è¨€è‘‰<rt>ã“ã¨ã°</rt></ruby>ã‚’ãˆã‚‰ã‚“ã§ã‚ã’ã¦ã­ã€‚" }
                ]
            },
            // --- 4. ã‚¹ãƒ†ãƒƒãƒ—3ï¼šç›¸æ‰‹ã¸ã®é…æ…® ---
            {
                type: "msg", speaker: "hi",
                text: "ï¼ˆã‚ˆã—ï¼ãŠã¨ã‚‚ã ã¡ã®<ruby>æ°—æŒ<rt>ãã‚‚</rt></ruby>ã¡ã‚’<ruby>è€ƒ<rt>ã‹ã‚“ãŒ</rt></ruby>ãˆã¦ã€<ruby>å£°<rt>ã“ãˆ</rt></ruby>ã‚’ã‹ã‘ã‚ˆã†ï¼ï¼‰"
            },
            {
                type: "question", speaker: "hi",
                text: "ï¼ˆãªã‚“ã¦<ruby>å£°<rt>ã“ãˆ</rt></ruby>ã‚’ã‹ã‘ã‚ˆã†ã‹ãªï¼Ÿï¼‰",
                options: [
                    { text: "ã€Œï¼”ï¼<ruby>ç‚¹<rt>ã¦ã‚“</rt></ruby>ï¼Ÿã‚‚ã£ã¨<ruby>å‹‰å¼·<rt>ã¹ã‚“ãã‚‡ã†</rt></ruby>ã—ãªã„ã¨ãƒ€ãƒ¡ã ã‚ˆï¼ã€", score: -10, response_speaker: "friends", response_text: "ãã‚“ãªâ€¦ã²ã©ã„ã‚ˆâ€¦ã€‚ï¼ˆãã™ã‚“ï¼‰" },
                    { text: "ã€Œãã£ã‹â€¦ã–ã‚“ã­ã‚“ã ã£ãŸã­ã€", score: 10, response_speaker: "friends", response_text: "ã†ã‚“â€¦<ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã¯ãŒã‚“ã°ã‚‹ã­ã€‚" },
                    { text: "ã€Œ<ruby>ä»Šå›<rt>ã“ã‚“ã‹ã„</rt></ruby>ã®ãƒ†ã‚¹ãƒˆã€<ruby>é›£<rt>ã‚€ãšã‹</rt></ruby>ã—ã‹ã£ãŸã‚ˆã­ï¼<ruby>åƒ•<rt>ã¼ã</rt></ruby>ã‚‚ãŸãã•ã‚“ãªã‚„ã‚“ã ã‚ˆã€", score: 20, response_speaker: "friends", response_text: "ã»ã‚“ã¨ã†ï¼Ÿãƒ’ãƒ¼ã¡ã‚ƒã‚“ã‚‚<ruby>é›£<rt>ã‚€ãšã‹</rt></ruby>ã—ã‹ã£ãŸã‚“ã ã­â€¦ã€‚" }
                ]
            },
            // --- 5. ã‚¹ãƒ†ãƒƒãƒ—4ï¼šæœ€å¾Œã®ãƒ•ã‚©ãƒ­ãƒ¼ ---
            {
                type: "msg", speaker: "friends",
                text: "<ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã®ãƒ†ã‚¹ãƒˆã¯ã€ã‚‚ã£ã¨ã„ã„<ruby>ç‚¹æ•°<rt>ã¦ã‚“ã™ã†</rt></ruby>ã‚’ã¨ã‚ŠãŸã„ãªâ€¦ã€‚"
            },
            {
                type: "question", speaker: "hi",
                text: "ï¼ˆãŠã¨ã‚‚ã ã¡ãŒ<ruby>å…ƒæ°—<rt>ã’ã‚“ã</rt></ruby>ã«ãªã‚‹ã‚ˆã†ã«ã€ãªã‚“ã¦<ruby>è¨€<rt>ã„</rt></ruby>ãŠã†ï¼Ÿï¼‰",
                options: [
                    { text: "ã€Œ<ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã‚‚<ruby>åƒ•<rt>ã¼ã</rt></ruby>ãŒï¼‘ï¼ï¼<ruby>ç‚¹<rt>ã¦ã‚“</rt></ruby>ã¨ã‚‹ã‚ˆï¼ã€", score: -10, response_speaker: "friends", response_text: "ã†ã‚“ã€ã‚ã‹ã£ãŸã‚ˆâ€¦ã€‚" },
                    { text: "ã€ŒãŒã‚“ã°ã£ã¦ã­ï¼ã€", score: 10, response_speaker: "friends", response_text: "ã†ã‚“ã€ã‚ã‚ŠãŒã¨ã†ã€‚" },
                    { text: "ã€Œã‚‚ã—ã‚ˆã‹ã£ãŸã‚‰ã€<ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã¯<ruby>ä¸€ç·’<rt>ã„ã£ã—ã‚‡</rt></ruby>ã«<ruby>å‹‰å¼·<rt>ã¹ã‚“ãã‚‡ã†</rt></ruby>ã—ã‚ˆã†ï¼ãŠ<ruby>äº’<rt>ãŸãŒ</rt></ruby>ã„ãŒã‚“ã°ã‚ã†ã­ï¼ã€", score: 40, response_speaker: "friends", response_text: "ãˆã£ã€ã»ã‚“ã¨ã†ï¼ï¼Ÿã‚ã‚ŠãŒã¨ã†ãƒ’ãƒ¼ã¡ã‚ƒã‚“ï¼ãœã£ãŸã„<ruby>ä¸€ç·’<rt>ã„ã£ã—ã‚‡</rt></ruby>ã«ã—ã‚ˆã†ã­ï¼" }
                ]
            }
        ];

        let currentStep = 0;
        let points = 0;

        const charImg = document.getElementById("char-img");
        const charIcon = document.getElementById("char-icon");
        const msgBox = document.getElementById("msg-box");
        const msgName = document.getElementById("msg-name");
        const msgText = document.getElementById("msg-text");
        const optionsBox = document.getElementById("options-box");
        const nextBtn = document.getElementById("next-btn");

        function renderSpeaker(speakerId) {
            const char = chars[speakerId];
            msgName.textContent = char.name;
            msgName.style.backgroundColor = char.color;
            msgBox.style.borderColor = char.border;

            if (char.type === "img") {
                charImg.src = char.src;
                charImg.style.display = "block";
                charIcon.style.display = "none";
            } else {
                charIcon.textContent = char.src;
                charIcon.style.borderColor = char.border;
                charIcon.style.display = "flex";
                charImg.style.display = "none";
            }
        }

        function advance() {
            if (currentStep >= scenario.length) {
                showEnding();
                return;
            }

            const step = scenario[currentStep];
            renderSpeaker(step.speaker);
            msgText.innerHTML = step.text;
            msgBox.style.display = "block";

            if (step.type === "msg") {
                optionsBox.style.display = "none";
                nextBtn.style.display = "block";
            } else if (step.type === "question") {
                optionsBox.innerHTML = "";
                step.options.forEach(opt => {
                    const btn = document.createElement("button");
                    btn.className = "option-btn";
                    btn.innerHTML = opt.text;
                    btn.onclick = () => selectOption(opt);
                    optionsBox.appendChild(btn);
                });
                optionsBox.style.display = "flex";
                nextBtn.style.display = "none";
            }
        }

        function selectOption(opt) {
            // ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
            points += opt.score;
            if (points < 0) points = 0;
            if (points > 100) points = 100;

            // ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°
            const bar = document.getElementById("meter-bar");
            const text = document.getElementById("meter-text");
            bar.style.width = points + "%";
            text.textContent = points + " / 100";
            if (points >= 100) bar.style.backgroundColor = "#4CAF50";
            else if (points >= 60) bar.style.backgroundColor = "#ff9800";
            else bar.style.backgroundColor = "#f44336";

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
            const popup = document.createElement("div");
            popup.className = "point-popup" + (opt.score < 0 ? " negative" : "");
            popup.textContent = (opt.score >= 0 ? "+" : "") + Math.abs(opt.score);
            document.getElementById("game-area").appendChild(popup);
            setTimeout(() => popup.remove(), 1000);

            // æ¬¡ã®åå¿œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³å¸­ã§å·®ã—è¾¼ã‚€
            scenario.splice(currentStep + 1, 0, {
                type: "msg",
                speaker: opt.response_speaker,
                text: opt.response_text
            });

            currentStep++;
            advance();
        }

        function nextStep() {
            currentStep++;
            advance();
        }

        function showEnding() {
            msgBox.style.display = "none";
            optionsBox.style.display = "none";
            nextBtn.style.display = "none";
            document.getElementById("char-display").style.display = "none";

            const endBox = document.getElementById("ending-box");
            endBox.style.display = "block";

            let title = "";
            let text = "";
            let icon = "";

            if (points >= 100) {
                title = "ğŸ‰ <ruby>å¤§æˆåŠŸ<rt>ã ã„ã›ã„ã“ã†</rt></ruby>ï¼";
                text = "ãŠã¨ã‚‚ã ã¡ã¸ã®<ruby>å„ª<rt>ã‚„ã•</rt></ruby>ã—ã•ãŒã—ã£ã‹ã‚Š<ruby>ä¼<rt>ã¤ãŸ</rt></ruby>ã‚ã£ãŸã­ï¼ã¿ã‚“ãªã‹ã‚‰ã€ŒãŠã‚ã§ã¨ã†ï¼ã€ã£ã¦<ruby>å¿ƒ<rt>ã“ã“ã‚</rt></ruby>ã‹ã‚‰ãŠ<ruby>ç¥<rt>ã„ã‚</rt></ruby>ã„ã—ã¦ã‚‚ã‚‰ãˆãŸã‚ˆï¼";
                icon = "ğŸ¶ğŸ¹âœ¨";
            } else if (points >= 60) {
                title = "ğŸ‘ <ruby>æˆåŠŸ<rt>ã›ã„ã“ã†</rt></ruby>ï¼";
                text = "<ruby>å°‘<rt>ã™ã“</rt></ruby>ã—ãšã¤ãŠã¨ã‚‚ã ã¡ã®<ruby>æ°—æŒ<rt>ãã‚‚</rt></ruby>ã¡ãŒã‚ã‹ã£ã¦ããŸã­ã€‚<ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã¯ã‚‚ã£ã¨ã‹ã£ã“ã‚ˆã<ruby>å–œ<rt>ã‚ˆã‚ã“</rt></ruby>ã¹ã‚‹ã¯ãšã ã‚ˆï¼";
                icon = "ğŸ¶ğŸ¹ğŸ‘";
            } else {
                title = "ğŸ˜¢ <ruby>å¤±æ•—<rt>ã—ã£ã±ã„</rt></ruby>â€¦";
                text = "ã†ãƒ¼ã‚“ã€ãŠã¨ã‚‚ã ã¡ãŒ<ruby>é <rt>ã¨ãŠ</rt></ruby>ãã¸<ruby>è¡Œ<rt>ã„</rt></ruby>ã£ã¡ã‚ƒã£ãŸã¿ãŸã„â€¦ã€‚ã€Œ<ruby>è‡ªåˆ†<rt>ã˜ã¶ã‚“</rt></ruby>ãŒ<ruby>è¨€<rt>ã„</rt></ruby>ã‚ã‚ŒãŸã‚‰ã©ã†<ruby>æ€<rt>ãŠã‚‚</rt></ruby>ã†ã‹ãªï¼Ÿã€ã¨ã‚‚ã†<ruby>ä¸€åº¦<rt>ã„ã¡ã©</rt></ruby> <ruby>è€ƒ<rt>ã‹ã‚“ãŒ</rt></ruby>ãˆã¦ã¿ã‚ˆã†ï¼";
                icon = "ğŸ¶ğŸ¹ğŸ’§";
            }

            document.getElementById("ending-icon").textContent = icon;
            document.getElementById("ending-title").innerHTML = title;
            document.getElementById("ending-text").innerHTML = text;

            if (points >= 60 && !pointsGiven) {
                const pointBtn = document.getElementById("point-btn");
                pointBtn.style.display = "block";
            }
        }

        let pointsGiven = false;
        function getPoints() {
            if (pointsGiven) return;
            pointsGiven = true;

            const pointBtn = document.getElementById("point-btn");
            if (pointBtn) {
                pointBtn.disabled = true;
                pointBtn.textContent = 'âœ… ã‚‚ã‚‰ã£ãŸï¼';
                pointBtn.style.backgroundColor = '#999';
                pointBtn.style.boxShadow = '0 6px 0 #777';
            }

            if (typeof showPointGetDialog === 'function') {
                showPointGetDialog(50, 'quest_stage4');
            } else {
                alert('50ãƒã‚¤ãƒ³ãƒˆ ã‚‚ã‚‰ã£ãŸã‚ˆï¼');
            }
        }

        // åˆæœŸåŒ–
        advance();

    </script>
</body>

</html>