<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ã‚ãµã‚Šç®—æ•°</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #263238;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center; /* ç”»é¢ä¸­å¤®ã«é…ç½® */
            height: 100vh; /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
            height: 100dvh; /* ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– */
            color: white;
            touch-action: manipulation;
        }

        /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã«æ ã‚’åˆ¶é™ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */
        #app-container {
            width: 100%;
            max-width: 500px; /* æ¨ªå¹…ã‚’åˆ¶é™ */
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #37474f;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-area {
            flex: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨ã¦ä½¿ã† */
            position: relative;
            background: linear-gradient(to bottom, #37474f, #455a64);
            overflow: hidden;
            border-bottom: 2px solid #546e7a;
        }

        /* ã‚¹ã‚³ã‚¢ãƒ»ãƒ©ã‚¤ãƒ•è¡¨ç¤º */
        .hud {
            position: absolute;
            top: 10px;
            left: 15px;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
        }
        .life-area {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            z-index: 10;
        }

        /* è½ã¡ã¦ãã‚‹é›« */
        .drop {
            position: absolute;
            width: 60px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            color: #0d47a1;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 120'%3E%3Cpath d='M50 0 C50 0 5 40 5 75 C5 100 25 120 50 120 C75 120 95 100 95 75 C95 40 50 0 50 0 Z' fill='%23e3f2fd' stroke='%2390caf9' stroke-width='2'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            text-shadow: 0 0 2px white;
            padding-top: 15px;
            box-sizing: border-box;
            will-change: top; /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š */
        }
        .drop.hit {
            transform: scale(1.5);
            opacity: 0;
            transition: all 0.2s;
        }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        #controls {
            /* å›ºå®šé«˜ã•ã§ã¯ãªãã€å†…å®¹ã«åˆã‚ã›ã¦æœ€å°é™ã®é«˜ã•ã‚’ç¢ºä¿ */
            flex-shrink: 0; 
            background: #fff;
            padding: 10px 10px 20px 10px; /* ä¸‹ã«å°‘ã—ä½™ç™½ */
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            z-index: 20;
        }

        /* ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ */
        #keypad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
            height: 180px; /* é«˜ã•ã‚’æŒ‡å®šã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢ */
        }

        .key-btn {
            background: white;
            border: 2px solid #cfd8dc;
            border-radius: 12px;
            font-size: 28px;
            font-weight: bold;
            color: #455a64;
            cursor: pointer;
            box-shadow: 0 4px #b0bec5;
            touch-action: manipulation;
            transition: 0.1s;
            /* ã‚¿ãƒƒãƒ—æ™‚ã®é’ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ */
            -webkit-tap-highlight-color: transparent;
        }
        .key-btn:active {
            background: #e3f2fd;
            transform: translateY(3px);
            box-shadow: 0 1px #b0bec5;
            border-color: #2196f3;
            color: #2196f3;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»çµæœç”»é¢ */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(38, 50, 56, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }
        .title-logo { font-size: 40px; margin-bottom: 20px; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .start-btn {
            font-size: 24px; padding: 15px 50px;
            background: #ff9800; color: white;
            border: none; border-radius: 50px;
            font-weight: bold; cursor: pointer;
            box-shadow: 0 5px #e65100;
            margin-top: 20px;
        }
        .start-btn:active { transform: scale(0.95); box-shadow: none; }

        /* ãƒ€ãƒ¡ãƒ¼ã‚¸æ¼”å‡º */
        .damage-effect {
            animation: shake 0.3s;
            box-shadow: inset 0 0 50px rgba(255, 82, 82, 0.8) !important;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

    </style>
</head>
<body>

<div id="app-container">
    <div id="game-area">
        <div class="hud">ã¨ãã¦ã‚“: <span id="score">0</span></div>
        <div class="life-area" id="life-icons">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
        <div id="drops-container"></div>
    </div>

    <div id="controls">
        <div id="keypad">
            <button class="key-btn" onclick="checkInput(1)">1</button>
            <button class="key-btn" onclick="checkInput(2)">2</button>
            <button class="key-btn" onclick="checkInput(3)">3</button>
            <button class="key-btn" onclick="checkInput(4)">4</button>
            <button class="key-btn" onclick="checkInput(5)">5</button>
            <button class="key-btn" onclick="checkInput(6)">6</button>
            <button class="key-btn" onclick="checkInput(7)">7</button>
            <button class="key-btn" onclick="checkInput(8)">8</button>
            <button class="key-btn" onclick="checkInput(9)">9</button>
            <button class="key-btn" onclick="checkInput(0)">0</button>
        </div>
    </div>

    <div id="start-screen" class="overlay">
        <div style="font-size:60px;">â˜”</div>
        <div class="title-logo">ã‚ã‚ãµã‚Š<br>ã•ã‚“ã™ã†</div>
        <p style="color:#cfd8dc;">ã“ãŸãˆã¯ ãœã‚“ã¶ 1ã‘ãŸï¼<br>ã™ã†ã˜ã‚’ ãŠã—ã¦ ã’ãã¤ã„ã›ã‚ˆï¼</p>
        <button class="start-btn" onclick="gameStart()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <br>
        <a href="index.html" style="color:#b0bec5; margin-top:20px; text-decoration: underline;">ğŸ  ã‚‚ã©ã‚‹</a>
    </div>

    <div id="gameover-screen" class="overlay" style="display:none;">
        <h1 style="color:#ff5252;">ãŠã—ã¾ã„ï¼</h1>
        <div style="font-size: 80px; margin: 10px;">ğŸ˜­</div>
        <p style="font-size:24px;">ã¨ãã¦ã‚“: <span id="final-score">0</span> ã¦ã‚“</p>
        <button class="start-btn" onclick="location.reload()">ã‚‚ã†ã„ã£ã‹ã„</button>
        <br>
        <a href="index.html" style="color:#b0bec5; margin-top:20px; text-decoration: underline;">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
    </div>
</div>

<script>
    const gameArea = document.getElementById('game-area');
    const dropsContainer = document.getElementById('drops-container');
    
    let score = 0;
    let life = 5;
    let isPlaying = false;
    let drops = []; 
    let frameCount = 0;
    let spawnRate = 120;
    
    // è½ä¸‹é€Ÿåº¦ç®¡ç†ç”¨
    let baseFallSpeed = 0.003; // ç”»é¢é«˜ã•ã«å¯¾ã™ã‚‹å‰²åˆï¼ˆ0.3%/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
    let currentFallSpeedPx = 0; // å®Ÿéš›ã®ãƒ”ã‚¯ã‚»ãƒ«é€Ÿåº¦
    let gameHeight = 0;

    let animationId;

    // åˆæœŸåŒ–ã¨ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    function resizeGame() {
        gameHeight = gameArea.clientHeight;
        // ç”»é¢ã®é«˜ã•ãŒå¤‰ã‚ã£ã¦ã‚‚ã€åˆ°é”æ™‚é–“ãŒåŒã˜ã«ãªã‚‹ã‚ˆã†ã«é€Ÿåº¦ã‚’èª¿æ•´
        // ä¾‹: é«˜ã•600pxãªã‚‰ 1.8px/frame, é«˜ã•1000pxãªã‚‰ 3.0px/frame
        currentFallSpeedPx = gameHeight * baseFallSpeed;
    }
    
    window.addEventListener('resize', resizeGame);
    // èµ·å‹•æ™‚ã«ã‚‚å®Ÿè¡Œ
    resizeGame();

    function gameStart() {
        resizeGame(); // é–‹å§‹å‰ã«ã‚‚å¿µã®ãŸã‚ã‚µã‚¤ã‚ºå–å¾—
        document.getElementById('start-screen').style.display = 'none';
        score = 0;
        life = 5;
        updateUI();
        isPlaying = true;
        gameLoop();
    }

    function gameLoop() {
        if (!isPlaying) return;

        frameCount++;

        // é›£æ˜“åº¦ä¸Šæ˜‡
        if (frameCount % 600 === 0) { 
            spawnRate = Math.max(30, spawnRate - 5);
            // é€Ÿåº¦ã‚‚å°‘ã—ãšã¤ä¸Šã’ã‚‹ï¼ˆå‰²åˆã‚’å¢—ã‚„ã™ï¼‰
            baseFallSpeed += 0.0002;
            currentFallSpeedPx = gameHeight * baseFallSpeed;
        }

        if (frameCount % spawnRate === 0) {
            spawnDrop();
        }

        moveDrops();

        animationId = requestAnimationFrame(gameLoop);
    }

    function spawnDrop() {
        const dropEl = document.createElement('div');
        dropEl.className = 'drop';
        
        let num1, num2, answer, symbol;
        
        if (Math.random() > 0.5) {
            // è¶³ã—ç®— (9ä»¥ä¸‹)
            num1 = Math.floor(Math.random() * 10);
            num2 = Math.floor(Math.random() * (10 - num1));
            answer = num1 + num2;
            symbol = "+";
        } else {
            // å¼•ãç®— (ç­”ãˆãŒ0-9)
            answer = Math.floor(Math.random() * 10);
            num2 = Math.floor(Math.random() * 10);
            num1 = answer + num2;
            symbol = "-";
        }

        dropEl.textContent = `${num1}${symbol}${num2}`;
        
        // æ¨ªä½ç½®ãƒ©ãƒ³ãƒ€ãƒ 
        const maxLeft = gameArea.clientWidth - 70;
        const x = Math.random() * maxLeft;
        
        dropEl.style.left = x + 'px';
        // ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ã¯ç”»é¢ä¸Šéƒ¨å¤–å´
        // DOMé…ç½®å¾Œã«ç§»å‹•é–‹å§‹
        dropEl.style.top = '-80px'; 

        dropsContainer.appendChild(dropEl);

        drops.push({
            el: dropEl,
            y: -80,
            ans: answer
        });
    }

    function moveDrops() {
        // ä¸‹ã«ã‚ã‚‹ï¼ˆé…åˆ—ã®å¤ã„æ–¹ï¼‰ã‹ã‚‰å‡¦ç†
        for (let i = drops.length - 1; i >= 0; i--) {
            const drop = drops[i];
            
            // è¨ˆç®—ã—ãŸé€Ÿåº¦ã§ç§»å‹•
            drop.y += currentFallSpeedPx;
            drop.el.style.top = drop.y + 'px';

            // ç”»é¢ä¸‹åˆ°é”åˆ¤å®š
            if (drop.y > gameHeight - 60) { // 60pxã¯å°‘ã—ä½™è£•ã‚’æŒãŸã›ã¦
                takeDamage();
                drop.el.remove();
                drops.splice(i, 1);
            }
        }
    }

    function checkInput(num) {
        if (!isPlaying) return;
        
        // æœ€ã‚‚ä¸‹ã«ã‚ã‚‹ï¼ˆyãŒå¤§ãã„ï¼‰æ­£è§£ã®é›«ã‚’æ¢ã™
        let targetIndex = -1;
        let maxY = -9999;

        for (let i = 0; i < drops.length; i++) {
            if (drops[i].ans === num) {
                if (drops[i].y > maxY) {
                    maxY = drops[i].y;
                    targetIndex = i;
                }
            }
        }

        if (targetIndex !== -1) {
            // æ­£è§£
            const target = drops[targetIndex];
            
            // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            target.el.classList.add('hit');
            target.el.textContent = "âœ¨"; 
            
            setTimeout(() => {
                if(target.el.parentNode) target.el.remove();
            }, 200);
            
            drops.splice(targetIndex, 1);
            score += 10;
        } else {
            // ä¸æ­£è§£æ¼”å‡º
            const bg = document.getElementById('app-container');
            bg.style.boxShadow = "inset 0 0 50px rgba(255, 255, 0, 0.5)"; // é»„è‰²ãç‚¹æ»…
            setTimeout(() => bg.style.boxShadow = "none", 100);
        }

        updateUI();
    }

    function takeDamage() {
        life--;
        updateUI();
        
        const app = document.getElementById('app-container');
        app.classList.add('damage-effect');
        setTimeout(() => app.classList.remove('damage-effect'), 300);

        if (life <= 0) {
            gameOver();
        }
    }

    function updateUI() {
        document.getElementById('score').textContent = score;
        let hearts = "";
        for(let i=0; i<life; i++) hearts += "â¤ï¸";
        document.getElementById('life-icons').textContent = hearts;
    }

    function gameOver() {
        isPlaying = false;
        cancelAnimationFrame(animationId);
        document.getElementById('final-score').textContent = score;
        document.getElementById('gameover-screen').style.display = 'flex';
        // 'rain_math' ã¯ ranking.js ã§æ±ºã‚ãŸIDã€ score ã¯ã“ã®ã‚²ãƒ¼ãƒ ã®å¾—ç‚¹å¤‰æ•°
        if(typeof showSaveDialog === 'function') {
            showSaveDialog('rain_math', score);
        }
    }

</script>
</body>
</html>