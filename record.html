<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åå„Çì„Å∞„Å£„Åü„Åç„Çç„Åè</title>
    <script src="ranking.js"></script>
    <style>
        body { 
            font-family: "UD Digital Kyokasho-tai-R", sans-serif; 
            background: #e0f7fa; 
            text-align: center; 
            padding: 20px; 
            margin: 0;
            color: #37474f;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { color: #0097a7; margin-bottom: 20px; }
        
        .user-select-area {
            background: #fff9c4;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        select { 
            padding: 12px; 
            font-size: 20px; 
            border-radius: 10px; 
            border: 2px solid #fbc02d; 
            width: 80%; 
            background: white;
            font-weight: bold;
            color: #333;
        }

        /* „Éù„Ç§„É≥„ÉàË°®Á§∫„Ç®„É™„Ç¢ */
        .point-display {
            background: linear-gradient(135deg, #ffca28, #ff6f00);
            color: white;
            padding: 15px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(255, 111, 0, 0.3);
            display: inline-block;
            min-width: 200px;
        }

        /* „Åä„Åæ„Åã„Åõ„Éú„Çø„É≥„Ç®„É™„Ç¢ */
        .auto-set-area {
            margin: 10px 0 20px 0;
        }
        .auto-btn {
            background: #29b6f6;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px #0288d1;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .auto-btn:active { transform: translateY(2px); box-shadow: none; }
        .auto-btn:hover { background: #03a9f4; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        
        th { 
            background: #f5f5f5;
            color: #777; 
            font-size: 14px; 
            padding: 10px;
        }
        
        td { 
            border-bottom: 1px solid #eee; 
            padding: 15px 5px; 
            text-align: left; 
            vertical-align: middle;
        }

        .game-name { font-weight: bold; font-size: 16px; }
        
        td.score { 
            text-align: right; 
            font-weight: bold; 
            color: #d84315; 
            font-size: 20px; 
            white-space: nowrap;
        }

        .goal-input {
            width: 70px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            font-family: inherit;
            color: #555;
            -webkit-appearance: none; /* iOS„Åß„ÅÆË¶ã„ÅüÁõÆË™øÊï¥ */
        }
        
        .goal-input:focus {
            border-color: #2196f3;
            outline: none;
            background: #e3f2fd;
        }

        /* OK„Éú„Çø„É≥ */
        .ok-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px #2e7d32;
        }
        .ok-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* ÁõÆÊ®ôÈÅîÊàêÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´ */
        tr.achieved {
            background-color: #fffde7;
        }
        tr.achieved .score {
            color: #e65100;
            text-shadow: 0 0 5px rgba(255, 167, 38, 0.4);
        }
        tr.achieved .game-name::before {
            content: 'üéâ ';
        }
        
        /* „Éú„Çø„É≥ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
        .nav-link { 
            display: inline-block; 
            margin: 10px 5px; 
            padding: 15px 30px;
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .nav-link:active { transform: translateY(2px); box-shadow: none; }

        .back-link { 
            background: #78909c;
            box-shadow: 0 4px #546e7a;
        }

        /* ËøΩÂä†ÔºöÂÖ®ÂõΩ„É©„É≥„Ç≠„É≥„Ç∞„Éú„Çø„É≥ */
        .ranking-link {
            background: #e91e63;
            box-shadow: 0 4px #c2185b;
        }

        .empty-msg { color: #aaa; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üèÜ „Åå„Çì„Å∞„Å£„Åü„Åç„Çç„Åè</h1>
        
        <div class="user-select-area">
            <p style="margin-top:0; font-weight:bold;">„Å†„Çå„ÅÆË®òÈå≤„Çí„Åø„ÇãÔºü</p>
            <select id="user-select" onchange="showRecords()">
                <option value="">(„Åà„Çâ„Çì„Åß„Å≠)</option>
            </select>
        </div>

        <div id="record-display" style="display:none;">
            <div class="point-display">
                <span style="font-size:16px;">„Éù„Ç§„É≥„Éà</span><br>
                <span id="total-points">0</span> pt
            </div>

            <div class="auto-set-area">
                <button class="auto-btn" onclick="autoSetGoals()">
                    ü§ñ ÁõÆÊ®ô„Çí„Äå„Åä„Åæ„Åã„Åõ„Äç„ÅßË®≠ÂÆö„Åô„Çã
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="text-align:left;">„Ç≤„Éº„É†</th>
                        <th style="text-align:right;">„Éô„Çπ„Éà</th>
                        <th style="text-align:center;">üéØ „ÇÇ„Åè„Å≤„Çá„ÅÜ</th>
                    </tr>
                </thead>
                <tbody id="score-list">
                    </tbody>
            </table>
        </div>
        
        <div id="empty-msg" class="empty-msg">
            „Åæ„Å† Ë®òÈå≤„Åå „ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br>„Ç≤„Éº„É†„ÅßÈÅä„Çì„Åß ‰øùÂ≠ò„Åó„Å¶„Å≠ÔºÅ
        </div>
    </div>

    <br>
    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
        <a href="open_record.html" class="nav-link ranking-link">üåè „Åú„Çì„Åì„Åè„É©„É≥„Ç≠„É≥„Ç∞„Çí„Åø„Çã</a>
        <a href="index.html" class="nav-link back-link">üè† „Éõ„Éº„É†„Å∏„ÇÇ„Å©„Çã</a>
    </div>

    <script>
        // „Ç≤„Éº„É†„Åî„Å®„ÅÆ„Éá„Éï„Ç©„É´„ÉàÁõÆÊ®ôÂÄ§ÔºàÂàùÂøÉËÄÖÂêë„ÅëÔºâ
        const DEFAULT_GOALS = {
            'sansuu': 50,      // 2ÂàÜ
            'rain': 200,         // 50ÁÇπ
            'make10': 50,      // 2ÂàÜ
            'flash_anzan': 50,  // 50ÁÇπ
            '99': 100,          // 1ÂàÜ40Áßí„Åè„Çâ„ÅÑ
            'whattime': 120,
            'triangle': 120,
            'bunsho': 100,
            'katakana': 60,
            '1gradekanji': 100,
            'alphabet': 90,
            'alphabet_read': 60,
            'romaji_quiz': 60,
            'rain_romaji': 100,
            'rain_vowel': 100,
            '100home': 100,
            'memory': 60,       // 1ÂàÜ
            'flash': 50,
            'numbers': 60,      // 1ÂàÜ
            'youji': 60,
            'kyorokyoro': 50,
            'search_count': 100,
            'count30': 50,      // Âãù„Å°ÁÇπ?
            'tsumitsumi': 50,
            'rail': 100,
            'detective': 100,
            'color_lab': 50,
            'pitch': 50,
            'rhythm': 50,
            'shopping': 90,     // 1ÂàÜ
            'water': 90         // 1ÂàÜ
        };

        window.onload = function() {
            if(typeof getUserNames !== 'function') {
                alert('ranking.js „ÅåÊ≠£„Åó„ÅèË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            const users = getUserNames(); 
            const select = document.getElementById('user-select');
            
            if (users.length > 0) {
                document.getElementById('empty-msg').style.display = 'none';
                users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u;
                    opt.innerText = u;
                    select.appendChild(opt);
                });
            }
        };

        function showRecords() {
            const userName = document.getElementById('user-select').value;
            const display = document.getElementById('record-display');
            const list = document.getElementById('score-list');
            const pointDisplay = document.getElementById('total-points');
            
            if (!userName) {
                display.style.display = 'none';
                return;
            }

            display.style.display = 'block';
            list.innerHTML = '';
            
            // „Éá„Éº„ÇøÂèñÂæó
            const allRecords = getAllRecords();
            const allGoals = getAllGoals();
            const userRecords = allRecords[userName] || {};
            const userGoals = allGoals[userName] || {};

            // „Éù„Ç§„É≥„ÉàË°®Á§∫
            pointDisplay.innerText = getUserPoints(userName);

            // „É™„Çπ„ÉàË°®Á§∫
            for (const [gameId, info] of Object.entries(GAME_LIST)) {
                const recordVal = userRecords[gameId];
                const goalVal = userGoals[gameId] || '';

                const tr = document.createElement('tr');

                // --- ÈÅîÊàêÂà§ÂÆö ---
                let isAchieved = false;
                if (recordVal !== undefined && goalVal !== '') {
                    const r = parseFloat(recordVal);
                    const g = parseFloat(goalVal);
                    if (!isNaN(r) && !isNaN(g)) {
                        if (info.type === 'score' && r >= g) isAchieved = true;
                        if (info.type === 'time' && r <= g) isAchieved = true;
                    }
                }

                if (isAchieved) {
                    tr.classList.add('achieved');
                }

                const displayVal = (recordVal !== undefined) ? `${recordVal} <span style="font-size:14px">${info.unit}</span>` : '<span style="color:#ddd; font-size:14px;">-</span>';

                const inputId = `goal-${gameId}`;
                tr.innerHTML = `
                    <td class="game-name">${info.name}</td>
                    <td class="score">${displayVal}</td>
                    <td style="text-align:center;">
                        <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                            <input type="number" id="${inputId}" class="goal-input" 
                                value="${goalVal}" 
                                placeholder="-" 
                                step="0.1"
                                onblur="updateGoal('${userName}', '${gameId}', this.value)"
                                onkeydown="if(event.key==='Enter')this.blur()">
                            <button class="ok-btn" onclick="updateGoal('${userName}', '${gameId}', document.getElementById('${inputId}').value)">OK</button>
                        </div>
                        <span style="font-size:10px; color:#999; display:block; margin-top:2px;">${info.unit}</span>
                    </td>
                `;
                list.appendChild(tr);
            }
        }

        function updateGoal(userName, gameId, value) {
            if(typeof saveGoal !== 'function') return;
            saveGoal(userName, gameId, value);
            showRecords(); 
        }

        // ‚ñº‚ñº‚ñº „Åä„Åæ„Åã„ÅõË®≠ÂÆö„É≠„Ç∏„ÉÉ„ÇØ ‚ñº‚ñº‚ñº
        function autoSetGoals() {
            const userName = document.getElementById('user-select').value;
            if(!userName) return;

            const confirmMsg = "ÁõÆÊ®ô„Çí„Äå„Åä„Åæ„Åã„Åõ„Äç„ÅßË®≠ÂÆö„Åó„Åæ„Åô„ÅãÔºü\n\n„ÉªÈÅîÊàê„Åó„Åü„ÇÇ„ÅÆ„ÅØ„ÄÅ„Éô„Çπ„ÉàË®òÈå≤„Çà„Çä1%È´ò„Åè\n„ÉªÊú™ÈÅîÊàê„ÅÆ„ÇÇ„ÅÆ„ÅØ„Åù„ÅÆ„Åæ„Åæ\n„ÉªË®òÈå≤„Åå„Å™„ÅÑ„ÇÇ„ÅÆ„ÅØÊ®ôÊ∫ñ„É¨„Éô„É´„Å´\n\nË®≠ÂÆö„Åï„Çå„Åæ„Åô„ÄÇ";
            if(!confirm(confirmMsg)) return;

            const userRecords = getAllRecords()[userName] || {};
            const userGoals = getAllGoals()[userName] || {};
            let isChanged = false;

            for (const [gameId, info] of Object.entries(GAME_LIST)) {
                const record = parseFloat(userRecords[gameId]);
                const goal = parseFloat(userGoals[gameId]);
                const hasRecord = !isNaN(record);
                const hasGoal = !isNaN(goal);

                let newGoal = null;

                // 1. ÈÅîÊàêÊ∏à„ÅøÂà§ÂÆöÔºà„Åæ„Åü„ÅØË®òÈå≤„ÅÇ„Çã„ÅÆ„Å´ÁõÆÊ®ô„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ
                let isAchieved = false;
                if (hasRecord) {
                    if (!hasGoal) {
                        isAchieved = true; // ÁõÆÊ®ô„Åå„Å™„ÅÑ„Å™„ÇâÈÅîÊàêÊâ±„ÅÑÔºà„Éô„Çπ„ÉàÂü∫Ê∫ñ„ÅßË®≠ÂÆö„Åô„ÇãÔºâ
                    } else {
                        if (info.type === 'score' && record >= goal) isAchieved = true;
                        if (info.type === 'time' && record <= goal) isAchieved = true;
                    }
                }

                // „É≠„Ç∏„ÉÉ„ÇØÂàÜÂ≤ê
                if (isAchieved) {
                    // ‚òÖ 1%„Å†„ÅëÈ´ò„ÅèË®≠ÂÆöÔºàÂçò‰ΩçÊú™Ê∫Ä„ÅØÁπ∞„Çä‰∏ä„ÅíÔºâ
                    if (info.type === 'score') {
                        // „Çπ„Ç≥„Ç¢Ôºö1%Â¢ó„ÇÑ„Åô
                        let increase = record * 0.01;
                        if (increase < 1) increase = 1; // ÊúÄÂ∞è1ÁÇπ„ÅØ‰∏ä„Åí„Çã
                        newGoal = Math.ceil(record + increase); 
                    } else {
                        // „Çø„Ç§„É†Ôºö1%Ê∏õ„Çâ„ÅôÔºàÈÄü„Åè„Åô„ÇãÔºâ
                        let decrease = record * 0.01;
                        if (decrease < 0.1) decrease = 0.1; // ÊúÄÂ∞è0.1Áßí„ÅØÈÄü„Åè„Åô„Çã
                        newGoal = parseFloat((record - decrease).toFixed(1));
                        if (newGoal < 0) newGoal = 0;
                    }

                } else if (!hasRecord && !hasGoal) {
                    // ‚òÖ Ë®òÈå≤„ÇÇÁõÆÊ®ô„ÇÇ„Å™„ÅÑ ‚Üí „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
                    newGoal = DEFAULT_GOALS[gameId] || (info.type === 'time' ? 60 : 50);
                }
                // ‚Äª Êú™ÈÅîÊàê„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà‰ªä„ÅÆÁõÆÊ®ô„ÇíÁ∂≠ÊåÅÔºâ

                // ‰øùÂ≠ò
                if (newGoal !== null) {
                    saveGoal(userName, gameId, newGoal);
                    isChanged = true;
                }
            }

            if (isChanged) {
                showRecords();
                alert("ÁõÆÊ®ô„ÇíË®≠ÂÆö„Åó„Åæ„Åó„ÅüÔºÅ\n„Åå„Çì„Å∞„Å£„Å¶Ë®òÈå≤Êõ¥Êñ∞„ÇíÁõÆÊåá„Åó„Å¶„Å≠ÔºÅ");
            } else {
                alert("Â§âÊõ¥„ÅåÂøÖË¶Å„Å™ÁõÆÊ®ô„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n‰ªä„ÅÆÁõÆÊ®ô„Å´Âêë„Åã„Å£„Å¶„Åå„Çì„Å∞„Çç„ÅÜÔºÅ");
            }
        }
    </script>
</body>
</html>