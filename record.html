<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŒã‚“ã°ã£ãŸãã‚ã</title>
    <script src="ranking.js"></script>
    <style>
        body { 
            font-family: "UD Digital Kyokasho-tai-R", sans-serif; 
            background: #e0f7fa; 
            text-align: center; 
            padding: 20px; 
            margin: 0;
            color: #37474f;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { color: #0097a7; margin-bottom: 20px; }
        
        .user-select-area {
            background: #fff9c4;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        select { 
            padding: 12px; 
            font-size: 20px; 
            border-radius: 10px; 
            border: 2px solid #fbc02d; 
            width: 80%; 
            background: white;
            font-weight: bold;
            color: #333;
        }

        /* ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .point-display {
            background: linear-gradient(135deg, #ffca28, #ff6f00);
            color: white;
            padding: 15px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(255, 111, 0, 0.3);
            display: inline-block;
            min-width: 200px;
        }

        /* ãŠã¾ã‹ã›ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .auto-set-area {
            margin: 10px 0 20px 0;
        }
        .auto-btn {
            background: #29b6f6;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px #0288d1;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .auto-btn:active { transform: translateY(2px); box-shadow: none; }
        .auto-btn:hover { background: #03a9f4; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        
        th { 
            background: #f5f5f5;
            color: #777; 
            font-size: 14px; 
            padding: 10px;
        }
        
        td { 
            border-bottom: 1px solid #eee; 
            padding: 15px 5px; 
            text-align: left; 
            vertical-align: middle;
        }

        .game-name { font-weight: bold; font-size: 16px; }
        
        td.score { 
            text-align: right; 
            font-weight: bold; 
            color: #d84315; 
            font-size: 20px; 
            white-space: nowrap;
        }

        .goal-input {
            width: 70px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            font-family: inherit;
            color: #555;
            -webkit-appearance: none; /* iOSã§ã®è¦‹ãŸç›®èª¿æ•´ */
        }
        
        .goal-input:focus {
            border-color: #2196f3;
            outline: none;
            background: #e3f2fd;
        }

        /* OKãƒœã‚¿ãƒ³ */
        .ok-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px #2e7d32;
        }
        .ok-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* ç›®æ¨™é”æˆæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        tr.achieved {
            background-color: #fffde7;
        }
        tr.achieved .score {
            color: #e65100;
            text-shadow: 0 0 5px rgba(255, 167, 38, 0.4);
        }
        tr.achieved .game-name::before {
            content: 'ğŸ‰ ';
        }
        
        /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .nav-link { 
            display: inline-block; 
            margin: 10px 5px; 
            padding: 15px 30px;
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .nav-link:active { transform: translateY(2px); box-shadow: none; }

        .back-link { 
            background: #78909c;
            box-shadow: 0 4px #546e7a;
        }

        /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .delete-btn {
            background: #eceff1;
            color: #b0bec5;
            border: none;
            border-radius: 50%;
            width: 30px; 
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
            transition: 0.2s;
            vertical-align: middle;
        }
        .delete-btn:hover {
            background: #ffcdd2;
            color: #d32f2f;
        }



        /* è¿½åŠ ï¼šå…¨å›½ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
        .ranking-link {
            background: #e91e63;
            box-shadow: 0 4px #c2185b;
        }

        .empty-msg { color: #aaa; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ† ãŒã‚“ã°ã£ãŸãã‚ã</h1>
        
        <div class="user-select-area">
            <p style="margin-top:0; font-weight:bold;">ã ã‚Œã®è¨˜éŒ²ã‚’ã¿ã‚‹ï¼Ÿ</p>
            <select id="user-select" onchange="showRecords()">
                <option value="">(ãˆã‚‰ã‚“ã§ã­)</option>
            </select>
        </div>

        <div id="record-display" style="display:none;">
            <div class="point-display">
                <span style="font-size:16px;">ãƒã‚¤ãƒ³ãƒˆ</span><br>
                <span id="total-points">0</span> pt
            </div>

            <div class="auto-set-area">
                <button class="auto-btn" onclick="autoSetGoals()">
                    ğŸ¤– ç›®æ¨™ã‚’ã€ŒãŠã¾ã‹ã›ã€ã§è¨­å®šã™ã‚‹
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="text-align:left;">ã‚²ãƒ¼ãƒ </th>
                        <th style="text-align:right;">ãƒ™ã‚¹ãƒˆ</th>
                        <th style="text-align:center;">ğŸ¯ ã‚‚ãã²ã‚‡ã†</th>
                    </tr>
                </thead>
                <tbody id="score-list">
                    </tbody>
            </table>
        </div>
        
        <div id="empty-msg" class="empty-msg">
            ã¾ã  è¨˜éŒ²ãŒ ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚²ãƒ¼ãƒ ã§éŠã‚“ã§ ä¿å­˜ã—ã¦ã­ï¼
        </div>
    </div>

    <br>
    <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
        <a href="open_record.html" class="nav-link ranking-link">ğŸŒ ãœã‚“ã“ããƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¿ã‚‹</a>
        <a href="index.html" class="nav-link back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ ã”ã¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç›®æ¨™å€¤ï¼ˆåˆå¿ƒè€…å‘ã‘ï¼‰
        const DEFAULT_GOALS = {
            'sansuu': 50,      // 2åˆ†
            'rain': 200,         // 50ç‚¹
            'make10': 50,      // 2åˆ†
            'flash_anzan': 50,  // 50ç‚¹
            '99': 100,          // 1åˆ†40ç§’ãã‚‰ã„
            'whattime': 120,
            'triangle': 120,
            'bunsho': 100,
            'katakana': 60,
            '1gradekanji': 100,
            'alphabet': 90,
            'alphabet_read': 60,
            'romaji_quiz': 60,
            'rain_romaji': 100,
            'rain_vowel': 100,
            '100home': 100,
            'memory': 60,       // 1åˆ†
            'flash': 50,
            'numbers': 60,      // 1åˆ†
            'youji': 60,
            'kyorokyoro': 50,
            'search_count': 100,
            'count30': 50,      // å‹ã¡ç‚¹?
            'tsumitsumi': 10,
            'rail': 300,
            'detective': 100,
            'color_lab': 50,
            'pitch': 50,
            'rhythm': 50,
            'shopping': 90,     // 1åˆ†
            'water': 90         // 1åˆ†
        };

        window.onload = function() {
            if(typeof getUserNames !== 'function') {
                alert('ranking.js ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            const users = getUserNames(); 
            const select = document.getElementById('user-select');
            
            if (users.length > 0) {
                document.getElementById('empty-msg').style.display = 'none';
                users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u;
                    opt.innerText = u;
                    select.appendChild(opt);
                });
            }
        };

        function showRecords() {
            const userName = document.getElementById('user-select').value;
            const display = document.getElementById('record-display');
            const list = document.getElementById('score-list');
            const pointDisplay = document.getElementById('total-points');
            
            if (!userName) {
                display.style.display = 'none';
                return;
            }

            display.style.display = 'block';
            list.innerHTML = '';
            
            // ãƒ‡ãƒ¼ã‚¿å–å¾—
            const allRecords = getAllRecords();
            const allGoals = getAllGoals();
            const userRecords = allRecords[userName] || {};
            const userGoals = allGoals[userName] || {};

            // ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
            pointDisplay.innerText = getUserPoints(userName);

            // ãƒªã‚¹ãƒˆè¡¨ç¤º
            for (const [gameId, info] of Object.entries(GAME_LIST)) {
                const recordVal = userRecords[gameId];
                const goalVal = userGoals[gameId] || '';

                const tr = document.createElement('tr');

                // --- é”æˆåˆ¤å®š ---
                let isAchieved = false;
                if (recordVal !== undefined && goalVal !== '') {
                    const r = parseFloat(recordVal);
                    const g = parseFloat(goalVal);
                    if (!isNaN(r) && !isNaN(g)) {
                        if (info.type === 'score' && r >= g) isAchieved = true;
                        if (info.type === 'time' && r <= g) isAchieved = true;
                    }
                }

                if (isAchieved) {
                    tr.classList.add('achieved');
                }

                // è¡¨ç¤ºç”¨ã®HTMLä½œæˆï¼ˆã‚¹ã‚³ã‚¢ãŒãªã„æ™‚ã¯ã€Œ-ã€ã€ã‚ã‚‹æ™‚ã¯ã€Œã‚¹ã‚³ã‚¢ï¼‹ã‚´ãƒŸç®±ã€ï¼‰
                let scoreHtml = '<span style="color:#ddd; font-size:14px;">-</span>';
                
                if (recordVal !== undefined) {
                    scoreHtml = `
                        ${recordVal} <span style="font-size:14px">${info.unit}</span>
                        <button class="delete-btn" title="è¨˜éŒ²ã‚’æ¶ˆã™" 
                            onclick="resetRecord('${userName}', '${gameId}', '${info.name}')">ğŸ—‘ï¸</button>
                    `;
                }

                const inputId = `goal-${gameId}`;
                tr.innerHTML = `
                    <td class="game-name">${info.name}</td>
                    <td class="score">${scoreHtml}</td> <td style="text-align:center;">
                        <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                            <input type="number" id="${inputId}" class="goal-input" 
                                value="${goalVal}" 
                                placeholder="-" 
                                step="0.1"
                                onblur="updateGoal('${userName}', '${gameId}', this.value)"
                                onkeydown="if(event.key==='Enter')this.blur()">
                            <button class="ok-btn" onclick="updateGoal('${userName}', '${gameId}', document.getElementById('${inputId}').value)">OK</button>
                        </div>
                        <span style="font-size:10px; color:#999; display:block; margin-top:2px;">${info.unit}</span>
                    </td>
                `;
                list.appendChild(tr);
            }
        }

        function updateGoal(userName, gameId, value) {
            if(typeof saveGoal !== 'function') return;
            saveGoal(userName, gameId, value);
            showRecords(); 
        }

        // â–¼â–¼â–¼ ãŠã¾ã‹ã›è¨­å®šãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
        function autoSetGoals() {
            const userName = document.getElementById('user-select').value;
            if(!userName) return;

            const confirmMsg = "ç›®æ¨™ã‚’ã€ŒãŠã¾ã‹ã›ã€ã§è¨­å®šã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»é”æˆã—ãŸã‚‚ã®ã¯ã€ãƒ™ã‚¹ãƒˆè¨˜éŒ²ã‚ˆã‚Š1%é«˜ã\nãƒ»æœªé”æˆã®ã‚‚ã®ã¯ãã®ã¾ã¾\nãƒ»è¨˜éŒ²ãŒãªã„ã‚‚ã®ã¯æ¨™æº–ãƒ¬ãƒ™ãƒ«ã«\n\nè¨­å®šã•ã‚Œã¾ã™ã€‚";
            if(!confirm(confirmMsg)) return;

            const userRecords = getAllRecords()[userName] || {};
            const userGoals = getAllGoals()[userName] || {};
            let isChanged = false;

            for (const [gameId, info] of Object.entries(GAME_LIST)) {
                const record = parseFloat(userRecords[gameId]);
                const goal = parseFloat(userGoals[gameId]);
                const hasRecord = !isNaN(record);
                const hasGoal = !isNaN(goal);

                let newGoal = null;

                // 1. é”æˆæ¸ˆã¿åˆ¤å®šï¼ˆã¾ãŸã¯è¨˜éŒ²ã‚ã‚‹ã®ã«ç›®æ¨™ãŒãªã„å ´åˆï¼‰
                let isAchieved = false;
                if (hasRecord) {
                    if (!hasGoal) {
                        isAchieved = true; // ç›®æ¨™ãŒãªã„ãªã‚‰é”æˆæ‰±ã„ï¼ˆãƒ™ã‚¹ãƒˆåŸºæº–ã§è¨­å®šã™ã‚‹ï¼‰
                    } else {
                        if (info.type === 'score' && record >= goal) isAchieved = true;
                        if (info.type === 'time' && record <= goal) isAchieved = true;
                    }
                }

                // ãƒ­ã‚¸ãƒƒã‚¯åˆ†å²
                if (isAchieved) {
                    // â˜… 1%ã ã‘é«˜ãè¨­å®šï¼ˆå˜ä½æœªæº€ã¯ç¹°ã‚Šä¸Šã’ï¼‰
                    if (info.type === 'score') {
                        // ã‚¹ã‚³ã‚¢ï¼š1%å¢—ã‚„ã™
                        let increase = record * 0.01;
                        if (increase < 1) increase = 1; // æœ€å°1ç‚¹ã¯ä¸Šã’ã‚‹
                        newGoal = Math.ceil(record + increase); 
                    } else {
                        // ã‚¿ã‚¤ãƒ ï¼š1%æ¸›ã‚‰ã™ï¼ˆé€Ÿãã™ã‚‹ï¼‰
                        let decrease = record * 0.01;
                        if (decrease < 0.1) decrease = 0.1; // æœ€å°0.1ç§’ã¯é€Ÿãã™ã‚‹
                        newGoal = parseFloat((record - decrease).toFixed(1));
                        if (newGoal < 0) newGoal = 0;
                    }

                } else if (!hasRecord && !hasGoal) {
                    // â˜… è¨˜éŒ²ã‚‚ç›®æ¨™ã‚‚ãªã„ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                    newGoal = DEFAULT_GOALS[gameId] || (info.type === 'time' ? 60 : 50);
                }
                // â€» æœªé”æˆã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆä»Šã®ç›®æ¨™ã‚’ç¶­æŒï¼‰

                // ä¿å­˜
                if (newGoal !== null) {
                    saveGoal(userName, gameId, newGoal);
                    isChanged = true;
                }
            }

            if (isChanged) {
                showRecords();
                alert("ç›®æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸï¼\nãŒã‚“ã°ã£ã¦è¨˜éŒ²æ›´æ–°ã‚’ç›®æŒ‡ã—ã¦ã­ï¼");
            } else {
                alert("å¤‰æ›´ãŒå¿…è¦ãªç›®æ¨™ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nä»Šã®ç›®æ¨™ã«å‘ã‹ã£ã¦ãŒã‚“ã°ã‚ã†ï¼");
            }
        }

        // â–¼â–¼â–¼ è¨˜éŒ²ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ â–¼â–¼â–¼
        function resetRecord(userName, gameId, gameName) {
            if(!confirm(`${userName}ã•ã‚“ã®\nã€Œ${gameName}ã€ã®è¨˜éŒ²ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»æ¶ˆã™ã¨ã€ã‚‚ã¨ã«ã¯ã‚‚ã©ã‚Šã¾ã›ã‚“ï¼`)) return;

            const STORAGE_KEY = 'papan_records_v1';
            const allRecords = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

            if (allRecords[userName] && allRecords[userName][gameId] !== undefined) {
                // è¨˜éŒ²ã‚’å‰Šé™¤
                delete allRecords[userName][gameId];
                
                // ä¿å­˜
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allRecords));
                
                // ç”»é¢æ›´æ–°
                showRecords();
                alert('è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸğŸ—‘ï¸');
            }
        }
    </script>
</body>
</html>