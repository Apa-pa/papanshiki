<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŒã‚“ã°ã£ãŸãã‚ã</title>
    <script src="ranking.js"></script>
    <style>
        body { 
            font-family: "UD Digital Kyokasho-tai-R", sans-serif; 
            background: #e0f7fa; 
            text-align: center; 
            padding: 20px; 
            margin: 0;
            color: #37474f;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { color: #0097a7; margin-bottom: 20px; }
        
        .user-select-area {
            background: #fff9c4;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        select { 
            padding: 12px; 
            font-size: 20px; 
            border-radius: 10px; 
            border: 2px solid #fbc02d; 
            width: 80%; 
            background: white;
            font-weight: bold;
            color: #333;
        }

        /* ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .point-display {
            background: linear-gradient(135deg, #ffca28, #ff6f00);
            color: white;
            padding: 15px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(255, 111, 0, 0.3);
            display: inline-block;
            min-width: 200px;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        
        th { 
            background: #f5f5f5;
            color: #777; 
            font-size: 14px; 
            padding: 10px;
        }
        
        td { 
            border-bottom: 1px solid #eee; 
            padding: 15px 5px; 
            text-align: left; 
            vertical-align: middle;
        }

        .game-name { font-weight: bold; font-size: 16px; }
        
        td.score { 
            text-align: right; 
            font-weight: bold; 
            color: #d84315; 
            font-size: 20px; 
            white-space: nowrap;
        }

        .goal-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            font-family: inherit;
            color: #555;
        }
        .goal-input:focus {
            border-color: #2196f3;
            outline: none;
        }

        /* ç›®æ¨™é”æˆæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        tr.achieved {
            background-color: #fffde7;
        }
        tr.achieved .score {
            color: #e65100;
            text-shadow: 0 0 5px rgba(255, 167, 38, 0.4);
        }
        tr.achieved .game-name::before {
            content: 'ğŸ‰ ';
        }
        
        /* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
        .reset-area {
            margin-top: 40px;
            border-top: 1px dashed #ddd;
            padding-top: 20px;
            text-align: right;
        }
        .reset-btn {
            background: #eceff1;
            color: #90a4ae;
            border: 1px solid #cfd8dc;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }
        .reset-btn:hover {
            background: #ffebee;
            color: #ef5350;
            border-color: #ef5350;
        }

        .back-link { 
            display: inline-block; 
            margin-top: 30px; 
            padding: 15px 40px;
            background: #78909c;
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
        }
        .empty-msg { color: #aaa; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ† ãŒã‚“ã°ã£ãŸãã‚ã</h1>
        
        <div class="user-select-area">
            <p style="margin-top:0; font-weight:bold;">ã ã‚Œã®è¨˜éŒ²ã‚’ã¿ã‚‹ï¼Ÿ</p>
            <select id="user-select" onchange="showRecords()">
                <option value="">(ãˆã‚‰ã‚“ã§ã­)</option>
            </select>
        </div>

        <div id="record-display" style="display:none;">
            <div class="point-display">
                <span style="font-size:16px;">ãƒã‚¤ãƒ³ãƒˆ</span><br>
                <span id="total-points">0</span> pt
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="text-align:left;">ã‚²ãƒ¼ãƒ </th>
                        <th style="text-align:right;">ãƒ™ã‚¹ãƒˆ</th>
                        <th style="text-align:center;">ğŸ¯ ã‚‚ãã²ã‚‡ã†</th>
                    </tr>
                </thead>
                <tbody id="score-list">
                    </tbody>
            </table>

            <div class="reset-area">
                <button class="reset-btn" onclick="resetPointsClick()">ğŸ—‘ï¸ ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
            </div>
        </div>
        
        <div id="empty-msg" class="empty-msg">
            ã¾ã  è¨˜éŒ²ãŒ ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚²ãƒ¼ãƒ ã§éŠã‚“ã§ ä¿å­˜ã—ã¦ã­ï¼
        </div>
    </div>

    <br>
    <a href="index.html" class="back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>

    <script>
        window.onload = function() {
            if(typeof getUserNames !== 'function') {
                alert('ranking.js ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            const users = getUserNames(); 
            const select = document.getElementById('user-select');
            
            if (users.length > 0) {
                document.getElementById('empty-msg').style.display = 'none';
                users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u;
                    opt.innerText = u;
                    select.appendChild(opt);
                });
            }
        };

        function showRecords() {
            const userName = document.getElementById('user-select').value;
            const display = document.getElementById('record-display');
            const list = document.getElementById('score-list');
            const pointDisplay = document.getElementById('total-points');
            
            if (!userName) {
                display.style.display = 'none';
                return;
            }

            display.style.display = 'block';
            list.innerHTML = '';
            
            // ãƒ‡ãƒ¼ã‚¿å–å¾—
            const allRecords = getAllRecords();
            const allGoals = getAllGoals();
            const userRecords = allRecords[userName] || {};
            const userGoals = allGoals[userName] || {};

            // ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º
            pointDisplay.innerText = getUserPoints(userName);

            // ãƒªã‚¹ãƒˆè¡¨ç¤º
            for (const [gameId, info] of Object.entries(GAME_LIST)) {
                const recordVal = userRecords[gameId];
                const goalVal = userGoals[gameId] || '';

                const tr = document.createElement('tr');

                // --- é”æˆåˆ¤å®š ---
                let isAchieved = false;
                if (recordVal !== undefined && goalVal !== '') {
                    const r = parseFloat(recordVal);
                    const g = parseFloat(goalVal);
                    if (!isNaN(r) && !isNaN(g)) {
                        if (info.type === 'score' && r >= g) isAchieved = true;
                        if (info.type === 'time' && r <= g) isAchieved = true;
                    }
                }

                if (isAchieved) {
                    tr.classList.add('achieved');
                }

                const displayVal = (recordVal !== undefined) ? `${recordVal} <span style="font-size:14px">${info.unit}</span>` : '<span style="color:#ddd; font-size:14px;">-</span>';

                tr.innerHTML = `
                    <td class="game-name">${info.name}</td>
                    <td class="score">${displayVal}</td>
                    <td style="text-align:center;">
                        <input type="number" class="goal-input" 
                            value="${goalVal}" 
                            placeholder="-" 
                            step="0.1"
                            onchange="updateGoal('${userName}', '${gameId}', this.value)">
                        <span style="font-size:12px; color:#999;">${info.unit}</span>
                    </td>
                `;
                list.appendChild(tr);
            }
        }

        // ç›®æ¨™ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ä¿å­˜ã™ã‚‹
        function updateGoal(userName, gameId, value) {
            saveGoal(userName, gameId, value);
            showRecords(); 
        }

        // ãƒã‚¤ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆå‡¦ç†
        function resetPointsClick() {
            const userName = document.getElementById('user-select').value;
            if(!userName) return;

            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            const isConfirmed = confirm(
                `${userName}ã•ã‚“ã® ãƒã‚¤ãƒ³ãƒˆã‚’ 0 ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\n` +
                `ï¼ˆã‚²ãƒ¼ãƒ ã®ãã‚ãã¯ æ¶ˆãˆã¾ã›ã‚“ï¼‰\n\n` +
                `ã»ã‚“ã¨ã†ã« ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`
            );

            if (isConfirmed) {
                // ranking.jsã«è¿½åŠ ã—ãŸãƒªã‚»ãƒƒãƒˆé–¢æ•°ã‚’å‘¼ã¶
                if(typeof resetUserPoints === 'function') {
                    resetUserPoints(userName);
                    showRecords(); // ç”»é¢æ›´æ–°ï¼ˆ0ãƒã‚¤ãƒ³ãƒˆã«ãªã‚‹ï¼‰
                    alert(`${userName}ã•ã‚“ã® ãƒã‚¤ãƒ³ãƒˆã‚’ ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`);
                } else {
                    alert("ã‚¨ãƒ©ãƒ¼ï¼šranking.jsãŒæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                }
            }
        }
    </script>
</body>
</html>