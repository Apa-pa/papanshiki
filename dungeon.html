<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨ˆç®—ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ | ã±ã±ã‚“å¼</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #263238;
            color: white;
            text-align: center;
            margin: 0;
            padding: 10px;
            touch-action: manipulation;
            user-select: none;
            overflow: hidden;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: #37474f;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± */
        .header-ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #455a64;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            flex-shrink: 0;
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ç¸®ã¾ã›ãªã„ */
        }

        .floor-badge {
            background: #ffc107;
            color: #333;
            padding: 3px 10px;
            border-radius: 5px;
        }

        .hp-bar-container {
            flex-grow: 1;
            margin: 0 15px;
            background: #263238;
            height: 15px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: #4caf50;
            width: 100%;
            transition: width 0.3s;
        }

        .hp-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 10px;
            line-height: 15px;
            top: 0;
        }

        /* ãƒãƒˆãƒ«ç”»é¢ */
        .battle-screen {
            flex-grow: 1;
            position: relative;
            background: #263238;
            border: 2px solid #546e7a;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            /* ä¸Šä¸‹ã«å‡ç­‰é…ç½® */
            align-items: center;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        /* ãƒœã‚¹éšã®èƒŒæ™¯æ¼”å‡º */
        .boss-floor {
            background: radial-gradient(circle, #5d4037 0%, #263238 80%);
            border-color: #ff5722;
        }

        /* æ•µã‚­ãƒ£ãƒ©ã‚¨ãƒªã‚¢ */
        .enemy-area {
            width: 100%;
            /* min-heightã‚’å°‘ã—æ¸›ã‚‰ã—ã¦åœ§è¿«æ„Ÿã‚’è»½æ¸›ã—ã¤ã¤ã€ç”»åƒã‚µã‚¤ã‚ºã¯ç¢ºä¿ */
            min-height: 180px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .enemy-emoji {
            font-size: 80px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
            transition: transform 0.1s;
            line-height: 1;
        }

        .enemy-img-file {
            width: 120px;
            height: 120px;
            object-fit: contain;
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.3));
            transition: transform 0.1s;
        }

        .boss-img-file {
            width: 160px;
            height: 160px;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.5));
            transition: transform 0.1s;
        }

        /* HPãƒãƒ¼ */
        .enemy-hp-bar {
            width: 140px;
            height: 12px;
            background: #000;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
        }

        .enemy-hp-fill {
            height: 100%;
            background: #e91e63;
            width: 100%;
            transition: width 0.2s;
        }

        /* ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¤ºä½ç½® */
        .damage-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            /* è¦ªè¦ç´ ã®ã©çœŸã‚“ä¸­ */
            transform: translate(-50%, -50%);
            font-size: 60px;
            /* æ–‡å­—ã‚’å¤§ãã */
            font-weight: bold;
            color: #ff5252;
            text-shadow: 3px 3px 0 #fff;
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }

        /* å•é¡Œè¡¨ç¤º */
        .question-box {
            font-size: 42px;
            font-weight: bold;
            color: #80deea;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 30px;
            border-radius: 10px;
            letter-spacing: 2px;
            flex-shrink: 0;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .answer-area {
            font-size: 32px;
            height: 50px;
            /* é«˜ã•ã‚’å›ºå®šã§ç¢ºä¿ */
            line-height: 50px;
            /* æ–‡å­—ã‚’ç¸¦ä¸­å¤®ã« */
            color: #ffeb3b;
            border-bottom: 2px solid #ffeb3b;
            width: 120px;
            margin: 0 auto 10px auto;
            /* ä¸‹ã«å°‘ã—éš™é–“ */
            flex-shrink: 0;
        }

        /* ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: auto;
            padding-top: 10px;
            flex-shrink: 0;
        }

        .key {
            background: #546e7a;
            color: white;
            font-size: 24px;
            padding: 15px 0;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px #37474f;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }

        .key:active {
            transform: translateY(2px);
            box-shadow: 0 0 #37474f;
        }

        .key-enter {
            background: #00bcd4;
            box-shadow: 0 4px #0097a7;
        }

        .key-del {
            background: #ef5350;
            box-shadow: 0 4px #c62828;
            font-size: 20px;
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .menu-box {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            text-align: center;
        }

        .btn {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-sizing: border-box;
            text-decoration: none;
            line-height: normal;
        }

        .btn-start {
            background: #ff9800;
            color: white;
        }

        .btn-home {
            background: #90a4ae;
            color: white;
        }

        .btn-reset {
            background: #ef9a9a;
            color: #b71c1c;
            font-size: 14px;
            padding: 10px;
            margin-top: 5px;
        }

        .btn-reward {
            padding: 10px 20px;
            font-size: 16px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-reward:disabled {
            background: #ccc;
            cursor: default;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-5px, 0);
            }

            75% {
                transform: translate(5px, 0);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        .shaking {
            animation: shake 0.2s;
        }

        @keyframes popUp {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.5);
            }

            50% {
                transform: translate(-50%, -100%) scale(1.2);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -120%) scale(1);
            }
        }

        .pop-anim {
            animation: popUp 0.8s ease-out forwards;
        }

        /* ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”¨ */
        #ending-screen {
            background: linear-gradient(135deg, #1a237e, #4a148c);
            color: white;
        }

        .ending-title {
            font-size: 32px;
            color: #ffd700;
            text-shadow: 0 0 10px #e65100;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header-ui">
            <div class="floor-badge"><span id="floor-disp">1</span>F</div>
            <div class="hp-bar-container">
                <div id="hero-hp-bar" class="hp-bar"></div>
                <div id="hero-hp-text" class="hp-text">50/50</div>
            </div>
            <button onclick="saveAndQuit()"
                style="background:none; border:1px solid #aaa; color:#fff; border-radius:5px; font-size:12px; cursor:pointer;">ä¸­æ–­</button>
        </div>

        <div class="battle-screen" id="battle-field">
            <div class="enemy-area">
                <div id="damage-disp" class="damage-popup">10</div>
                <div id="enemy-display">ğŸ‘¾</div>
                <div class="enemy-hp-bar">
                    <div id="enemy-hp-fill" class="enemy-hp-fill"></div>
                </div>
            </div>

            <div id="question-text" class="question-box">5 + 3</div>
            <div id="user-input" class="answer-area"></div>
        </div>

        <div class="numpad">
            <button class="key" onclick="inputNum(7)">7</button>
            <button class="key" onclick="inputNum(8)">8</button>
            <button class="key" onclick="inputNum(9)">9</button>
            <button class="key" onclick="inputNum(4)">4</button>
            <button class="key" onclick="inputNum(5)">5</button>
            <button class="key" onclick="inputNum(6)">6</button>
            <button class="key" onclick="inputNum(1)">1</button>
            <button class="key" onclick="inputNum(2)">2</button>
            <button class="key" onclick="inputNum(3)">3</button>
            <button class="key key-del" onclick="delNum()">ã‘ã™</button>
            <button class="key" onclick="inputNum(0)">0</button>
            <button class="key key-enter" onclick="checkAnswer()">ã“ã†ã’ã</button>
        </div>

        <div id="start-screen" class="overlay" style="display:flex;">
            <div class="menu-box">
                <h1 style="color:#e65100; margin-top:0;">ğŸ—¡ï¸ è¨ˆç®—ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</h1>
                <p>ã ã‚ŒãŒãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                <select id="user-select" style="font-size:18px; padding:10px; width:100%; margin-bottom:20px;">
                    <option value="">(ãˆã‚‰ã‚“ã§ã­)</option>
                </select>

                <div id="resume-info" style="display:none; color:#555; margin-bottom:10px;">
                    <span id="save-floor">1</span>éšã‹ã‚‰ å†é–‹ï¼
                </div>

                <button id="start-btn-text" class="btn btn-start" onclick="gameStart()">å†’é™ºã¸ã„ãï¼</button>

                <div id="reset-area"
                    style="display:none; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                    <button class="btn btn-reset" onclick="resetGameStart()">ã¯ã˜ã‚ã‹ã‚‰ (ãƒ‡ãƒ¼ã‚¿ã‚’ã‘ã™)</button>
                </div>

                <a href="index.html" class="btn btn-home">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
            </div>
        </div>

        <div id="clear-screen" class="overlay">
            <div class="menu-box">
                <div style="font-size:60px;">ğŸ—ï¸</div>
                <h2 id="clear-msg" style="color:#00bcd4;">ã‚¯ãƒªã‚¢ï¼</h2>
                <p>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å€’ã—ãŸï¼</p>

                <button id="reward-btn" class="btn-reward" style="display:none;">
                    ğŸ 30ãƒã‚¤ãƒ³ãƒˆ
                </button>

                <p style="font-size:14px; color:#888;">HPãŒå°‘ã—å›å¾©ã—ãŸã‚ˆ</p>
                <button class="btn btn-start" onclick="nextFloor()">æ¬¡ã®éšã¸é€²ã‚€</button>

                <button class="btn btn-home" onclick="saveAndQuitNext()">ã‚»ãƒ¼ãƒ–ã—ã¦ã‚„ã‚ã‚‹</button>
            </div>
        </div>

        <div id="ending-screen" class="overlay">
            <div class="menu-box" style="background:rgba(255,255,255,0.9);">
                <div style="font-size:80px;">ğŸ‘‘</div>
                <h1 class="ending-title">å®Œå…¨åˆ¶è¦‡ï¼</h1>
                <p style="font-size:18px; color:#333;">ãŠã‚ã§ã¨ã†ï¼<br>åœ°ä¸‹100éšã®ãƒœã‚¹ã‚’å€’ã—ã€<br>ä¼èª¬ã®å‹‡è€…ã«ãªã£ãŸï¼</p>
                <p style="color:#e91e63; font-weight:bold;">ã‚­ãƒŸã®è¨ˆç®—åŠ›ã¯æœ€å¼·ã ï¼</p>
                <a href="index.html" class="btn btn-start">ğŸ  å‡±æ—‹ï¼ˆãƒ›ãƒ¼ãƒ ã¸ï¼‰</a>
            </div>
        </div>

        <div id="gameover-screen" class="overlay">
            <div class="menu-box">
                <div style="font-size:60px;">âš°ï¸</div>
                <h2 style="color:#ff5252;">ã‚„ã‚‰ã‚ŒãŸ...</h2>
                <p>HPãŒãªããªã£ã¦ã—ã¾ã£ãŸã€‚</p>
                <button class="btn btn-start" onclick="retryFloor()">ã“ã®éšã‹ã‚‰ã‚„ã‚ŠãªãŠã™</button>
                <a href="index.html" class="btn btn-home" style="text-decoration:none;">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
            </div>
        </div>
    </div>

    <script>
        let currentUser = "";
        let gameState = {
            floor: 1,
            maxHp: 50,
            currentHp: 50
        };

        // æˆ¦é—˜ä¸­ãƒ‡ãƒ¼ã‚¿
        let enemy = { hp: 10, maxHp: 10, isBoss: false };
        let currentQ = { ans: 0 };
        let inputBuffer = "";
        let currentReward = 30;

        const ENEMIES = ['ğŸ‘¾', 'ğŸ¦‡', 'ğŸ', 'ğŸº', 'ğŸ’€', 'ğŸ‘»', 'ğŸ‘º', 'ğŸ‘¹', 'ğŸ‰', 'ğŸ‘¿'];

        // â–¼â–¼â–¼ è¿½åŠ ï¼šåŠ¹æœéŸ³ã®æº–å‚™ â–¼â–¼â–¼
        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªãã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã€å†ç”Ÿæ™‚ã«ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
        const SE = {
            attack: new Audio('se/attack.mp3'),
            damage: new Audio('se/damage.mp3'),
            clear: new Audio('se/clear.mp3')
        };

        function playSe(type) {
            try {
                const audio = SE[type];
                if (audio) {
                    audio.currentTime = 0; // é€£ç¶šå†ç”Ÿç”¨
                    audio.play().catch(e => { /* ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆãªã©ã¯ã“ã“ã«æ¥ã‚‹ãŒç„¡è¦– */ });
                }
            } catch (e) {
                // ã‚¨ãƒ©ãƒ¼ç„¡è¦–
            }
        }
        // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

        window.onload = function () {
            const users = getUserNames();
            const select = document.getElementById('user-select');
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.innerText = u;
                select.appendChild(opt);
            });

            select.addEventListener('change', function () {
                const user = this.value;
                if (!user) return;

                const saved = loadGameData(user);
                const resumeInfo = document.getElementById('resume-info');
                const startBtn = document.getElementById('start-btn-text');
                const resetArea = document.getElementById('reset-area');

                if (saved) {
                    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š
                    document.getElementById('save-floor').innerText = saved.floor;
                    resumeInfo.style.display = 'block';
                    startBtn.innerText = "ã¤ã¥ãã‹ã‚‰ å†’é™ºï¼";
                    resetArea.style.display = 'block';
                } else {
                    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãªã—
                    resumeInfo.style.display = 'none';
                    startBtn.innerText = "å†’é™ºã¸ã„ãï¼";
                    resetArea.style.display = 'none';
                }
            });
        };

        function getKey(user) { return `papan_dungeon_v1_${user}`; }

        function saveGameData(user, data) {
            localStorage.setItem(getKey(user), JSON.stringify(data));
        }

        function loadGameData(user) {
            const json = localStorage.getItem(getKey(user));
            return json ? JSON.parse(json) : null;
        }

        function gameStart() {
            const user = document.getElementById('user-select').value;
            if (!user) { alert("ãªã¾ãˆã‚’ãˆã‚‰ã‚“ã§ã­"); return; }

            currentUser = user;
            const saved = loadGameData(user);

            if (saved) {
                gameState = saved;
            } else {
                gameState = { floor: 1, maxHp: 50, currentHp: 50 };
            }

            document.getElementById('start-screen').style.display = 'none';
            initFloor();
        }

        function resetGameStart() {
            const user = document.getElementById('user-select').value;
            if (!user) return;

            if (confirm(user + "ã•ã‚“ã® ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¦\n1éšã‹ã‚‰ ã¯ã˜ã‚ã¾ã™ã‹ï¼Ÿ")) {
                currentUser = user;
                gameState = { floor: 1, maxHp: 50, currentHp: 50 };
                saveGameData(currentUser, gameState);

                document.getElementById('start-screen').style.display = 'none';
                initFloor();
            }
        }

        function saveAndQuit() {
            if (!currentUser) return;
            saveGameData(currentUser, gameState);
            alert("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚ã¾ãŸã‚ãã‚“ã§ã­ï¼");
            location.href = "index.html";
        }

        function saveAndQuitNext() {
            if (!currentUser) return;

            gameState.floor++;
            gameState.maxHp += 5;
            gameState.currentHp += 20;
            if (gameState.currentHp > gameState.maxHp) gameState.currentHp = gameState.maxHp;

            if (gameState.floor > 100) gameState.floor = 101;

            saveGameData(currentUser, gameState);
            alert("ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚ã¤ãã¯ " + gameState.floor + "éš ã‹ã‚‰å†’é™ºå†é–‹ã§ã™ï¼");
            location.href = "index.html";
        }

        // --- ãƒ•ãƒ­ã‚¢åˆæœŸåŒ– ---
        function initFloor() {
            if (gameState.floor > 100) {
                document.getElementById('ending-screen').style.display = 'flex';
                return;
            }

            document.getElementById('floor-disp').innerText = gameState.floor;
            updateHeroHpUI();

            const field = document.getElementById('battle-field');
            const enemyDisplay = document.getElementById('enemy-display');
            enemy.isBoss = false;

            let hpVal = 0;

            if (gameState.floor % 10 === 0) {
                // ãƒœã‚¹éš
                enemy.isBoss = true;
                const avgDmg = 12 + Math.floor(gameState.floor / 2);
                hpVal = avgDmg * 15;

                const bossNum = gameState.floor / 10;
                const bossNumStr = bossNum < 10 ? '0' + bossNum : bossNum;
                const imgPath = `image/monster${bossNumStr}.png`;
                enemyDisplay.innerHTML = `<img src="${imgPath}" class="boss-img-file" alt="ãƒœã‚¹">`;
                field.classList.add('boss-floor');

            } else if (gameState.floor === 1) {
                // 1éšã‚¹ãƒ©ã‚¤ãƒ 
                hpVal = 80;
                enemyDisplay.innerHTML = '<img src="slime.png" class="enemy-img-file" alt="ã‚¹ãƒ©ã‚¤ãƒ ">';
                field.classList.remove('boss-floor');

            } else {
                // é€šå¸¸éš
                const avgDmg = 12 + Math.floor(gameState.floor / 2);
                hpVal = avgDmg * 7;

                const idx = (gameState.floor) % ENEMIES.length;
                enemyDisplay.innerHTML = ENEMIES[idx];
                enemyDisplay.className = "enemy-emoji";
                field.classList.remove('boss-floor');
            }

            enemy.maxHp = hpVal;
            enemy.hp = hpVal;

            updateEnemyHpUI();
            nextQuestion();
        }

        // --- å•é¡Œä½œæˆãƒ­ã‚¸ãƒƒã‚¯ ---
        function nextQuestion() {
            inputBuffer = "";
            document.getElementById('user-input').innerText = "";

            const f = gameState.floor;
            let op = '';
            let a = 0, b = 0, ans = 0;
            let type = 0;

            if (f <= 20) {
                if (f <= 5) {
                    type = 0; a = r(1, 9); b = r(1, 9);
                } else if (f <= 10) {
                    type = 1; a = r(5, 15); b = r(1, a);
                } else {
                    type = 0; a = r(10, 50); b = r(1, 50);
                }
            } else if (f <= 25) {
                type = 1; a = r(20, 99); b = r(5, a - 1);
            } else if (f <= 35) {
                type = 2; a = r(1, 9); b = r(1, 9);
            } else if (f <= 45) {
                type = 3; ans = r(1, 9); b = r(2, 9); a = ans * b;
            } else {
                const dice = Math.random();
                if (dice < 0.25) { type = 0; a = r(10, 99); b = r(10, 99); }
                else if (dice < 0.5) { type = 1; a = r(20, 99); b = r(5, a); }
                else if (dice < 0.75) { type = 2; a = r(2, 9); b = r(2, 9); }
                else { type = 3; ans = r(2, 9); b = r(2, 9); a = ans * b; }
            }

            if (type === 0) { op = '+'; ans = a + b; }
            else if (type === 1) { op = '-'; ans = a - b; }
            else if (type === 2) { op = 'Ã—'; ans = a * b; }
            else if (type === 3) { op = 'Ã·'; ans = a / b; }

            currentQ = { ans: ans };
            document.getElementById('question-text').innerText = `${a} ${op} ${b}`;
        }

        function r(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // --- å…¥åŠ›ãƒ»åˆ¤å®š ---
        function inputNum(n) {
            if (inputBuffer.length >= 4) return;
            inputBuffer += n;
            document.getElementById('user-input').innerText = inputBuffer;
        }
        function delNum() {
            inputBuffer = inputBuffer.slice(0, -1);
            document.getElementById('user-input').innerText = inputBuffer;
        }

        function checkAnswer() {
            if (inputBuffer === "") return;
            const userAns = parseInt(inputBuffer);

            if (userAns === currentQ.ans) {
                // æ­£è§£
                const baseDmg = Math.floor(Math.random() * 5) + 10;
                const levelBonus = Math.floor(gameState.floor / 2);
                const damage = baseDmg + levelBonus;

                playSe('attack'); // â–¼ è¿½åŠ 
                playEffect('attack');
                enemy.hp -= damage;
                showDamage(damage);

                if (enemy.hp <= 0) {
                    enemy.hp = 0;
                    updateEnemyHpUI();
                    setTimeout(floorClear, 500);
                } else {
                    updateEnemyHpUI();
                    nextQuestion();
                }
            } else {
                // ä¸æ­£è§£
                const dmg = Math.floor(Math.random() * 5) + 5;
                playSe('damage'); // â–¼ è¿½åŠ 
                playEffect('damage');
                gameState.currentHp -= dmg;
                if (gameState.currentHp < 0) gameState.currentHp = 0;

                updateHeroHpUI();
                const field = document.getElementById('battle-field');
                field.style.borderColor = '#ff5252';
                setTimeout(() => field.style.borderColor = '#546e7a', 200);

                if (gameState.currentHp <= 0) {
                    setTimeout(gameOver, 500);
                } else {
                    inputBuffer = "";
                    document.getElementById('user-input').innerText = "";
                }
            }
        }

        // --- UIæ›´æ–° ---
        function updateHeroHpUI() {
            const bar = document.getElementById('hero-hp-bar');
            const txt = document.getElementById('hero-hp-text');
            const pct = (gameState.currentHp / gameState.maxHp) * 100;
            bar.style.width = pct + "%";
            if (pct < 30) bar.style.background = "#ff5252";
            else bar.style.background = "#4caf50";
            txt.innerText = `${gameState.currentHp} / ${gameState.maxHp}`;
        }

        function updateEnemyHpUI() {
            const bar = document.getElementById('enemy-hp-fill');
            const pct = (enemy.hp / enemy.maxHp) * 100;
            bar.style.width = pct + "%";
        }

        function showDamage(val) {
            const el = document.getElementById('damage-disp');
            el.innerText = val;
            el.classList.remove('pop-anim');
            void el.offsetWidth;
            el.classList.add('pop-anim');
        }

        function playEffect(type) {
            const target = type === 'attack' ? document.getElementById('enemy-display') : document.getElementById('battle-field');
            target.classList.add('shaking');
            setTimeout(() => target.classList.remove('shaking'), 200);
        }

        // --- çµæœç”»é¢ ---
        function floorClear() {
            playSe('clear');
            saveGameData(currentUser, gameState);

            // å ±é…¬è¨ˆç®—
            if (gameState.floor === 100) {
                currentReward = 1000;
                document.getElementById('clear-msg').innerText = "åœ°ä¸‹100éš åˆ¶è¦‡ï¼";
            } else if (enemy.isBoss) {
                currentReward = 100;
                document.getElementById('clear-msg').innerText = "ãƒœã‚¹æ’ƒç ´ï¼";
            } else {
                currentReward = 30;
                document.getElementById('clear-msg').innerText = "ã‚¯ãƒªã‚¢ï¼";
            }

            // è‡ªå‹•ã§ãƒã‚¤ãƒ³ãƒˆå–å¾—
            if (typeof showPointGetDialog === 'function') {
                showPointGetDialog(currentReward);
            }

            // UIæ›´æ–°: ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã€ç²å¾—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const btn = document.getElementById('reward-btn');
            btn.style.display = 'none';

            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
            const existingMsg = document.getElementById('auto-reward-msg');
            if (existingMsg) existingMsg.remove();

            const msg = document.createElement('div');
            msg.id = 'auto-reward-msg';
            msg.innerText = `ğŸ ${currentReward} ãƒã‚¤ãƒ³ãƒˆ ã‚²ãƒƒãƒˆï¼`;
            msg.style.cssText = "font-size: 20px; color: #ff9800; font-weight: bold; margin-bottom: 20px;";

            // ãƒœã‚¿ãƒ³ã®ç›´å¾Œã«æŒ¿å…¥
            btn.insertAdjacentElement('afterend', msg);

            document.getElementById('clear-screen').style.display = 'flex';
        }

        function receiveReward() {
            const btn = document.getElementById('reward-btn');
            btn.disabled = true;
            btn.innerText = 'ã‚²ãƒƒãƒˆï¼';
            btn.style.background = '#ccc';

            if (typeof showPointGetDialog === 'function') {
                showPointGetDialog(currentReward);
            } else {
                alert(`${currentReward}ãƒã‚¤ãƒ³ãƒˆã‚²ãƒƒãƒˆï¼`);
            }
        }

        function nextFloor() {
            document.getElementById('clear-screen').style.display = 'none';

            // è‡ªå‹•å ±é…¬ã®ãŸã‚ãƒœã‚¿ãƒ³ãƒªã‚»ãƒƒãƒˆã¯ä¸è¦

            // 100éšã‚¯ãƒªã‚¢æ™‚ -> ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¸
            if (gameState.floor >= 100) {
                document.getElementById('ending-screen').style.display = 'flex';
                gameState.floor = 101;
                saveGameData(currentUser, gameState);
                return;
            }

            gameState.floor++;
            gameState.maxHp += 5;
            gameState.currentHp += 20;
            if (gameState.currentHp > gameState.maxHp) gameState.currentHp = gameState.maxHp;

            saveGameData(currentUser, gameState);
            initFloor();
        }

        function gameOver() {
            document.getElementById('gameover-screen').style.display = 'flex';
        }

        function retryFloor() {
            document.getElementById('gameover-screen').style.display = 'none';
            gameState.currentHp = Math.floor(gameState.maxHp / 2);
            updateHeroHpUI();
            saveGameData(currentUser, gameState);
            initFloor();
        }

    </script>
</body>

</html>