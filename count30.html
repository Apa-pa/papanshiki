<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30ã‚’è¨€ã‚ã›ã‚ï¼</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #fff3e0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #4e342e;
            touch-action: manipulation;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
            max-height: 800px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: #ff9800;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        #chat-area {
            flex: 1;
            background: #fff8e1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-bottom: 2px solid #ffe0b2;
        }

        .message {
            display: flex;
            align-items: flex-end;
            max-width: 80%;
        }
        .msg-cpu { align-self: flex-start; }
        .msg-player { align-self: flex-end; flex-direction: row-reverse; }

        .icon {
            font-size: 40px;
            margin: 0 10px;
            background: white;
            border-radius: 50%;
            width: 50px; height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .bubble {
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 18px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .msg-cpu .bubble {
            background: white;
            border-top-left-radius: 5px;
        }
        .msg-player .bubble {
            background: #dce775;
            border-top-right-radius: 5px;
        }

        /* æ•°å­—ã®å¼·èª¿ */
        .count-num {
            font-weight: bold;
            color: #d84315;
            font-size: 1.2em;
        }
        .last-num {
            color: #c62828;
            font-size: 1.5em;
            font-weight: bold;
        }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        #controls {
            padding: 20px;
            background: white;
            text-align: center;
        }

        .btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 15px 0;
            width: 30%;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px #f57c00;
            font-weight: bold;
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }

        .level-btn {
            width: 200px;
            margin: 10px;
            padding: 15px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px rgba(0,0,0,0.2);
        }
        .lvl-easy { background: #81c784; }
        .lvl-normal { background: #ffb74d; }
        .lvl-hard { background: #e57373; }

        .back-link {
            margin-top: 20px;
            color: #8d6e63;
            text-decoration: underline;
        }

        /* ç¾åœ¨ã®æ•°å­—è¡¨ç¤º */
        #status-bar {
            text-align: center;
            padding: 5px;
            font-size: 14px;
            color: #777;
        }

    </style>
</head>
<body>

<div id="game-container">
    <header>30ã‚’è¨€ã‚ã›ã‚ï¼</header>
    
    <div id="status-bar">30ã‚’ ã„ã£ãŸã‚‰ ã¾ã‘ã ã‚ˆï¼</div>

    <div id="chat-area">
        </div>

    <div id="controls">
        <div id="turn-msg">ã‚ãªãŸã® ã°ã‚“ ã§ã™</div>
        <div class="btn-group">
            <button class="btn" onclick="playerMove(1)">1ã“<br>ã„ã†</button>
            <button class="btn" onclick="playerMove(2)">2ã“<br>ã„ã†</button>
            <button class="btn" onclick="playerMove(3)">3ã“<br>ã„ã†</button>
        </div>
    </div>
</div>

<div id="start-screen" class="overlay">
    <div style="font-size: 80px; margin-bottom: 20px;">ğŸ—£ï¸</div>
    <h1 style="color:#e65100; margin:0;">30ã‚’è¨€ã‚ã›ã‚ï¼</h1>
    <p style="margin: 20px; color:#5d4037;">
        ã˜ã‚…ã‚“ã°ã‚“ã« æ•°å­—ã‚’ ã„ã£ã¦ã­ã€‚<br>
        ã€Œ30ã€ã‚’ ã„ã£ãŸã»ã†ãŒ è² ã‘ï¼<br>
        (1å›ã« 3ã“ã¾ã§ ã„ãˆã‚‹ã‚ˆ)
    </p>
    <p style="font-weight:bold;">ã¤ã‚ˆã•ã‚’ ãˆã‚‰ã‚“ã§ã­</p>
    <button class="level-btn lvl-easy" onclick="startGame('easy')">ã‚ˆã‚ã„</button>
    <button class="level-btn lvl-normal" onclick="startGame('normal')">ãµã¤ã†</button>
    <button class="level-btn lvl-hard" onclick="startGame('hard')">ã•ã„ãã‚‡ã†</button>
    
    <a href="index.html" class="back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>
</div>

<div id="result-screen" class="overlay" style="display:none;">
    <h1 id="result-title">ã‹ã¡ï¼</h1>
    <div id="result-icon" style="font-size: 80px; margin: 20px;">ğŸ‰</div>
    <p id="result-msg">ã™ã”ã„ï¼ä½œæˆ¦ã©ãŠã‚Šã ã­ï¼</p>
    <button onclick="showPointGetDialog(30)" style="font-size:20px; padding:10px 30px; background:#ff9800; color:white; border:none; border-radius:30px; margin:10px; font-weight:bold; cursor:pointer;">
    ğŸ 30ãƒã‚¤ãƒ³ãƒˆã‚’ã‚‚ã‚‰ã†
</button>
    <button class="level-btn lvl-normal" onclick="location.reload()">ã‚‚ã†ã„ã£ã‹ã„</button>
    <a href="index.html" class="back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
</div>

<script>
    let currentCount = 0;
    let difficulty = 'normal';
    let isPlayerTurn = true;
    const targetNumber = 30;
    const chatArea = document.getElementById('chat-area');
    const btns = document.querySelectorAll('.btn');

    function startGame(level) {
        difficulty = level;
        document.getElementById('start-screen').style.display = 'none';
        
        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        addMessage('cpu', 'ã‚ãŸã—ã¯ ãƒãƒªãƒã‚ºãƒŸã ã‚ˆã€‚ã‚ˆã‚ã—ãã­ï¼<br>ã‚ãªãŸã¯ ãƒªã‚¹ã•ã‚“ã ã­ã€‚ã•ãã« ã©ã†ãï¼');
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ“ä½œ
    function playerMove(count) {
        if (!isPlayerTurn) return;

        // å…¥åŠ›ãŒæ­£ã—ã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ30ã‚’è¶…ãˆã‚‹å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ãªãã™ã‚‹åˆ¶å¾¡ã‚‚å¯ã ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
        if (currentCount + count > targetNumber) {
            count = targetNumber - currentCount; // å¼·åˆ¶çš„ã«30ã§æ­¢ã‚ã‚‹
        }

        // æ•°å­—ã‚’é€²ã‚ã‚‹
        let nums = [];
        for (let i = 1; i <= count; i++) {
            currentCount++;
            nums.push(currentCount);
        }

        addMessage('player', nums.join(', '));
        checkWin();

        if (currentCount < targetNumber) {
            isPlayerTurn = false;
            setButtonsEnabled(false);
            document.getElementById('turn-msg').textContent = 'ãƒãƒªãƒã‚ºãƒŸãŒ ã‹ã‚“ãŒãˆä¸­...';
            
            // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ï¼ˆå°‘ã—å¾…ã¤ï¼‰
            setTimeout(computerMove, 1000);
        }
    }

    // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®æ€è€ƒ
    function computerMove() {
        let moveCount = 1;

        // æ®‹ã‚Šã„ãã¤ã‹ï¼Ÿ
        const remaining = targetNumber - currentCount;

        // æˆ¦ç•¥ãƒ­ã‚¸ãƒƒã‚¯
        if (remaining <= 1) {
            // è² ã‘ç¢ºå®šã®å ´é¢ï¼ˆ30ã‚’è¨€ã†ã—ã‹ãªã„ï¼‰
            moveCount = 1; 
        } else {
            // å‹ã¤ãŸã‚ã®æ•°å­—ï¼ˆtargetNumber-1 = 29, 25, 21... ã«ç€åœ°ã—ãŸã„ï¼‰
            // å¿…å‹ãƒ‘ã‚¿ãƒ¼ãƒ³: (ç¾åœ¨ã®æ•° - 1) ã‚’ 4 ã§å‰²ã£ãŸä½™ã‚Šã«æ³¨ç›®
            // ç›¸æ‰‹ã« (4n + 1) ã‚’è¨€ã‚ã›ãŸã„ã€‚
            // ã¤ã¾ã‚Šã€è‡ªåˆ†ãŒè¨€ã„çµ‚ã‚ã£ãŸæ•°å­—ã‚’ 4n + 1 ã«ã—ãŸã„ã€‚
            // ä¾‹: 1, 5, 9, 13, 17, 21, 25, 29
            
            // æ¬¡ã«è‡ªåˆ†ãŒç€åœ°ã™ã¹ãã€Œç›®æ¨™ã®æ•°å­—ã€ã‚’æ¢ã™
            // ç¾åœ¨åœ°ã‚ˆã‚Šå¤§ããã€ã‹ã¤ 4n+1 ã®æ•°å­—
            let targetPos = -1;
            for (let i = 1; i < 30; i += 4) {
                if (i > currentCount && i <= currentCount + 3) {
                    targetPos = i;
                    break;
                }
            }

            if (targetPos !== -1) {
                // å¿…å‹æ‰‹ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
                if (difficulty === 'hard') {
                    // æœ€å¼·ï¼šå¿…ãšå¿…å‹æ‰‹ã‚’æ‰“ã¤
                    moveCount = targetPos - currentCount;
                } else if (difficulty === 'normal') {
                    // æ™®é€šï¼š50%ã®ç¢ºç‡ã§å¿…å‹æ‰‹ã€ãƒŸã‚¹ã‚‚ã™ã‚‹
                    if (Math.random() > 0.5) {
                        moveCount = targetPos - currentCount;
                    } else {
                        moveCount = Math.floor(Math.random() * 3) + 1;
                    }
                } else {
                    // å¼±ã„ï¼šã»ã¼ãƒ©ãƒ³ãƒ€ãƒ 
                    if (Math.random() > 0.8) {
                        moveCount = targetPos - currentCount;
                    } else {
                        moveCount = Math.floor(Math.random() * 3) + 1;
                    }
                }
            } else {
                // è‡ªåˆ†ãŒã€Œ4n+1ã€ã«ã„ã¦ã€ã©ã†ã‚„ã£ã¦ã‚‚ç›¸æ‰‹ã«ãƒãƒ£ãƒ³ã‚¹ã‚’ä¸ãˆã‚‹å ´åˆ
                // ã¾ãŸã¯è¨ˆç®—ãŒé¢å€’ãªå ´åˆ -> ãƒ©ãƒ³ãƒ€ãƒ 
                moveCount = Math.floor(Math.random() * 3) + 1;
            }
        }

        // ãƒ«ãƒ¼ãƒ«é•åé˜²æ­¢ï¼ˆ30ã‚’è¶…ãˆãªã„ã€1ä»¥ä¸Šï¼‰
        if (currentCount + moveCount > targetNumber) {
            moveCount = targetNumber - currentCount;
        }
        if (moveCount < 1) moveCount = 1;
        if (moveCount > 3) moveCount = 3;

        // å®Ÿè¡Œ
        let nums = [];
        for (let i = 1; i <= moveCount; i++) {
            currentCount++;
            nums.push(currentCount);
        }

        addMessage('cpu', nums.join(', '));
        checkWin();

        if (currentCount < targetNumber) {
            isPlayerTurn = true;
            setButtonsEnabled(true);
            document.getElementById('turn-msg').textContent = 'ã‚ãªãŸã® ã°ã‚“ ã§ã™';
        }
    }

    function checkWin() {
        if (currentCount >= targetNumber) {
            setTimeout(() => {
                showResult(!isPlayerTurn); // ã‚¿ãƒ¼ãƒ³ãŒçµ‚ã‚ã£ãŸäººãŒ30ã‚’è¨€ã£ãŸäººï¼è² ã‘
            }, 500);
        }
    }

    function showResult(playerWin) {
        const screen = document.getElementById('result-screen');
        const title = document.getElementById('result-title');
        const icon = document.getElementById('result-icon');
        const msg = document.getElementById('result-msg');

        screen.style.display = 'flex';

        if (playerWin) {
            title.textContent = 'ã‚ãªãŸã®ã‹ã¡ï¼';
            title.style.color = '#e65100';
            icon.textContent = 'ğŸ†';
            msg.textContent = 'ãƒãƒªãƒã‚ºãƒŸã«ã€Œ30ã€ã‚’ã„ã‚ã›ãŸã­ï¼';
        } else {
            title.textContent = 'ã‚ãªãŸã®ã¾ã‘...';
            title.style.color = '#555';
            icon.textContent = 'ğŸ˜­';
            msg.textContent = 'ã€Œ30ã€ã‚’ã„ã£ã¡ã‚ƒã£ãŸã­...';
        }
    }

    function addMessage(who, text) {
        const div = document.createElement('div');
        div.className = `message msg-${who}`;
        
        // ã‚¢ã‚¤ã‚³ãƒ³
        const icon = document.createElement('div');
        icon.className = 'icon';
        icon.textContent = who === 'player' ? 'ğŸ¿ï¸' : 'ğŸ¦”';
        
        // ãµãã ã—
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        // æ•°å­—ã®è£…é£¾
        if (text.includes(targetNumber.toString())) {
             text = text.replace(targetNumber.toString(), `<span class="last-num">${targetNumber}</span>`);
        }
        bubble.innerHTML = text;

        div.appendChild(icon);
        div.appendChild(bubble);
        chatArea.appendChild(div);

        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function setButtonsEnabled(enabled) {
        btns.forEach(btn => btn.disabled = !enabled);
    }

</script>
</body>
</html>