<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼¢å­—ã¤ã¿ã¤ã¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="ranking.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #e0e0e0;
            /* PCãªã©ã®èƒŒæ™¯è‰²ï¼ˆæ å¤–ï¼‰ */
            font-family: "UD Digital Kyokasho-tai-R", "Zen Kaku Gothic New", sans-serif;
            touch-action: manipulation;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ã‚’ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã«å›ºå®š */
        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            /* æœ€å¤§å¹…ã‚’åˆ¶é™ */
            height: 100%;
            max-height: 900px;
            background-color: #fffbe6;
            /* ã‚²ãƒ¼ãƒ ç”»é¢ã®èƒŒæ™¯ */
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            /* å½±ã‚’ã¤ã‘ã¦æµ®ãä¸ŠãŒã‚‰ã›ã‚‹ */
        }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hud {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #5d4037;
            text-shadow: 2px 2px 0 #fff;
        }

        .life-area {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 253, 231, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            pointer-events: auto;
            text-align: center;
        }

        h1 {
            color: #d84315;
            font-size: 36px;
            margin-bottom: 10px;
            font-family: serif;
        }

        .btn {
            background: #d84315;
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 22px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px #bf360c;
            font-weight: bold;
            margin-top: 20px;
        }

        .btn:active {
            transform: scale(0.95);
            box-shadow: none;
        }

        .back-link {
            margin-top: 20px;
            color: #8d6e63;
            text-decoration: underline;
            font-size: 16px;
        }

        /* ç†Ÿèªå›³é‘‘ */
        .jukugo-result {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            width: 80%;
            text-align: left;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
        }

        .jukugo-result h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #d84315;
            text-align: center;
        }

        .jukugo-item {
            display: inline-block;
            background: linear-gradient(135deg, #fff8e1, #ffe082);
            border: 2px solid #f9a825;
            border-radius: 8px;
            padding: 4px 10px;
            margin: 3px;
            font-size: 16px;
            font-weight: bold;
            color: #5d4037;
        }

        .jukugo-item ruby rt {
            font-size: 10px;
            color: #8d6e63;
        }

        .no-jukugo {
            text-align: center;
            color: #8d6e63;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div class="ui-layer">
            <div class="hud">ã¤ã‚“ã æ•°: <span id="score">0</span> ã“</div>
            <div class="life-area" id="life-display">â¤ï¸â¤ï¸â¤ï¸</div>
        </div>

        <div id="start-screen" class="overlay">
            <h1>æ¼¢å­—ã¤ã¿ã¤ã¿</h1>
            <div style="font-size: 60px; margin: 20px;">ğŸ§±</div>
            <p style="color:#5d4037; font-size:16px; line-height: 1.6;">
                ã‚†ã‚Œã‚‹ æ¼¢å­—(ã‹ã‚“ã˜)ã‚’ ã‚¿ãƒƒãƒ—ã§ ãŠã¨ãã†ï¼<br>
                å°åº§(ã ã„ã–)ã‹ã‚‰ ãŠã¡ãŸã‚‰ ã‚¢ã‚¦ãƒˆã ã‚ˆã€‚<br>
                <span style="color:#d84315; font-weight:bold;">
                    ç†Ÿèª(ã˜ã‚…ãã”)ãŒã§ãã‚‹ã¨ ãã£ã¤ãã‚ˆï¼
                </span>
            </p>
            <button class="btn" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <br>
            <a href="index.html" class="back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>
        </div>

        <div id="gameover-screen" class="overlay" style="display:none;">
            <h1 style="color:#5d4037;">ãã“ã¾ã§ï¼</h1>
            <p style="font-size:24px; color:#d84315; font-weight:bold;">
                ãã‚ã: <span id="final-score">0</span> ã“
            </p>
            <div id="jukugo-result-area"></div>
            <button class="btn" onclick="startGame()">ã‚‚ã†ã„ã£ã‹ã„</button>
            <br>
            <a href="index.html" class="back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
        </div>
    </div>

    <script>
        const Engine = Matter.Engine,
            Render = Matter.Render,
            Runner = Matter.Runner,
            Bodies = Matter.Bodies,
            Body = Matter.Body,
            Composite = Matter.Composite,
            Constraint = Matter.Constraint,
            Events = Matter.Events;

        // æ¼¢å­—ãƒ‡ãƒ¼ã‚¿ï¼ˆ40å­—ï¼šå°1ã€œ3ãƒ¬ãƒ™ãƒ«ï¼‰
        const kanjiList = [
            { char: "å±±", w: 1.2, h: 0.8 },
            { char: "ç«", w: 1.1, h: 1.1 },
            { char: "æ°´", w: 1.1, h: 1.1 },
            { char: "ç”°", w: 1.0, h: 1.0 },
            { char: "æ—¥", w: 0.9, h: 1.1 },
            { char: "æœ¬", w: 1.1, h: 1.1 },
            { char: "å¤§", w: 1.3, h: 1.0 },
            { char: "å°", w: 0.8, h: 0.8 },
            { char: "äºº", w: 1.2, h: 0.8 },
            { char: "å£", w: 1.0, h: 0.9 },
            { char: "å¤©", w: 1.2, h: 0.9 },
            { char: "æ°—", w: 1.0, h: 1.1 },
            { char: "å­¦", w: 1.1, h: 1.0 },
            { char: "æ ¡", w: 1.0, h: 1.1 },
            { char: "ç”Ÿ", w: 1.0, h: 1.1 },
            { char: "ç‹", w: 1.1, h: 1.0 },
            { char: "å­", w: 0.9, h: 1.0 },
            { char: "åŠ›", w: 1.0, h: 1.1 },
            { char: "å…¥", w: 1.0, h: 1.0 },
            { char: "ä¸Š", w: 1.0, h: 0.9 },
            { char: "ä¸‹", w: 1.0, h: 0.9 },
            { char: "å…ˆ", w: 1.0, h: 1.1 },
            { char: "é’", w: 1.0, h: 1.1 },
            { char: "ç©º", w: 1.1, h: 1.0 },
            { char: "é‡‘", w: 1.2, h: 1.0 },
            { char: "åœŸ", w: 1.2, h: 0.8 },
            { char: "æœ¨", w: 1.1, h: 1.1 },
            { char: "ç›®", w: 0.9, h: 1.1 },
            { char: "èŠ±", w: 1.0, h: 1.1 },
            { char: "æ‰‹", w: 1.1, h: 1.0 },
            { char: "æ­£", w: 1.0, h: 1.0 },
            { char: "æ–‡", w: 1.1, h: 1.0 },
            { char: "å­—", w: 1.0, h: 1.0 },
            { char: "å¹´", w: 1.0, h: 1.1 },
            { char: "æœˆ", w: 0.9, h: 1.1 },
            { char: "é›¨", w: 1.1, h: 1.0 },
            { char: "è»Š", w: 1.0, h: 1.0 },
            { char: "çŸ³", w: 1.0, h: 1.0 },
            { char: "è¶³", w: 1.0, h: 1.1 },
            { char: "è€³", w: 0.9, h: 1.1 }
        ];

        // ç†Ÿèªè¾æ›¸ï¼ˆã€Œæ¼¢å­—1+æ¼¢å­—2ã€â†’ã€Œèª­ã¿ä»®åã€ï¼‰
        const jukugoDict = {
            "ç«å±±": "ã‹ã–ã‚“",
            "å¤§å°": "ã ã„ã—ã‚‡ã†",
            "äººå£": "ã˜ã‚“ã“ã†",
            "æ°´ç”°": "ã™ã„ã§ã‚“",
            "æ—¥æœ¬": "ã«ã»ã‚“",
            "å¤©æ°—": "ã¦ã‚“ã",
            "å­¦æ ¡": "ãŒã£ã“ã†",
            "ç‹å­": "ãŠã†ã˜",
            "å…¥åŠ›": "ã«ã‚…ã†ã‚Šã‚‡ã",
            "ä¸Šä¸‹": "ã˜ã‚‡ã†ã’",
            "å…ˆç”Ÿ": "ã›ã‚“ã›ã„",
            "é’ç©º": "ã‚ãŠãã‚‰",
            "å­¦ç”Ÿ": "ãŒãã›ã„",
            "äººç”Ÿ": "ã˜ã‚“ã›ã„",
            "ç«åŠ›": "ã‹ã‚Šã‚‡ã",
            "æ°´åŠ›": "ã™ã„ã‚Šã‚‡ã",
            "æœ¬äºº": "ã»ã‚“ã«ã‚“",
            "å¤§äºº": "ãŠã¨ãª",
            "å¤©ä¸‹": "ã¦ã‚“ã‹",
            "å¤§é‡‘": "ãŸã„ãã‚“",
            "å…¥å£": "ã„ã‚Šãã¡",
            "åœŸæœ¨": "ã©ã¼ã",
            "ç›®ä¸Š": "ã‚ã†ãˆ",
            "ç›®ä¸‹": "ã‚ã—ãŸ",
            "æ‰‹æœ¬": "ã¦ã»ã‚“",
            "èŠ±ç«": "ã¯ãªã³",
            "é›¨æ°´": "ã‚ã¾ã¿ãš",
            "é›¨å¤©": "ã†ã¦ã‚“",
            "æ­£æœˆ": "ã—ã‚‡ã†ãŒã¤",
            "æ–‡å­—": "ã‚‚ã˜",
            "æ–‡å­¦": "ã¶ã‚“ãŒã",
            "å¹´é‡‘": "ã­ã‚“ãã‚“",
            "å¹´ä¸Š": "ã¨ã—ã†ãˆ",
            "å¹´ä¸‹": "ã¨ã—ã—ãŸ",
            "ç©ºæ°—": "ãã†ã",
            "äººæ°—": "ã«ã‚“ã",
            "æœ¬æ—¥": "ã»ã‚“ã˜ã¤",
            "å¤§æœ¨": "ãŸã„ã¼ã",
            "æ°´è»Š": "ã™ã„ã—ã‚ƒ",
            "æ°´ä¸Š": "ã™ã„ã˜ã‚‡ã†",
            "ç«å£": "ã‹ã“ã†",
            "é‡‘å±±": "ãã‚“ã–ã‚“",
            "ä¸‹å±±": "ã’ã–ã‚“",
            "ä¸Šæ‰‹": "ã˜ã‚‡ã†ãš",
            "ä¸‹æ‰‹": "ã¸ãŸ",
            "å¤§æ°—": "ãŸã„ã",
            "äººåŠ›": "ã˜ã‚“ã‚Šã",
            "æœˆæ—¥": "ã¤ãã²",
            "æ­£æ°—": "ã—ã‚‡ã†ã",
            "çŸ³å±±": "ã„ã—ã‚„ã¾",
            "æ‰‹è¶³": "ã¦ã‚ã—",
            "è€³ç›®": "ã˜ã‚‚ã",
            "é‡‘æ˜Ÿ": "ãã‚“ã›ã„",
            "ä¸‹å±±": "ã’ã–ã‚“",
            "ä¸‹æ ¡": "ã’ã“ã†",
            "ä¸Šç©º": "ã˜ã‚‡ã†ãã†",
            "æœ¨ç›®": "ã‚‚ãã‚",
            "æœ¬å­—": "ã»ã‚“ã˜",
            "å¤§å­¦": "ã ã„ãŒã",
            "å…¥å­¦": "ã«ã‚…ã†ãŒã",
            "å°å­¦": "ã—ã‚‡ã†ãŒã",
            "ç”ŸèŠ±": "ã„ã‘ã°ãª",
            "é’å¹´": "ã›ã„ã­ã‚“",
            "æ­£æ–‡": "ã›ã„ã¶ã‚“",
            "è¶³ä¸‹": "ã‚ã—ã‚‚ã¨",
            "å°çŸ³": "ã“ã„ã—",
            "å…¥å±±": "ã«ã‚…ã†ã–ã‚“",
            "æœ¬æ°—": "ã»ã‚“ã",
            "å…¥æ°´": "ã«ã‚…ã†ã™ã„",
            "é’å¤©": "ã›ã„ã¦ã‚“",
            "æœˆä¸‹": "ã’ã£ã‹",
            "æ ¡æ­£": "ã“ã†ã›ã„",
            "å¤§ç‹": "ã ã„ãŠã†",
            "ç›®å…ˆ": "ã‚ã•ã",
            "æ‰‹å…ˆ": "ã¦ã•ã",
            "å¤©ä¸‹": "ã¦ã‚“ã‹",
            "å°äºº": "ã“ã³ã¨",
            "å°ç”Ÿ": "ã—ã‚‡ã†ã›ã„",
            "åŠ›å­¦": "ã‚ŠããŒã",
        };

        let engine, render, runner;
        let isPlaying = false;
        let score = 0;
        let life = 3;
        let spawnerX = 0;
        let nextKanjiIndex = 0;
        let canDrop = true;

        // ç†Ÿèªãƒãƒƒãƒé–¢é€£
        let matchedJukugo = [];          // ä»Šå›ã®ã‚²ãƒ¼ãƒ ã§è¦‹ã¤ã‘ãŸç†Ÿèªãƒªã‚¹ãƒˆ
        let matchedPairs = new Set();    // æ—¢ã«ãƒãƒƒãƒã—ãŸãƒœãƒ‡ã‚£IDãƒšã‚¢
        let popups = [];                 // èª­ã¿ä»®åãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—

        // ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚µã‚¤ã‚ºã‚’å–å¾—ï¼ˆå›ºå®šå¹…ã®ä¸­ã§ã®ã‚µã‚¤ã‚ºï¼‰
        const container = document.getElementById('game-container');
        let gameW = container.clientWidth;
        let gameH = container.clientHeight;

        function init() {
            engine = Engine.create();

            render = Render.create({
                element: container,
                engine: engine,
                options: {
                    width: gameW,
                    height: gameH,
                    background: 'transparent',
                    wireframes: false
                }
            });

            // æç”»ãƒ«ãƒ¼ãƒ—å†…ã®å‡¦ç†ï¼ˆæ–‡å­—æç”»ãªã©ï¼‰
            Events.on(render, 'afterRender', function () {
                const context = render.context;
                const bodies = Composite.allBodies(engine.world);

                // æ¼¢å­—ãƒ–ãƒ­ãƒƒã‚¯ã®æç”»
                bodies.forEach(body => {
                    if (body.label && body.label.startsWith('kanji-')) {
                        const char = body.label.split('-')[1];
                        const isMatched = body.jukugoMatched;

                        context.save();
                        context.translate(body.position.x, body.position.y);
                        context.rotate(body.angle);

                        // ãƒãƒƒãƒã—ãŸæ¼¢å­—ã¯é‡‘è‰²ã®å…‰å½©åŠ¹æœ
                        if (isMatched) {
                            context.shadowColor = '#ffd700';
                            context.shadowBlur = 15;
                            context.font = "bold 32px 'UD Digital Kyokasho-tai-R', serif";
                            context.fillStyle = "#b8860b";
                        } else {
                            context.font = "bold 30px 'UD Digital Kyokasho-tai-R', serif";
                            context.fillStyle = "#3e2723";
                        }
                        context.textAlign = "center";
                        context.textBaseline = "middle";
                        context.fillText(char, 0, 0);
                        context.restore();
                    }
                });

                // ã‚¹ãƒãƒŠãƒ¼ï¼ˆäºˆå‘Šï¼‰
                if (isPlaying && canDrop) {
                    const nextChar = kanjiList[nextKanjiIndex].char;
                    context.fillStyle = "rgba(216, 67, 21, 0.5)";
                    context.font = "bold 40px serif";
                    context.textAlign = "center";
                    context.textBaseline = "middle";
                    context.fillText(nextChar, spawnerX, 100);

                    context.beginPath();
                    context.moveTo(spawnerX, 0);
                    context.lineTo(spawnerX, 80);
                    context.strokeStyle = "#8d6e63";
                    context.lineWidth = 2;
                    context.stroke();
                }

                // èª­ã¿ä»®åãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®æç”»
                const now = Date.now();
                for (let i = popups.length - 1; i >= 0; i--) {
                    const p = popups[i];
                    const elapsed = now - p.startTime;
                    if (elapsed > 2500) {
                        popups.splice(i, 1);
                        continue;
                    }

                    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ â†’ è¡¨ç¤º â†’ ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                    let alpha = 1;
                    if (elapsed < 300) {
                        alpha = elapsed / 300;
                    } else if (elapsed > 2000) {
                        alpha = 1 - (elapsed - 2000) / 500;
                    }

                    // ä¸Šæ–¹å‘ã«å°‘ã—æµ®ãä¸ŠãŒã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    const yOffset = -Math.min(elapsed * 0.03, 30);

                    context.save();
                    context.globalAlpha = alpha;
                    context.textAlign = "center";
                    context.textBaseline = "middle";

                    // èƒŒæ™¯å¸¯
                    const text = p.jukugo + "ï¼ˆ" + p.reading + "ï¼‰";
                    context.font = "bold 20px 'UD Digital Kyokasho-tai-R', serif";
                    const metrics = context.measureText(text);
                    const bgW = metrics.width + 24;
                    const bgH = 36;
                    const px = p.x;
                    const py = p.y + yOffset;

                    context.fillStyle = "rgba(255, 215, 0, 0.9)";
                    context.beginPath();
                    // è§’ä¸¸çŸ©å½¢
                    const r = 8;
                    context.moveTo(px - bgW / 2 + r, py - bgH / 2);
                    context.lineTo(px + bgW / 2 - r, py - bgH / 2);
                    context.quadraticCurveTo(px + bgW / 2, py - bgH / 2, px + bgW / 2, py - bgH / 2 + r);
                    context.lineTo(px + bgW / 2, py + bgH / 2 - r);
                    context.quadraticCurveTo(px + bgW / 2, py + bgH / 2, px + bgW / 2 - r, py + bgH / 2);
                    context.lineTo(px - bgW / 2 + r, py + bgH / 2);
                    context.quadraticCurveTo(px - bgW / 2, py + bgH / 2, px - bgW / 2, py + bgH / 2 - r);
                    context.lineTo(px - bgW / 2, py - bgH / 2 + r);
                    context.quadraticCurveTo(px - bgW / 2, py - bgH / 2, px - bgW / 2 + r, py - bgH / 2);
                    context.closePath();
                    context.fill();

                    // ãƒ†ã‚­ã‚¹ãƒˆ
                    context.fillStyle = "#5d4037";
                    context.fillText(text, px, py);

                    context.restore();
                }
            });

            // è¡çªåˆ¤å®šï¼šç†Ÿèªãƒãƒƒãƒãƒã‚§ãƒƒã‚¯
            Events.on(engine, 'collisionStart', function (event) {
                if (!isPlaying) return;
                const pairs = event.pairs;

                for (let i = 0; i < pairs.length; i++) {
                    const pair = pairs[i];
                    const bodyA = pair.bodyA;
                    const bodyB = pair.bodyB;

                    // ä¸¡æ–¹ãŒæ¼¢å­—ãƒ–ãƒ­ãƒƒã‚¯ã‹ãƒã‚§ãƒƒã‚¯
                    if (!bodyA.label || !bodyA.label.startsWith('kanji-')) continue;
                    if (!bodyB.label || !bodyB.label.startsWith('kanji-')) continue;

                    // æ—¢ã«ãƒãƒƒãƒæ¸ˆã¿ã®ãƒšã‚¢ã¯ã‚¹ã‚­ãƒƒãƒ—
                    const pairKey = [bodyA.id, bodyB.id].sort().join('-');
                    if (matchedPairs.has(pairKey)) continue;

                    // æ—¢ã«å›ºå®šã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯åŒå£«ã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (bodyA.jukugoMatched && bodyB.jukugoMatched) continue;

                    const charA = bodyA.label.split('-')[1];
                    const charB = bodyB.label.split('-')[1];

                    // å·¦å³ã®ä½ç½®é–¢ä¿‚ã§èªé †ã‚’åˆ¤å®š
                    let leftBody, rightBody, leftChar, rightChar;
                    if (bodyA.position.x <= bodyB.position.x) {
                        leftBody = bodyA; rightBody = bodyB;
                        leftChar = charA; rightChar = charB;
                    } else {
                        leftBody = bodyB; rightBody = bodyA;
                        leftChar = charB; rightChar = charA;
                    }

                    // ä¸¡æ–¹ã®èªé †ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå·¦â†’å³ ã¨ å³â†’å·¦ï¼‰
                    const word1 = leftChar + rightChar;
                    const word2 = rightChar + leftChar;
                    let matchedWord = null;
                    let reading = null;

                    if (jukugoDict[word1]) {
                        matchedWord = word1;
                        reading = jukugoDict[word1];
                    } else if (jukugoDict[word2]) {
                        matchedWord = word2;
                        reading = jukugoDict[word2];
                    }

                    if (matchedWord) {
                        // ãƒãƒƒãƒï¼ãƒšã‚¢ã‚’è¨˜éŒ²
                        matchedPairs.add(pairKey);

                        // ãƒ–ãƒ­ãƒƒã‚¯ã‚’å›ºå®šåŒ–
                        Body.setStatic(bodyA, true);
                        Body.setStatic(bodyB, true);
                        bodyA.jukugoMatched = true;
                        bodyB.jukugoMatched = true;

                        // é‡‘è‰²ã«å¤‰æ›´
                        bodyA.render.fillStyle = '#ffd700';
                        bodyA.render.strokeStyle = '#b8860b';
                        bodyA.render.lineWidth = 3;
                        bodyB.render.fillStyle = '#ffd700';
                        bodyB.render.strokeStyle = '#b8860b';
                        bodyB.render.lineWidth = 3;

                        // Constraintã§çµåˆ
                        const constraint = Constraint.create({
                            bodyA: bodyA,
                            bodyB: bodyB,
                            stiffness: 1,
                            render: { visible: false }
                        });
                        Composite.add(engine.world, constraint);

                        // èª­ã¿ä»®åãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
                        const midX = (bodyA.position.x + bodyB.position.x) / 2;
                        const midY = Math.min(bodyA.position.y, bodyB.position.y) - 30;
                        popups.push({
                            jukugo: matchedWord,
                            reading: reading,
                            x: midX,
                            y: midY,
                            startTime: Date.now()
                        });

                        // ç†Ÿèªã‚’å›³é‘‘ã«è¨˜éŒ²
                        if (!matchedJukugo.find(j => j.word === matchedWord)) {
                            matchedJukugo.push({ word: matchedWord, reading: reading });
                        }

                        // ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆ +3
                        score += 3;
                        updateUI();

                        // ç”»é¢ã‚’é‡‘è‰²ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
                        container.style.boxShadow = "inset 0 0 50px rgba(255, 215, 0, 0.6)";
                        setTimeout(() => container.style.boxShadow = "0 0 20px rgba(0,0,0,0.2)", 400);
                    }
                }
            });

            // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ã¦ã‚‚æ¯”ç‡ã‚’ç¶­æŒï¼‰
            window.addEventListener('resize', () => {
                gameW = container.clientWidth;
                gameH = container.clientHeight;
                render.canvas.width = gameW;
                render.canvas.height = gameH;

                if (!isPlaying) {
                    Composite.clear(engine.world);
                    createPlatform();
                }
            });

            runner = Runner.create();
        }

        function createPlatform() {
            // å°åº§ã®ã¿ä½œæˆï¼ˆåœ°é¢ã¯ä½œã‚‰ãªã„ï¼è½ã¡ãŸã‚‰çµ‚ã‚ã‚Šï¼‰
            const platformW = 320;
            const platformH = 30;

            const platform = Bodies.rectangle(gameW / 2, gameH - 100, platformW, platformH, {
                isStatic: true,
                render: { fillStyle: '#8d6e63' },
                label: 'platform'
            });

            Composite.add(engine.world, platform);
        }

        function startGame() {
            if (!engine) init();

            // ä¸–ç•Œã‚’ãƒªã‚»ãƒƒãƒˆ
            Composite.clear(engine.world);
            Engine.clear(engine);

            // ã‚µã‚¤ã‚ºå†å–å¾—ï¼ˆå¿µã®ãŸã‚ï¼‰
            gameW = container.clientWidth;
            gameH = container.clientHeight;
            render.canvas.width = gameW;
            render.canvas.height = gameH;

            createPlatform();

            score = 0;
            life = 3;
            matchedJukugo = [];
            matchedPairs = new Set();
            popups = [];
            updateUI();

            nextKanjiIndex = Math.floor(Math.random() * kanjiList.length);

            isPlaying = true;
            canDrop = true;

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('gameover-screen').style.display = 'none';

            Render.run(render);
            Runner.run(runner, engine);

            gameLoop();
        }

        function gameLoop() {
            if (!isPlaying) return;

            // ã‚¹ãƒãƒŠãƒ¼ç§»å‹•ï¼ˆå°åº§ã®å¹…ãã‚‰ã„ã‚’è¡Œã£ãŸã‚Šæ¥ãŸã‚Šï¼‰
            const time = Date.now() * 0.002;
            // æŒ¯ã‚Œå¹…ã‚’å°åº§ã‚ˆã‚Šå°‘ã—ç‹­ãã™ã‚‹ï¼ˆç©ã¿ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
            const range = 140;
            spawnerX = (gameW / 2) + Math.sin(time) * range;

            // è½ä¸‹åˆ¤å®š + ç©ã¿ä¸ŠãŒã‚Šåˆ¤å®š
            const bodies = Composite.allBodies(engine.world);
            const topLine = 130; // ã‚¹ãƒãƒŠãƒ¼ãƒ©ã‚¤ãƒ³ä»˜è¿‘

            for (let i = bodies.length - 1; i >= 0; i--) {
                const b = bodies[i];
                if (b.label === 'platform') continue;

                // ç”»é¢å¤–ï¼ˆä¸‹ï¼‰ã«è½ã¡ãŸã‚‰ãƒŸã‚¹
                if (!b.isStatic && b.position.y > gameH + 50) {
                    Composite.remove(engine.world, b);
                    life--;
                    updateUI();

                    // ç”»é¢ã‚’èµ¤ããƒ•ãƒ©ãƒƒã‚·ãƒ¥
                    container.style.boxShadow = "inset 0 0 50px red";
                    setTimeout(() => container.style.boxShadow = "0 0 20px rgba(0,0,0,0.2)", 200);

                    if (life <= 0) {
                        gameOver();
                        return;
                    }
                }

                // ç©ã¿ä¸ŠãŒã‚Šåˆ¤å®šï¼šæ¼¢å­—ãƒ–ãƒ­ãƒƒã‚¯ãŒä¸Šéƒ¨ãƒ©ã‚¤ãƒ³ã«åˆ°é”ã—ã€ã»ã¼é™æ­¢ã—ã¦ã„ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
                // â€»ç”Ÿæˆã‹ã‚‰2ç§’ä»¥å†…ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè½ä¸‹ä¸­ã®èª¤åˆ¤å®šã‚’é˜²ãï¼‰
                if (b.label && b.label.startsWith('kanji-') && b.position.y < topLine) {
                    const age = Date.now() - (b.createdAt || 0);
                    if (age > 2000) {
                        const speed = Math.sqrt(b.velocity.x ** 2 + b.velocity.y ** 2);
                        if (speed < 1) {
                            // ã»ã¼é™æ­¢çŠ¶æ…‹ã§ä¸Šéƒ¨ã«åˆ°é” â†’ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
                            gameOver();
                            return;
                        }
                    }
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // ã‚¿ãƒƒãƒ—æ“ä½œ
        container.addEventListener('pointerdown', (e) => {
            // ãƒœã‚¿ãƒ³ç­‰ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
            if (e.target.closest('button') || e.target.closest('a')) return;
            if (!isPlaying || !canDrop) return;

            dropKanji();
        });

        function dropKanji() {
            canDrop = false;

            const data = kanjiList[nextKanjiIndex];
            const baseSize = 50;
            const w = baseSize * data.w;
            const h = baseSize * data.h;

            const colors = ['#ffe0b2', '#ffcc80', '#ffecb3', '#fff9c4'];
            const color = colors[Math.floor(Math.random() * colors.length)];

            // ã‚¹ãƒãƒŠãƒ¼ã®ä½ç½®ã‹ã‚‰è½ä¸‹
            const body = Bodies.rectangle(spawnerX, 100, w, h, {
                restitution: 0.1,
                friction: 0.8,
                density: 0.002,
                render: {
                    fillStyle: color,
                    strokeStyle: '#8d6e63',
                    lineWidth: 2
                },
                label: 'kanji-' + data.char
            });
            body.createdAt = Date.now(); // ç”Ÿæˆæ™‚åˆ»ã‚’è¨˜éŒ²

            Composite.add(engine.world, body);

            nextKanjiIndex = Math.floor(Math.random() * kanjiList.length);
            score++;
            updateUI();

            setTimeout(() => {
                canDrop = true;
            }, 600); // ãƒ†ãƒ³ãƒã‚ˆãè½ã¨ã›ã‚‹ã‚ˆã†å°‘ã—çŸ­ç¸®
        }

        function updateUI() {
            document.getElementById('score').textContent = score;
            let hearts = "";
            for (let i = 0; i < life; i++) hearts += "â¤ï¸";
            document.getElementById('life-display').textContent = hearts;
        }

        function gameOver() {
            isPlaying = false;
            Runner.stop(runner);
            document.getElementById('final-score').textContent = score;

            // ç†Ÿèªå›³é‘‘ã‚’è¡¨ç¤º
            const resultArea = document.getElementById('jukugo-result-area');
            if (matchedJukugo.length > 0) {
                let html = '<div class="jukugo-result">';
                html += '<h3>ğŸ“– ã¿ã¤ã‘ãŸç†Ÿèªï¼ˆã˜ã‚…ãã”ï¼‰</h3>';
                matchedJukugo.forEach(j => {
                    html += `<span class="jukugo-item"><ruby>${j.word}<rt>${j.reading}</rt></ruby></span>`;
                });
                html += '</div>';
                resultArea.innerHTML = html;
            } else {
                resultArea.innerHTML = '<div class="jukugo-result"><p class="no-jukugo">ç†Ÿèªã¯ã¿ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚<br>ã¤ãã¯ã•ãŒã—ã¦ã¿ã‚ˆã†ï¼</p></div>';
            }

            document.getElementById('gameover-screen').style.display = 'flex';
            if (typeof showSaveDialog === 'function') {
                showSaveDialog('tsumitsumi', score);
            }
        }

        init();

    </script>
</body>

</html>