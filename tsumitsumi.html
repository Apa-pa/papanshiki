<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼¢å­—ã¤ã¿ã¤ã¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="ranking.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #e0e0e0; /* PCãªã©ã®èƒŒæ™¯è‰²ï¼ˆæ å¤–ï¼‰ */
            font-family: "UD Digital Kyokasho-tai-R", "Zen Kaku Gothic New", sans-serif;
            touch-action: manipulation;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ã‚’ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã«å›ºå®š */
        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px; /* æœ€å¤§å¹…ã‚’åˆ¶é™ */
            height: 100%;
            max-height: 900px;
            background-color: #fffbe6; /* ã‚²ãƒ¼ãƒ ç”»é¢ã®èƒŒæ™¯ */
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.2); /* å½±ã‚’ã¤ã‘ã¦æµ®ãä¸ŠãŒã‚‰ã›ã‚‹ */
        }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hud {
            position: absolute;
            top: 20px; left: 20px;
            font-size: 24px; font-weight: bold;
            color: #5d4037;
            text-shadow: 2px 2px 0 #fff;
        }

        .life-area {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 24px;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 253, 231, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            pointer-events: auto;
            text-align: center;
        }

        h1 {
            color: #d84315; font-size: 36px; margin-bottom: 10px;
            font-family: serif;
        }

        .btn {
            background: #d84315; color: white; border: none;
            padding: 15px 50px; font-size: 22px;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px #bf360c; font-weight: bold;
            margin-top: 20px;
        }
        .btn:active { transform: scale(0.95); box-shadow: none; }

        .back-link {
            margin-top: 20px; color: #8d6e63;
            text-decoration: underline; font-size: 16px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="ui-layer">
        <div class="hud">ã¤ã‚“ã æ•°: <span id="score">0</span> ã“</div>
        <div class="life-area" id="life-display">â¤ï¸â¤ï¸â¤ï¸</div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>æ¼¢å­—ã¤ã¿ã¤ã¿</h1>
        <div style="font-size: 60px; margin: 20px;">ğŸ§±</div>
        <p style="color:#5d4037; font-size:16px; line-height: 1.6;">
            ã‚†ã‚Œã‚‹ æ¼¢å­—(ã‹ã‚“ã˜)ã‚’ ã‚¿ãƒƒãƒ—ã§ ãŠã¨ãã†ï¼<br>
            å°åº§(ã ã„ã–)ã‹ã‚‰ ãŠã¡ãŸã‚‰ ã‚¢ã‚¦ãƒˆã ã‚ˆã€‚
        </p>
        <button class="btn" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <br>
        <a href="index.html" class="back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>
    </div>

    <div id="gameover-screen" class="overlay" style="display:none;">
        <h1 style="color:#5d4037;">ãã“ã¾ã§ï¼</h1>
        <p style="font-size:24px; color:#d84315; font-weight:bold;">
            ãã‚ã: <span id="final-score">0</span> ã“
        </p>
        <button class="btn" onclick="startGame()">ã‚‚ã†ã„ã£ã‹ã„</button>
        <br>
        <a href="index.html" class="back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
    </div>
</div>

<script>
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Events = Matter.Events;

    // æ¼¢å­—ãƒ‡ãƒ¼ã‚¿
    const kanjiList = [
        { char: "å±±", w: 1.2, h: 0.8 },
        { char: "å·", w: 0.8, h: 1.2 },
        { char: "ç”°", w: 1.0, h: 1.0 },
        { char: "æ—¥", w: 0.9, h: 1.1 },
        { char: "ç›®", w: 0.9, h: 1.1 },
        { char: "å£", w: 1.0, h: 0.9 },
        { char: "æœ¨", w: 1.1, h: 1.1 },
        { char: "äºº", w: 1.2, h: 0.8 },
        { char: "æ°´", w: 1.1, h: 1.1 },
        { char: "ç«", w: 1.1, h: 1.1 },
        { char: "åœŸ", w: 1.2, h: 0.8 },
        { char: "ç‹", w: 1.1, h: 1.0 },
        { char: "é‡‘", w: 1.2, h: 1.0 },
        { char: "å¤§", w: 1.3, h: 1.0 },
        { char: "å°", w: 0.8, h: 0.8 },
        { char: "åŠ›", w: 1.0, h: 1.1 },
        { char: "å¤•", w: 1.0, h: 1.0 },
        { char: "å††", w: 1.0, h: 1.0 }
    ];

    let engine, render, runner;
    let isPlaying = false;
    let score = 0;
    let life = 3;
    let spawnerX = 0;
    let nextKanjiIndex = 0;
    let canDrop = true;

    // ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚µã‚¤ã‚ºã‚’å–å¾—ï¼ˆå›ºå®šå¹…ã®ä¸­ã§ã®ã‚µã‚¤ã‚ºï¼‰
    const container = document.getElementById('game-container');
    let gameW = container.clientWidth;
    let gameH = container.clientHeight;

    function init() {
        engine = Engine.create();
        
        render = Render.create({
            element: container,
            engine: engine,
            options: {
                width: gameW,
                height: gameH,
                background: 'transparent',
                wireframes: false
            }
        });

        // æç”»ãƒ«ãƒ¼ãƒ—å†…ã®å‡¦ç†ï¼ˆæ–‡å­—æç”»ãªã©ï¼‰
        Events.on(render, 'afterRender', function() {
            const context = render.context;
            const bodies = Composite.allBodies(engine.world);

            context.font = "bold 30px 'UD Digital Kyokasho-tai-R', serif";
            context.textAlign = "center";
            context.textBaseline = "middle";
            context.fillStyle = "#3e2723";

            bodies.forEach(body => {
                if (body.label && body.label.startsWith('kanji-')) {
                    const char = body.label.split('-')[1];
                    context.save();
                    context.translate(body.position.x, body.position.y);
                    context.rotate(body.angle);
                    context.fillText(char, 0, 0);
                    context.restore();
                }
            });

            // ã‚¹ãƒãƒŠãƒ¼ï¼ˆäºˆå‘Šï¼‰
            if(isPlaying && canDrop) {
                const nextChar = kanjiList[nextKanjiIndex].char;
                context.fillStyle = "rgba(216, 67, 21, 0.5)";
                context.font = "bold 40px serif";
                context.fillText(nextChar, spawnerX, 100);
                
                context.beginPath();
                context.moveTo(spawnerX, 0);
                context.lineTo(spawnerX, 80);
                context.strokeStyle = "#8d6e63";
                context.lineWidth = 2;
                context.stroke();
            }
        });

        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ã¦ã‚‚æ¯”ç‡ã‚’ç¶­æŒï¼‰
        window.addEventListener('resize', () => {
            gameW = container.clientWidth;
            gameH = container.clientHeight;
            render.canvas.width = gameW;
            render.canvas.height = gameH;
            
            // åœ°é¢ãªã©ã®å†é…ç½®ãŒå¿…è¦ãªã‚‰ã“ã“ã§è¡Œã†ãŒã€
            // ä»Šå›ã¯å›ºå®šå¹…ã‚³ãƒ³ãƒ†ãƒŠãªã®ã§CSSå´ã§åˆ¶å¾¡ã•ã‚Œã€JSå´ã¯ã‚ã¾ã‚Šå´©ã‚Œãªã„
            // ãŸã ã—å°åº§ã®ä½ç½®ã¯ãšã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å†ç”Ÿæˆ
            if(!isPlaying) {
                Composite.clear(engine.world);
                createPlatform();
            }
        });

        runner = Runner.create();
    }

    function createPlatform() {
        // å°åº§ã®ã¿ä½œæˆï¼ˆåœ°é¢ã¯ä½œã‚‰ãªã„ï¼è½ã¡ãŸã‚‰çµ‚ã‚ã‚Šï¼‰
        // å¹…ã‚’320pxã«è¨­å®šï¼ˆä»¥å‰ã‚ˆã‚Šåºƒãï¼‰
        const platformW = 320;
        const platformH = 30;
        
        const platform = Bodies.rectangle(gameW / 2, gameH - 100, platformW, platformH, {
            isStatic: true,
            render: { fillStyle: '#8d6e63' },
            label: 'platform'
        });

        Composite.add(engine.world, platform);
    }

    function startGame() {
        if (!engine) init();

        // ä¸–ç•Œã‚’ãƒªã‚»ãƒƒãƒˆ
        Composite.clear(engine.world);
        Engine.clear(engine);
        
        // ã‚µã‚¤ã‚ºå†å–å¾—ï¼ˆå¿µã®ãŸã‚ï¼‰
        gameW = container.clientWidth;
        gameH = container.clientHeight;
        render.canvas.width = gameW;
        render.canvas.height = gameH;

        createPlatform();

        score = 0;
        life = 3;
        updateUI();
        
        nextKanjiIndex = Math.floor(Math.random() * kanjiList.length);
        
        isPlaying = true;
        canDrop = true;

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('gameover-screen').style.display = 'none';

        Render.run(render);
        Runner.run(runner, engine);
        
        gameLoop();
    }

    function gameLoop() {
        if (!isPlaying) return;

        // ã‚¹ãƒãƒŠãƒ¼ç§»å‹•ï¼ˆå°åº§ã®å¹…ãã‚‰ã„ã‚’è¡Œã£ãŸã‚Šæ¥ãŸã‚Šï¼‰
        const time = Date.now() * 0.002;
        // æŒ¯ã‚Œå¹…ã‚’å°åº§ã‚ˆã‚Šå°‘ã—ç‹­ãã™ã‚‹ï¼ˆç©ã¿ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
        const range = 140; 
        spawnerX = (gameW / 2) + Math.sin(time) * range;

        // è½ä¸‹åˆ¤å®š
        const bodies = Composite.allBodies(engine.world);
        for (let i = bodies.length - 1; i >= 0; i--) {
            const b = bodies[i];
            if (b.isStatic) continue;

            // ç”»é¢å¤–ï¼ˆä¸‹ï¼‰ã«è½ã¡ãŸã‚‰ãƒŸã‚¹
            if (b.position.y > gameH + 50) {
                Composite.remove(engine.world, b);
                life--;
                updateUI();
                
                // ç”»é¢ã‚’èµ¤ããƒ•ãƒ©ãƒƒã‚·ãƒ¥
                container.style.boxShadow = "inset 0 0 50px red";
                setTimeout(() => container.style.boxShadow = "0 0 20px rgba(0,0,0,0.2)", 200);

                if (life <= 0) {
                    gameOver();
                    return;
                }
            }
        }

        requestAnimationFrame(gameLoop);
    }

    // ã‚¿ãƒƒãƒ—æ“ä½œ
    container.addEventListener('pointerdown', (e) => {
        // ãƒœã‚¿ãƒ³ç­‰ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
        if (e.target.closest('button') || e.target.closest('a')) return;
        if (!isPlaying || !canDrop) return;

        dropKanji();
    });

    function dropKanji() {
        canDrop = false;

        const data = kanjiList[nextKanjiIndex];
        const baseSize = 50; 
        const w = baseSize * data.w;
        const h = baseSize * data.h;

        const colors = ['#ffe0b2', '#ffcc80', '#ffecb3', '#fff9c4'];
        const color = colors[Math.floor(Math.random() * colors.length)];

        // ã‚¹ãƒãƒŠãƒ¼ã®ä½ç½®ã‹ã‚‰è½ä¸‹
        const body = Bodies.rectangle(spawnerX, 100, w, h, {
            restitution: 0.1,
            friction: 0.8,
            density: 0.002,
            render: {
                fillStyle: color,
                strokeStyle: '#8d6e63',
                lineWidth: 2
            },
            label: 'kanji-' + data.char
        });

        Composite.add(engine.world, body);

        nextKanjiIndex = Math.floor(Math.random() * kanjiList.length);
        score++;
        updateUI();

        setTimeout(() => {
            canDrop = true;
        }, 600); // ãƒ†ãƒ³ãƒã‚ˆãè½ã¨ã›ã‚‹ã‚ˆã†å°‘ã—çŸ­ç¸®
    }

    function updateUI() {
        document.getElementById('score').textContent = score;
        let hearts = "";
        for(let i=0; i<life; i++) hearts += "â¤ï¸";
        document.getElementById('life-display').textContent = hearts;
    }

    function gameOver() {
        isPlaying = false;
        Runner.stop(runner);
        document.getElementById('final-score').textContent = score;
        document.getElementById('gameover-screen').style.display = 'flex';
        if(typeof showSaveDialog === 'function') {
            showSaveDialog('tsumitsumi', score);
        }
    }

    init();

</script>
</body>
</html>