<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã„ã¾ãªã‚“ã˜ï¼Ÿ ã¨ã‘ã„ã‚¯ã‚¤ã‚º</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", "UD Digital Kyokasho-tai", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #fff8e1; /* ã‚„ã•ã—ã„é»„è‰² */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
        }

        #game-container {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .screen { display: none; }
        .active { display: block; }

        h1 { color: #ff6f00; font-size: 26px; }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆæ™‚è¨ˆã®æç”»ã‚¨ãƒªã‚¢ï¼‰ */
        canvas {
            background-color: white;
            border-radius: 50%;
            margin: 10px auto;
            display: block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        #choices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .choice-btn {
            font-size: 28px;
            padding: 15px 5px;
            background: #e3f2fd;
            border: 3px solid #90caf9;
            border-radius: 15px;
            cursor: pointer;
            color: #333;
            font-weight: bold;
            font-family: inherit;
        }
        .choice-btn:active { background: #bbdefb; transform: translateY(2px); }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ç­‰ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .start-btn, .retry-btn {
            font-size: 24px;
            padding: 15px 40px;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            font-family: inherit;
            font-weight: bold;
        }
        .start-btn { background: #ff9800; box-shadow: 0 5px #e65100; }
        .retry-btn { background: #4caf50; box-shadow: 0 5px #2e7d32; }
        .start-btn:active, .retry-btn:active { transform: scale(0.95); box-shadow: none; }

        .back-to-index-btn {
            font-size: 16px;
            padding: 10px 20px;
            background: #90a4ae;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        /* æ­£è§£ãƒ»ä¸æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .correct-flash { animation: flash 0.3s; }
        @keyframes flash {
            0% { background-color: white; }
            50% { background-color: #c8e6c9; }
            100% { background-color: white; }
        }

        #feedback-mark {
            position: absolute;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 180px;
            display: none;
            z-index: 100;
            pointer-events: none;
            text-shadow: 3px 3px 0px white;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="feedback-mark">â­•</div>

    <div id="home-screen" class="screen active">
        <h1>ã„ã¾ ãªã‚“ã˜ï¼Ÿ</h1>
        <div style="font-size: 80px; margin: 10px;">ğŸ•’</div>
        <p>ã¨ã‘ã„ã‚’ã¿ã¦ã€ãŸã ã—ã„ã˜ã‹ã‚“ã‚’<br>ã‚ã¦ã¦ã­ï¼</p>
        <button class="start-btn" onclick="startGame()">ã‚ˆãƒ¼ã„ã€ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        <br>
        <a href="index.html" class="back-to-index-btn">ğŸ  ã‚‚ã©ã‚‹</a>
    </div>

    <div id="quiz-screen" class="screen">
        <div style="display:flex; justify-content:space-between; padding:0 10px; color:#555;">
            <span id="timer-display">0.0ã³ã‚‡ã†</span>
            <span id="progress">1 / 10</span>
        </div>
        
        <canvas id="clockCanvas" width="250" height="250"></canvas>
        
        <div id="choices"></div>
        <br>
        <a href="index.html" class="back-to-index-btn" style="background:#cfd8dc; color:#555;">ğŸ  ã‚„ã‚ã‚‹</a>
    </div>

    <div id="result-screen" class="screen">
        <h1>âœ¨ ã‚´ãƒ¼ãƒ«ï¼ âœ¨</h1>
        <div style="font-size: 60px;">ğŸ†</div>
        <p>ãã¿ã® ã‚¿ã‚¤ãƒ ã¯...</p>
        <div id="final-time" style="font-size:36px; color:#d84315; font-weight:bold; margin:10px;">0.0ã³ã‚‡ã†</div>
        <button class="retry-btn" onclick="startGame()">ã‚‚ã†ã„ã£ã‹ã„ï¼</button>
        <br>
        <a href="index.html" class="back-to-index-btn">ğŸ  ã‚‚ã©ã‚‹</a>
    </div>
</div>

<script>
    const canvas = document.getElementById('clockCanvas');
    const ctx = canvas.getContext('2d');
    const totalQuestions = 10;
    let currentQuestion = 0;
    let correctTime = { h: 0, m: 0 };
    let startTime, timerInterval;

    // æ™‚è¨ˆã‚’æç”»ã™ã‚‹é–¢æ•°ï¼ˆé‡è¦ï¼ï¼‰
    function drawClock(hour, minute) {
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        const radius = cx - 10;

        // ãƒªã‚»ãƒƒãƒˆ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // æ ã‚’æã
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
        ctx.fillStyle = '#fff';
        ctx.fill();
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 5;
        ctx.stroke();

        // æ–‡å­—ç›¤ã®æ•°å­—
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for (let num = 1; num <= 12; num++) {
            const ang = num * Math.PI / 6;
            const x = cx + radius * 0.8 * Math.sin(ang);
            const y = cy - radius * 0.8 * Math.cos(ang);
            ctx.fillText(num.toString(), x, y);
        }

        // åˆ†é‡ï¼ˆãªãŒã„é‡ï¼‰
        const mAng = (minute * Math.PI / 30);
        drawHand(cx, cy, mAng, radius * 0.85, 5, '#2196f3'); // é’è‰²

        // æ™‚é‡ï¼ˆã¿ã˜ã‹ã„é‡ï¼‰
        // â€»ãƒã‚¤ãƒ³ãƒˆï¼šåˆ†ãŒé€²ã‚€ã«ã¤ã‚Œã¦æ™‚é‡ã‚‚å°‘ã—é€²ã‚ã‚‹
        const hAng = (hour % 12 * Math.PI / 6) + (minute * Math.PI / 360);
        drawHand(cx, cy, hAng, radius * 0.55, 8, '#f44336'); // èµ¤è‰²

        // ä¸­å¿ƒç‚¹
        ctx.beginPath();
        ctx.arc(cx, cy, 8, 0, 2 * Math.PI);
        ctx.fillStyle = '#333';
        ctx.fill();
    }

    function drawHand(cx, cy, angle, length, width, color) {
        ctx.beginPath();
        ctx.lineWidth = width;
        ctx.lineCap = 'round';
        ctx.strokeStyle = color;
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + length * Math.sin(angle), cy - length * Math.cos(angle));
        ctx.stroke();
    }

    function changeScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function startGame() {
        currentQuestion = 0;
        changeScreen('quiz-screen');
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const t = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = t + "ã³ã‚‡ã†";
        }, 100);
        nextQuestion();
    }

    function stopTimer() {
        clearInterval(timerInterval);
        return ((Date.now() - startTime) / 1000).toFixed(1);
    }

    function nextQuestion() {
        if (currentQuestion >= totalQuestions) {
            const time = stopTimer();
            document.getElementById('final-time').textContent = time + "ã³ã‚‡ã†";
            changeScreen('result-screen');
            // IDã¯ 'clock_read'ã€è¨˜éŒ²ã¯ time (ç§’æ•°) ã§ã™
            if(typeof showSaveDialog === 'function') {
                showSaveDialog('clock_read', time);
            }

            return;
        }

        currentQuestion++;
        document.getElementById('progress').textContent = `${currentQuestion} / ${totalQuestions}`;

        // å•é¡Œä½œæˆï¼š5åˆ†åˆ»ã¿ã§ãƒ©ãƒ³ãƒ€ãƒ ãªæ™‚é–“ã‚’ç”Ÿæˆ
        let h = Math.floor(Math.random() * 12) + 1; // 1~12
        let m = Math.floor(Math.random() * 12) * 5; // 0, 5, 10...55
        correctTime = { h, m };

        drawClock(h, m);
        generateChoices(h, m);
    }

    function generateChoices(h, m) {
        // æ­£è§£ã®æ–‡å­—åˆ—
        const correctStr = `${h}ã˜ ${m}ãµã‚“`.replace(' 0ãµã‚“', ' ã¯ã‚“').replace('0ãµã‚“', ''); 
        // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œ3ã˜ 00ãµã‚“ã€å½¢å¼ã§è¡¨ç¤ºçµ±ä¸€ã—ã¾ã™
        
        const formatTime = (hh, mm) => `${hh}ã˜ ${mm.toString().padStart(2, '0')}ãµã‚“`;
        
        let answers = [formatTime(h, m)];

        // ãƒ€ãƒŸãƒ¼ç”Ÿæˆï¼ˆã‚ˆãã‚ã‚‹é–“é•ã„ã‚’ä½œã‚‹ï¼‰
        while (answers.length < 4) {
            let dh = Math.floor(Math.random() * 12) + 1;
            let dm = Math.floor(Math.random() * 12) * 5;
            
            // å¼•ã£ã‹ã‘å•é¡Œï¼šé‡ãŒé€†ï¼ˆ9:15 ã¨ 3:45ãªã©ï¼‰
            if (answers.length === 1) { dh = h + 1; dm = m; } 
            
            let str = formatTime(dh > 12 ? dh - 12 : dh, dm);
            if (!answers.includes(str)) {
                answers.push(str);
            }
        }

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        answers.sort(() => Math.random() - 0.5);

        const container = document.getElementById('choices');
        container.innerHTML = '';
        answers.forEach(ans => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = ans;
            btn.onclick = () => checkAnswer(ans, formatTime(h, m));
            container.appendChild(btn);
        });
    }

    function checkAnswer(selected, correct) {
        const feedback = document.getElementById('feedback-mark');
        if (selected === correct) {
            feedback.textContent = 'â­•';
            feedback.style.color = '#ff3d00';
            feedback.style.display = 'block';
            document.body.classList.add('correct-flash');
            
            setTimeout(() => {
                feedback.style.display = 'none';
                document.body.classList.remove('correct-flash');
                nextQuestion();
            }, 600);
        } else {
            feedback.textContent = 'âŒ';
            feedback.style.color = '#555';
            feedback.style.display = 'block';
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 500);
        }
    }
</script>

</body>
</html>