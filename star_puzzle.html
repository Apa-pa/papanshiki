<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊòüÁ©∫„Éë„Ç∫„É´</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #0d1b2a;
            background-image: radial-gradient(white 1px, transparent 1px), radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh;
            touch-action: none;
            user-select: none;
            overflow: hidden;
            color: white;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header-info {
            position: absolute; top: 10px; left: 10px;
            z-index: 10;
            pointer-events: none;
        }
        .stage-title {
            font-size: 24px; font-weight: bold; color: #ffd700;
            text-shadow: 2px 2px 0 #000;
            margin-bottom: 5px;
        }
        .target-guide {
            font-size: 18px; font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }
        
        .quit-btn {
            position: absolute; top: 10px; right: 10px;
            font-weight: bold; color: #fff; z-index: 20;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px; border-radius: 20px;
            text-decoration: none; font-size: 14px;
            pointer-events: auto;
        }

        .canvas-area {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px; 
            box-sizing: border-box;
        }

        svg {
            width: 100%; height: 100%;
            max-width: 100%;
            max-height: 100%;
        }

        .star {
            fill: #ffd700;
            stroke: none;
            cursor: pointer;
            transition: r 0.3s;
        }
        .star.active { fill: #fff; filter: drop-shadow(0 0 10px #fff); }
        
        .star-num {
            fill: #fff;
            font-size: 16px;
            font-weight: bold;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: central;
            text-shadow: 0 0 3px #000; /* ÊñáÂ≠ó„ÇíË¶ã„ÇÑ„Åô„Åè */
        }

        .constellation-line {
            stroke: #ffd700;
            stroke-width: 4;
            stroke-linecap: round;
            opacity: 0.6;
            filter: drop-shadow(0 0 5px #ffd700);
        }

        .complete-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 1s;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 25;
        }
        
        .complete-text {
            font-size: 40px; font-weight: bold; color: #ffeb3b;
            text-shadow: 0 0 20px #ff9800;
            margin-bottom: 20px;
            transform: scale(0.5);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            line-height: 1.2;
        }

        .next-btn {
            position: absolute; bottom: 50px; left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px; background: #e91e63; color: white;
            border: none; border-radius: 30px; font-size: 20px;
            font-weight: bold;
            display: none; cursor: pointer;
            box-shadow: 0 4px #ad1457;
            pointer-events: auto;
            z-index: 30;
        }
        .next-btn:active { transform: translateX(-50%) translateY(2px); box-shadow: none; }

    </style>
</head>
<body>

<div id="game-container">
    <div class="header-info">
        <div class="stage-title" id="stage-name">ÊòüÂ∫ßÂêç</div>
        <div class="target-guide">„Å§„Åé„ÅÆÊòü: <span id="target-num" style="color:#ff4081; font-size:24px;">1</span></div>
    </div>
    
    <a href="index.html" class="quit-btn">üè† „ÇÑ„ÇÅ„Çã</a>

    <div class="canvas-area">
        <svg id="svg-field" viewBox="0 0 400 600" preserveAspectRatio="xMidYMid meet">
            </svg>

        <div id="complete-overlay" class="complete-overlay">
            <div style="font-size:80px;">‚ú®</div>
            <div id="final-text" class="complete-text">„Åã„Çì„Åõ„ÅÑÔºÅ</div>
        </div>
    </div>
    
    <button class="next-btn" onclick="nextStage()">„Å§„Åé„ÅÆ ÊòüÂ∫ß„Å∏</button>
</div>

<script>
    // ÊòüÂ∫ß„Éá„Éº„Çø
    const STAGES = [
        {
            name: "ÂåóÊñó‰∏ÉÊòüÔºà„Åª„Åè„Å®„Åó„Å°„Åõ„ÅÑÔºâ",
            stars: [
                {x:80, y:180}, {x:140, y:210}, {x:190, y:260}, 
                {x:220, y:320}, {x:280, y:340}, {x:320, y:290}, {x:250, y:270} 
            ]
        },
        {
            name: "„Ç´„Ç∑„Ç™„Éö„É§Â∫ß",
            stars: [
                {x:50, y:250}, {x:120, y:350}, {x:200, y:300}, {x:280, y:350}, {x:350, y:250}
            ]
        },
        {
            name: "„Åï„Åù„ÇäÂ∫ß",
            stars: [
                {x:320, y:120}, {x:300, y:150}, {x:280, y:170}, 
                {x:250, y:220}, {x:220, y:270}, {x:200, y:350}, 
                {x:180, y:410}, {x:200, y:460}, {x:250, y:480}, {x:280, y:450}, {x:270, y:420} 
            ]
        },
        {
            name: "„Åó„ÅóÂ∫ß",
            stars: [
                {x:280, y:180}, {x:230, y:150}, {x:180, y:180}, {x:190, y:250}, 
                {x:250, y:280}, {x:320, y:280}, 
                {x:350, y:330}, {x:250, y:350}, {x:130, y:310} 
            ]
        },
        {
            name: "„ÅØ„Åè„Å°„Çá„ÅÜÂ∫ß",
            // ‰∏≠Â§Æ„ÅÆÊòü(200,280)„Çí3,5,7ÂõûÁõÆ„Åß‰Ωø„ÅÑ„Åæ„Åô
            stars: [
                {x:200, y:480}, {x:200, y:380}, {x:200, y:280}, 
                {x:100, y:230}, {x:200, y:280}, {x:300, y:230}, 
                {x:200, y:280}, {x:200, y:130} 
            ]
        },
        {
            name: "„Å¶„Çì„Å≥„ÇìÂ∫ß",
            // 1ÂõûÁõÆ„Å®5ÂõûÁõÆ„ÅåÂêå„ÅòÂ†¥ÊâÄ
            stars: [
                {x:200, y:200}, {x:100, y:300}, {x:200, y:400}, {x:300, y:300}, {x:200, y:200}
            ]
        },
        {
            name: "„Ç™„É™„Ç™„É≥Â∫ß",
            stars: [
                {x:120, y:150}, {x:280, y:150}, 
                {x:220, y:300}, {x:200, y:300}, {x:180, y:300}, 
                {x:120, y:450}, {x:280, y:450} 
            ]
        }
    ];

    let currentStageIdx = 0;
    let currentTarget = 1;
    let stars = [];

    window.onload = loadStage;

    function loadStage() {
        const svg = document.getElementById('svg-field');
        svg.innerHTML = ''; 
        
        const overlay = document.getElementById('complete-overlay');
        overlay.style.opacity = 0;
        document.getElementById('final-text').style.transform = "scale(0.5)";
        document.querySelector('.next-btn').style.display = 'none';
        
        const data = STAGES[currentStageIdx];
        stars = data.stars;
        
        document.getElementById('stage-name').innerText = data.name;

        currentTarget = 1;
        document.getElementById('target-num').innerText = currentTarget;

        // Êòü„ÇíÊèèÁîª
        stars.forEach((s, i) => {
            // ÂÜÜ
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", s.x);
            circle.setAttribute("cy", s.y);
            circle.setAttribute("r", 15);
            circle.setAttribute("class", "star");
            // Â∫ßÊ®ô„ÇíÁõ¥Êé•„Éá„Éº„Çø„Å®„Åó„Å¶ÊåÅ„Åü„Åõ„ÇãÔºà„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÁî®Ôºâ
            circle.setAttribute("data-x", s.x);
            circle.setAttribute("data-y", s.y);
            circle.addEventListener("pointerdown", handleTap);
            svg.appendChild(circle);
        });

        // „É©„Éô„É´ÔºàÊï∞Â≠óÔºâ„ÅÆÂàùÊúüÊèèÁîª
        updateLabels();
    }

    // Èáç„Å™„Å£„Å¶„ÅÑ„ÇãÂ†¥ÊâÄ„ÅÆÊï∞Â≠ó„ÇíÂà∂Âæ°„Åô„ÇãÈñ¢Êï∞
    function updateLabels() {
        const svg = document.getElementById('svg-field');
        // Êó¢Â≠ò„ÅÆÊï∞Â≠ó„ÇíÊ∂à„Åô
        const oldTexts = svg.querySelectorAll('.star-num');
        oldTexts.forEach(t => t.remove());

        // ÂêÑÂ∫ßÊ®ô„Åî„Å®„Å´„ÄÅ„Åæ„Å†ÈÄöÈÅé„Åó„Å¶„ÅÑ„Å™„ÅÑ‰∏ÄÁï™Ëã•„ÅÑÁï™Âè∑„ÇíË°®Á§∫„Åô„Çã
        // Â∫ßÊ®ô "x,y" „Çí„Ç≠„Éº„Å´„Åó„Å¶ÁÆ°ÁêÜ
        const map = {};

        stars.forEach((s, i) => {
            const num = i + 1;
            // „Çø„Éº„Ç≤„ÉÉ„Éà„Çà„ÇäÂ∞è„Åï„ÅÑÔºà„Åô„Åß„Å´ÈÄöÈÅé„Åó„ÅüÔºâÁï™Âè∑„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºà„Åæ„Åü„ÅØ‚òÖ„Å´„Åô„ÇãÔºâ
            if (num < currentTarget) return;

            const key = `${s.x},${s.y}`;
            // „Åæ„Å†„Åù„ÅÆÂ†¥ÊâÄ„Å´Êï∞Â≠ó„ÇíÁΩÆ„ÅÑ„Å¶„ÅÑ„Å™„ÅÑ„Å™„Çâ„ÄÅ„Åì„ÅÆÁï™Âè∑„Åå„Äå‰ªä„ÅÆ„Åù„ÅÆÂ†¥ÊâÄ„ÅÆÁï™Âè∑„Äç
            if (!map[key]) {
                map[key] = num;
                
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", s.x);
                text.setAttribute("y", s.y);
                text.setAttribute("class", "star-num");
                text.textContent = num;
                svg.appendChild(text);
            }
        });
    }

    function handleTap(e) {
        e.preventDefault();
        
        // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥ÊâÄ„ÅÆÂ∫ßÊ®ô„ÇíÂèñÂæó
        const cx = parseInt(e.target.getAttribute("data-x"));
        const cy = parseInt(e.target.getAttribute("data-y"));

        // ‰ªä„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆÊòü„ÅÆÂ∫ßÊ®ô„Å®‰∏ÄËá¥„Åô„Çã„ÅãÁ¢∫Ë™ç
        const targetStar = stars[currentTarget - 1];

        if (targetStar.x === cx && targetStar.y === cy) {
            // Ê≠£Ëß£ÔºÅ
            
            // ÂÖâ„Çâ„Åõ„ÇãÔºàÂêå„ÅòÂ∫ßÊ®ô„ÅÆÊòü„Åú„Çì„Å∂Ôºâ
            const allStars = document.querySelectorAll('.star');
            allStars.forEach(el => {
                if(parseInt(el.getAttribute("data-x")) === cx && parseInt(el.getAttribute("data-y")) === cy) {
                    el.setAttribute("class", "star active");
                }
            });
            
            // 2„Å§ÁõÆ‰ª•Èôç„Å™„ÇâÁ∑ö„ÇíÂºï„Åè
            if (currentTarget > 1) {
                drawLine(stars[currentTarget-2], stars[currentTarget-1]);
            }

            if (currentTarget === stars.length) {
                document.getElementById('target-num').innerText = "OK!";
                // ÊúÄÂæå„ÅÆÊï∞Â≠ó„ÇíÊ∂à„Åô„Åü„ÇÅ„Å´Êõ¥Êñ∞
                currentTarget++; 
                updateLabels();
                
                setTimeout(stageClear, 500);
            } else {
                currentTarget++;
                document.getElementById('target-num').innerText = currentTarget;
                // Ê¨°„ÅÆÊï∞Â≠ó„ÇíË°®Á§∫
                updateLabels();
            }
        }
    }

    function drawLine(p1, p2) {
        const svg = document.getElementById('svg-field');
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", p1.x);
        line.setAttribute("y1", p1.y);
        line.setAttribute("x2", p2.x);
        line.setAttribute("y2", p2.y);
        line.setAttribute("class", "constellation-line");
        // Êòü„Çà„ÇäÂ••„ÄÅ„Åß„ÇÇËÉåÊôØ„Çà„ÇäÊâãÂâç„Å´
        svg.insertBefore(line, svg.firstChild);
    }

    function stageClear() {
        const overlay = document.getElementById('complete-overlay');
        overlay.style.opacity = 1;
        
        const finalText = document.getElementById('final-text');
        finalText.innerText = STAGES[currentStageIdx].name;
        finalText.style.transform = "scale(1)";
        
        document.querySelector('.next-btn').style.display = 'block';
        
        if(typeof showPointGetDialog === 'function'){
           // showPointGetDialog(10);
        }
    }

    function nextStage() {
        currentStageIdx++;
        if (currentStageIdx >= STAGES.length) {
            alert("ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ Â§úÁ©∫„ÅÆÂçöÂ£´„Å†„Å≠ÔºÅ");
            currentStageIdx = 0;
            if(typeof showPointGetDialog === 'function'){
                showPointGetDialog(50);
            }
        }
        loadStage();
    }
</script>
</body>
</html>