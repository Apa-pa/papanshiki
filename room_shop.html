<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ³ãƒ†ãƒªã‚¢ã‚·ãƒ§ãƒƒãƒ—</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #e8f5e9;
            text-align: center;
            padding: 20px;
            color: #2e7d32;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { color: #2e7d32; margin-bottom: 10px; }

        .user-select-area {
            background: #c8e6c9;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        select {
            padding: 10px; font-size: 18px; border-radius: 10px;
            border: 2px solid #81c784; width: 80%; max-width: 300px;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #1b5e20;
            color: white;
            padding: 10px;
            border-radius: 50px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .point-box { font-size: 20px; }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }

        .item-card {
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 10px;
            transition: 0.2s;
            position: relative;
            background: #fff;
        }
        .item-card.owned { border-color: #81c784; background: #f1f8e9; }
        
        .badge-equipped {
            position: absolute; top: 5px; right: 5px;
            background: #ffca28; color: #5d4037;
            padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;
            z-index: 2;
        }

        .item-img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fff;
        }

        .section-title {
            text-align: left;
            border-bottom: 2px solid #a5d6a7;
            padding-bottom: 5px;
            margin: 30px 0 15px 0;
            font-size: 20px;
            font-weight: bold;
            color: #388e3c;
        }

        .action-btn {
            width: 100%; padding: 8px; margin-top: 5px;
            border: none; border-radius: 20px; font-weight: bold; cursor: pointer;
        }
        .btn-buy { background: #ff7043; color: white; }
        .btn-equip { background: #66bb6a; color: white; margin-top: 2px; font-size: 11px; padding: 5px 0;}
        .btn-disabled { background: #ccc; color: #666; cursor: not-allowed; }

        .medal-btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
        }

        .back-link {
            display: inline-block; margin-top: 10px; padding: 10px 30px;
            background: #bcaaa4; color: white; text-decoration: none;
            border-radius: 30px; font-weight: bold;
        }
        .room-link {
            display: inline-block; padding: 12px 30px;
            background: #26a69a; color: white; text-decoration: none;
            border-radius: 30px; font-weight: bold;
            box-shadow: 0 4px #00796b;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸª‘ ã‚¤ãƒ³ãƒ†ãƒªã‚¢ã‚·ãƒ§ãƒƒãƒ—</h1>
    <p>ãŠéƒ¨å±‹ã‚’ ã™ã¦ãã« ã‚‚ã‚ˆã†ãŒãˆï¼</p>

    <div class="user-select-area">
        <label>ã ã‚Œã®ãŠè²·ã„ç‰©ï¼Ÿ</label><br>
        <select id="user-select" onchange="loadShop()">
            <option value="">(ãˆã‚‰ã‚“ã§ã­)</option>
        </select>
    </div>

    <div id="shop-content" style="display:none;">
        <div class="status-bar">
            <div class="point-box">ğŸ’° <span id="current-points">0</span> pt</div>
        </div>

        <div class="section-title">ğŸ  ãŠéƒ¨å±‹ (å£ã¨åºŠ)</div>
        <div id="room-list" class="item-grid"></div>

        <div class="section-title">ğŸ† å‹²ç«  (ãã‚“ã—ã‚‡ã†)</div>
        <div id="medal-list" class="item-grid"></div>
        
        <div class="section-title">ğŸª‘ å®¶å…· (ã‹ã)</div>
        <div id="furniture-list" class="item-grid"></div>
    </div>

    <div style="margin-top: 40px; display: flex; flex-direction: column; align-items: center;">
        <a href="room.html" class="room-link">ğŸ  ãƒã‚¤ãƒ«ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>
        <a href="index.html" class="back-link">ğŸ  ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>
    </div>
</div>

<script>
    const ROOMS = [
        { id: 'none', name: 'ã‚·ãƒ³ãƒ—ãƒ«ãªãŠéƒ¨å±‹', src: '', price: 0, desc: 'ã¾ã£ã—ã‚ãª ãŠéƒ¨å±‹' },
        { id: 'room_01', name: 'ã²ã¾ã‚ã‚Šã®ã‹ã¹ãŒã¿ã®éƒ¨å±‹', src: 'room/room_01.jpg', price: 1000, desc: 'ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã«ã‹ã‚ã„ã„èŠ±ã®å£ç´™' },
        { id: 'room_02', name: 'ã•ã‚ã‚„ã‹å‹‰å¼·éƒ¨å±‹', src: 'room/room_02.jpg', price: 1500, desc: 'æ°´è‰²ã®ã•ã‚ã‚„ã‹ãªã¸ã‚„' },
        { id: 'room_03', name: 'æœ¨ã®ãŠã†ã¡', src: 'room/room_03.jpg', price: 2000, desc: 'æœ¨æ¼ã‚Œæ—¥ãŒã•ã™ã™ã¦ããªæœ¨ã®ã¸ã‚„' },
    ];

    const MEDALS = [
        { id: 'shield_silver', name: 'ã‚·ãƒ«ãƒãƒ¼ã®ãŸã¦', src: 'room/shield_silver.png', price: 100000, desc: 'éŠ€ï¼100000ãƒã‚¤ãƒ³ãƒˆã® è¨¼ï¼' },
        { id: 'shield_gold', name: 'ã‚´ãƒ¼ãƒ«ãƒ‰ã®ãŸã¦', src: 'room/shield_gold.png', price: 1000000, desc: 'é‡‘ï¼1000000ãƒã‚¤ãƒ³ãƒˆã®è¨¼ï¼' }
    ];

    const FURNITURE = [
        { id: 'table_01', name: 'æœ¨ã®å‹‰å¼·æœº', src: 'room/table_01.png', price: 1500, desc: 'ã‚ãŸãŸã‹ã¿ã®ã‚ã‚‹ æœ¨è£½ã®å‹‰å¼·ã¥ããˆ' },
        { id: 'table_02', name: 'ãµã‹ãµã‹ãƒ™ãƒƒãƒ‰', src: 'room/table_02.png', price: 1500, desc: 'ã‚ãŸãŸã‹ãã†ãªæ›å¸ƒå›£ã®ãƒ™ãƒƒãƒ‰' },
        { id: 'table_03', name: 'ã˜ã‚‡ã†ã²ã‚“ãƒ™ãƒƒãƒ‰', src: 'room/table_03.png', price: 2000, desc: 'ãƒ¬ãƒ¼ã‚¹ãŒã¤ã„ã¦ã¦ã‹ã‚ã„ã„ãƒ™ãƒƒãƒ‰' }
    ];

    const DATA_KEY = 'papan_avatar_v1';

    function getUserData() { return JSON.parse(localStorage.getItem(DATA_KEY) || '{}'); }
    function saveUserData(data) { localStorage.setItem(DATA_KEY, JSON.stringify(data)); }

    window.onload = function() {
        if(typeof getUserNames !== 'function') { alert('ranking.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
        const users = getUserNames();
        const select = document.getElementById('user-select');
        users.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u; opt.innerText = u;
            select.appendChild(opt);
        });
    };

    function loadShop() {
        const userName = document.getElementById('user-select').value;
        const shopContent = document.getElementById('shop-content');
        
        if(!userName) {
            shopContent.style.display = 'none';
            return;
        }
        shopContent.style.display = 'block';

        const currentPoints = getUserPoints(userName);
        document.getElementById('current-points').innerText = currentPoints;

        const allData = getUserData();
        const userData = allData[userName] || {};
        
        if (!userData.ownedRooms) userData.ownedRooms = ['none'];
        if (!userData.currentRoom) userData.currentRoom = 'none';
        if (!userData.ownedMedals) userData.ownedMedals = [];
        if (!userData.medals) userData.medals = {}; 
        if (!userData.ownedFurniture) userData.ownedFurniture = []; 
        if (!userData.furniture) userData.furniture = { left: null, right: null }; 

        // 1. ãŠéƒ¨å±‹
        const roomContainer = document.getElementById('room-list');
        roomContainer.innerHTML = '';
        ROOMS.forEach(item => {
            const isOwned = userData.ownedRooms.includes(item.id);
            const isEquipped = (userData.currentRoom === item.id);
            const canBuy = (currentPoints >= item.price);
            const card = document.createElement('div');
            card.className = `item-card ${isOwned ? 'owned' : ''}`;
            let btnHtml = isOwned ? (isEquipped ? `<button class="action-btn btn-equipped">ä½¿ç”¨ä¸­</button>` : `<button class="action-btn btn-equip" onclick="equipRoom('${userName}', '${item.id}')">ã‚‚ã‚ˆã†ãŒãˆ</button>`) : (canBuy ? `<button class="action-btn btn-buy" onclick="buyRoom('${userName}', '${item.id}', ${item.price})">${item.price}ptã§è³¼å…¥</button>` : `<button class="action-btn btn-disabled">${item.price}pt (ä¸è¶³)</button>`);
            card.innerHTML = `<img src="${item.src || 'https://placehold.jp/300x200.png?text=Simple'}" class="item-img"><div style="font-weight:bold;">${item.name}</div>${btnHtml}`;
            roomContainer.appendChild(card);
        });

        // 2. å‹²ç« 
        const medalContainer = document.getElementById('medal-list');
        medalContainer.innerHTML = '';
        MEDALS.forEach(item => {
            const isOwned = userData.ownedMedals.includes(item.id);
            const canBuy = (currentPoints >= item.price);
            
            // ã©ã“ã«é£¾ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const isEqL1 = (userData.medals.left1 === item.id);
            const isEqL2 = (userData.medals.left2 === item.id);
            const isEqR1 = (userData.medals.right1 === item.id);
            const isEqR2 = (userData.medals.right2 === item.id);

            let badge = '';
            if (isEqL1) badge = '<div class="badge-equipped">å·¦1</div>';
            else if (isEqL2) badge = '<div class="badge-equipped">å·¦2</div>';
            else if (isEqR1) badge = '<div class="badge-equipped">å³1</div>';
            else if (isEqR2) badge = '<div class="badge-equipped">å³2</div>';

            const card = document.createElement('div');
            card.className = `item-card ${isOwned ? 'owned' : ''}`;
            
            let btnHtml = '';
            if (isOwned) {
                btnHtml = `
                    <div class="medal-btn-group">
                        <button class="action-btn btn-equip" onclick="equipMedal('${userName}', '${item.id}', 'left2')">å·¦å¤–</button>
                        <button class="action-btn btn-equip" onclick="equipMedal('${userName}', '${item.id}', 'left1')">å·¦å†…</button>
                        <button class="action-btn btn-equip" onclick="equipMedal('${userName}', '${item.id}', 'right1')">å³å†…</button>
                        <button class="action-btn btn-equip" onclick="equipMedal('${userName}', '${item.id}', 'right2')">å³å¤–</button>
                    </div>`;
            } else if (canBuy) {
                btnHtml = `<button class="action-btn btn-buy" onclick="buyMedal('${userName}', '${item.id}', ${item.price})">${item.price}ptè³¼å…¥</button>`;
            } else {
                btnHtml = `<button class="action-btn btn-disabled">${item.price}pt (ä¸è¶³)</button>`;
            }

            card.innerHTML = `${badge}<img src="${item.src}" class="item-img"><div style="font-weight:bold;">${item.name}</div>${btnHtml}`;
            medalContainer.appendChild(card);
        });

        // 3. å®¶å…·
        const furnContainer = document.getElementById('furniture-list');
        furnContainer.innerHTML = '';
        FURNITURE.forEach(item => {
            const isOwned = userData.ownedFurniture.includes(item.id);
            const isEqLeft = (userData.furniture.left === item.id);
            const isEqRight = (userData.furniture.right === item.id);
            const canBuy = (currentPoints >= item.price);

            const card = document.createElement('div');
            card.className = `item-card ${isOwned ? 'owned' : ''}`;
            
            let badge = isEqLeft ? `<div class="badge-equipped">å·¦ã«ãŠãä¸­</div>` : (isEqRight ? `<div class="badge-equipped">å³ã«ãŠãä¸­</div>` : '');
            let btnHtml = isOwned ? 
                `<div style="display:flex; gap:5px;"><button class="action-btn btn-equip" onclick="equipFurniture('${userName}', '${item.id}', 'left')">å·¦ã«ãŠã</button><button class="action-btn btn-equip" onclick="equipFurniture('${userName}', '${item.id}', 'right')">å³ã«ãŠã</button></div>` : 
                (canBuy ? `<button class="action-btn btn-buy" onclick="buyFurniture('${userName}', '${item.id}', ${item.price})">${item.price}ptè³¼å…¥</button>` : `<button class="action-btn btn-disabled">${item.price}pt (ä¸è¶³)</button>`);

            card.innerHTML = `${badge}<img src="${item.src}" class="item-img" onerror="this.src='https://placehold.jp/150x150.png?text=Furniture'"><div style="font-weight:bold; margin-top:5px;">${item.name}</div>${btnHtml}`;
            furnContainer.appendChild(card);
        });
    }

    // --- å‡¦ç†é–¢æ•° ---
    function buyRoom(u, i, p) { if(confirm(`${p}ptã§è³¼å…¥ï¼Ÿ`)) if(spendPoints(u,p)){ let d=getUserData(); if(!d[u]) d[u]={}; if(!d[u].ownedRooms) d[u].ownedRooms=['none']; d[u].ownedRooms.push(i); saveUserData(d); loadShop(); } }
    function equipRoom(u, i) { let d=getUserData(); d[u].currentRoom=i; saveUserData(d); loadShop(); }
    function buyMedal(u, i, p) { if(confirm(`${p}ptã§è³¼å…¥ï¼Ÿ`)) if(spendPoints(u,p)){ let d=getUserData(); if(!d[u]) d[u]={}; if(!d[u].ownedMedals) d[u].ownedMedals=[]; d[u].ownedMedals.push(i); saveUserData(d); loadShop(); } }
    
    // â˜…ä¿®æ­£: é‡è¤‡ãƒã‚°å¯¾ç­–æ¸ˆã¿ã®é–¢æ•°
    function equipMedal(u, i, s) { 
        let d = getUserData(); 
        if(!d[u].medals) d[u].medals = {}; 
        
        // 1. ä»–ã®å ´æ‰€ã«åŒã˜å‹²ç« ãŒã‚ã£ãŸã‚‰æ¶ˆã™ï¼ˆç§»å‹•ã®ãŸã‚ï¼‰
        Object.keys(d[u].medals).forEach(key => {
            if (d[u].medals[key] === i) {
                delete d[u].medals[key];
            }
        });

        // 2. æŒ‡å®šã®å ´æ‰€ã«ã‚»ãƒƒãƒˆ
        d[u].medals[s] = i; 

        // å¿µã®ãŸã‚å¤ã„äº’æ›ã‚­ãƒ¼ã‚‚æƒé™¤
        if(d[u].medals.left === i) delete d[u].medals.left;
        if(d[u].medals.right === i) delete d[u].medals.right;

        saveUserData(d); 
        loadShop(); 
    }

    function buyFurniture(userName, itemId, price) {
        if(!confirm(`${price}ãƒã‚¤ãƒ³ãƒˆã§ è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        if (spendPoints(userName, price)) {
            const allData = getUserData();
            if (!allData[userName]) allData[userName] = {};
            if (!allData[userName].ownedFurniture) allData[userName].ownedFurniture = [];
            allData[userName].ownedFurniture.push(itemId);
            saveUserData(allData);
            alert('è³¼å…¥ã—ã¾ã—ãŸï¼âœ¨');
            loadShop(); 
        } else { alert('ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ã‚ˆã†ã§ã™â€¦'); }
    }

    function equipFurniture(userName, itemId, side) {
        const allData = getUserData();
        if (!allData[userName].furniture) allData[userName].furniture = { left: null, right: null };
        allData[userName].furniture[side] = itemId;
        saveUserData(allData);
        alert(`${side === 'left' ? 'å·¦' : 'å³'}ã« ãŠãã¾ã—ãŸï¼ğŸª‘`);
        loadShop();
    }
</script>

</body>
</html>