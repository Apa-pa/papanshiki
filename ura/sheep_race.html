<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Å≤„Å§„Åò„Éó„É≠„Éª„ÉÄ„Éº„Éì„Éº</title>
    <script src="../ranking.js"></script>
    <style>
        body {
            font-family: 'Arial Black', sans-serif;
            background: linear-gradient(135deg, #1a0033, #2c003e);
            color: #fff;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
        }

        .header {
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ffd700;
        }

        .balance-area {
            color: #ffd700;
            font-size: 18px;
        }

        .user-name-tag {
            font-size: 14px;
            color: #fff;
            background: #e91e63;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .race-track {
            flex: 1;
            position: relative;
            background: #2e7d32;
            border-top: 5px solid #fff;
            border-bottom: 5px solid #fff;
            margin: 10px 0;
            overflow: hidden;
        }

        .lane {
            height: 16.6%;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.3);
            position: relative;
            display: flex;
            align-items: center;
        }

        .finish-line {
            position: absolute;
            right: 50px;
            top: 0;
            width: 10px;
            height: 100%;
            background: repeating-linear-gradient(0deg, #fff, #fff 10px, #000 10px, #000 20px);
        }

        .sheep {
            position: absolute;
            left: 10px;
            width: 60px;
            height: 60px;
            z-index: 10;
        }

        .sheep-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .betting-panel {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sheep-selector {
            display: flex;
            justify-content: space-around;
            gap: 5px;
        }

        .sheep-btn {
            flex: 1;
            padding: 8px;
            background: #444;
            border: 2px solid #666;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 11px;
        }

        .sheep-btn.selected {
            background: #ffd700;
            color: #000;
            border-color: #fff;
        }

        .odds-val {
            display: block;
            font-size: 14px;
            font-weight: bold;
        }

        .bet-input-area {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        input[type="number"] {
            width: 80px;
            padding: 8px;
            font-size: 18px;
            border-radius: 5px;
            border: none;
            text-align: center;
        }

        .start-btn {
            padding: 10px 25px;
            background: #ff0055;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px #990033;
        }

        .start-btn:disabled {
            background: #666;
            box-shadow: none;
        }

        /* ÂÆüÊ≥Å„É≠„Ç∞ */
        .commentary {
            height: 34px;
            background: #000;
            color: #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        /* ÂÖ±ÈÄö„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }

        .user-btn {
            margin: 5px;
            padding: 12px 25px;
            font-size: 18px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="header">
        <div id="user-display" class="user-name-tag">„Ç≤„Çπ„Éà</div>
        <div class="balance-area">üí∞ <span id="balance">0</span> üå∞</div>
    </div>

    <div class="commentary" id="commentary">„Å©„ÅÆ„Å≤„Å§„Åò„ÅåÂãù„Å§„Åã‰∫àÊÉ≥„Åó„Å¶„Å≠ÔºÅ</div>

    <div class="race-track" id="track">
        <div class="finish-line"></div>
        <script>
            for (let i = 0; i < 6; i++) {
                document.write(`
                <div class="lane">
                    <div class="sheep" id="sheep-${i}">
                        <div style="position:absolute; top:-12px; left:50%; transform:translateX(-50%); font-size:10px; background:rgba(0,0,0,0.5); padding:1px 4px; border-radius:4px;">No.${i + 1}</div>
                        <img src="hitsuji_walk.webp" class="sheep-img" id="img-${i}">
                    </div>
                </div>
            `);
            }
        </script>
    </div>

    <div class="betting-panel">
        <div class="sheep-selector" id="selectors"></div>
        <div class="bet-input-area">
            <input type="number" id="bet-amount" value="1" min="1">
            <button class="start-btn" id="start-btn" onclick="startRace()">ÂãùË≤†ÔºàBETÔºâÔºÅ</button>
        </div>
        <a href="secret_home.html" style="color:#aaa; font-size:12px; text-align:center; margin-top:5px;">„Ç´„Ç∏„Éé„É≠„Éì„Éº„Å´Êàª„Çã</a>
    </div>

    <div id="user-selection-screen" class="overlay">
        <h2 style="color:#ffd700;">„Å†„Çå„Åå „ÅÇ„Åù„Å∂Ôºü</h2>
        <div id="user-list"></div>
        <div style="margin-top:20px; border-top:1px dashed #666; padding-top:20px;">
            <input type="text" id="new-user-input" placeholder="Êñ∞„Åó„ÅÑ„Å™„Åæ„Åà"
                style="padding:10px; border-radius:5px; border:none;">
            <button class="user-btn" style="background:#2196f3; font-size:14px; padding:10px 20px;"
                onclick="createNewUser()">‰ΩúÊàê</button>
        </div>
    </div>

    <div id="result-overlay" class="overlay" style="display:none;">
        <h1 id="result-title" style="font-size:40px; color:#ffd700;">1ÁùÄ: No.1</h1>
        <p id="result-msg" style="font-size:20px;"></p>
        <button class="start-btn" onclick="resetRace()">„ÇÇ„ÅÜ‰∏ÄÂõûÔºÅ</button>
    </div>

    <script>
        let currentUserName = "";
        let selectedSheep = 0;
        let raceInProgress = false;

        // Ë®≠ÂÆöÔºö„Ç™„ÉÉ„Ç∫„ÅÆÂπÖ„ÇíÂ∞è„Åï„ÅèË™øÊï¥Ôºà3.3ÂÄç „Äú 14.3ÂÄçÔºâ
        // winProb„ÅÆÂêàË®à„ÅØ 1.0 (100%) „Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô
        // „Ç™„ÉÉ„Ç∫ = 1 / winProb „Å™„ÅÆ„Åß„ÄÅÈï∑ÊúüÁöÑ„Å´„ÅØ„Å©„Çì„Åê„Çä„ÅØÂ¢óÊ∏õ„Åó„Åæ„Åõ„Çì
        const SHEEP_CONFIG = [
            { id: 0, name: "„É¢„Éï„Çπ„Éî„Éº„Éâ", speed: 2.2, stamina: 1.0, winProb: 0.30, odds: 3.3 }, // 30%„ÅßÂãùÂà©
            { id: 1, name: "„É°„Çß„Éº„Åò„Çç„ÅÜ", speed: 2.0, stamina: 1.1, winProb: 0.20, odds: 5.0 }, // 20%„ÅßÂãùÂà©
            { id: 2, name: "„Ç¶„Éº„É´100%", speed: 1.9, stamina: 1.0, winProb: 0.18, odds: 5.6 }, // 18%„ÅßÂãùÂà©
            { id: 3, name: "„Éâ„É≥„Ç∞„É™Â•Ω„Åç", speed: 1.8, stamina: 1.3, winProb: 0.15, odds: 6.7 }, // 15%„ÅßÂãùÂà©
            { id: 4, name: "„É¨„Ç∏„Çß„É≥„ÉâÁæä", speed: 1.7, stamina: 0.8, winProb: 0.10, odds: 10.0 }, // 10%„ÅßÂãùÂà©
            { id: 5, name: "„ÅÆ„Çì„Å≥„ÇäÈõ≤", speed: 1.6, stamina: 1.5, winProb: 0.07, odds: 14.3 }  // 7%„ÅßÂãùÂà©
        ];

        window.onload = init;

        function init() {
            showUserSelection();
            setupSelectors();
        }

        function showUserSelection() {
            const listDiv = document.getElementById('user-list');
            listDiv.innerHTML = '';
            const users = (typeof getUserNames === 'function') ? getUserNames() : [];

            users.forEach(u => {
                const btn = document.createElement('button');
                btn.className = 'user-btn';
                btn.innerText = u;
                btn.onclick = () => selectUser(u);
                listDiv.appendChild(btn);
            });
            document.getElementById('user-selection-screen').style.display = 'flex';
        }

        function createNewUser() {
            const input = document.getElementById('new-user-input');
            const name = input.value.trim();
            if (name) selectUser(name);
        }

        function selectUser(name) {
            currentUserName = name;
            document.getElementById('user-selection-screen').style.display = 'none';
            document.getElementById('user-display').innerText = name;
            updateBalance();
        }

        function updateBalance() {
            const balance = (typeof getUserDonguri === 'function') ? getUserDonguri(currentUserName) : 0;
            document.getElementById('balance').innerText = balance;
        }

        function setupSelectors() {
            const selectors = document.getElementById('selectors');
            selectors.innerHTML = "";
            SHEEP_CONFIG.forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'sheep-btn';
                btn.id = `btn-${s.id}`;
                // „Ç™„ÉÉ„Ç∫Ë°®Á§∫
                btn.innerHTML = `No.${s.id + 1}<span class="odds-val">${s.odds.toFixed(1)}ÂÄç</span>`;
                btn.onclick = () => {
                    if (raceInProgress) return;
                    selectedSheep = s.id;
                    document.querySelectorAll('.sheep-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById('commentary').innerText = `No.${s.id + 1} „Äå${s.name}„Äç„Å´Ë≥≠„Åë„Åü„ÅûÔºÅ`;
                };
                selectors.appendChild(btn);
            });
            document.getElementById('btn-0').click();
        }

        function startRace() {
            const betInput = document.getElementById('bet-amount');
            const bet = parseInt(betInput.value);
            const currentBalance = (typeof getUserDonguri === 'function') ? getUserDonguri(currentUserName) : 0;

            if (bet > currentBalance) { alert("„Å©„Çì„Åê„Çä„ÅåË∂≥„Çä„Å™„ÅÑ„ÇàÔºÅ"); return; }
            if (bet <= 0) return;

            if (typeof spendDonguri === 'function') {
                spendDonguri(currentUserName, bet);
            }
            updateBalance();

            raceInProgress = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('commentary').innerText = "ÂêÑ„Å≤„Å§„Åò„ÄÅ„ÅÑ„Å£„Åõ„ÅÑ„Å´Âá∫Ëµ∞ÔºÅÔºÅ";

            const trackWidth = document.getElementById('track').clientWidth - 80;
            const positions = [0, 0, 0, 0, 0, 0];

            // --- ÂãùË≤†„ÅÆÊ±∫ÂÆö„É≠„Ç∏„ÉÉ„ÇØ ---
            // Á¢∫Áéá„Å´Âü∫„Å•„ÅÑ„Å¶„ÄÅ„É¨„Éº„ÇπÂâç„Å´ÂãùËÄÖ„ÇíÊ±∫ÂÆö„Åó„Åæ„Åô
            let winnerId = 0;
            const rand = Math.random();
            let accumulatedProb = 0;

            for (let i = 0; i < SHEEP_CONFIG.length; i++) {
                accumulatedProb += SHEEP_CONFIG[i].winProb;
                if (rand < accumulatedProb) {
                    winnerId = i;
                    break;
                }
            }
            // Âøµ„ÅÆ„Åü„ÇÅ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            if (rand >= accumulatedProb) winnerId = SHEEP_CONFIG.length - 1;

            // --- „É¨„Éº„ÇπÊºîÂá∫ ---
            // Ê±∫„Åæ„Å£„ÅüÂãùËÄÖ„ÅåÂøÖ„ÅöÂãù„Å§„Çà„ÅÜ„Å´ÈÄüÂ∫¶„ÇíË™øÊï¥„Åó„Å™„Åå„ÇâËµ∞„Çâ„Åõ„Åæ„Åô
            let frame = 0;
            let finished = false;

            const raceInterval = setInterval(() => {
                frame++;

                for (let i = 0; i < 6; i++) {
                    if (finished) continue;

                    const cfg = SHEEP_CONFIG[i];

                    // Âü∫Êú¨ÁßªÂãï
                    let move = cfg.speed * 0.8 + (Math.random() * 1.5);

                    // „ÄêÊºîÂá∫Ë™øÊï¥„Äë
                    if (i === winnerId) {
                        // ÂãùËÄÖ„ÅØÂ∞ë„Åó„Éñ„Éº„Çπ„Éà
                        move += 0.8;
                    } else {
                        // ÂãùËÄÖ„Çà„ÇäÂâç„Å´Âá∫„Åù„ÅÜ„Å´„Å™„Å£„Åü„ÇâÊ∏õÈÄü
                        if (positions[i] > positions[winnerId]) {
                            move -= 0.8;
                        }
                    }

                    positions[i] += move;
                    document.getElementById(`sheep-${i}`).style.left = positions[i] + 'px';

                    // ÁîªÂÉèÂàá„ÇäÊõø„Åà
                    const img = document.getElementById(`img-${i}`);
                    img.src = (frame % 10 < 5) ? "hitsuji_walk.webp" : "hitsuji_run1.webp";

                    // „Ç¥„Éº„É´Âà§ÂÆöÔºàÂãùËÄÖ„Åå„Ç¥„Éº„É´„Åó„ÅüÊôÇ„ÅÆ„ÅøÁµÇ‰∫ÜÔºâ
                    if (positions[i] >= trackWidth) {
                        if (i === winnerId) {
                            finished = true;
                            clearInterval(raceInterval);
                            finishRace(winnerId, bet);
                        }
                    }
                }
            }, 30);
        }

        function finishRace(winnerId, betAmount) {
            raceInProgress = false;
            const isWin = (winnerId === selectedSheep);
            const winAmount = Math.floor(betAmount * SHEEP_CONFIG[winnerId].odds);

            document.getElementById('result-title').innerText = `1ÁùÄ: No.${winnerId + 1}`;
            const msg = document.getElementById('result-msg');

            if (isWin) {
                msg.innerHTML = `ÁöÑ‰∏≠ÔºÅ üí∞ <span style="color:#ffd700; font-size:1.2em;">${winAmount}</span> „Å©„Çì„Åê„Çä „Ç≤„ÉÉ„ÉàÔºÅ`;
                if (typeof addDonguri === 'function') addDonguri(currentUserName, winAmount);
                updateBalance();
                document.getElementById('result-title').style.color = "#ff0055";
            } else {
                msg.innerText = "„ÅØ„Åö„Çå... „Å©„Çì„Åê„ÇäÊ≤°Âèé„Å†„ÄÇ";
                document.getElementById('result-title').style.color = "#ffd700";
            }
            document.getElementById('result-overlay').style.display = 'flex';
        }

        function resetRace() {
            document.getElementById('result-overlay').style.display = 'none';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('commentary').innerText = "Ê¨°„ÅÆÂãùË≤†„ÅØ„Å©„ÅÜ„Åô„ÇãÔºü";
            for (let i = 0; i < 6; i++) {
                document.getElementById(`sheep-${i}`).style.left = '10px';
                document.getElementById(`img-${i}`).src = "hitsuji_walk.webp";
            }
        }
    </script>
</body>

</html>