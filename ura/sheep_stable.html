<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã²ã¤ã˜å©èˆãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    <script src="../ranking.js"></script>
    <script type="module" src="../firebase-ranking.js"></script>
    <style>
        body {
            font-family: 'Arial Black', sans-serif;
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .balance-box {
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #ffd700;
            color: #ffd700;
        }

        .current-sheep-card {
            width: 100%;
            max-width: 450px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 25px;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            text-align: center;
            border: 5px solid #ffca28;
            position: relative;
        }

        .sheep-main-img {
            width: 140px;
            height: 140px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .toast-msg {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s;
            z-index: 10;
        }

        .toast-msg.show {
            top: 10%;
            opacity: 1;
        }

        .name-input {
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-bottom: 3px solid #ffd700;
            background: transparent;
            text-align: center;
            width: 80%;
            margin-bottom: 5px;
            color: #333;
        }

        .contract-info {
            font-size: 12px;
            color: #e91e63;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-container {
            text-align: left;
            margin: 10px 0;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 15px;
        }

        .stat-row {
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 11px;
            font-weight: bold;
            color: #555;
            display: flex;
            justify-content: space-between;
        }

        .stat-bar-bg {
            background: #ddd;
            height: 10px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 4px;
            border: 1px solid #ccc;
        }

        .stat-bar-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s;
        }

        .bar-speed {
            background: linear-gradient(to right, #e91e63, #ff4081);
        }

        .bar-stamina {
            background: linear-gradient(to right, #2196f3, #03a9f4);
        }

        .bar-tenacity {
            background: linear-gradient(to right, #4caf50, #8bc34a);
        }

        .total-cap-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .train-area {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .train-btn {
            padding: 8px 2px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            box-shadow: 0 3px rgba(0, 0, 0, 0.2);
            font-size: 10px;
            line-height: 1.2;
        }

        .btn-speed {
            background: #e91e63;
        }

        .btn-stamina {
            background: #2196f3;
        }

        .btn-tenacity {
            background: #4caf50;
        }

        .train-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .train-btn:disabled {
            background: #bbb;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .scout-list {
            width: 100%;
            max-width: 500px;
            display: grid;
            gap: 10px;
        }

        .scout-card {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 10px;
            display: flex;
            align-items: center;
        }

        .scout-info {
            flex: 1;
            margin-left: 10px;
        }

        .rank-label {
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 4px;
            margin-bottom: 2px;
            display: inline-block;
            color: #fff;
        }

        .rank-rookie {
            background: #81c784;
        }

        .rank-pro {
            background: #64b5f6;
        }

        .rank-legend {
            background: #ffb74d;
        }

        .contract-btn {
            background: #ff5252;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px #c62828;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .user-btn {
            margin: 5px;
            padding: 15px 30px;
            font-size: 18px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 30px;
        }

        .back-link {
            color: #fff;
            margin-top: 20px;
            text-decoration: underline;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <div class="header">
        <div id="user-display" style="font-weight:bold;">åå‰: ---</div>
        <div class="balance-box">ğŸŒ° <span id="balance">0</span></div>
    </div>

    <div id="current-sheep-area" class="current-sheep-card">
        <div id="toast" class="toast-msg"></div>
        <div id="no-sheep-msg" style="padding:40px; font-weight:bold; color:#888;">ã²ã¤ã˜ãŒã„ã¾ã›ã‚“ã€‚</div>

        <div id="sheep-details" style="display:none;">
            <p style="margin:0; font-size:11px; color:#ff9800; font-weight:bold;">ğŸ† å¥‘ç´„ä¸­ã®ã‚¢ã‚¹ãƒªãƒ¼ãƒˆ</p>
            <input type="text" id="my-sheep-name" class="name-input" onchange="renameSheep()">
            <div id="remaining-races" class="contract-info">æ®‹ã‚Šå¥‘ç´„ãƒ¬ãƒ¼ã‚¹: -- å›</div>
            <div id="record-info" class="contract-info" style="color:#4caf50;">ğŸ“Š 0æˆ¦ 0å‹ ï½œ ç´¯è¨ˆè³é‡‘: 0 ğŸŒ°</div>

            <img src="hitsuji_shomen.webp" class="sheep-main-img" id="my-sheep-img">

            <div id="total-status" class="total-cap-info">åˆè¨ˆèƒ½åŠ›: 0 / 0</div>

            <div class="stat-container">
                <div class="stat-row">
                    <div class="stat-label"><span>ã‚¹ãƒ”ãƒ¼ãƒ‰</span><span id="speed-val">0</span></div>
                    <div class="stat-bar-bg">
                        <div id="my-stat-speed" class="stat-bar-fill bar-speed"></div>
                    </div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>ã‚¹ã‚¿ãƒŸãƒŠ</span><span id="stamina-val">0</span></div>
                    <div class="stat-bar-bg">
                        <div id="my-stat-stamina" class="stat-bar-fill bar-stamina"></div>
                    </div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>æ ¹æ€§</span><span id="tenacity-val">0</span></div>
                    <div class="stat-bar-bg">
                        <div id="my-stat-tenacity" class="stat-bar-fill bar-tenacity"></div>
                    </div>
                </div>

                <div class="train-area">
                    <button class="train-btn btn-speed" onclick="trainSheep('speed')">ğŸ’¨ ã‚¹ãƒ”ãƒ¼ãƒ‰<br>(1ğŸŒ°)</button>
                    <button class="train-btn btn-stamina" onclick="trainSheep('stamina')">ğŸ– ã‚¹ã‚¿ãƒŸãƒŠ<br>(1ğŸŒ°)</button>
                    <button class="train-btn btn-tenacity" onclick="trainSheep('tenacity')">ğŸ”¥ æ ¹æ€§<br>(1ğŸŒ°)</button>
                </div>
            </div>

            <button class="contract-btn"
                style="background:#4caf50; box-shadow:0 4px #2e7d32; width:100%; margin-bottom:10px;"
                onclick="startLocalRace()">ğŸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ãƒ¼ã‚¹ã«å‡ºã‚‹ (5ğŸŒ°)</button>
            <button class="contract-btn" style="background:#2196f3; box-shadow:0 4px #1565c0; width:100%;"
                onclick="entryNationalRace()">å…¨å›½ãƒ¬ãƒ¼ã‚¹ã«å‡ºèµ°ç™»éŒ²ï¼</button>
            <p id="entry-status" style="font-size:12px; color:#e91e63; margin-top:10px; font-weight:bold;"></p>
        </div>
    </div>

    <h3 style="margin: 10px 0; border-left: 5px solid #ffd700; padding-left: 10px; width: 100%; max-width: 500px;">
        æ–°ã—ãå¥‘ç´„ã‚’çµã¶ï¼ˆ24ãƒ¬ãƒ¼ã‚¹å¥‘ç´„ï¼‰</h3>
    <div class="scout-list" id="scout-list"></div>

    <a href="secret_home.html" class="back-link">ã‚«ã‚¸ãƒãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</a>

    <div id="user-overlay" class="overlay">
        <h2 style="color:#ffd700;">ã ã‚ŒãŒ å©èˆ(ãã‚…ã†ã—ã‚ƒ)ã‚’ã¿ã‚‹ï¼Ÿ</h2>
        <div id="user-list"></div>
    </div>

    <script>
        let currentUserName = "";
        const SHEEP_STORAGE_KEY = "papan_my_sheep_v3";

        // --- â˜… ä¸è¶³ã—ã¦ã„ãŸãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’è¿½åŠ  ---
        function getUserData() {
            // å©èˆã®ãƒ‡ãƒ¼ã‚¿ã¯å°‚ç”¨ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨
            return JSON.parse(localStorage.getItem(SHEEP_STORAGE_KEY) || "{}");
        }
        function saveUserData(data) {
            localStorage.setItem(SHEEP_STORAGE_KEY, JSON.stringify(data));
        }
        function generateUuid() {
            return 'u_' + Math.random().toString(36).substring(2, 9) + Date.now().toString(36);
        }

        const MASTERS = [
            { rank: "Rookie", name: "ã‚‚ãµã‚‚ãµæ–°äºº", cost: 24, speed: 30, stamina: 30, tenacity: 30, totalMax: 200, desc: "åˆè¨ˆé™ç•Œ: 200" },
            { rank: "Pro", name: "ã‚¦ãƒ¼ãƒ«ãƒ»ã‚¹ã‚¿ãƒ¼", cost: 60, speed: 60, stamina: 60, tenacity: 60, totalMax: 240, desc: "åˆè¨ˆé™ç•Œ: 240" },
            { rank: "Legend", name: "ã‚¼ã‚¦ã‚¹ãƒ»ãƒ¡ã‚§ãƒ¼", cost: 200, speed: 85, stamina: 85, tenacity: 85, totalMax: 280, desc: "åˆè¨ˆé™ç•Œ: 280" }
        ];

        window.onload = () => {
            const users = (typeof getUserNames === 'function') ? getUserNames() : [];
            const list = document.getElementById('user-list');
            users.forEach(u => {
                const b = document.createElement('button');
                b.className = 'user-btn';
                b.innerText = u;
                b.onclick = () => selectUser(u);
                list.appendChild(b);
            });
            renderScoutList();
        };

        function selectUser(name) {
            currentUserName = name;
            document.getElementById('user-overlay').style.display = 'none';
            document.getElementById('user-display').innerText = "ã‚ªãƒ¼ãƒŠãƒ¼: " + name;
            updateUI();
        }

        function updateUI() {
            const bal = (typeof getUserDonguri === 'function') ? getUserDonguri(currentUserName) : 0;
            document.getElementById('balance').innerText = bal;
            const allData = getUserData();
            const s = allData[currentUserName];
            const details = document.getElementById('sheep-details');
            const msg = document.getElementById('no-sheep-msg');

            if (s) {
                msg.style.display = "none";
                details.style.display = "block";
                document.getElementById('my-sheep-name').value = s.name;
                document.getElementById('my-stat-speed').style.width = s.speed + "%";
                document.getElementById('my-stat-stamina').style.width = s.stamina + "%";
                document.getElementById('my-stat-tenacity').style.width = s.tenacity + "%";
                document.getElementById('speed-val').innerText = s.speed;
                document.getElementById('stamina-val').innerText = s.stamina;
                document.getElementById('tenacity-val').innerText = s.tenacity;
                const currentTotal = s.speed + s.stamina + s.tenacity;
                document.getElementById('total-status').innerText = `åˆè¨ˆèƒ½åŠ›: ${currentTotal} / ${s.totalMax}`;

                const rem = s.contractRaces !== undefined ? s.contractRaces : 24;
                document.getElementById('remaining-races').innerText = `æ®‹ã‚Šå¥‘ç´„ãƒ¬ãƒ¼ã‚¹: ${rem} å›`;

                // æˆ¦ç¸¾è¡¨ç¤º
                const rec = s.record || { totalRaces: 0, wins: 0, totalPrize: 0 };
                document.getElementById('record-info').innerText =
                    `ğŸ“Š ${rec.totalRaces}æˆ¦ ${rec.wins}å‹ ï½œ ç´¯è¨ˆè³é‡‘: ${rec.totalPrize} ğŸŒ°`;

                const isMax = (currentTotal >= s.totalMax);
                document.querySelectorAll('.train-btn').forEach(btn => btn.disabled = isMax);
                document.getElementById('entry-status').innerText = s.entry ? "ğŸ“¢ å…¨å›½ãƒ¬ãƒ¼ã‚¹ã«ç™»éŒ²æ¸ˆã¿ï¼" : "";
            } else {
                msg.style.display = "block";
                details.style.display = "none";
            }
        }

        function renderScoutList() {
            const list = document.getElementById('scout-list');
            list.innerHTML = "";
            MASTERS.forEach(m => {
                const card = document.createElement('div');
                card.className = 'scout-card';
                card.innerHTML = `
                <div style="font-size:28px;">ğŸ‘</div>
                <div class="scout-info">
                    <span class="rank-label rank-${m.rank.toLowerCase()}">${m.rank}</span>
                    <div style="font-weight:bold; font-size:13px; color:#ffd700;">${m.name}</div>
                    <div style="font-size:11px; color:#fff; font-weight:bold;">å¥‘ç´„é‡‘: ${m.cost} ğŸŒ°</div>
                    <div style="font-size:9px; color:#ccc;">${m.desc}</div>
                </div>
                <button class="contract-btn" onclick="signContract('${m.rank}')">å¥‘ç´„</button>
            `;
                list.appendChild(card);
            });
        }

        function signContract(rank) {
            const target = MASTERS.find(m => m.rank === rank);
            const bal = (typeof getUserDonguri === 'function') ? getUserDonguri(currentUserName) : 0;
            if (bal < target.cost) { alert("ã©ã‚“ãã‚ŠãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }
            if (!confirm(`${target.name} ã¨å¥‘ç´„ã—ã¾ã™ã‹ï¼Ÿ (24ãƒ¬ãƒ¼ã‚¹å¥‘ç´„)`)) return;
            if (typeof spendDonguri === 'function') spendDonguri(currentUserName, target.cost);
            const allData = getUserData();

            allData[currentUserName] = {
                rank: target.rank,
                name: target.name,
                speed: target.speed,
                stamina: target.stamina,
                tenacity: target.tenacity,
                totalMax: target.totalMax,
                entry: false,
                contractRaces: 24,
                record: { totalRaces: 0, wins: 0, totalPrize: 0 }
            };

            saveUserData(allData);
            playActionAnimation("hitsuji_eat.webp", "å¥‘ç´„å®Œäº†ï¼");
        }

        function renameSheep() {
            const newName = document.getElementById('my-sheep-name').value.trim();
            if (!newName) return;
            const allData = getUserData();
            if (allData[currentUserName]) {
                allData[currentUserName].name = newName;
                saveUserData(allData);
            }
        }

        function trainSheep(type) {
            const allData = getUserData();
            const s = allData[currentUserName];
            if (!s) return;
            const currentTotal = s.speed + s.stamina + s.tenacity;
            if (currentTotal >= s.totalMax) { showToast("é™ç•Œã§ã™ï¼"); return; }
            const bal = (typeof getUserDonguri === 'function') ? getUserDonguri(currentUserName) : 0;
            if (bal < 1) { showToast("ã©ã‚“ãã‚Šä¸è¶³ï¼"); return; }

            let trainImg = "hitsuji_eat.webp";
            if (type === 'speed') { s.speed += 2; trainImg = "hitsuji_run2.webp"; }
            else if (type === 'stamina') { s.stamina += 2; trainImg = "hitsuji_eat.webp"; }
            else if (type === 'tenacity') { s.tenacity += 2; trainImg = "hitsuji_run1.webp"; }

            const newTotal = s.speed + s.stamina + s.tenacity;
            if (newTotal > s.totalMax) { s[type] -= (newTotal - s.totalMax); }

            if (typeof spendDonguri === 'function') spendDonguri(currentUserName, 1);
            saveUserData(allData);
            playActionAnimation(trainImg, "ãƒŠã‚¤ã‚¹ç‰¹è¨“ï¼");
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1500);
        }

        function playActionAnimation(imgSrc, msg) {
            const img = document.getElementById('my-sheep-img');
            if (!img) return;
            const originalSrc = "hitsuji_shomen.webp";
            img.src = imgSrc;
            if (msg) showToast(msg);
            setTimeout(() => {
                img.src = originalSrc;
                updateUI();
            }, 800);
        }

        function startLocalRace() {
            const bal = (typeof getUserDonguri === 'function') ? getUserDonguri(currentUserName) : 0;
            if (bal < 5) { alert("å‡ºèµ°æ–™ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }

            if (confirm(`å‡ºèµ°æ–™ 5 ğŸŒ° ã‚’æ‰•ã£ã¦å‡ºå ´ã—ã¾ã™ã‹ï¼Ÿ`)) {
                if (typeof spendDonguri === 'function') spendDonguri(currentUserName, 5);
                const allData = getUserData();
                const s = allData[currentUserName];
                location.href = `sheep_stable_race.html?user=${encodeURIComponent(currentUserName)}&rank=${encodeURIComponent(s.rank)}`;
            }
        }

        async function entryNationalRace() {
            const allData = getUserData();
            const s = allData[currentUserName];
            if (!s) return;

            // ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (s.entry) {
                alert("ã™ã§ã«ä»Šé€±ã®ãƒ¬ãƒ¼ã‚¹ã«ã¯ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆã¿ã§ã™ï¼");
                return;
            }

            const publicName = prompt("å…¨å›½ãƒ¬ãƒ¼ã‚¹ã«ç™»éŒ²ã™ã‚‹ã‚ªãƒ¼ãƒŠãƒ¼åã‚’å…¥åŠ›ã—ã¦ã­", currentUserName);
            if (!publicName) return;

            // ç¾åœ¨ã¯ã€Œç„¡æ–™ã€ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º
            if (confirm(`ã€Œ${s.name}ã€ã‚’å…¨å›½ãƒ¬ãƒ¼ã‚¹ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä»Šã ã‘å‡ºèµ°æ–™ï¼šç„¡æ–™ï¼ ğŸŒ°ï¼‰`)) {

                // IDãŒãªã„å ´åˆã¯ç™ºè¡Œ
                if (!s.uid) {
                    s.uid = generateUuid();
                }

                // Firebaseã¸é€ä¿¡
                if (typeof window.registerNationalRaceEntry === 'function') {
                    const success = await window.registerNationalRaceEntry(s.uid, s, publicName);
                    if (success) {
                        s.entry = true;
                        allData[currentUserName] = s;
                        saveUserData(allData);
                        updateUI();
                        showToast("å…¨å›½ãƒ¬ãƒ¼ã‚¹ã«ã‚¨ãƒ³ãƒˆãƒªãƒ¼å®Œäº†ï¼ğŸŒ");
                    } else {
                        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ç™»éŒ²ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                    }
                }
            }
        }

        async function initNationalRaceSystem() {
            const allData = getUserData();
            const s = allData[currentUserName];
            if (!s) return;

            if (typeof window.checkAndRunNationalRace === 'function') {
                const res = await window.checkAndRunNationalRace();

                if (res.status === "new_result" || res.status === "finished") {
                    const data = res.data;
                    if (s.lastAwardedRace === data.raceId) return;

                    let myRank = 0;
                    let prize = 0;

                    [...data.rookie, ...data.pro, ...data.legend].forEach(win => {
                        if (win.uid === s.uid) {
                            myRank = win.rank;
                        }
                    });

                    if (myRank > 0) {
                        prize = (myRank === 1) ? 20 : (myRank === 2) ? 10 : 5;
                        if (typeof addDonguri === 'function') {
                            addDonguri(currentUserName, prize);
                            alert(`ğŸ†å…¨å›½ãƒ¬ãƒ¼ã‚¹çµæœç™ºè¡¨ï¼\nã‚ãªãŸã¯ç¬¬${myRank}ä½ã§ã—ãŸï¼\nè³é‡‘ ${prize} ğŸŒ° ã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼`);
                        }
                    } else {
                        // å…¥è³åœå¤–ã§ã‚‚çµæœã‚’é€šçŸ¥
                        alert("ğŸ“¢ å…¨å›½ãƒ¬ãƒ¼ã‚¹çµæœç™ºè¡¨ï¼\næ®‹å¿µã€ä»Šå›ã¯å…¥è³ãªã‚‰ãšâ€¦\næ¬¡ã®ãƒ¬ãƒ¼ã‚¹ã«æœŸå¾…ï¼");
                    }

                    // æˆ¦ç¸¾è¨˜éŒ²ï¼ˆå…¥è³ãƒ»åœå¤–å•ã‚ãšå‡ºèµ°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼‰
                    if (!s.record) s.record = { totalRaces: 0, wins: 0, totalPrize: 0 };
                    s.record.totalRaces++;
                    if (myRank === 1) s.record.wins++;
                    s.record.totalPrize += prize;

                    s.lastAwardedRace = data.raceId;
                    s.entry = false;
                    saveUserData(allData);
                    updateUI();
                }
            }
        }

        window.addEventListener('load', () => {
            setTimeout(initNationalRaceSystem, 1000);
        });
    </script>
</body>

</html>