<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã©ã†ã¶ã¤ ã‚ã‚ã›ï¼ˆç¥çµŒè¡°å¼±ï¼‰</title>
    <script src="ranking.js"></script>
    <script type="module" src="firebase-ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #f3e5f5;
            /* ã‚„ã•ã—ã„ç´«è‰² */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            touch-action: manipulation;
        }

        #game-container {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 500px;
        }

        .screen {
            display: none;
        }

        .active {
            display: block;
        }

        h1 {
            color: #8e24aa;
            font-size: 24px;
            margin: 10px 0;
        }

        /* ã‚²ãƒ¼ãƒ æƒ…å ±ã‚¨ãƒªã‚¢ */
        .info-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #555;
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚’ä¸¦ã¹ã‚‹ã‚°ãƒªãƒƒãƒ‰ï¼ˆ4x4ï¼‰ */
        #grid-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            perspective: 1000px;
            /* 3Då›è»¢ã®ãŸã‚ã«å¿…è¦ */
        }

        /* ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .card {
            aspect-ratio: 1 / 1;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }

        /* ã‚«ãƒ¼ãƒ‰ãŒã‚ãã‚‰ã‚ŒãŸæ™‚ */
        .card.flipped {
            transform: rotateY(180deg);
        }

        /* ã‚«ãƒ¼ãƒ‰ã®ã‚ªãƒ¢ãƒ†ã¨ã‚¦ãƒ© */
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* ã‚¦ãƒ©é¢ï¼ˆæ¨¡æ§˜ï¼‰ */
        .card-back {
            background-color: #ce93d8;
            color: white;
            font-size: 24px;
        }

        /* ã‚ªãƒ¢ãƒ†é¢ï¼ˆå‹•ç‰©ï¼‰ */
        .card-front {
            background-color: white;
            border: 2px solid #ce93d8;
            transform: rotateY(180deg);
            /* æœ€åˆã¯è£è¿”ã—ã¦ãŠã */
        }

        /* æ­£è§£ã—ãŸã‚«ãƒ¼ãƒ‰ */
        .card.matched .card-front {
            background-color: #e1bee7;
            /* è–„ã„ç´« */
            border-color: #8e24aa;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ */
        .start-btn {
            font-size: 24px;
            padding: 15px 40px;
            background: #ab47bc;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px #7b1fa2;
            margin: 20px 0;
            font-weight: bold;
        }

        .start-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px #7b1fa2;
        }

        .back-btn {
            background: #90a4ae;
            font-size: 14px;
            padding: 8px 20px;
            color: white;
            border-radius: 20px;
            text-decoration: none;
            display: inline-block;
        }

        /* æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .correct-flash {
            animation: flash 0.5s;
        }

        @keyframes flash {
            0% {
                background-color: white;
            }

            50% {
                background-color: #e1bee7;
            }

            100% {
                background-color: white;
            }
        }
    </style>
</head>

<body>

    <div id="game-container">

        <div id="home-screen" class="screen active">
            <h1>ã©ã†ã¶ã¤ ã‚ã‚ã›</h1>
            <div style="font-size: 80px; margin: 20px;">ğŸƒ</div>
            <p>ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã£ã¦<br>ãŠãªã˜ ã©ã†ã¶ã¤ã‚’ ã¿ã¤ã‘ã¦ã­ï¼</p>
            <button class="start-btn" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
            <br>
            <a href="index.html" class="back-btn">ğŸ  ã‚‚ã©ã‚‹</a>
        </div>

        <div id="game-screen" class="screen">
            <div class="info-bar">
                <span>ã®ã“ã‚Š: <span id="pairs-left">8</span> ãƒšã‚¢</span>
                <span id="timer">0.0ã³ã‚‡ã†</span>
            </div>

            <div id="grid-board">
            </div>

            <a href="index.html" class="back-btn">ğŸ  ã‚„ã‚ã‚‹</a>
        </div>

        <div id="result-screen" class="screen">
            <h1>âœ¨ ãœã‚“ã¶ã¿ã¤ã‘ãŸï¼ âœ¨</h1>
            <div style="font-size: 60px;">ğŸ¦„</div>
            <p>ã‚¿ã‚¤ãƒ ã¯...</p>
            <div id="final-time" style="font-size: 36px; color: #8e24aa; font-weight: bold;">0.0ã³ã‚‡ã†</div>
            <button class="start-btn" style="background: #e91e63;" onclick="saveScoreToRanking()">
                ğŸ† ã‚¿ã‚¤ãƒ ã‚’ãã‚ãã™ã‚‹
            </button>
            <button class="start-btn" onclick="startGame()">ã‚‚ã†ã„ã£ã‹ã„ï¼</button>
            <br>
            <a href="index.html" class="back-btn">ğŸ  ã‚‚ã©ã‚‹</a>
        </div>

    </div>

    <script>
        // ä½¿ã„ãŸã„çµµæ–‡å­—ãƒªã‚¹ãƒˆï¼ˆã“ã“ã‚’å¤‰ãˆã‚‹ã¨ã‚­ãƒ£ãƒ©ãŒå¤‰ã‚ã‚Šã¾ã™ï¼‰
        const emojis = ['ğŸ¶', 'ğŸ±', 'ğŸ°', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦'];

        let cardsArray = [];
        let flippedCards = []; // ä»Šã‚ãã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ï¼ˆæœ€å¤§2æšï¼‰
        let matchedPairs = 0;
        let startTime;
        let timerInterval;
        let isProcessing = false; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®æ“ä½œé˜²æ­¢
        let gameFinishTime = 0; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²ç”¨ã®ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ 

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²é–¢æ•°
        function saveScoreToRanking() {
            if (typeof showSaveDialog === 'function') {
                showSaveDialog('eawase', gameFinishTime);
            } else {
                alert('ranking.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        }

        function changeScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function startGame() {
            // ãƒªã‚»ãƒƒãƒˆ
            flippedCards = [];
            matchedPairs = 0;
            isProcessing = false;
            const totalPairs = emojis.length; // 8ãƒšã‚¢
            document.getElementById('pairs-left').textContent = totalPairs;

            // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆå„çµµæ–‡å­—ã‚’2ã¤ãšã¤ç”¨æ„ï¼‰
            let deck = [...emojis, ...emojis];
            deck = shuffle(deck);

            const board = document.getElementById('grid-board');
            board.innerHTML = '';

            deck.forEach((emoji, index) => {
                // ã‚«ãƒ¼ãƒ‰ã®HTMLæ§‹é€ ã‚’ä½œã‚‹
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.emoji = emoji; // æ­£è§£åˆ¤å®šç”¨
                card.dataset.index = index; // è­˜åˆ¥ç”¨

                // ã‚¦ãƒ©é¢
                const back = document.createElement('div');
                back.className = 'card-back';
                back.textContent = 'â“'; // ã‚¦ãƒ©ã®æ¨¡æ§˜

                // ã‚ªãƒ¢ãƒ†é¢
                const front = document.createElement('div');
                front.className = 'card-front';
                front.textContent = emoji;

                card.appendChild(back);
                card.appendChild(front);

                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                card.onclick = () => flipCard(card);

                board.appendChild(card);
            });

            changeScreen('game-screen');

            startTime = Date.now();
            timerInterval = setInterval(() => {
                const t = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('timer').textContent = t + "ã³ã‚‡ã†";
            }, 100);
        }

        function flipCard(card) {
            // ã™ã§ã«ã‚ãã‚‰ã‚Œã¦ã„ã‚‹ã€ã¾ãŸã¯å‡¦ç†ä¸­ã€ã¾ãŸã¯ãƒãƒƒãƒæ¸ˆã¿ã®å ´åˆã¯ç„¡è¦–
            if (card.classList.contains('flipped') || isProcessing || card.classList.contains('matched')) {
                return;
            }

            // ã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã‚‹
            card.classList.add('flipped');
            flippedCards.push(card);

            // 2æšã‚ãã£ãŸã‚‰åˆ¤å®š
            if (flippedCards.length === 2) {
                checkForMatch();
            }
        }

        function checkForMatch() {
            isProcessing = true; // æ“ä½œãƒ­ãƒƒã‚¯
            const [card1, card2] = flippedCards;

            if (card1.dataset.emoji === card2.dataset.emoji) {
                // æ­£è§£ï¼
                matchedPairs++;
                document.getElementById('pairs-left').textContent = emojis.length - matchedPairs;

                card1.classList.add('matched');
                card2.classList.add('matched');

                // å°‘ã—ãƒ”ã‚«ãƒƒã¨ã•ã›ã‚‹
                document.body.classList.add('correct-flash');
                setTimeout(() => document.body.classList.remove('correct-flash'), 500);

                flippedCards = [];
                isProcessing = false;

                // å…¨ãƒšã‚¢æƒã£ãŸã‚‰çµ‚äº†
                if (matchedPairs === emojis.length) {
                    finishGame();
                }

            } else {
                // ä¸æ­£è§£...å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆ»ã™
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    flippedCards = [];
                    isProcessing = false; // ãƒ­ãƒƒã‚¯è§£é™¤
                }, 1000); // 1ç§’ã ã‘è¦‹ã›ã‚‹
            }
        }

        function finishGame() {
            clearInterval(timerInterval);
            const finalTime = ((Date.now() - startTime) / 1000).toFixed(1);
            gameFinishTime = finalTime; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²ç”¨ã«ä¿å­˜
            document.getElementById('final-time').textContent = finalTime + "ã³ã‚‡ã†";
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰çµæœç”»é¢ã¸ï¼ˆæœ€å¾Œã®ã‚«ãƒ¼ãƒ‰ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ï¼‰
            setTimeout(() => {
                changeScreen('result-screen');
            }, 800);
        }
    </script>

</body>

</html>