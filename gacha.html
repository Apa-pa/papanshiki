<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Å±„Å±„Çì„Ç¨„ÉÅ„É£</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #f3e5f5; /* ËñÑ„ÅÑ„ÇÄ„Çâ„Åï„Åç */
            text-align: center;
            margin: 0;
            padding: 20px;
            color: #4a148c;
            touch-action: manipulation;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        h1 { margin: 0 0 20px 0; color: #7b1fa2; }

        /* „É¶„Éº„Ç∂„Éº„Éª„Éù„Ç§„É≥„ÉàË°®Á§∫ */
        .status-bar {
            background: #fff3e0;
            padding: 15px;
            border-radius: 20px;
            border: 2px solid #ffb74d;
            margin-bottom: 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .point-box { font-size: 24px; color: #e65100; }

        /* „Ç¨„ÉÅ„É£„Éû„Ç∑„É≥ */
        .machine-area {
            position: relative;
            height: 300px;
            background: #e1bee7;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border: 4px solid #ba68c8;
        }

        .machine-img { font-size: 150px; line-height: 1; z-index: 2; transition: transform 0.1s; }
        
        /* „Ç¨„ÉÅ„É£„ÇíÂõû„Åô„Éú„Çø„É≥ */
        .spin-btn {
            background: linear-gradient(to bottom, #ff4081, #c51162);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px #880e4f;
            font-weight: bold;
            font-family: inherit;
            position: relative;
            top: -20px; /* „Éû„Ç∑„É≥„ÅÆ‰∏ã„Å´„Åã„Å∂„Åõ„Çã */
            z-index: 10;
        }
        .spin-btn:active { transform: translateY(4px); box-shadow: 0 2px #880e4f; }
        .spin-btn:disabled { background: #bdbdbd; box-shadow: none; cursor: not-allowed; }

        /* „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„É™„Çπ„Éà */
        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 15px;
        }
        .item-card {
            background: white;
            border-radius: 10px;
            padding: 5px;
            border: 2px solid #ddd;
            aspect-ratio: 1/1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .item-card img { width: 100%; height: 100%; object-fit: contain; }
        .unknown { font-size: 40px; color: #ccc; }
        .item-card.has-item { border-color: #ffca28; background: #fffde7; }

        /* ÁµêÊûúÁîªÈù¢Ôºà„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºâ */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            animation: fadeIn 0.3s;
        }
        
        .capsule {
            font-size: 100px;
            animation: bounce 0.5s infinite alternate;
        }

        .result-content {
            text-align: center;
            display: none; /* ÊúÄÂàù„ÅØÈö†„Åô */
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .result-img {
            width: 200px; height: 200px; object-fit: contain;
            background: white; border-radius: 20px; padding: 10px;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }
        .result-name { font-size: 28px; font-weight: bold; margin: 15px 0; }
        .result-rarity { font-size: 18px; color: #ffd54f; margin-bottom: 20px; }
        .new-badge {
            background: #f50057; color: white; padding: 5px 15px;
            border-radius: 20px; font-weight: bold; font-size: 14px;
            position: absolute; top: -10px; right: -10px;
            animation: pulse 1s infinite;
        }

        .close-btn {
            background: white; color: #333; border: none;
            padding: 10px 30px; font-size: 18px; border-radius: 30px;
            cursor: pointer; font-weight: bold;
        }

        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .shaking { animation: shake 0.1s infinite; }

    </style>
</head>
<body>

<div class="container">
    <h1>üíä „Å±„Å±„Çì„Ç¨„ÉÅ„É£</h1>
    
    <select id="user-select" onchange="updateStatus()" style="padding: 10px; font-size: 16px; margin-bottom: 10px;">
        <option value="">(„Å™„Åæ„Åà„Çí„Åà„Çâ„Çì„Åß„Å≠)</option>
    </select>

    <div class="status-bar">
        <div>üíé „ÇÇ„Å£„Å¶„Çã„Éù„Ç§„É≥„Éà</div>
        <div class="point-box"><span id="current-points">0</span> pt</div>
    </div>

    <div class="machine-area">
        <div id="machine-body" class="machine-img">üîÆ</div>
    </div>

    <button id="spin-btn" class="spin-btn" onclick="spinGacha()" disabled>
        „Åæ„Çè„Åô (50pt)
    </button>

    <div style="text-align: left; margin-top: 30px; font-weight: bold; color: #555;">
        üìñ „Åö„Åã„Çì (<span id="collect-count">0</span> / 5)
    </div>
    <div class="collection-grid" id="collection-list">
        </div>
    
    <div style="margin-top: 30px;">
        <a href="index.html" style="color: #8d6e63; text-decoration: underline;">üè† „Éõ„Éº„É†„Å∏„ÇÇ„Å©„Çã</a>
    </div>
</div>

<div id="result-overlay" class="overlay">
    <div id="capsule-anim" class="capsule">üíä</div>

    <div id="result-view" class="result-content" style="position: relative;">
        <div id="new-badge" class="new-badge" style="display:none;">NEW!</div>
        <img id="res-img" class="result-img" src="">
        <div id="res-rarity" class="result-rarity">‚òÖ‚òÖ‚òÖ‚òÖ</div>
        <div id="res-name" class="result-name">„Ç≠„É£„É©Âêç</div>
        <button class="close-btn" onclick="closeResult()">OK</button>
    </div>
</div>

<script>
    // „Ç¨„ÉÅ„É£„ÅÆ‰∏≠Ë∫´„É™„Çπ„ÉàÔºàÊèê‰æõÂâ≤Âêà„Å™„Å©„ÅØÁ∞°ÊòìÁöÑ„Å´ÂùáÁ≠â„Åæ„Åü„ÅØÈáç„Åø‰ªò„ÅëÂèØËÉΩÔºâ
    const gachaItems = [
        { id: 'hi-an', name: '„Éí„ÉºÔºÜ„Ç¢„É≥', img: 'hi-an-192.png', rarity: '‚òÖ‚òÖ‚òÖ' },
        { id: 'hi-an-s', name: 'Ê∞¥ÂΩ©„Éí„ÉºÔºÜ„Ç¢„É≥', img: 'hi-an-suisai-192.png', rarity: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ' }, // „É¨„Ç¢ÔºÅ
        { id: 'pippi', name: '„Åè„Åæ„ÅÆ„Éî„ÉÉ„Éî', img: 'pippi192.png', rarity: '‚òÖ‚òÖ‚òÖ' },
        { id: 'an', name: '„Éè„É™„Éç„Ç∫„Éü„ÅÆ„Ç¢„É≥', img: 'an192.png', rarity: '‚òÖ‚òÖ‚òÖ‚òÖ' },
        { id: 'hi', name: '„Ç®„Çæ„É™„Çπ„ÅÆ„Éí„Éº', img: 'hi-192.png', rarity: '‚òÖ‚òÖ‚òÖ‚òÖ' }
    ];

    const GACHA_COST = 50;

    window.onload = function() {
        const users = getUserNames();
        const select = document.getElementById('user-select');
        users.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u;
            opt.innerText = u;
            select.appendChild(opt);
        });
        renderCollection();
    };

    function updateStatus() {
        const userName = document.getElementById('user-select').value;
        const ptSpan = document.getElementById('current-points');
        const btn = document.getElementById('spin-btn');

        if (!userName) {
            ptSpan.innerText = 0;
            btn.disabled = true;
            btn.innerText = `„Åæ„Çè„Åô (${GACHA_COST}pt)`;
            renderCollection();
            return;
        }

        const pts = getUserPoints(userName);
        ptSpan.innerText = pts;

        if (pts >= GACHA_COST) {
            btn.disabled = false;
            btn.innerText = `„Åæ„Çè„Åô (${GACHA_COST}pt)`;
            btn.style.background = "linear-gradient(to bottom, #ff4081, #c51162)";
        } else {
            btn.disabled = true;
            btn.innerText = "„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Å™„ÅÑ„Çà";
            btn.style.background = "#bdbdbd";
        }

        renderCollection();
    }

    function spinGacha() {
        const userName = document.getElementById('user-select').value;
        if (!userName) return;

        // „Éù„Ç§„É≥„ÉàÊ∂àË≤ª
        const success = spendPoints(userName, GACHA_COST);
        if (!success) {
            alert("„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ");
            return;
        }

        updateStatus(); // Ë°®Á§∫Êõ¥Êñ∞

        // ÊºîÂá∫ÈñãÂßã
        const machine = document.getElementById('machine-body');
        machine.classList.add('shaking'); // „Ç¨„Çø„Ç¨„ÇøÊè∫„Çâ„Åô

        // ÊäΩÈÅ∏Ôºà„É©„É≥„ÉÄ„É†Ôºâ
        const picked = gachaItems[Math.floor(Math.random() * gachaItems.length)];

        // 1.5ÁßíÂæå„Å´ÁµêÊûúË°®Á§∫
        setTimeout(() => {
            machine.classList.remove('shaking');
            showResult(userName, picked);
        }, 1500);
    }

    function showResult(userName, item) {
        const overlay = document.getElementById('result-overlay');
        const capsule = document.getElementById('capsule-anim');
        const view = document.getElementById('result-view');
        
        overlay.style.display = 'flex';
        capsule.style.display = 'block';
        view.style.display = 'none';

        // „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥‰øùÂ≠ò
        const isNew = addToCollection(userName, item.id);

        // „Ç´„Éó„Çª„É´„ÅåÈñã„ÅèÊºîÂá∫Ôºà1ÁßíÂæåÔºâ
        setTimeout(() => {
            capsule.style.display = 'none';
            view.style.display = 'block';

            document.getElementById('res-img').src = item.img;
            document.getElementById('res-name').innerText = item.name;
            document.getElementById('res-rarity').innerText = item.rarity;
            
            const badge = document.getElementById('new-badge');
            if (isNew) {
                badge.style.display = 'block';
                // „Ç≠„É©„Ç≠„É©ÂäπÊûúÈü≥„Å™„Å©„ÇíÈ≥¥„Çâ„Åó„Å¶„ÇÇÊ•Ω„Åó„ÅÑ
            } else {
                badge.style.display = 'none';
            }
        }, 1000);
    }

    function closeResult() {
        document.getElementById('result-overlay').style.display = 'none';
        renderCollection(); // Âõ≥ÈëëÊõ¥Êñ∞
    }

    // Âõ≥Èëë„ÅÆÊèèÁîª
    function renderCollection() {
        const userName = document.getElementById('user-select').value;
        const list = document.getElementById('collection-list');
        const countSpan = document.getElementById('collect-count');
        list.innerHTML = '';

        if (!userName) {
            countSpan.innerText = "0";
            return;
        }

        const myCollection = getCollection(userName);
        countSpan.innerText = myCollection.length;

        gachaItems.forEach(item => {
            const hasIt = myCollection.includes(item.id);
            
            const div = document.createElement('div');
            div.className = `item-card ${hasIt ? 'has-item' : ''}`;
            
            if (hasIt) {
                div.innerHTML = `<img src="${item.img}">`;
            } else {
                div.innerHTML = `<span class="unknown">?</span>`;
            }
            list.appendChild(div);
        });
    }
</script>

</body>
</html>