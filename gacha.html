<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã±ã±ã‚“ã‚¬ãƒãƒ£</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #f3e5f5;
            /* è–„ã„ã‚€ã‚‰ã•ã */
            text-align: center;
            margin: 0;
            padding: 20px;
            color: #4a148c;
            touch-action: manipulation;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0 0 20px 0;
            color: #7b1fa2;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º */
        .status-bar {
            background: #fff3e0;
            padding: 15px;
            border-radius: 20px;
            border: 2px solid #ffb74d;
            margin-bottom: 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .point-box {
            font-size: 24px;
            color: #e65100;
        }

        /* ã‚¬ãƒãƒ£ãƒã‚·ãƒ³ã‚¨ãƒªã‚¢ */
        .machine-area {
            position: relative;
            height: 350px;
            /* ç”»åƒã«åˆã‚ã›ã¦å°‘ã—é«˜ãã—ã¾ã—ãŸ */
            background: #e1bee7;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border: 4px solid #ba68c8;
        }

        /* â–¼â–¼â–¼ ç”»åƒç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›´ â–¼â–¼â–¼ */
        .machine-img {
            height: 90%;
            /* æ ã®é«˜ã•ã®90%ã«åˆã‚ã›ã‚‹ */
            width: auto;
            /* æ¨ªå¹…ã¯è‡ªå‹•èª¿æ•´ï¼ˆæ¯”ç‡ã‚’ä¿ã¤ï¼‰ */
            object-fit: contain;
            z-index: 2;
            transition: transform 0.1s;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
        }

        /* ã‚¬ãƒãƒ£ã‚’å›ã™ãƒœã‚¿ãƒ³ */
        .spin-btn {
            background: linear-gradient(to bottom, #ff4081, #c51162);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px #880e4f;
            font-weight: bold;
            font-family: inherit;
            position: relative;
            top: -30px;
            /* ãƒã‚·ãƒ³ã®ä¸‹ã«ã‹ã¶ã›ã‚‹ */
            z-index: 10;
        }

        .spin-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px #880e4f;
        }

        .spin-btn:disabled {
            background: #bdbdbd;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ */
        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 15px;
        }

        .item-card {
            background: white;
            border-radius: 10px;
            padding: 5px;
            border: 2px solid #ddd;
            aspect-ratio: 1/1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .item-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .unknown {
            font-size: 40px;
            color: #ccc;
        }

        .item-card.has-item {
            border-color: #ffca28;
            background: #fffde7;
        }

        /* çµæœç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            animation: fadeIn 0.3s;
        }

        .capsule {
            font-size: 100px;
            animation: bounce 0.5s infinite alternate;
        }

        .result-content {
            text-align: center;
            display: none;
            /* æœ€åˆã¯éš ã™ */
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .result-img {
            width: 200px;
            height: 200px;
            object-fit: contain;
            background: white;
            border-radius: 20px;
            padding: 10px;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }

        .result-name {
            font-size: 28px;
            font-weight: bold;
            margin: 15px 0;
        }

        .result-rarity {
            font-size: 18px;
            color: #ffd54f;
            margin-bottom: 20px;
        }

        .new-badge {
            background: #f50057;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            position: absolute;
            top: -10px;
            right: -10px;
            animation: pulse 1s infinite;
        }

        .close-btn {
            background: white;
            color: #333;
            border: none;
            padding: 10px 30px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
        }

        @keyframes shake {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(2deg);
            }

            75% {
                transform: rotate(-2deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        @keyframes popIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-20px);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .shaking {
            animation: shake 0.1s infinite;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ğŸ’Š ã±ã±ã‚“ã‚¬ãƒãƒ£</h1>

        <select id="user-select" onchange="updateStatus()" style="padding: 10px; font-size: 16px; margin-bottom: 10px;">
            <option value="">(ãªã¾ãˆã‚’ãˆã‚‰ã‚“ã§ã­)</option>
        </select>

        <div class="status-bar">
            <div>ğŸ’ ã‚‚ã£ã¦ã‚‹ãƒã‚¤ãƒ³ãƒˆ</div>
            <div class="point-box"><span id="current-points">0</span> pt</div>
        </div>

        <div class="machine-area">
            <img id="machine-body" class="machine-img" src="gacha_machine.webp" alt="ã‚¬ãƒãƒ£ãƒã‚·ãƒ³">
        </div>

        <button id="spin-btn" class="spin-btn" onclick="spinGacha()" disabled>
            ã¾ã‚ã™ (50pt)
        </button>

        <div style="text-align: left; margin-top: 30px; font-weight: bold; color: #555;">
            ğŸ“– ãšã‹ã‚“ (<span id="collect-count">0</span> / 5)
        </div>
        <div class="collection-grid" id="collection-list">
        </div>

        <div style="margin-top: 30px;">
            <a href="index.html" style="color: #8d6e63; text-decoration: underline;">ğŸ  ãƒ›ãƒ¼ãƒ ã¸ã‚‚ã©ã‚‹</a>
        </div>
    </div>

    <div id="result-overlay" class="overlay">
        <div id="capsule-anim" class="capsule">ğŸ’Š</div>

        <div id="result-view" class="result-content" style="position: relative;">
            <div id="new-badge" class="new-badge" style="display:none;">NEW!</div>
            <img id="res-img" class="result-img" src="">
            <div id="res-rarity" class="result-rarity">â˜…â˜…â˜…â˜…</div>
            <div id="res-name" class="result-name">ã‚­ãƒ£ãƒ©å</div>
            <button class="close-btn" onclick="closeResult()">OK</button>
        </div>
    </div>

    <script>
        // ã‚¬ãƒãƒ£ã®ä¸­èº«ãƒªã‚¹ãƒˆ
        const gachaItems = [
            { id: 'hi-an', name: 'ãƒ’ãƒ¼ï¼†ã‚¢ãƒ³', img: 'hi-an-192.webp', rarity: 'â˜…â˜…â˜…' },
            { id: 'hi-an-s', name: 'æ°´å½©ãƒ’ãƒ¼ï¼†ã‚¢ãƒ³', img: 'hi-an-suisai-192.webp', rarity: 'â˜…â˜…â˜…â˜…â˜…' }, // ãƒ¬ã‚¢ï¼
            { id: 'pippi', name: 'ãã¾ã®ãƒ”ãƒƒãƒ”', img: 'pippi192.webp', rarity: 'â˜…â˜…â˜…' },
            { id: 'an', name: 'ãƒãƒªãƒã‚ºãƒŸã®ã‚¢ãƒ³', img: 'an192.webp', rarity: 'â˜…â˜…â˜…â˜…' },
            { id: 'hi', name: 'ã‚¨ã‚¾ãƒªã‚¹ã®ãƒ’ãƒ¼', img: 'hi-192.webp', rarity: 'â˜…â˜…â˜…â˜…' }
        ];

        const GACHA_COST = 50;

        window.onload = function () {
            const users = getUserNames();
            const select = document.getElementById('user-select');
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.innerText = u;
                select.appendChild(opt);
            });
            renderCollection();
        };

        function updateStatus() {
            const userName = document.getElementById('user-select').value;
            const ptSpan = document.getElementById('current-points');
            const btn = document.getElementById('spin-btn');

            if (!userName) {
                ptSpan.innerText = 0;
                btn.disabled = true;
                btn.innerText = `ã¾ã‚ã™ (${GACHA_COST}pt)`;
                renderCollection();
                return;
            }

            const pts = getUserPoints(userName);
            ptSpan.innerText = pts;

            if (pts >= GACHA_COST) {
                btn.disabled = false;
                btn.innerText = `ã¾ã‚ã™ (${GACHA_COST}pt)`;
                btn.style.background = "linear-gradient(to bottom, #ff4081, #c51162)";
            } else {
                btn.disabled = true;
                btn.innerText = "ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ã‚ˆ";
                btn.style.background = "#bdbdbd";
            }

            renderCollection();
        }

        function spinGacha() {
            const userName = document.getElementById('user-select').value;
            if (!userName) return;

            // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
            const success = spendPoints(userName, GACHA_COST);
            if (!success) {
                alert("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                return;
            }

            updateStatus(); // è¡¨ç¤ºæ›´æ–°

            // æ¼”å‡ºé–‹å§‹
            const machine = document.getElementById('machine-body');
            machine.classList.add('shaking'); // ã‚¬ã‚¿ã‚¬ã‚¿æºã‚‰ã™

            // æŠ½é¸ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
            const picked = gachaItems[Math.floor(Math.random() * gachaItems.length)];

            // 1.5ç§’å¾Œã«çµæœè¡¨ç¤º
            setTimeout(() => {
                machine.classList.remove('shaking');
                showResult(userName, picked);
            }, 1500);
        }

        function showResult(userName, item) {
            const overlay = document.getElementById('result-overlay');
            const capsule = document.getElementById('capsule-anim');
            const view = document.getElementById('result-view');

            overlay.style.display = 'flex';
            capsule.style.display = 'block';
            view.style.display = 'none';

            // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¿å­˜
            const isNew = addToCollection(userName, item.id);

            // ã‚«ãƒ—ã‚»ãƒ«ãŒé–‹ãæ¼”å‡ºï¼ˆ1ç§’å¾Œï¼‰
            setTimeout(() => {
                capsule.style.display = 'none';
                view.style.display = 'block';

                document.getElementById('res-img').src = item.img;
                document.getElementById('res-name').innerText = item.name;
                document.getElementById('res-rarity').innerText = item.rarity;

                const badge = document.getElementById('new-badge');
                if (isNew) {
                    badge.style.display = 'block';
                    // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœéŸ³ãªã©ã‚’é³´ã‚‰ã—ã¦ã‚‚æ¥½ã—ã„
                } else {
                    badge.style.display = 'none';
                }
            }, 1000);
        }

        function closeResult() {
            document.getElementById('result-overlay').style.display = 'none';
            renderCollection(); // å›³é‘‘æ›´æ–°
        }

        // å›³é‘‘ã®æç”»
        function renderCollection() {
            const userName = document.getElementById('user-select').value;
            const list = document.getElementById('collection-list');
            const countSpan = document.getElementById('collect-count');
            list.innerHTML = '';

            if (!userName) {
                countSpan.innerText = "0";
                return;
            }

            const myCollection = getCollection(userName);
            countSpan.innerText = myCollection.length;

            gachaItems.forEach(item => {
                const hasIt = myCollection.includes(item.id);

                const div = document.createElement('div');
                div.className = `item-card ${hasIt ? 'has-item' : ''}`;

                if (hasIt) {
                    div.innerHTML = `<img src="${item.img}">`;
                } else {
                    div.innerHTML = `<span class="unknown">?</span>`;
                }
                list.appendChild(div);
            });
        }
    </script>

</body>

</html>