<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠã¨ã‚ã¦ã‚¯ã‚¤ã‚º</title>
    <script src="ranking.js"></script>
    <style>
        body {
            font-family: "UD Digital Kyokasho-tai-R", sans-serif;
            background-color: #e1f5fe;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            touch-action: manipulation;
            user-select: none;
        }

        #game-container {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            width: 95%;
            max-width: 600px;
        }

        .screen { display: none; }
        .active { display: block; }

        h1 { color: #039be5; font-size: 24px; margin: 10px 0; }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
        .level-btn {
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: #039be5;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px #0277bd;
        }
        .level-btn:active { transform: translateY(2px); box-shadow: none; }
        .lvl-easy { background: #4caf50; box-shadow: 0 4px #2e7d32; }
        .lvl-normal { background: #ff9800; box-shadow: 0 4px #ef6c00; }
        .lvl-hard { background: #f44336; box-shadow: 0 4px #c62828; }

        /* å†ç”Ÿã‚¨ãƒªã‚¢ */
        .controls-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .play-btn {
            padding: 15px 20px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }
        .play-btn:active { transform: translateY(2px); box-shadow: none; }

        .btn-replay { background: #fbc02d; color: #555; }
        .btn-hint { background: #90a4ae; color: white; }

        .icon-large { font-size: 40px; margin-bottom: 5px; }

        /* éµç›¤ã‚¨ãƒªã‚¢ */
        #keyboard-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            min-height: 150px; /* é«˜ã•ã‚’ç¢ºä¿ */
        }
        
        .key-btn {
            width: 60px;
            height: 100px; /* ç¸¦é•·ã«ã—ã¦ãƒ”ã‚¢ãƒã£ã½ã */
            border-radius: 0 0 10px 10px;
            font-size: 18px;
            font-weight: bold;
            border: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            box-shadow: 0 4px rgba(0,0,0,0.2);
            color: #555; /* æ–‡å­—è‰² */
            transition: transform 0.1s;
            background: white; /* åŸºæœ¬ã¯ç™½éµ */
            display: flex;
            align-items: flex-end; /* æ–‡å­—ã‚’ä¸‹æƒãˆ */
            justify-content: center;
            padding-bottom: 10px;
            position: relative;
        }
        .key-btn:active { transform: translateY(2px); box-shadow: none; background: #eee; }

        /* éŸ³ã”ã¨ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚«ãƒ©ãƒ¼ï¼ˆè¦–è¦šè£œåŠ©ï¼‰ */
        .key-btn[data-note="C4"] { border-top: 10px solid #e57373; }
        .key-btn[data-note="D4"] { border-top: 10px solid #ffb74d; }
        .key-btn[data-note="E4"] { border-top: 10px solid #fff176; }
        .key-btn[data-note="F4"] { border-top: 10px solid #81c784; }
        .key-btn[data-note="G4"] { border-top: 10px solid #4fc3f7; }
        .key-btn[data-note="A4"] { border-top: 10px solid #7986cb; }
        .key-btn[data-note="B4"] { border-top: 10px solid #ba68c8; }
        /* C5å‰Šé™¤ */

        .back-btn {
            background: #cfd8dc; font-size: 14px; padding: 8px 20px;
            color: #555; border-radius: 20px; text-decoration: none;
            display: inline-block; margin-top: 20px;
        }

        #feedback {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 150px;
            display: none;
            z-index: 100;
            text-shadow: 2px 2px 0 white;
            pointer-events: none;
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="feedback">â­•</div>

    <div id="home-screen" class="screen active">
        <h1>ãŠã¨ã‚ã¦ã‚¯ã‚¤ã‚º</h1>
        <div style="font-size: 60px; margin: 10px;">ğŸ¹</div>
        <p>ãƒ¬ãƒ™ãƒ«ã‚’ãˆã‚‰ã‚“ã§ã­</p>
        
        <button class="level-btn lvl-easy" onclick="startGame(1)">ãƒ¬ãƒ™ãƒ«1<br><span style="font-size:14px; font-weight:normal;">ãƒ‰ãƒ»ãƒŸãƒ»ã‚½ ã®3ã¤</span></button>
        <button class="level-btn lvl-normal" onclick="startGame(2)">ãƒ¬ãƒ™ãƒ«2<br><span style="font-size:14px; font-weight:normal;">ãƒ‰ã€œã‚½ ã®5ã¤</span></button>
        <button class="level-btn lvl-hard" onclick="startGame(3)">ãƒ¬ãƒ™ãƒ«3<br><span style="font-size:14px; font-weight:normal;">ãƒ‰ã€œã‚· ãœã‚“ã¶</span></button>

        <p style="color:#f57f17; font-size:12px; margin-top:20px;">â€»éŸ³ãŒå‡ºã‚‹ã‚ˆï¼ãƒãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¦ã­</p>
        <a href="index.html" class="back-btn">ğŸ  ã‚‚ã©ã‚‹</a>
    </div>

    <div id="game-screen" class="screen">
        <div style="text-align: right; color:#888; font-size:14px;">
            ã‚‚ã‚“ã ã„ <span id="q-count">1</span> / 10
        </div>

        <div class="controls-row">
            <button class="play-btn btn-hint" onclick="playNote('C4')">
                <span class="icon-large">ğŸ’¡</span>
                ãƒ’ãƒ³ãƒˆ(ãƒ‰)
            </button>
            <button class="play-btn btn-replay" onclick="playCurrentNote()">
                <span class="icon-large">ğŸ”Š</span>
                ã‚‚ã†ã„ã¡ã©
            </button>
        </div>

        <h2>ã©ã®ãŠã¨ ã‹ãªï¼Ÿ</h2>

        <div id="keyboard-area">
            </div>

        <a href="index.html" class="back-btn">ğŸ  ã‚„ã‚ã‚‹</a>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ‰ ãŠã—ã¾ã„ï¼ ğŸ‰</h1>
        <div style="font-size: 80px; margin: 20px;">ğŸµ</div>
        <p>ã›ã„ã‹ã„ã¯...</p>
        <p style="font-size:24px; font-weight:bold; color:#e91e63;">
            <span id="score-display">0</span> / 10 ã‚‚ã‚“
        </p>
        <button onclick="this.disabled=true; this.innerText='ã‚‚ã‚‰ã„ã¾ã—ãŸ'; this.style.background='#ccc'; if(typeof showPointGetDialog==='function'){showPointGetDialog(30)}else{alert('ãƒã‚¤ãƒ³ãƒˆã‚²ãƒƒãƒˆï¼')}" 
    style="padding:15px 30px; font-size:18px; background:#ff9800; color:white; border:none; border-radius:30px; font-weight:bold; cursor:pointer; margin-top:10px; box-shadow: 0 4px #e65100;">
    ğŸ 30ãƒã‚¤ãƒ³ãƒˆã‚’ã‚‚ã‚‰ã†
</button>
        <button class="level-btn" onclick="location.reload()">ã‚‚ã†ã„ã£ã‹ã„</button>
        <br>
        <a href="index.html" class="back-btn">ğŸ  ãƒ›ãƒ¼ãƒ ã¸</a>
    </div>
</div>

<script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    // â–¼â–¼â–¼ ä¿®æ­£: éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¿½åŠ ã—ã€C5ã‚’å‰Šé™¤ â–¼â–¼â–¼
    const allNotes = {
        'C4': { file: 'se/C4.mp3', freq: 261.63, name: 'ãƒ‰' },
        'D4': { file: 'se/D4.mp3', freq: 293.66, name: 'ãƒ¬' },
        'E4': { file: 'se/E4.mp3', freq: 329.63, name: 'ãƒŸ' },
        'F4': { file: 'se/F4.mp3', freq: 349.23, name: 'ãƒ•ã‚¡' },
        'G4': { file: 'se/G4.mp3', freq: 392.00, name: 'ã‚½' },
        'A4': { file: 'se/A4.mp3', freq: 440.00, name: 'ãƒ©' },
        'B4': { file: 'se/B4.mp3', freq: 493.88, name: 'ã‚·' }
    };

    const audioBuffers = {};

    // ãƒ¬ãƒ™ãƒ«è¨­å®š (C5ã‚’å‰Šé™¤)
    const levels = {
        1: ['C4', 'E4', 'G4'], 
        2: ['C4', 'D4', 'E4', 'F4', 'G4'],
        3: ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'] 
    };

    let currentLevelKeys = [];
    let currentQuestionKey = '';
    let questionCount = 0;
    let score = 0;
    const totalQuestions = 10;

    // éŸ³æºã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
    window.onload = function() {
        // ã‚­ãƒ¼ã”ã¨ã«Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        for (const [key, data] of Object.entries(allNotes)) {
            const audio = new Audio(data.file);
            audio.load();
            audioBuffers[key] = audio;
        }
    };
    
    function changeScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // â–¼â–¼â–¼ æ–°ã—ã„å†ç”Ÿé–¢æ•°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å„ªå…ˆã€ãªã‘ã‚Œã°é›»å­éŸ³ï¼‰ â–¼â–¼â–¼
    function playNote(key) {
        if (!audioBuffers[key]) return;

        // ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿã‚’è©¦ã¿ã‚‹
        const sound = audioBuffers[key].cloneNode();
        sound.volume = 1.0;
        const playPromise = sound.play();

        if (playPromise !== undefined) {
            playPromise.catch(error => {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®é›»å­éŸ³
                playSynthTone(allNotes[key].freq, 'sine');
            });
        }
    }

    // æ­£è§£ãƒ»ä¸æ­£è§£ã€ãŠã‚ˆã³ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã®é›»å­éŸ³ç”Ÿæˆ
    function playSynthTone(freq, type = 'sine') {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        
        gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1.2);

        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        osc.start();
        osc.stop(audioCtx.currentTime + 1.2);
    }

    function startGame(lvl) {
        if (!audioCtx) audioCtx = new AudioContext();
        
        currentLevelKeys = levels[lvl];
        renderKeyboard();

        questionCount = 0;
        score = 0;
        changeScreen('game-screen');
        nextQuestion();
    }

    function renderKeyboard() {
        const area = document.getElementById('keyboard-area');
        area.innerHTML = ''; 

        // é †ç•ªé€šã‚Šã«è¡¨ç¤º
        const orderedKeys = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'];
        
        orderedKeys.forEach(key => {
            if (currentLevelKeys.includes(key)) {
                const note = allNotes[key];
                const btn = document.createElement('button');
                btn.className = 'key-btn';
                btn.textContent = note.name;
                btn.setAttribute('data-note', key); 
                btn.onclick = () => checkAnswer(key);
                area.appendChild(btn);
            }
        });
    }

    function nextQuestion() {
        if (questionCount >= totalQuestions) {
            document.getElementById('score-display').textContent = score;
            changeScreen('result-screen');
            return;
        }

        questionCount++;
        document.getElementById('q-count').textContent = questionCount;

        const r = Math.floor(Math.random() * currentLevelKeys.length);
        currentQuestionKey = currentLevelKeys[r];

        setTimeout(() => {
            playNote(currentQuestionKey);
        }, 500);
    }

    function playCurrentNote() {
        if(currentQuestionKey) {
            playNote(currentQuestionKey);
        }
    }

    function checkAnswer(userKey) {
        const feedback = document.getElementById('feedback');
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ¼ã—ãŸéŸ³ã‚‚é³´ã‚‰ã™ï¼ˆæ­£è§£éŸ³ã®å‰ã«å°‘ã—èã“ãˆã‚‹ã‚ˆã†ã«ï¼‰
        // playNote(userKey); 
        // â†‘ æ··ãœã‚‹ã¨ã†ã‚‹ã•ã„ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€ã“ã“ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«åŠ¹æœéŸ³ã ã‘ã«ã—ã¾ã™

        if (userKey === currentQuestionKey) {
            score++;
            feedback.textContent = 'â­•';
            feedback.style.color = '#ff3d00';
            feedback.style.display = 'block';
            
            // æ­£è§£éŸ³ï¼ˆãƒ”ãƒ³ãƒãƒ³ï¼ï¼‰- é›»å­éŸ³ã®ã¾ã¾
            playSynthTone(880, 'sine'); 
            setTimeout(() => playSynthTone(1108, 'sine'), 100); 
            
            setTimeout(() => {
                feedback.style.display = 'none';
                nextQuestion();
            }, 1000);
        } else {
            feedback.textContent = 'âŒ';
            feedback.style.color = '#555';
            feedback.style.display = 'block';
            
            // ä¸æ­£è§£éŸ³ï¼ˆãƒ–ãƒ–ãƒ¼ï¼‰- é›»å­éŸ³ã®ã¾ã¾
            playSynthTone(150, 'sawtooth'); 

            setTimeout(() => {
                feedback.style.display = 'none';
                nextQuestion(); 
            }, 1000);
        }
    }
</script>

</body>
</html>